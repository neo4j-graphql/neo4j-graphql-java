:toc:
:toclevels: 42

= Connections -> Interfaces

== Setup

.Schema
[source,graphql,schema=true]
----
interface Production {
  title: String!
}

type Movie implements Production {
  title: String!
  runtime: Int!
}

type Series implements Production {
  title: String!
  episodes: Int!
}

type ActedIn @relationshipProperties {
  screenTime: Int!
}

type Actor {
  name: String!
  actedIn: [Production!]! @relationship(type: "ACTED_IN", direction: OUT, properties: "ActedIn")
}
----

.Test Data
[source,cypher,test-data=true]
----
CREATE (actor:Actor {name: "Jason Momoa"})
 CREATE (actor)-[:ACTED_IN {screenTime: 858}]->(:Series {title: "Game of Thrones", episodes: 73})
 CREATE (actor)-[:ACTED_IN {screenTime: 90}]->(:Movie {title: "Dune", runtime: 155})
 CREATE (actor)-[:ACTED_IN {screenTime: 120}]->(:Movie {title: "Aquaman", runtime: 144})
----

== Projecting node and relationship properties with no arguments

.GraphQL-Query
[source,graphql,request=true]
----
query Actors($name: String) {
  actors(where: {name: $name}) {
    name
    actedInConnection {
      edges {
        properties {
          screenTime
        }
        node {
          title
          ... on Movie {
            runtime
          }
          ... on Series {
            episodes
          }
        }
      }
    }
  }
}
----

.GraphQL params input
[source,json,request=true]
----
{
  "name" : "Jason Momoa"
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "Jason Momoa"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WHERE this.name = $param0
CALL {
	WITH this
	CALL {
		WITH this
		MATCH (this)-[actedIn0:ACTED_IN]->(movie0:Movie)
		WITH {
			properties: {
				__typename: 'ActedIn',
				screenTime: actedIn0.screenTime
			},
			node: {
				__typename: 'Movie',
				title: movie0.title,
				runtime: movie0.runtime,
				__id: elementId(movie0)
			}
		} AS edge
		RETURN edge UNION
		WITH this
		MATCH (this)-[actedIn1:ACTED_IN]->(series0:Series)
		WITH {
			properties: {
				__typename: 'ActedIn',
				screenTime: actedIn1.screenTime
			},
			node: {
				__typename: 'Series',
				title: series0.title,
				episodes: series0.episodes,
				__id: elementId(series0)
			}
		} AS edge
		RETURN edge
	}
	WITH collect(edge) AS edges
	WITH edges, size(edges) AS totalCount
	RETURN {
		edges: edges,
		totalCount: totalCount
	} AS actedInConnection
}
RETURN this {
	.name,
	actedInConnection: actedInConnection
} AS this
----

.GraphQL-Response
[source,json,response=true,ignore-order]
----
{
  "actors" : [ {
    "name" : "Jason Momoa",
    "actedInConnection" : {
      "edges" : [ {
        "properties" : {
          "screenTime" : 120
        },
        "node" : {
          "title" : "Aquaman",
          "runtime" : 144
        }
      }, {
        "properties" : {
          "screenTime" : 90
        },
        "node" : {
          "title" : "Dune",
          "runtime" : 155
        }
      }, {
        "properties" : {
          "screenTime" : 858
        },
        "node" : {
          "title" : "Game of Thrones",
          "episodes" : 73
        }
      } ]
    }
  } ]
}
----

== Projecting node and relationship properties with shared where argument

.GraphQL-Query
[source,graphql,request=true]
----
query Actors($name: String) {
  actors(where: {name: $name}) {
    name
    actedInConnection(where: {node: {title: "Game of Thrones"}}) {
      edges {
        properties {
          screenTime
        }
        node {
          title
          ... on Movie {
            runtime
          }
          ... on Series {
            episodes
          }
        }
      }
    }
  }
}
----

.GraphQL params input
[source,json,request=true]
----
{
  "name" : "Jason Momoa"
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "Jason Momoa",
  "param1" : "Game of Thrones",
  "param2" : "Game of Thrones"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WHERE this.name = $param0
CALL {
	WITH this
	CALL {
		WITH this
		MATCH (this)-[actedIn0:ACTED_IN]->(movie0:Movie)
		WHERE movie0.title = $param1
		WITH {
			properties: {
				__typename: 'ActedIn',
				screenTime: actedIn0.screenTime
			},
			node: {
				__typename: 'Movie',
				title: movie0.title,
				runtime: movie0.runtime,
				__id: elementId(movie0)
			}
		} AS edge
		RETURN edge UNION
		WITH this
		MATCH (this)-[actedIn1:ACTED_IN]->(series0:Series)
		WHERE series0.title = $param2
		WITH {
			properties: {
				__typename: 'ActedIn',
				screenTime: actedIn1.screenTime
			},
			node: {
				__typename: 'Series',
				title: series0.title,
				episodes: series0.episodes,
				__id: elementId(series0)
			}
		} AS edge
		RETURN edge
	}
	WITH collect(edge) AS edges
	WITH edges, size(edges) AS totalCount
	RETURN {
		edges: edges,
		totalCount: totalCount
	} AS actedInConnection
}
RETURN this {
	.name,
	actedInConnection: actedInConnection
} AS this
----

.GraphQL-Response
[source,json,response=true]
----
{
  "actors" : [ {
    "name" : "Jason Momoa",
    "actedInConnection" : {
      "edges" : [ {
        "properties" : {
          "screenTime" : 858
        },
        "node" : {
          "title" : "Game of Thrones",
          "episodes" : 73
        }
      } ]
    }
  } ]
}
----

== Projecting node and relationship properties with sort argument

.GraphQL-Query
[source,graphql,request=true]
----
query Actors($name: String) {
  actors(where: {name: $name}) {
    name
    actedInConnection(sort: [{edge: {screenTime: DESC}}]) {
      edges {
        properties {
          screenTime
        }
        node {
          title
          ... on Movie {
            runtime
          }
          ... on Series {
            episodes
          }
        }
      }
    }
  }
}
----

.GraphQL params input
[source,json,request=true]
----
{
  "name" : "Jason Momoa"
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "Jason Momoa"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WHERE this.name = $param0
CALL {
	WITH this
	CALL {
		WITH this
		MATCH (this)-[actedIn0:ACTED_IN]->(movie0:Movie)
		WITH {
			properties: {
				__typename: 'ActedIn',
				screenTime: actedIn0.screenTime
			},
			node: {
				__typename: 'Movie',
				title: movie0.title,
				runtime: movie0.runtime,
				__id: elementId(movie0)
			}
		} AS edge
		RETURN edge UNION
		WITH this
		MATCH (this)-[actedIn1:ACTED_IN]->(series0:Series)
		WITH {
			properties: {
				__typename: 'ActedIn',
				screenTime: actedIn1.screenTime
			},
			node: {
				__typename: 'Series',
				title: series0.title,
				episodes: series0.episodes,
				__id: elementId(series0)
			}
		} AS edge
		RETURN edge
	}
	WITH collect(edge) AS edges
	WITH edges, size(edges) AS totalCount
	CALL {
		WITH edges
		UNWIND edges AS edge
		WITH edge ORDER BY edge.properties.screenTime DESC
		RETURN collect(edge) AS sortedEdges0
	}
	RETURN {
		edges: sortedEdges0,
		totalCount: totalCount
	} AS actedInConnection
}
RETURN this {
	.name,
	actedInConnection: actedInConnection
} AS this
----

.GraphQL-Response
[source,json,response=true]
----
{
  "actors" : [ {
    "name" : "Jason Momoa",
    "actedInConnection" : {
      "edges" : [ {
        "properties" : {
          "screenTime" : 858
        },
        "node" : {
          "title" : "Game of Thrones",
          "episodes" : 73
        }
      }, {
        "properties" : {
          "screenTime" : 120
        },
        "node" : {
          "title" : "Aquaman",
          "runtime" : 144
        }
      }, {
        "properties" : {
          "screenTime" : 90
        },
        "node" : {
          "title" : "Dune",
          "runtime" : 155
        }
      } ]
    }
  } ]
}
----

== Projecting node and relationship properties with pagination

.GraphQL-Query
[source,graphql,request=true]
----
query Actors($name: String, $after: String) {
  actors(where: {name: $name}) {
    name
    actedInConnection(first: 2, after: $after, sort: {edge: {screenTime: DESC}}) {
      pageInfo {
        hasNextPage
        hasPreviousPage
        endCursor
      }
      edges {
        properties {
          screenTime
        }
        node {
          title
          ... on Movie {
            runtime
          }
          ... on Series {
            episodes
          }
        }
      }
    }
  }
}
----

.GraphQL params input
[source,json,request=true]
----
{
  "name" : "Jason Momoa"
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "Jason Momoa",
  "param1" : 2
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WHERE this.name = $param0
CALL {
	WITH this
	CALL {
		WITH this
		MATCH (this)-[actedIn0:ACTED_IN]->(movie0:Movie)
		WITH {
			properties: {
				__typename: 'ActedIn',
				screenTime: actedIn0.screenTime
			},
			node: {
				__typename: 'Movie',
				title: movie0.title,
				runtime: movie0.runtime,
				__id: elementId(movie0)
			}
		} AS edge
		RETURN edge UNION
		WITH this
		MATCH (this)-[actedIn1:ACTED_IN]->(series0:Series)
		WITH {
			properties: {
				__typename: 'ActedIn',
				screenTime: actedIn1.screenTime
			},
			node: {
				__typename: 'Series',
				title: series0.title,
				episodes: series0.episodes,
				__id: elementId(series0)
			}
		} AS edge
		RETURN edge
	}
	WITH collect(edge) AS edges
	WITH edges, size(edges) AS totalCount
	CALL {
		WITH edges
		UNWIND edges AS edge
		WITH edge ORDER BY edge.properties.screenTime DESC LIMIT $param1
		RETURN collect(edge) AS sortedEdges0
	}
	RETURN {
		edges: sortedEdges0,
		totalCount: totalCount
	} AS actedInConnection
}
RETURN this {
	.name,
	actedInConnection: actedInConnection
} AS this
----

.GraphQL-Response
[source,json,response=true]
----
{
  "actors" : [ {
    "name" : "Jason Momoa",
    "actedInConnection" : {
      "pageInfo" : {
        "hasNextPage" : true,
        "hasPreviousPage" : false,
        "endCursor" : "YXJyYXljb25uZWN0aW9uOjE="
      },
      "edges" : [ {
        "properties" : {
          "screenTime" : 858
        },
        "node" : {
          "title" : "Game of Thrones",
          "episodes" : 73
        }
      }, {
        "properties" : {
          "screenTime" : 120
        },
        "node" : {
          "title" : "Aquaman",
          "runtime" : 144
        }
      } ]
    }
  } ]
}
----

'''

.GraphQL-Query
[source,graphql,request=true]
----
query Actors($name: String, $after: String) {
  actors(where: {name: $name}) {
    name
    actedInConnection(first: 2, after: $after, sort: {edge: {screenTime: DESC}}) {
      pageInfo {
        hasNextPage
        hasPreviousPage
        endCursor
      }
      edges {
        properties {
          screenTime
        }
        node {
          title
          ... on Movie {
            runtime
          }
          ... on Series {
            episodes
          }
        }
      }
    }
  }
}
----

.GraphQL params input
[source,json,request=true]
----
{
  "after" : "YXJyYXljb25uZWN0aW9uOjE=",
  "name" : "Jason Momoa"
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "Jason Momoa",
  "param1" : 2,
  "param2" : 2
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WHERE this.name = $param0
CALL {
	WITH this
	CALL {
		WITH this
		MATCH (this)-[actedIn0:ACTED_IN]->(movie0:Movie)
		WITH {
			properties: {
				__typename: 'ActedIn',
				screenTime: actedIn0.screenTime
			},
			node: {
				__typename: 'Movie',
				title: movie0.title,
				runtime: movie0.runtime,
				__id: elementId(movie0)
			}
		} AS edge
		RETURN edge UNION
		WITH this
		MATCH (this)-[actedIn1:ACTED_IN]->(series0:Series)
		WITH {
			properties: {
				__typename: 'ActedIn',
				screenTime: actedIn1.screenTime
			},
			node: {
				__typename: 'Series',
				title: series0.title,
				episodes: series0.episodes,
				__id: elementId(series0)
			}
		} AS edge
		RETURN edge
	}
	WITH collect(edge) AS edges
	WITH edges, size(edges) AS totalCount
	CALL {
		WITH edges
		UNWIND edges AS edge
		WITH edge ORDER BY edge.properties.screenTime DESC SKIP $param1 LIMIT $param2
		RETURN collect(edge) AS sortedEdges0
	}
	RETURN {
		edges: sortedEdges0,
		totalCount: totalCount
	} AS actedInConnection
}
RETURN this {
	.name,
	actedInConnection: actedInConnection
} AS this
----

.GraphQL-Response
[source,json,response=true]
----
{
  "actors" : [ {
    "name" : "Jason Momoa",
    "actedInConnection" : {
      "pageInfo" : {
        "hasNextPage" : false,
        "hasPreviousPage" : true,
        "endCursor" : "YXJyYXljb25uZWN0aW9uOjI="
      },
      "edges" : [ {
        "properties" : {
          "screenTime" : 90
        },
        "node" : {
          "title" : "Dune",
          "runtime" : 155
        }
      } ]
    }
  } ]
}
----

== With where argument for shared field on node with node in database

.GraphQL-Query
[source,graphql,request=true]
----
query Actors($name: String, $title: String) {
  actors(where: {name: $name}) {
    name
    actedInConnection(where: {node: {title: $title}}) {
      edges {
        properties {
          screenTime
        }
        node {
          title
          ... on Movie {
            runtime
          }
          ... on Series {
            episodes
          }
        }
      }
    }
  }
}
----

.GraphQL params input
[source,json,request=true]
----
{
  "name" : "Jason Momoa",
  "title" : "Dune"
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "Jason Momoa",
  "param1" : "Dune",
  "param2" : "Dune"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WHERE this.name = $param0
CALL {
	WITH this
	CALL {
		WITH this
		MATCH (this)-[actedIn0:ACTED_IN]->(movie0:Movie)
		WHERE movie0.title = $param1
		WITH {
			properties: {
				__typename: 'ActedIn',
				screenTime: actedIn0.screenTime
			},
			node: {
				__typename: 'Movie',
				title: movie0.title,
				runtime: movie0.runtime,
				__id: elementId(movie0)
			}
		} AS edge
		RETURN edge UNION
		WITH this
		MATCH (this)-[actedIn1:ACTED_IN]->(series0:Series)
		WHERE series0.title = $param2
		WITH {
			properties: {
				__typename: 'ActedIn',
				screenTime: actedIn1.screenTime
			},
			node: {
				__typename: 'Series',
				title: series0.title,
				episodes: series0.episodes,
				__id: elementId(series0)
			}
		} AS edge
		RETURN edge
	}
	WITH collect(edge) AS edges
	WITH edges, size(edges) AS totalCount
	RETURN {
		edges: edges,
		totalCount: totalCount
	} AS actedInConnection
}
RETURN this {
	.name,
	actedInConnection: actedInConnection
} AS this
----

.GraphQL-Response
[source,json,response=true]
----
{
  "actors" : [ {
    "name" : "Jason Momoa",
    "actedInConnection" : {
      "edges" : [ {
        "properties" : {
          "screenTime" : 90
        },
        "node" : {
          "title" : "Dune",
          "runtime" : 155
        }
      } ]
    }
  } ]
}
----
