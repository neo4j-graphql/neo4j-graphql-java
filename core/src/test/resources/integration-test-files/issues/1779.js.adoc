// This file was generated by the Test-Case extractor of neo4j-graphql
:toc:
:toclevels: 42

= https://github.com/neo4j/graphql/issues/1779

== Setup

.Schema
[source,graphql,schema=true]
----
type Person {
  name: String
  age: Int
  attends: [School!]! @relationship(type: "ATTENDS", direction: OUT)
}

type School {
  name: String
  students: [Person!]! @relationship(type: "ATTENDS", direction: IN)
}
----

== Does not throw error 'The EXISTS subclause is not valid inside a WITH or RETURN clause. '

.Test Data
[source,cypher,test-data=true]
----
CREATE (personA:Person { name: "A", age: 24 })-[:ATTENDS]->(schoolOld:School { name: "Old" })
 CREATE (personB:Person { name: "B", age: 26 })-[:ATTENDS]->(schoolOld)
 CREATE (personC:Person { name: "C", age: 23 })-[:ATTENDS]->(schoolYoung:School { name: "Young" })
 CREATE (personD:Person { name: "D", age: 25 })-[:ATTENDS]->(schoolYoung)
----

.GraphQL-Query
[source,graphql,request=true]
----
{
  people {
    name
    attends(where: {students_ALL: {age_GT: 23}}) {
      name
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": 23
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Person)
CALL {
    WITH this
    MATCH (this)-[this0:ATTENDS]->(this1:School)
    WHERE (EXISTS {
        MATCH (this1)<-[:ATTENDS]-(this2:Person)
        WHERE this2.age > $param0
    } AND NOT (EXISTS {
        MATCH (this1)<-[:ATTENDS]-(this2:Person)
        WHERE NOT (this2.age > $param0)
    }))
    WITH this1 { .name } AS this1
    RETURN collect(this1) AS var3
}
RETURN this { .name, attends: var3 } AS this
----

.GraphQL-Response
[source,json,response=true]
----
{
  "people": [
    {
      "name": "B",
      "attends": [
        {
          "name": "Old"
        }
      ]
    },
    {
      "name": "C",
      "attends": []
    },
    {
      "name": "A",
      "attends": [
        {
          "name": "Old"
        }
      ]
    },
    {
      "name": "D",
      "attends": []
    }
  ]
}
----
