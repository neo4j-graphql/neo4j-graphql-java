// This file was generated by the Test-Case extractor of neo4j-graphql
:toc:
:toclevels: 42

= https://github.com/neo4j/graphql/issues/2820

== Setup

.Schema
[source,graphql,schema=true]
----
interface Production {
  title: String!
}

type Movie implements Production {
  title: String!
}

type Series implements Production {
  title: String!
}

union ProductionUnion = Movie | Series

type Actor {
  name: String!
  actedIn: [Production!]! @relationship(type: "ACTED_IN", direction: OUT)
  actedInUnion: [ProductionUnion!]! @relationship(type: "ACTED_IN", direction: OUT)
}
----

.Test Data
[source,cypher,test-data=true]
----
CREATE (a:Actor { name: "Actor" })
 CREATE (a)-[:ACTED_IN]->(:Movie { title: "House" })
 CREATE (a)-[:ACTED_IN]->(:Series { title: "House" })
 CREATE (a)-[:ACTED_IN]->(:Movie { title: "Friends" })
 CREATE (a)-[:ACTED_IN]->(:Series { title: "Friends" })
----

== interface count and amount should be correct

=== should return total count 4

.GraphQL-Query
[source,graphql,request=true]
----
{
  actors {
    actedInConnection {
      totalCount
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
CALL {
    WITH this
    CALL {
        WITH this
        MATCH (this)-[this0:ACTED_IN]->(this1:Movie)
        WITH { node: { __typename: "Movie", __id: toString(id(this1)) } } AS edge
        RETURN edge
        UNION
        WITH this
        MATCH (this)-[this2:ACTED_IN]->(this3:Series)
        WITH { node: { __typename: "Series", __id: toString(id(this3)) } } AS edge
        RETURN edge
    }
    WITH collect(edge) AS edges
    WITH edges, size(edges) AS totalCount
    RETURN { edges: edges, totalCount: totalCount } AS var4
}
RETURN this { actedInConnection: var4 } AS this
----

.GraphQL-Response
[source,json,response=true]
----
{
  "actors": [
    {
      "actedInConnection": {
        "totalCount": 4
      }
    }
  ]
}
----

=== should return interface members in Connection

.GraphQL-Query
[source,graphql,request=true]
----
{
  actors {
    actedInConnection {
      totalCount
      edges {
        node {
          __typename
          title
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
CALL {
    WITH this
    CALL {
        WITH this
        MATCH (this)-[this0:ACTED_IN]->(this1:Movie)
        WITH { node: { __typename: "Movie", __id: toString(id(this1)), title: this1.title } } AS edge
        RETURN edge
        UNION
        WITH this
        MATCH (this)-[this2:ACTED_IN]->(this3:Series)
        WITH { node: { __typename: "Series", __id: toString(id(this3)), title: this3.title } } AS edge
        RETURN edge
    }
    WITH collect(edge) AS edges
    WITH edges, size(edges) AS totalCount
    RETURN { edges: edges, totalCount: totalCount } AS var4
}
RETURN this { actedInConnection: var4 } AS this
----

.GraphQL-Response
[source,json,response=true]
----
{
  "actors": [
    {
      "actedInConnection": {
        "totalCount": 4,
        "edges": [
          {
            "node": {
              "__typename": "Movie",
              "title": "House"
            }
          },
          {
            "node": {
              "__typename": "Movie",
              "title": "Friends"
            }
          },
          {
            "node": {
              "__typename": "Series",
              "title": "Friends"
            }
          },
          {
            "node": {
              "__typename": "Series",
              "title": "House"
            }
          }
        ]
      }
    }
  ]
}
----

=== should return interface members in Connection without querying title

.GraphQL-Query
[source,graphql,request=true]
----
{
  actors {
    actedInConnection {
      totalCount
      edges {
        node {
          __typename
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
CALL {
    WITH this
    CALL {
        WITH this
        MATCH (this)-[this0:ACTED_IN]->(this1:Movie)
        WITH { node: { __typename: "Movie", __id: toString(id(this1)) } } AS edge
        RETURN edge
        UNION
        WITH this
        MATCH (this)-[this2:ACTED_IN]->(this3:Series)
        WITH { node: { __typename: "Series", __id: toString(id(this3)) } } AS edge
        RETURN edge
    }
    WITH collect(edge) AS edges
    WITH edges, size(edges) AS totalCount
    RETURN { edges: edges, totalCount: totalCount } AS var4
}
RETURN this { actedInConnection: var4 } AS this
----

.GraphQL-Response
[source,json,response=true]
----
{
  "actors": [
    {
      "actedInConnection": {
        "totalCount": 4,
        "edges": [
          {
            "node": {
              "__typename": "Movie"
            }
          },
          {
            "node": {
              "__typename": "Movie"
            }
          },
          {
            "node": {
              "__typename": "Series"
            }
          },
          {
            "node": {
              "__typename": "Series"
            }
          }
        ]
      }
    }
  ]
}
----

=== should return interface members in normal field

.GraphQL-Query
[source,graphql,request=true]
----
{
  actors {
    actedIn {
      __typename
      title
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
CALL {
    WITH this
    CALL {
        WITH *
        MATCH (this)-[this0:ACTED_IN]->(this1:Movie)
        WITH this1 { .title, __typename: "Movie", __id: toString(id(this1)) } AS this1
        RETURN this1 AS var2
        UNION
        WITH *
        MATCH (this)-[this3:ACTED_IN]->(this4:Series)
        WITH this4 { .title, __typename: "Series", __id: toString(id(this4)) } AS this4
        RETURN this4 AS var2
    }
    WITH var2
    RETURN collect(var2) AS var2
}
RETURN this { actedIn: var2 } AS this
----

.GraphQL-Response
[source,json,response=true]
----
{
  "actors": [
    {
      "actedIn": [
        {
          "__typename": "Movie",
          "title": "Friends"
        },
        {
          "__typename": "Movie",
          "title": "House"
        },
        {
          "__typename": "Series",
          "title": "House"
        },
        {
          "__typename": "Series",
          "title": "Friends"
        }
      ]
    }
  ]
}
----

=== should return interface members in normal field without querying title

.GraphQL-Query
[source,graphql,request=true]
----
{
  actors {
    actedIn {
      __typename
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
CALL {
    WITH this
    CALL {
        WITH *
        MATCH (this)-[this0:ACTED_IN]->(this1:Movie)
        WITH this1 { __typename: "Movie", __id: toString(id(this1)) } AS this1
        RETURN this1 AS var2
        UNION
        WITH *
        MATCH (this)-[this3:ACTED_IN]->(this4:Series)
        WITH this4 { __typename: "Series", __id: toString(id(this4)) } AS this4
        RETURN this4 AS var2
    }
    WITH var2
    RETURN collect(var2) AS var2
}
RETURN this { actedIn: var2 } AS this
----

.GraphQL-Response
[source,json,response=true]
----
{
  "actors": [
    {
      "actedIn": [
        {
          "__typename": "Movie"
        },
        {
          "__typename": "Movie"
        },
        {
          "__typename": "Series"
        },
        {
          "__typename": "Series"
        }
      ]
    }
  ]
}
----

== union count and amount should be correct

=== should return total count 4

.GraphQL-Query
[source,graphql,request=true]
----
{
  actors {
    actedInUnionConnection {
      totalCount
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
CALL {
    WITH this
    CALL {
        WITH this
        MATCH (this)-[this0:ACTED_IN]->(this1:Movie)
        WITH { node: { __typename: "Movie", __id: toString(id(this1)) } } AS edge
        RETURN edge
        UNION
        WITH this
        MATCH (this)-[this2:ACTED_IN]->(this3:Series)
        WITH { node: { __typename: "Series", __id: toString(id(this3)) } } AS edge
        RETURN edge
    }
    WITH collect(edge) AS edges
    WITH edges, size(edges) AS totalCount
    RETURN { edges: edges, totalCount: totalCount } AS var4
}
RETURN this { actedInUnionConnection: var4 } AS this
----

.GraphQL-Response
[source,json,response=true]
----
{
  "actors": [
    {
      "actedInUnionConnection": {
        "totalCount": 4
      }
    }
  ]
}
----

=== should return interface members in Connection

.GraphQL-Query
[source,graphql,request=true]
----
{
  actors {
    actedInUnionConnection {
      totalCount
      edges {
        node {
          __typename
          ... on Movie {
            title
          }
          ... on Series {
            title
          }
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
CALL {
    WITH this
    CALL {
        WITH this
        MATCH (this)-[this0:ACTED_IN]->(this1:Movie)
        WITH { node: { __typename: "Movie", __id: toString(id(this1)), title: this1.title } } AS edge
        RETURN edge
        UNION
        WITH this
        MATCH (this)-[this2:ACTED_IN]->(this3:Series)
        WITH { node: { __typename: "Series", __id: toString(id(this3)), title: this3.title } } AS edge
        RETURN edge
    }
    WITH collect(edge) AS edges
    WITH edges, size(edges) AS totalCount
    RETURN { edges: edges, totalCount: totalCount } AS var4
}
RETURN this { actedInUnionConnection: var4 } AS this
----

.GraphQL-Response
[source,json,response=true]
----
{
  "actors": [
    {
      "actedInUnionConnection": {
        "totalCount": 4,
        "edges": [
          {
            "node": {
              "__typename": "Movie",
              "title": "House"
            }
          },
          {
            "node": {
              "__typename": "Movie",
              "title": "Friends"
            }
          },
          {
            "node": {
              "__typename": "Series",
              "title": "House"
            }
          },
          {
            "node": {
              "__typename": "Series",
              "title": "Friends"
            }
          }
        ]
      }
    }
  ]
}
----

=== should return interface members in Connection without querying title

.GraphQL-Query
[source,graphql,request=true]
----
{
  actors {
    actedInUnionConnection {
      totalCount
      edges {
        node {
          __typename
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
CALL {
    WITH this
    CALL {
        WITH this
        MATCH (this)-[this0:ACTED_IN]->(this1:Movie)
        WITH { node: { __typename: "Movie", __id: toString(id(this1)) } } AS edge
        RETURN edge
        UNION
        WITH this
        MATCH (this)-[this2:ACTED_IN]->(this3:Series)
        WITH { node: { __typename: "Series", __id: toString(id(this3)) } } AS edge
        RETURN edge
    }
    WITH collect(edge) AS edges
    WITH edges, size(edges) AS totalCount
    RETURN { edges: edges, totalCount: totalCount } AS var4
}
RETURN this { actedInUnionConnection: var4 } AS this
----

.GraphQL-Response
[source,json,response=true]
----
{
  "actors": [
    {
      "actedInUnionConnection": {
        "totalCount": 4,
        "edges": [
          {
            "node": {
              "__typename": "Movie"
            }
          },
          {
            "node": {
              "__typename": "Movie"
            }
          },
          {
            "node": {
              "__typename": "Series"
            }
          },
          {
            "node": {
              "__typename": "Series"
            }
          }
        ]
      }
    }
  ]
}
----

=== should return interface members in normal field

.GraphQL-Query
[source,graphql,request=true]
----
{
  actors {
    actedInUnion {
      __typename
      ... on Movie {
        title
      }
      ... on Series {
        title
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
CALL {
    WITH this
    CALL {
        WITH *
        MATCH (this)-[this0:ACTED_IN]->(this1:Movie)
        WITH this1 { .title, __typename: "Movie", __id: toString(id(this1)) } AS this1
        RETURN this1 AS var2
        UNION
        WITH *
        MATCH (this)-[this3:ACTED_IN]->(this4:Series)
        WITH this4 { .title, __typename: "Series", __id: toString(id(this4)) } AS this4
        RETURN this4 AS var2
    }
    WITH var2
    RETURN collect(var2) AS var2
}
RETURN this { actedInUnion: var2 } AS this
----

.GraphQL-Response
[source,json,response=true]
----
{
  "actors": [
    {
      "actedInUnion": [
        {
          "__typename": "Movie",
          "title": "House"
        },
        {
          "__typename": "Movie",
          "title": "Friends"
        },
        {
          "__typename": "Series",
          "title": "Friends"
        },
        {
          "__typename": "Series",
          "title": "House"
        }
      ]
    }
  ]
}
----

=== should return interface members in normal field without querying title

.GraphQL-Query
[source,graphql,request=true]
----
{
  actors {
    actedInUnion {
      __typename
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
CALL {
    WITH this
    CALL {
        WITH *
        MATCH (this)-[this0:ACTED_IN]->(this1:Movie)
        WITH this1 { __typename: "Movie", __id: toString(id(this1)) } AS this1
        RETURN this1 AS var2
        UNION
        WITH *
        MATCH (this)-[this3:ACTED_IN]->(this4:Series)
        WITH this4 { __typename: "Series", __id: toString(id(this4)) } AS this4
        RETURN this4 AS var2
    }
    WITH var2
    RETURN collect(var2) AS var2
}
RETURN this { actedInUnion: var2 } AS this
----

.GraphQL-Response
[source,json,response=true]
----
{
  "actors": [
    {
      "actedInUnion": [
        {
          "__typename": "Movie"
        },
        {
          "__typename": "Movie"
        },
        {
          "__typename": "Series"
        },
        {
          "__typename": "Series"
        }
      ]
    }
  ]
}
----
