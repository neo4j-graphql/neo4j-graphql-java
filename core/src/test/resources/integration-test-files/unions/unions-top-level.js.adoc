// This file was generated by the Test-Case extractor of neo4j-graphql
:toc:
:toclevels: 42

= Top-level union query fields

== Setup

.Schema
[source,graphql,schema=true]
----
union Search = Genre | Movie

type Genre {
  name: String
}

type Movie {
  title: String
  search: [Search!]! @relationship(type: "SEARCH", direction: OUT)
}
----

.Test Data
[source,cypher,test-data=true]
----
CREATE (m:Movie {title: "The Matrix"})
 CREATE (g:Genre {name: "Action"})
 MERGE (m)-[:SEARCH]->(m)
 MERGE (m)-[:SEARCH]->(g)
----

== should read top-level simple query on union

.GraphQL-Query
[source,graphql,request=true]
----
{
  searches {
    ... on Genre {
      name
    }
    ... on Movie {
      title
      search {
        ... on Genre {
          name
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{}
----

.Expected Cypher output
[source,cypher]
----
CALL {
    MATCH (this0:Genre)
    WITH this0 { .name, __typename: "Genre", __id: toString(id(this0)) } AS this0
    RETURN this0 AS this
    UNION
    MATCH (this1:Movie)
    CALL {
        WITH this1
        CALL {
            WITH *
            MATCH (this1)-[this2:SEARCH]->(this3:Genre)
            WITH this3 { .name, __typename: "Genre", __id: toString(id(this3)) } AS this3
            RETURN this3 AS var4
            UNION
            WITH *
            MATCH (this1)-[this5:SEARCH]->(this6:Movie)
            WITH this6 { __typename: "Movie", __id: toString(id(this6)) } AS this6
            RETURN this6 AS var4
        }
        WITH var4
        RETURN collect(var4) AS var4
    }
    WITH this1 { .title, search: var4, __typename: "Movie", __id: toString(id(this1)) } AS this1
    RETURN this1 AS this
}
WITH this
RETURN this AS this
----

.GraphQL-Response
[source,json,response=true]
----
{
  "searches": [
    {
      "name": "Action"
    },
    {
      "title": "The Matrix",
      "search": [
        {
          "name": "Action"
        },
        {}
      ]
    }
  ]
}
----

== should read top-level simple query on union sorted

.GraphQL-Query
[source,graphql,request=true]
----
{
  searches(options: {limit: 1, offset: 1}) {
    ... on Genre {
      name
    }
    ... on Movie {
      title
      search {
        ... on Genre {
          name
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": 1,
  "param1": 1
}
----

.Expected Cypher output
[source,cypher]
----
CALL {
    MATCH (this0:Genre)
    WITH this0 { .name, __typename: "Genre", __id: toString(id(this0)) } AS this0
    RETURN this0 AS this
    UNION
    MATCH (this1:Movie)
    CALL {
        WITH this1
        CALL {
            WITH *
            MATCH (this1)-[this2:SEARCH]->(this3:Genre)
            WITH this3 { .name, __typename: "Genre", __id: toString(id(this3)) } AS this3
            RETURN this3 AS var4
            UNION
            WITH *
            MATCH (this1)-[this5:SEARCH]->(this6:Movie)
            WITH this6 { __typename: "Movie", __id: toString(id(this6)) } AS this6
            RETURN this6 AS var4
        }
        WITH var4
        RETURN collect(var4) AS var4
    }
    WITH this1 { .title, search: var4, __typename: "Movie", __id: toString(id(this1)) } AS this1
    RETURN this1 AS this
}
WITH this

SKIP $param0
LIMIT $param1
RETURN this AS this
----

.GraphQL-Response
[source,json,response=true]
----
{
  "searches": [
    {
      "title": "The Matrix",
      "search": [
        {
          "name": "Action"
        },
        {}
      ]
    }
  ]
}
----
