:toc:

= Cypher Advanced Filtering

Tests advanced filtering.

== Inputs

[source,graphql,schema=true]
----
type Movie {
    _id: ID
    id: ID
    title: String
    actorCount: Int
# TODO support BigInt
#    budget: BigInt
    genres: [Genre] @relation(name: "IN_GENRE", direction: OUT)
}

type Genre {
  name: String
  movies: [Movie] @relation(name: "IN_GENRE", direction: IN)
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{
  "queryOptionStyle": "INPUT_TYPE",
  "inputStyle": "INPUT_TYPE",
  "useWhereFilter": true,
  "pluralizeFields": true,
  "useTemporalScalars": true,
  "enableStatistics": true
}
----

== Tests

=== IN

.GraphQL-Query
[source,graphql]
----
{
    movies(where: { id_in: ["123"] }) {
        id
    }
}
----

.Expected Cypher params
[source,json]
----
{
  "whereMoviesIdIn" : [ "123" ]
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (movies:Movie)
WHERE movies.id IN $whereMoviesIdIn
RETURN movies {
	.id
} AS movies
----

=== REGEX

.GraphQL-Query
[source,graphql]
----
{
    movies(where: { id_matches: "(?i)123.*" }) {
        id
    }
}
----

.Expected Cypher params
[source,json]
----
{
  "whereMoviesIdMatches" : "(?i)123.*"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (movies:Movie)
WHERE movies.id =~ $whereMoviesIdMatches
RETURN movies {
	.id
} AS movies
----

=== NOT

.GraphQL-Query
[source,graphql]
----
{
    movies(where: { id_not: "123" }) {
        id
    }
}
----


.Expected Cypher params
[source,json]
----
{
  "whereMoviesIdNot" : "123"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (movies:Movie)
WHERE NOT (movies.id = $whereMoviesIdNot)
RETURN movies {
	.id
} AS movies
----

=== NOT_IN

.GraphQL-Query
[source,graphql]
----
{
    movies(where: { id_not_in: ["123"] }) {
        id
    }
}
----

.Expected Cypher params
[source,json]
----
{
  "whereMoviesIdNotIn" : [ "123" ]
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (movies:Movie)
WHERE NOT (movies.id IN $whereMoviesIdNotIn)
RETURN movies {
	.id
} AS movies
----

=== CONTAINS

.GraphQL-Query
[source,graphql]
----
{
    movies(where: { id_contains: "123" }) {
        id
    }
}
----

.Expected Cypher params
[source,json]
----
{
  "whereMoviesIdContains" : "123"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (movies:Movie)
WHERE movies.id CONTAINS $whereMoviesIdContains
RETURN movies {
	.id
} AS movies
----

=== NOT_CONTAINS

.GraphQL-Query
[source,graphql]
----
{
    movies(where: { id_not_contains: "123" }) {
        id
    }
}
----

.Expected Cypher params
[source,json]
----
{
  "whereMoviesIdNotContains" : "123"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (movies:Movie)
WHERE NOT (movies.id CONTAINS $whereMoviesIdNotContains)
RETURN movies {
	.id
} AS movies
----

=== STARTS_WITH

.GraphQL-Query
[source,graphql]
----
{
    movies(where: { id_starts_with: "123" }) {
        id
    }
}
----

.Expected Cypher params
[source,json]
----
{
  "whereMoviesIdStartsWith" : "123"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (movies:Movie)
WHERE movies.id STARTS WITH $whereMoviesIdStartsWith
RETURN movies {
	.id
} AS movies
----

=== NOT_STARTS_WITH

.GraphQL-Query
[source,graphql]
----
{
    movies(where: { id_not_starts_with: "123" }) {
        id
    }
}
----

.Expected Cypher params
[source,json]
----
{
  "whereMoviesIdNotStartsWith" : "123"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (movies:Movie)
WHERE NOT (movies.id STARTS WITH $whereMoviesIdNotStartsWith)
RETURN movies {
	.id
} AS movies
----

=== ENDS_WITH

.GraphQL-Query
[source,graphql]
----
{
    movies(where: { id_ends_with: "123" }) {
        id
    }
}
----

.Expected Cypher params
[source,json]
----
{
  "whereMoviesIdEndsWith" : "123"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (movies:Movie)
WHERE movies.id ENDS WITH $whereMoviesIdEndsWith
RETURN movies {
	.id
} AS movies
----

=== NOT_ENDS_WITH

.GraphQL-Query
[source,graphql]
----
{
    movies(where: { id_not_ends_with: "123" }) {
        id
    }
}
----

.Expected Cypher params
[source,json]
----
{
  "whereMoviesIdNotEndsWith" : "123"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (movies:Movie)
WHERE NOT (movies.id ENDS WITH $whereMoviesIdNotEndsWith)
RETURN movies {
	.id
} AS movies
----

=== LT

.GraphQL-Query
[source,graphql]
----
{
    movies(where: { actorCount_lt: 123 }) {
        actorCount
    }
}
----

.Expected Cypher params
[source,json]
----
{
  "whereMoviesActorCountLt" : 123
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (movies:Movie)
WHERE movies.actorCount < $whereMoviesActorCountLt
RETURN movies {
	.actorCount
} AS movies
----

=== LT BigInt

CAUTION: *Not yet implemented*

.GraphQL-Query
[source,graphql]
----
{
    movies(where: { budget_lt: 9223372036854775807 }) {
        budget
    }
}
----

.Expected Cypher params
[source,json]
----
{
    "this_budget_LT": {
        "low": -1,
        "high": 2147483647
    }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.budget < $this_budget_LT
RETURN this { .budget } as this
----

=== LTE

.GraphQL-Query
[source,graphql]
----
{
    movies(where: { actorCount_lte: 123 }) {
        actorCount
    }
}
----

.Expected Cypher params
[source,json]
----
{
  "whereMoviesActorCountLte" : 123
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (movies:Movie)
WHERE movies.actorCount <= $whereMoviesActorCountLte
RETURN movies {
	.actorCount
} AS movies
----

=== LTE BigInt

CAUTION: *Not yet implemented*

.GraphQL-Query
[source,graphql]
----
{
    movies(where: { budget_lte: 9223372036854775807 }) {
        budget
    }
}
----

.Expected Cypher params
[source,json]
----
{
    "this_budget_LTE": {
        "low": -1,
        "high": 2147483647
    }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.budget <= $this_budget_LTE
RETURN this { .budget } as this
----

=== GT

.GraphQL-Query
[source,graphql]
----
{
    movies(where: { actorCount_gt: 123 }) {
        actorCount
    }
}
----

.Expected Cypher params
[source,json]
----
{
  "whereMoviesActorCountGt" : 123
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (movies:Movie)
WHERE movies.actorCount > $whereMoviesActorCountGt
RETURN movies {
	.actorCount
} AS movies
----

=== GT BigInt

CAUTION: *Not yet implemented*

.GraphQL-Query
[source,graphql]
----
{
    movies(where: { budget_gt: 9223372036854775000 }) {
        budget
    }
}
----

.Expected Cypher params
[source,json]
----
{
    "this_budget_GT": {
        "low": -808,
        "high": 2147483647
    }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.budget > $this_budget_GT
RETURN this { .budget } as this
----

=== GTE

.GraphQL-Query
[source,graphql]
----
{
    movies(where: { actorCount_gte: 123 }) {
        actorCount
    }
}
----

.Expected Cypher params
[source,json]
----
{
  "whereMoviesActorCountGte" : 123
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (movies:Movie)
WHERE movies.actorCount >= $whereMoviesActorCountGte
RETURN movies {
	.actorCount
} AS movies
----

=== GTE BigInt

CAUTION: *Not yet implemented*

.GraphQL-Query
[source,graphql]
----
{
    movies(where: { budget_gte: 9223372036854775000 }) {
        budget
    }
}
----

.Expected Cypher params
[source,json]
----
{
    "this_budget_GTE": {
        "low": -808,
        "high": 2147483647
    }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.budget >= $this_budget_GTE
RETURN this { .budget } as this
----

=== Relationship equality

.GraphQL-Query
[source,graphql]
----
{
    movies(where: { genres: { name: "some genre" } }) {
        actorCount
    }
}
----

.Expected Cypher params
[source,json]
----
{
  "whereMoviesGenreName" : "some genre"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (movies:Movie)
WHERE all(whereMoviesGenreCond IN [(movies)-[:IN_GENRE]->(whereMoviesGenre:Genre) | whereMoviesGenre.name = $whereMoviesGenreName]
WHERE whereMoviesGenreCond)
RETURN movies {
	.actorCount
} AS movies
----

=== Relationship NOT

.GraphQL-Query
[source,graphql]
----
{
    movies(where: { genres_not: { name: "some genre" } }) {
        actorCount
    }
}
----

.Expected Cypher params
[source,json]
----
{
  "whereMoviesGenreName" : "some genre"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (movies:Movie)
WHERE none(whereMoviesGenreCond IN [(movies)-[:IN_GENRE]->(whereMoviesGenre:Genre) | whereMoviesGenre.name = $whereMoviesGenreName]
WHERE whereMoviesGenreCond)
RETURN movies {
	.actorCount
} AS movies
----
