:toc:

= Cypher Advanced Filtering

== Source schema

[source,graphql,schema=true]
----
type Movie {
  _id: ID
  id: ID
  title: String
  actorCount: Int
  budget: BigInt
  genres: [Genre!]! @relationship(type: "IN_GENRE", direction: OUT)
}

type Genre {
  name: String
  movies: [Movie!]! @relationship(type: "IN_GENRE", direction: IN)
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{
  "features": {
    "filters": {
      "String": {
        "LT": true,
        "GT": true,
        "LTE": true,
        "GTE": true,
        "MATCHES": true
      },
      "ID": {
        "MATCHES": true
      }
    }
  }
}
----
== CONTAINS

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {id_CONTAINS: "123"}) {
    id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "123"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.id CONTAINS $param0
RETURN this {
	.id
} AS this
----

'''

== ENDS_WITH

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {id_ENDS_WITH: "123"}) {
    id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "123"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.id ENDS WITH $param0
RETURN this {
	.id
} AS this
----

'''

== GT

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {actorCount_GT: 123}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : 123
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.actorCount > $param0
RETURN this {
	.actorCount
} AS this
----

'''

== GT BigInt

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {budget_GT: 9223372036854775000}) {
    budget
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : {
    "low" : -808,
    "high" : 2147483647
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.budget > $param0
RETURN this {
	.budget
} AS this
----

'''

== GT String

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {title_GT: "The Matrix Revolutions"}) {
    title
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "The Matrix Revolutions"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.title > $param0
RETURN this {
	.title
} AS this
----

'''

== GTE

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {actorCount_GTE: 123}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : 123
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.actorCount >= $param0
RETURN this {
	.actorCount
} AS this
----

'''

== GTE BigInt

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {budget_GTE: 9223372036854775000}) {
    budget
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : {
    "low" : -808,
    "high" : 2147483647
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.budget >= $param0
RETURN this {
	.budget
} AS this
----

'''

== GTE String

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {title_GTE: "The Matrix Revolutions"}) {
    title
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "The Matrix Revolutions"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.title >= $param0
RETURN this {
	.title
} AS this
----

'''

== IN

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {_id_IN: ["123"]}) {
    _id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : [ "123" ]
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this._id IN $param0
RETURN this {
	._id
} AS this
----

'''

== LT

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {actorCount_LT: 123}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : 123
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.actorCount < $param0
RETURN this {
	.actorCount
} AS this
----

'''

== LT BigInt

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {budget_LT: 9223372036854775807}) {
    budget
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : {
    "low" : -1,
    "high" : 2147483647
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.budget < $param0
RETURN this {
	.budget
} AS this
----

'''

== LT String

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {title_LT: "The Matrix Revolutions"}) {
    title
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "The Matrix Revolutions"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.title < $param0
RETURN this {
	.title
} AS this
----

'''

== LTE

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {actorCount_LTE: 123}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : 123
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.actorCount <= $param0
RETURN this {
	.actorCount
} AS this
----

'''

== LTE BigInt

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {budget_LTE: 9223372036854775807}) {
    budget
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : {
    "low" : -1,
    "high" : 2147483647
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.budget <= $param0
RETURN this {
	.budget
} AS this
----

'''

== LTE String

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {title_LTE: "The Matrix Revolutions"}) {
    title
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "The Matrix Revolutions"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.title <= $param0
RETURN this {
	.title
} AS this
----

'''

== NOT

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {id_NOT: "123"}) {
    id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "123"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE NOT (this.id = $param0)
RETURN this {
	.id
} AS this
----

'''

== NOT_CONTAINS

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {id_NOT_CONTAINS: "123"}) {
    id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "123"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE NOT (this.id CONTAINS $param0)
RETURN this {
	.id
} AS this
----

'''

== NOT_ENDS_WITH

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {id_NOT_ENDS_WITH: "123"}) {
    id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "123"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE NOT (this.id ENDS WITH $param0)
RETURN this {
	.id
} AS this
----

'''

== NOT_IN

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {id_NOT_IN: ["123"]}) {
    id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : [ "123" ]
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE NOT (this.id IN $param0)
RETURN this {
	.id
} AS this
----

'''

== NOT_STARTS_WITH

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {id_NOT_STARTS_WITH: "123"}) {
    id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "123"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE NOT (this.id STARTS WITH $param0)
RETURN this {
	.id
} AS this
----

'''

== REGEX

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {id_MATCHES: "(?i)123.*"}) {
    id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "(?i)123.*"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.id =~ $param0
RETURN this {
	.id
} AS this
----

'''

== STARTS_WITH

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {id_STARTS_WITH: "123"}) {
    id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "123"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.id STARTS WITH $param0
RETURN this {
	.id
} AS this
----

'''

== Connections

=== Node and relationship properties equality

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {genresConnection: {node: {name: "some genre"}}}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "some genre"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE EXISTS {
	MATCH (this)-[this0:IN_GENRE]->(this1:Genre)
	WHERE this1.name = $param0
}
RETURN this {
	.actorCount
} AS this
----

'''

=== Node and relationship properties NOT

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {genresConnection_NOT: {node: {name: "some genre"}}}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "some genre"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE NOT (EXISTS {
	MATCH (this)-[this0:IN_GENRE]->(this1:Genre)
	WHERE this1.name = $param0
})
RETURN this {
	.actorCount
} AS this
----

'''

=== List Predicates

==== ALL

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {genresConnection_ALL: {node: {name: "some genre"}}}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "some genre"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE (EXISTS {
		MATCH (this)-[this0:IN_GENRE]->(this1:Genre)
		WHERE this1.name = $param0
	}
	AND NOT (EXISTS {
		MATCH (this)-[this0:IN_GENRE]->(this1:Genre)
		WHERE NOT (this1.name = $param0)
	}))
RETURN this {
	.actorCount
} AS this
----

'''

==== NONE

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {genresConnection_NONE: {node: {name: "some genre"}}}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "some genre"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE NOT (EXISTS {
	MATCH (this)-[this0:IN_GENRE]->(this1:Genre)
	WHERE this1.name = $param0
})
RETURN this {
	.actorCount
} AS this
----

'''

==== SINGLE

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {genresConnection_SINGLE: {node: {name: "some genre"}}}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "some genre"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE single(this0 IN [(this)-[this1:IN_GENRE]->(this0)
WHERE this0.name = $param0 | 1]
WHERE true)
RETURN this {
	.actorCount
} AS this
----

'''

==== SOME

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {genresConnection_SOME: {node: {name: "some genre"}}}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "some genre"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE EXISTS {
	MATCH (this)-[this0:IN_GENRE]->(this1:Genre)
	WHERE this1.name = $param0
}
RETURN this {
	.actorCount
} AS this
----

'''



== Relationships

=== equality

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {genres: {name: "some genre"}}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "some genre"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE EXISTS {
	MATCH (this)-[:IN_GENRE]->(this0:Genre)
	WHERE this0.name = $param0
}
RETURN this {
	.actorCount
} AS this
----

'''

=== NOT

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {genres_NOT: {name: "some genre"}}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "some genre"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE NOT (EXISTS {
	MATCH (this)-[:IN_GENRE]->(this0:Genre)
	WHERE this0.name = $param0
})
RETURN this {
	.actorCount
} AS this
----

'''

=== List Predicates

==== ALL

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {genres_ALL: {name: "some genre"}}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "some genre"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE (EXISTS {
		MATCH (this)-[:IN_GENRE]->(this0:Genre)
		WHERE this0.name = $param0
	}
	AND NOT (EXISTS {
		MATCH (this)-[:IN_GENRE]->(this0:Genre)
		WHERE NOT (this0.name = $param0)
	}))
RETURN this {
	.actorCount
} AS this
----

'''

==== NONE

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {genres_NONE: {name: "some genre"}}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "some genre"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE NOT (EXISTS {
	MATCH (this)-[:IN_GENRE]->(this0:Genre)
	WHERE this0.name = $param0
})
RETURN this {
	.actorCount
} AS this
----

'''

==== SINGLE

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {genres_SINGLE: {name: "some genre"}}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "some genre"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE single(this0 IN [(this)-[:IN_GENRE]->(this0)
WHERE this0.name = $param0 | 1]
WHERE true)
RETURN this {
	.actorCount
} AS this
----

'''

==== SOME

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {genres_SOME: {name: "some genre"}}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "some genre"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE EXISTS {
	MATCH (this)-[:IN_GENRE]->(this0:Genre)
	WHERE this0.name = $param0
}
RETURN this {
	.actorCount
} AS this
----

'''



