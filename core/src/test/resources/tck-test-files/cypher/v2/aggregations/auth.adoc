:toc:

= Cypher Aggregations with Auth

== Source schema

[source,graphql,schema=true]
----
type User {
  id: ID @authorization(validate: [{operations: [READ], when: [BEFORE], where: {node: {id: "$jwt.sub"}}}])
  name: String! @authorization(validate: [{operations: [READ], when: [BEFORE], where: {node: {id: "$jwt.sub"}}}])
  imdbRatingInt: Int! @authorization(validate: [{operations: [READ], when: [BEFORE], where: {node: {id: "$jwt.sub"}}}])
  imdbRatingFloat: Float! @authorization(validate: [{operations: [READ], when: [BEFORE], where: {node: {id: "$jwt.sub"}}}])
  imdbRatingBigInt: BigInt! @authorization(validate: [{operations: [READ], when: [BEFORE], where: {node: {id: "$jwt.sub"}}}])
  createdAt: DateTime @authorization(validate: [{operations: [READ], when: [BEFORE], where: {node: {id: "$jwt.sub"}}}])
}

extend type User @authorization(validate: [{operations: [AGGREGATE], when: [BEFORE], where: {node: {id: "$jwt.sub"}}}], filter: [{operations: [AGGREGATE], where: {node: {id: "$jwt.sub"}}}])
----
== Count with WHERE

.GraphQL-Query
[source,graphql]
----
{
  usersAggregate(where: {name: "some-name"}) {
    count
  }
}
----

.Query Context
[source,json,query-config=true]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [],
    "jwt": {
      "roles": [],
      "sub": "super_admin"
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": "some-name",
  "isAuthenticated": true,
  "jwt": {
    "roles": [],
    "sub": "super_admin"
  }
}
----

.Expected Cypher output
[source,cypher]
----
CALL {
    MATCH (this:User)
    WHERE (this.name = $param0 AND ($isAuthenticated = true AND ($jwt.sub IS NOT NULL AND this.id = $jwt.sub)) AND apoc.util.validatePredicate(NOT ($isAuthenticated = true AND ($jwt.sub IS NOT NULL AND this.id = $jwt.sub)), "@neo4j/graphql/FORBIDDEN", [0]))
    RETURN count(this) AS var0
}
RETURN { count: var0 }
----

'''

== Field BigInt with auth

.GraphQL-Query
[source,graphql]
----
{
  usersAggregate {
    imdbRatingBigInt {
      min
      max
    }
  }
}
----

.Query Context
[source,json,query-config=true]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [],
    "jwt": {
      "roles": [],
      "sub": "super_admin"
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "isAuthenticated": true,
  "jwt": {
    "roles": [],
    "sub": "super_admin"
  }
}
----

.Expected Cypher output
[source,cypher]
----
CALL {
    MATCH (this:User)
    WHERE (($isAuthenticated = true AND ($jwt.sub IS NOT NULL AND this.id = $jwt.sub)) AND apoc.util.validatePredicate(NOT ($isAuthenticated = true AND ($jwt.sub IS NOT NULL AND this.id = $jwt.sub)), "@neo4j/graphql/FORBIDDEN", [0]))
    RETURN { min: min(this.imdbRatingBigInt), max: max(this.imdbRatingBigInt) } AS var0
}
RETURN { imdbRatingBigInt: var0 }
----

'''

== Field DateTime with auth

.GraphQL-Query
[source,graphql]
----
{
  usersAggregate {
    createdAt {
      min
      max
    }
  }
}
----

.Query Context
[source,json,query-config=true]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [],
    "jwt": {
      "roles": [],
      "sub": "super_admin"
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "isAuthenticated": true,
  "jwt": {
    "roles": [],
    "sub": "super_admin"
  }
}
----

.Expected Cypher output
[source,cypher]
----
CALL {
    MATCH (this:User)
    WHERE (($isAuthenticated = true AND ($jwt.sub IS NOT NULL AND this.id = $jwt.sub)) AND apoc.util.validatePredicate(NOT ($isAuthenticated = true AND ($jwt.sub IS NOT NULL AND this.id = $jwt.sub)), "@neo4j/graphql/FORBIDDEN", [0]))
    RETURN { min: apoc.date.convertFormat(toString(min(this.createdAt)), "iso_zoned_date_time", "iso_offset_date_time"), max: apoc.date.convertFormat(toString(max(this.createdAt)), "iso_zoned_date_time", "iso_offset_date_time") } AS var0
}
RETURN { createdAt: var0 }
----

'''

== Field Float with auth

.GraphQL-Query
[source,graphql]
----
{
  usersAggregate {
    imdbRatingFloat {
      min
      max
    }
  }
}
----

.Query Context
[source,json,query-config=true]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [],
    "jwt": {
      "roles": [],
      "sub": "super_admin"
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "isAuthenticated": true,
  "jwt": {
    "roles": [],
    "sub": "super_admin"
  }
}
----

.Expected Cypher output
[source,cypher]
----
CALL {
    MATCH (this:User)
    WHERE (($isAuthenticated = true AND ($jwt.sub IS NOT NULL AND this.id = $jwt.sub)) AND apoc.util.validatePredicate(NOT ($isAuthenticated = true AND ($jwt.sub IS NOT NULL AND this.id = $jwt.sub)), "@neo4j/graphql/FORBIDDEN", [0]))
    RETURN { min: min(this.imdbRatingFloat), max: max(this.imdbRatingFloat) } AS var0
}
RETURN { imdbRatingFloat: var0 }
----

'''

== Field ID with auth

.GraphQL-Query
[source,graphql]
----
{
  usersAggregate {
    id {
      shortest
      longest
    }
  }
}
----

.Query Context
[source,json,query-config=true]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [],
    "jwt": {
      "roles": [],
      "sub": "super_admin"
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "isAuthenticated": true,
  "jwt": {
    "roles": [],
    "sub": "super_admin"
  }
}
----

.Expected Cypher output
[source,cypher]
----
CALL {
    MATCH (this:User)
    WHERE (($isAuthenticated = true AND ($jwt.sub IS NOT NULL AND this.id = $jwt.sub)) AND apoc.util.validatePredicate(NOT ($isAuthenticated = true AND ($jwt.sub IS NOT NULL AND this.id = $jwt.sub)), "@neo4j/graphql/FORBIDDEN", [0]))
    RETURN { shortest: min(this.id), longest: max(this.id) } AS var0
}
RETURN { id: var0 }
----

'''

== Field Int with auth

.GraphQL-Query
[source,graphql]
----
{
  usersAggregate {
    imdbRatingInt {
      min
      max
    }
  }
}
----

.Query Context
[source,json,query-config=true]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [],
    "jwt": {
      "roles": [],
      "sub": "super_admin"
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "isAuthenticated": true,
  "jwt": {
    "roles": [],
    "sub": "super_admin"
  }
}
----

.Expected Cypher output
[source,cypher]
----
CALL {
    MATCH (this:User)
    WHERE (($isAuthenticated = true AND ($jwt.sub IS NOT NULL AND this.id = $jwt.sub)) AND apoc.util.validatePredicate(NOT ($isAuthenticated = true AND ($jwt.sub IS NOT NULL AND this.id = $jwt.sub)), "@neo4j/graphql/FORBIDDEN", [0]))
    RETURN { min: min(this.imdbRatingInt), max: max(this.imdbRatingInt) } AS var0
}
RETURN { imdbRatingInt: var0 }
----

'''

== Field String with auth

.GraphQL-Query
[source,graphql]
----
{
  usersAggregate {
    name {
      shortest
      longest
    }
  }
}
----

.Query Context
[source,json,query-config=true]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [],
    "jwt": {
      "roles": [],
      "sub": "super_admin"
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "isAuthenticated": true,
  "jwt": {
    "roles": [],
    "sub": "super_admin"
  }
}
----

.Expected Cypher output
[source,cypher]
----
CALL {
    MATCH (this:User)
    WHERE (($isAuthenticated = true AND ($jwt.sub IS NOT NULL AND this.id = $jwt.sub)) AND apoc.util.validatePredicate(NOT ($isAuthenticated = true AND ($jwt.sub IS NOT NULL AND this.id = $jwt.sub)), "@neo4j/graphql/FORBIDDEN", [0]))
    WITH this
    ORDER BY size(this.name) DESC
    WITH collect(this.name) AS list
    RETURN { longest: head(list), shortest: last(list) } AS var0
}
RETURN { name: var0 }
----

'''

== Simple Count

.GraphQL-Query
[source,graphql]
----
{
  usersAggregate {
    count
  }
}
----

.Query Context
[source,json,query-config=true]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [],
    "jwt": {
      "roles": [],
      "sub": "super_admin"
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "isAuthenticated": true,
  "jwt": {
    "roles": [],
    "sub": "super_admin"
  }
}
----

.Expected Cypher output
[source,cypher]
----
CALL {
    MATCH (this:User)
    WHERE (($isAuthenticated = true AND ($jwt.sub IS NOT NULL AND this.id = $jwt.sub)) AND apoc.util.validatePredicate(NOT ($isAuthenticated = true AND ($jwt.sub IS NOT NULL AND this.id = $jwt.sub)), "@neo4j/graphql/FORBIDDEN", [0]))
    RETURN count(this) AS var0
}
RETURN { count: var0 }
----

'''

