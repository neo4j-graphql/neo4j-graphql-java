:toc:

= Field Level Aggregations

== Source schema

[source,graphql,schema=true]
----
type Movie @auth(rules: [{isAuthenticated: true}]) {
  title: String
  actors: [Actor!]! @relationship(type: "ACTED_IN", direction: IN)
}

type Actor {
  name: String
  age: Int
  movies: [Movie!]! @relationship(type: "ACTED_IN", direction: OUT)
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{
  "enableRegex": true
}
----
== Count aggregation with auth in aggregated node

.GraphQL-Query
[source,graphql]
----
{
  actors {
    name
    moviesAggregate {
      count
    }
  }
}
----

.Query Context
[source,json,query-config=true]
----
{
  "contextParams": {
    "jwt": {
      "sub": "super_admin"
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [],
    "jwt": {
      "roles": [],
      "sub": "super_admin"
    }
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
CALL {
	WITH this
	MATCH (this)-[this_moviesAggregate_this0:ACTED_IN]->(this_moviesAggregate_this1:Movie)
	WHERE apoc.util.validatePredicate(NOT (apoc.util.validatePredicate(NOT ($auth.isAuthenticated = true), '@neo4j/graphql/UNAUTHENTICATED', [0])), '@neo4j/graphql/FORBIDDEN', [0])
	RETURN count(this_moviesAggregate_this1) AS this_moviesAggregate_var2
}
RETURN this {
	.name,
	moviesAggregate: {
		count: this_moviesAggregate_var2
	}
} AS this
----

'''

== Count aggregation with parent node auth

.GraphQL-Query
[source,graphql]
----
{
  movies {
    title
    actorsAggregate {
      count
    }
  }
}
----

.Query Context
[source,json,query-config=true]
----
{
  "contextParams": {
    "jwt": {
      "sub": "super_admin"
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [],
    "jwt": {
      "roles": [],
      "sub": "super_admin"
    }
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE apoc.util.validatePredicate(NOT (apoc.util.validatePredicate(NOT ($auth.isAuthenticated = true), '@neo4j/graphql/UNAUTHENTICATED', [0])), '@neo4j/graphql/FORBIDDEN', [0])
CALL {
	WITH this
	MATCH (this_actorsAggregate_this1:Actor)-[this_actorsAggregate_this0:ACTED_IN]->(this)
	RETURN count(this_actorsAggregate_this1) AS this_actorsAggregate_var2
}
RETURN this {
	.title,
	actorsAggregate: {
		count: this_actorsAggregate_var2
	}
} AS this
----

'''

