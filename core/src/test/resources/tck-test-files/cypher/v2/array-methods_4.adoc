:toc:

= Arrays Methods

== Source schema

[source,graphql,schema=true]
----
type JWT @jwt {
  roles: [String!]!
}

type Movie {
  title: String!
  ratings: [Float!]! @authorization(validate: [{operations: [UPDATE], where: {jwt: {roles_INCLUDES: "update"}}}])
}
----
== pop auth

.GraphQL-Query
[source,graphql]
----
mutation {
  updateMovies(update: {ratings_POP: 1}) {
    movies {
      title
      ratings
    }
  }
}
----

.Query Context
[source,json,query-config=true]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [],
    "jwt": {
      "roles": []
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "isAuthenticated": true,
  "jwt": {
    "roles": []
  },
  "authorization__before_param2": "update",
  "authorization__after_param2": "update",
  "this_update_ratings_POP": 1
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WITH this
WHERE apoc.util.validatePredicate(NOT ($isAuthenticated = true AND ($jwt.roles IS NOT NULL AND $authorization__before_param2 IN $jwt.roles)), "@neo4j/graphql/FORBIDDEN", [0]) AND apoc.util.validatePredicate(this.ratings IS NULL, "Property %s cannot be NULL", ['ratings'])

SET this.ratings = this.ratings[0..-$this_update_ratings_POP]
WITH this
WHERE apoc.util.validatePredicate(NOT ($isAuthenticated = true AND ($jwt.roles IS NOT NULL AND $authorization__after_param2 IN $jwt.roles)), "@neo4j/graphql/FORBIDDEN", [0])
RETURN collect(DISTINCT this { .title, .ratings }) AS data
----

'''

== push auth

.GraphQL-Query
[source,graphql]
----
mutation {
  updateMovies(update: {ratings_PUSH: 1.0}) {
    movies {
      title
      ratings
    }
  }
}
----

.Query Context
[source,json,query-config=true]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [],
    "jwt": {
      "roles": []
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "isAuthenticated": true,
  "jwt": {
    "roles": []
  },
  "authorization__before_param2": "update",
  "authorization__after_param2": "update",
  "this_update_ratings_PUSH": [
    1
  ]
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WITH this
WHERE apoc.util.validatePredicate(NOT ($isAuthenticated = true AND ($jwt.roles IS NOT NULL AND $authorization__before_param2 IN $jwt.roles)), "@neo4j/graphql/FORBIDDEN", [0]) AND apoc.util.validatePredicate(this.ratings IS NULL, "Property %s cannot be NULL", ['ratings'])

SET this.ratings = this.ratings + $this_update_ratings_PUSH
WITH this
WHERE apoc.util.validatePredicate(NOT ($isAuthenticated = true AND ($jwt.roles IS NOT NULL AND $authorization__after_param2 IN $jwt.roles)), "@neo4j/graphql/FORBIDDEN", [0])
RETURN collect(DISTINCT this { .title, .ratings }) AS data
----

'''

