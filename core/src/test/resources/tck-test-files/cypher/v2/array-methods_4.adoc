:toc:

= Arrays Methods

== Source schema

[source,graphql,schema=true]
----
type Movie {
  title: String!
  ratings: [Float!]! @auth(rules: [{operations: [UPDATE], isAuthenticated: true}])
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{
  "enableRegex": true
}
----
== pop auth

.GraphQL-Query
[source,graphql]
----
mutation {
  updateMovies(update: {ratings_POP: 1}) {
    movies {
      title
      ratings
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_update_ratings_POP": {
    "low": 1,
    "high": 0
  },
  "resolvedCallbacks": {},
  "auth": {
    "isAuthenticated": true,
    "roles": [],
    "jwt": {
      "roles": []
    }
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:`Movie`)
WITH this
CALL apoc.util.validate(NOT (apoc.util.validatePredicate(NOT ($auth.isAuthenticated = true), "@neo4j/graphql/UNAUTHENTICATED", [0])), "@neo4j/graphql/FORBIDDEN", [0])
CALL apoc.util.validate(this.ratings IS NULL, "Property %s cannot be NULL", ['ratings'])
SET this.ratings = this.ratings[0..-$this_update_ratings_POP]

RETURN collect(DISTINCT this { .title, .ratings }) AS data
----

'''

== push auth

.GraphQL-Query
[source,graphql]
----
mutation {
  updateMovies(update: {ratings_PUSH: 1.0}) {
    movies {
      title
      ratings
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_update_ratings_PUSH": [
    1
  ],
  "resolvedCallbacks": {},
  "auth": {
    "isAuthenticated": true,
    "roles": [],
    "jwt": {
      "roles": []
    }
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:`Movie`)
WITH this
CALL apoc.util.validate(NOT (apoc.util.validatePredicate(NOT ($auth.isAuthenticated = true), "@neo4j/graphql/UNAUTHENTICATED", [0])), "@neo4j/graphql/FORBIDDEN", [0])
CALL apoc.util.validate(this.ratings IS NULL, "Property %s cannot be NULL", ['ratings'])
SET this.ratings = this.ratings + $this_update_ratings_PUSH

RETURN collect(DISTINCT this { .title, .ratings }) AS data
----

'''

