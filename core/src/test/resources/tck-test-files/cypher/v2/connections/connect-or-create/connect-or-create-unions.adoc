:toc:

= Create or connect with unions

== Source schema

[source,graphql,schema=true]
----
type Movie {
  title: String!
  isan: String! @unique
}

type Series {
  title: String!
  isan: String! @unique
}

union Production = Movie | Series

interface ActedIn @relationshipProperties {
  screentime: Int!
}

type Actor {
  name: String!
  actedIn: [Production!]! @relationship(type: "ACTED_IN", direction: OUT, properties: "ActedIn")
}
----
== Create with createOrConnect operation

.GraphQL-Query
[source,graphql]
----
mutation {
  createActors(
    input: [{name: "Tom Hanks", actedIn: {Movie: {connectOrCreate: {where: {node: {isan: "0000-0000-03B6-0000-O-0000-0006-P"}}, onCreate: {edge: {screentime: 105}, node: {title: "Forrest Gump", isan: "0000-0000-03B6-0000-O-0000-0006-P"}}}}, Series: {connectOrCreate: {where: {node: {isan: "0000-0001-ECC5-0000-8-0000-0001-B"}}, onCreate: {edge: {screentime: 126}, node: {title: "Band of Brothers", isan: "0000-0001-ECC5-0000-8-0000-0001-B"}}}}}}]
  ) {
    actors {
      name
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this0_name": "Tom Hanks",
  "this0_actedIn_Movie_connectOrCreate_param0": "0000-0000-03B6-0000-O-0000-0006-P",
  "this0_actedIn_Movie_connectOrCreate_param1": "Forrest Gump",
  "this0_actedIn_Movie_connectOrCreate_param2": "0000-0000-03B6-0000-O-0000-0006-P",
  "this0_actedIn_Movie_connectOrCreate_param3": 105,
  "this0_actedIn_Series_connectOrCreate_param0": "0000-0001-ECC5-0000-8-0000-0001-B",
  "this0_actedIn_Series_connectOrCreate_param1": "Band of Brothers",
  "this0_actedIn_Series_connectOrCreate_param2": "0000-0001-ECC5-0000-8-0000-0001-B",
  "this0_actedIn_Series_connectOrCreate_param3": 126
}
----

.Expected Cypher output
[source,cypher]
----
CALL {
CREATE (this0:Actor)
SET this0.name = $this0_name
WITH this0
CALL {
    WITH this0
    MERGE (this0_actedIn_Movie_connectOrCreate0:Movie { isan: $this0_actedIn_Movie_connectOrCreate_param0 })
    ON CREATE SET
        this0_actedIn_Movie_connectOrCreate0.title = $this0_actedIn_Movie_connectOrCreate_param1,
        this0_actedIn_Movie_connectOrCreate0.isan = $this0_actedIn_Movie_connectOrCreate_param2
    MERGE (this0)-[this0_actedIn_Movie_connectOrCreate_this0:ACTED_IN]->(this0_actedIn_Movie_connectOrCreate0)
    ON CREATE SET
        this0_actedIn_Movie_connectOrCreate_this0.screentime = $this0_actedIn_Movie_connectOrCreate_param3
    RETURN count(*) AS _
}
WITH this0
CALL {
    WITH this0
    MERGE (this0_actedIn_Series_connectOrCreate0:Series { isan: $this0_actedIn_Series_connectOrCreate_param0 })
    ON CREATE SET
        this0_actedIn_Series_connectOrCreate0.title = $this0_actedIn_Series_connectOrCreate_param1,
        this0_actedIn_Series_connectOrCreate0.isan = $this0_actedIn_Series_connectOrCreate_param2
    MERGE (this0)-[this0_actedIn_Series_connectOrCreate_this0:ACTED_IN]->(this0_actedIn_Series_connectOrCreate0)
    ON CREATE SET
        this0_actedIn_Series_connectOrCreate_this0.screentime = $this0_actedIn_Series_connectOrCreate_param3
    RETURN count(*) AS _
}
RETURN this0
}
CALL {
    WITH this0
    RETURN this0 { .name } AS create_var0
}
RETURN [create_var0] AS data
----

'''

== Update with createOrConnect operation

.GraphQL-Query
[source,graphql]
----
mutation {
  updateActors(
    update: {name: "Tom Hanks", actedIn: {Movie: {connectOrCreate: {where: {node: {isan: "0000-0000-03B6-0000-O-0000-0006-P"}}, onCreate: {edge: {screentime: 105}, node: {title: "Forrest Gump", isan: "0000-0000-03B6-0000-O-0000-0006-P"}}}}, Series: {connectOrCreate: {where: {node: {isan: "0000-0001-ECC5-0000-8-0000-0001-B"}}, onCreate: {edge: {screentime: 126}, node: {title: "Band of Brothers", isan: "0000-0001-ECC5-0000-8-0000-0001-B"}}}}}}
    where: {name: "Tom Hanks evil twin"}
  ) {
    actors {
      name
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": "Tom Hanks evil twin",
  "this_update_name": "Tom Hanks",
  "this_actedIn_Movie0_connectOrCreate_param0": "0000-0000-03B6-0000-O-0000-0006-P",
  "this_actedIn_Movie0_connectOrCreate_param1": "Forrest Gump",
  "this_actedIn_Movie0_connectOrCreate_param2": "0000-0000-03B6-0000-O-0000-0006-P",
  "this_actedIn_Movie0_connectOrCreate_param3": 105,
  "this_actedIn_Series0_connectOrCreate_param0": "0000-0001-ECC5-0000-8-0000-0001-B",
  "this_actedIn_Series0_connectOrCreate_param1": "Band of Brothers",
  "this_actedIn_Series0_connectOrCreate_param2": "0000-0001-ECC5-0000-8-0000-0001-B",
  "this_actedIn_Series0_connectOrCreate_param3": 126
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WHERE this.name = $param0


SET this.name = $this_update_name
WITH this
CALL {
    WITH this
    MERGE (this_actedIn_Movie0_connectOrCreate0:Movie { isan: $this_actedIn_Movie0_connectOrCreate_param0 })
    ON CREATE SET
        this_actedIn_Movie0_connectOrCreate0.title = $this_actedIn_Movie0_connectOrCreate_param1,
        this_actedIn_Movie0_connectOrCreate0.isan = $this_actedIn_Movie0_connectOrCreate_param2
    MERGE (this)-[this_actedIn_Movie0_connectOrCreate_this0:ACTED_IN]->(this_actedIn_Movie0_connectOrCreate0)
    ON CREATE SET
        this_actedIn_Movie0_connectOrCreate_this0.screentime = $this_actedIn_Movie0_connectOrCreate_param3
    RETURN count(*) AS _
}
WITH this
CALL {
    WITH this
    MERGE (this_actedIn_Series0_connectOrCreate0:Series { isan: $this_actedIn_Series0_connectOrCreate_param0 })
    ON CREATE SET
        this_actedIn_Series0_connectOrCreate0.title = $this_actedIn_Series0_connectOrCreate_param1,
        this_actedIn_Series0_connectOrCreate0.isan = $this_actedIn_Series0_connectOrCreate_param2
    MERGE (this)-[this_actedIn_Series0_connectOrCreate_this0:ACTED_IN]->(this_actedIn_Series0_connectOrCreate0)
    ON CREATE SET
        this_actedIn_Series0_connectOrCreate_this0.screentime = $this_actedIn_Series0_connectOrCreate_param3
    RETURN count(*) AS _
}

RETURN collect(DISTINCT this { .name }) AS data
----

'''

