:toc:

= Relationship Properties Create Cypher

== Source schema

[source,graphql,schema=true]
----
type Movie {
  title: String!
  actors: [Actor!]! @relationship(type: "ACTED_IN", properties: "ActedIn", direction: IN)
}

type Actor {
  name: String!
  movies: [Movie!]! @relationship(type: "ACTED_IN", properties: "ActedIn", direction: OUT)
}

type ActedIn @relationshipProperties {
  screenTime: Int!
}
----
== Create movie with a relationship that has properties

.GraphQL-Query
[source,graphql]
----
mutation {
  createMovies(
    input: [{title: "Forrest Gump", actors: {create: [{node: {name: "Tom Hanks"}, edge: {screenTime: 60}}]}}]
  ) {
    movies {
      title
      actorsConnection {
        edges {
          properties {
            screenTime
          }
          node {
            name
          }
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "create_param0": [
    {
      "title": "Forrest Gump",
      "actors": {
        "create": [
          {
            "edge": {
              "screenTime": 60
            },
            "node": {
              "name": "Tom Hanks"
            }
          }
        ]
      }
    }
  ]
}
----

.Expected Cypher output
[source,cypher]
----
UNWIND $create_param0 AS create_var0
CALL {
    WITH create_var0
    CREATE (create_this1:Movie)
    SET
        create_this1.title = create_var0.title
    WITH create_this1, create_var0
    CALL {
        WITH create_this1, create_var0
        UNWIND create_var0.actors.create AS create_var2
        WITH create_var2.node AS create_var3, create_var2.edge AS create_var4, create_this1
        CREATE (create_this5:Actor)
        SET
            create_this5.name = create_var3.name
        MERGE (create_this1)<-[create_this6:ACTED_IN]-(create_this5)
        SET
            create_this6.screenTime = create_var4.screenTime
        
        RETURN collect(NULL) AS create_var7
    }
    
    RETURN create_this1
}
CALL {
    WITH create_this1
    MATCH (create_this1)<-[create_this8:ACTED_IN]-(create_this9:Actor)
    WITH collect({ node: create_this9, relationship: create_this8 }) AS edges
    WITH edges, size(edges) AS totalCount
    CALL {
        WITH edges
        UNWIND edges AS edge
        WITH edge.node AS create_this9, edge.relationship AS create_this8
        RETURN collect({ properties: { screenTime: create_this8.screenTime, __resolveType: "ActedIn" }, node: { name: create_this9.name, __resolveType: "Actor" } }) AS create_var10
    }
    RETURN { edges: create_var10, totalCount: totalCount } AS create_var11
}
RETURN collect(create_this1 { .title, actorsConnection: create_var11 }) AS data
----

'''

