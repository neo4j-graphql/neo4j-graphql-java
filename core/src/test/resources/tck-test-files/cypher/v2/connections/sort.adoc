:toc:

= Relationship Properties Cypher

== Source schema

[source,graphql,schema=true]
----
type Movie {
  title: String!
  actors: [Actor!]! @relationship(type: "ACTED_IN", properties: "ActedIn", direction: IN)
  numberOfActors: Int! @cypher(statement: "MATCH (actor:Actor)-[:ACTED_IN]->(this) RETURN count(actor) as count", columnName: "count")
}

type Actor {
  name: String!
  movies: [Movie!]! @relationship(type: "ACTED_IN", properties: "ActedIn", direction: OUT)
}

interface ActedIn @relationshipProperties {
  screenTime: Int!
  year: Int!
}
----
== Projecting node and relationship properties with no arguments

.GraphQL-Query
[source,graphql]
----
{
  moviesConnection(first: 5, sort: {title: ASC}) {
    edges {
      node {
        title
        actorsConnection {
          edges {
            node {
              name
            }
          }
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": 5
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this0:Movie)
WITH collect({ node: this0 }) AS edges
WITH edges, size(edges) AS totalCount
CALL {
    WITH edges
    UNWIND edges AS edge
    WITH edge.node AS this0
    WITH *
    ORDER BY this0.title ASC
    LIMIT $param0
    CALL {
        WITH this0
        MATCH (this0)<-[this1:ACTED_IN]-(this2:Actor)
        WITH collect({ node: this2, relationship: this1 }) AS edges
        WITH edges, size(edges) AS totalCount
        CALL {
            WITH edges
            UNWIND edges AS edge
            WITH edge.node AS this2, edge.relationship AS this1
            RETURN collect({ node: { name: this2.name } }) AS var3
        }
        RETURN { edges: var3, totalCount: totalCount } AS var4
    }
    RETURN collect({ node: { title: this0.title, actorsConnection: var4 } }) AS var5
}
RETURN { edges: var5, totalCount: totalCount } AS this
----

'''

== Sort by cypher fields

.GraphQL-Query
[source,graphql]
----
{
  moviesConnection(first: 2, sort: {title: DESC, numberOfActors: ASC}) {
    edges {
      node {
        title
        actorsConnection {
          edges {
            node {
              name
            }
          }
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": 2
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this0:Movie)
WITH collect({ node: this0 }) AS edges
WITH edges, size(edges) AS totalCount
CALL {
    WITH edges
    UNWIND edges AS edge
    WITH edge.node AS this0
    CALL {
        WITH this0
        CALL {
            WITH this0
            WITH this0 AS this
            MATCH (actor:Actor)-[:ACTED_IN]->(this) RETURN count(actor) as count
        }
        UNWIND count AS this1
        RETURN head(collect(this1)) AS this1
    }
    WITH *
    ORDER BY this0.title DESC, this1 ASC
    LIMIT $param0
    CALL {
        WITH this0
        MATCH (this0)<-[this2:ACTED_IN]-(this3:Actor)
        WITH collect({ node: this3, relationship: this2 }) AS edges
        WITH edges, size(edges) AS totalCount
        CALL {
            WITH edges
            UNWIND edges AS edge
            WITH edge.node AS this3, edge.relationship AS this2
            RETURN collect({ node: { name: this3.name } }) AS var4
        }
        RETURN { edges: var4, totalCount: totalCount } AS var5
    }
    RETURN collect({ node: { title: this0.title, actorsConnection: var5 } }) AS var6
}
RETURN { edges: var6, totalCount: totalCount } AS this
----

'''

