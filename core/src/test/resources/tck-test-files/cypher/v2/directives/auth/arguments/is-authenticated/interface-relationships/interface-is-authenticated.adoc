:toc:

= Cypher Auth isAuthenticated

== Source schema

[source,graphql,schema=true]
----
type History {
  url: String @auth(rules: [{operations: [READ], isAuthenticated: true}])
}

interface Content @auth(rules: [{operations: [READ, CREATE, UPDATE, CONNECT, DISCONNECT, DELETE], isAuthenticated: true}]) {
  id: String
  content: String
}

type Comment implements Content {
  id: String
  content: String
}

type Post implements Content {
  id: String
  content: String
}

type User {
  id: ID
  name: String
  password: String @auth(rules: [{operations: [READ, CREATE, UPDATE], isAuthenticated: true}])
  content: [Content!]! @relationship(type: "HAS_CONTENT", direction: OUT)
}

extend type User @auth(rules: [{operations: [READ, CREATE, UPDATE, CONNECT, DISCONNECT, DELETE], isAuthenticated: true}])

extend type User {
  password: String @auth(rules: [{operations: [READ, CREATE, UPDATE], isAuthenticated: true}])
}

extend type User {
  history: [History] @cypher(statement: "MATCH (this)-[:HAS_HISTORY]->(h:History) RETURN h") @auth(rules: [{operations: [READ], isAuthenticated: true}])
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{
  "enableRegex": true
}
----
== Connect

.GraphQL-Query
[source,graphql]
----
mutation {
  updateUsers(connect: {content: {}}) {
    users {
      id
    }
  }
}
----

.Query Context
[source,json,query-config=true]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [
      "admin"
    ]
  },
  "contextParams": {
    "jwt": {
      "roles": [
        "admin"
      ],
      "sub": "super_admin"
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "auth" : {
    "isAuthenticated" : true,
    "roles" : [ "admin" ],
    "jwt" : {
      "roles" : [ "admin" ],
      "sub" : "super_admin"
    }
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:User)
WITH this
CALL {
	WITH this
	OPTIONAL MATCH (this_connect_content0_node:Comment)
	WITH this, this_connect_content0_node CALL apoc.util.validate(NOT ((apoc.util.validatePredicate(NOT ($auth.isAuthenticated = true), '@neo4j/graphql/UNAUTHENTICATED', [0])
		AND apoc.util.validatePredicate(NOT ($auth.isAuthenticated = true), '@neo4j/graphql/UNAUTHENTICATED', [0]))), '@neo4j/graphql/FORBIDDEN', [0])
	CALL {
		WITH *
		WITH collect(this_connect_content0_node) AS connectedNodes, collect(this) AS parentNodes
		CALL {
			WITH connectedNodes, parentNodes
			UNWIND parentNodes AS this
			UNWIND connectedNodes AS this_connect_content0_node
			MERGE (this)-[:HAS_CONTENT]->(this_connect_content0_node)
			RETURN count(*) AS _
		}
		RETURN count(*) AS _
	}
	WITH this, this_connect_content0_node
	RETURN count(*) AS connect_this_connect_content_Comment
}
CALL {
	WITH this
	OPTIONAL MATCH (this_connect_content1_node:Post)
	WITH this, this_connect_content1_node CALL apoc.util.validate(NOT ((apoc.util.validatePredicate(NOT ($auth.isAuthenticated = true), '@neo4j/graphql/UNAUTHENTICATED', [0])
		AND apoc.util.validatePredicate(NOT ($auth.isAuthenticated = true), '@neo4j/graphql/UNAUTHENTICATED', [0]))), '@neo4j/graphql/FORBIDDEN', [0])
	CALL {
		WITH *
		WITH collect(this_connect_content1_node) AS connectedNodes, collect(this) AS parentNodes
		CALL {
			WITH connectedNodes, parentNodes
			UNWIND parentNodes AS this
			UNWIND connectedNodes AS this_connect_content1_node
			MERGE (this)-[:HAS_CONTENT]->(this_connect_content1_node)
			RETURN count(*) AS _
		}
		RETURN count(*) AS _
	}
	WITH this, this_connect_content1_node
	RETURN count(*) AS connect_this_connect_content_Post
}
WITH *
RETURN collect(DISTINCT this {
	.id
}) AS data
----

'''

== Create Node

.GraphQL-Query
[source,graphql]
----
mutation {
  createPosts(input: [{id: "1", content: "content"}]) {
    posts {
      id
    }
  }
}
----

.Query Context
[source,json,query-config=true]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [
      "admin"
    ]
  },
  "contextParams": {
    "jwt": {
      "roles": [
        "admin"
      ],
      "sub": "super_admin"
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "auth" : {
    "isAuthenticated" : true,
    "roles" : [ "admin" ],
    "jwt" : {
      "roles" : [ "admin" ],
      "sub" : "super_admin"
    }
  },
  "create_param0" : [ {
    "id" : "1",
    "content" : "content"
  } ]
}
----

.Expected Cypher output
[source,cypher]
----
UNWIND $create_param0 AS create_var1
CALL {
	WITH create_var1
	CREATE (create_this0:Post)
	SET create_this0.id = create_var1.id, create_this0.content = create_var1.content
	WITH * CALL apoc.util.validate(NOT (apoc.util.validatePredicate(NOT ($auth.isAuthenticated = true), '@neo4j/graphql/UNAUTHENTICATED', [0])), '@neo4j/graphql/FORBIDDEN', [0])
	RETURN create_this0
}
RETURN collect(create_this0 {
	.id
}) AS data
----

'''

== Delete

.GraphQL-Query
[source,graphql]
----
mutation {
  deletePosts {
    nodesDeleted
  }
}
----

.Query Context
[source,json,query-config=true]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [
      "admin"
    ]
  },
  "contextParams": {
    "jwt": {
      "roles": [
        "admin"
      ],
      "sub": "super_admin"
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "auth" : {
    "isAuthenticated" : true,
    "roles" : [ "admin" ],
    "jwt" : {
      "roles" : [ "admin" ],
      "sub" : "super_admin"
    }
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Post)
WITH this CALL apoc.util.validate(NOT (apoc.util.validatePredicate(NOT ($auth.isAuthenticated = true), '@neo4j/graphql/UNAUTHENTICATED', [0])), '@neo4j/graphql/FORBIDDEN', [0]) DETACH DELETE this
----

'''

== Disconnect

.GraphQL-Query
[source,graphql]
----
mutation {
  updateUsers(disconnect: {content: {}}) {
    users {
      id
    }
  }
}
----

.Query Context
[source,json,query-config=true]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [
      "admin"
    ]
  },
  "contextParams": {
    "jwt": {
      "roles": [
        "admin"
      ],
      "sub": "super_admin"
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "auth" : {
    "isAuthenticated" : true,
    "roles" : [ "admin" ],
    "jwt" : {
      "roles" : [ "admin" ],
      "sub" : "super_admin"
    }
  },
  "updateUsers" : {
    "args" : {
      "disconnect" : {
        "content" : [ { } ]
      }
    }
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:User)
WITH this
CALL {
	WITH this
	OPTIONAL MATCH (this)-[this_disconnect_content0_rel:HAS_CONTENT]->(this_disconnect_content0:Comment)
	WITH this, this_disconnect_content0, this_disconnect_content0_rel CALL apoc.util.validate(NOT ((apoc.util.validatePredicate(NOT ($auth.isAuthenticated = true), '@neo4j/graphql/UNAUTHENTICATED', [0])
		AND apoc.util.validatePredicate(NOT ($auth.isAuthenticated = true), '@neo4j/graphql/UNAUTHENTICATED', [0]))), '@neo4j/graphql/FORBIDDEN', [0])
	CALL {
		WITH this_disconnect_content0, this_disconnect_content0_rel, this
		WITH collect(this_disconnect_content0) AS this_disconnect_content0, this_disconnect_content0_rel, this
		UNWIND this_disconnect_content0 AS x DELETE this_disconnect_content0_rel
		RETURN count(*) AS _
	}
	RETURN count(*) AS disconnect_this_disconnect_content_Comment
}
CALL {
	WITH this
	OPTIONAL MATCH (this)-[this_disconnect_content0_rel:HAS_CONTENT]->(this_disconnect_content0:Post)
	WITH this, this_disconnect_content0, this_disconnect_content0_rel CALL apoc.util.validate(NOT ((apoc.util.validatePredicate(NOT ($auth.isAuthenticated = true), '@neo4j/graphql/UNAUTHENTICATED', [0])
		AND apoc.util.validatePredicate(NOT ($auth.isAuthenticated = true), '@neo4j/graphql/UNAUTHENTICATED', [0]))), '@neo4j/graphql/FORBIDDEN', [0])
	CALL {
		WITH this_disconnect_content0, this_disconnect_content0_rel, this
		WITH collect(this_disconnect_content0) AS this_disconnect_content0, this_disconnect_content0_rel, this
		UNWIND this_disconnect_content0 AS x DELETE this_disconnect_content0_rel
		RETURN count(*) AS _
	}
	RETURN count(*) AS disconnect_this_disconnect_content_Post
}
WITH *
RETURN collect(DISTINCT this {
	.id
}) AS data
----

'''

== Nested Delete

.GraphQL-Query
[source,graphql]
----
mutation {
  deleteUsers(delete: {content: {where: {}}}) {
    nodesDeleted
  }
}
----

.Query Context
[source,json,query-config=true]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [
      "admin"
    ]
  },
  "contextParams": {
    "jwt": {
      "roles": [
        "admin"
      ],
      "sub": "super_admin"
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "auth" : {
    "isAuthenticated" : true,
    "roles" : [ "admin" ],
    "jwt" : {
      "roles" : [ "admin" ],
      "sub" : "super_admin"
    }
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:User)
WITH this
OPTIONAL MATCH (this)-[this_content_Comment0_relationship:HAS_CONTENT]->(this_content_Comment0:Comment)
WITH this, this_content_Comment0 CALL apoc.util.validate(NOT (apoc.util.validatePredicate(NOT ($auth.isAuthenticated = true), '@neo4j/graphql/UNAUTHENTICATED', [0])), '@neo4j/graphql/FORBIDDEN', [0])
WITH this, collect(DISTINCT this_content_Comment0) AS this_content_Comment0_to_delete
CALL {
	WITH this_content_Comment0_to_delete
	UNWIND this_content_Comment0_to_delete AS x DETACH DELETE x
	RETURN count(*) AS _
}
WITH this
OPTIONAL MATCH (this)-[this_content_Post0_relationship:HAS_CONTENT]->(this_content_Post0:Post)
WITH this, this_content_Post0 CALL apoc.util.validate(NOT (apoc.util.validatePredicate(NOT ($auth.isAuthenticated = true), '@neo4j/graphql/UNAUTHENTICATED', [0])), '@neo4j/graphql/FORBIDDEN', [0])
WITH this, collect(DISTINCT this_content_Post0) AS this_content_Post0_to_delete
CALL {
	WITH this_content_Post0_to_delete
	UNWIND this_content_Post0_to_delete AS x DETACH DELETE x
	RETURN count(*) AS _
}
WITH this CALL apoc.util.validate(NOT (apoc.util.validatePredicate(NOT ($auth.isAuthenticated = true), '@neo4j/graphql/UNAUTHENTICATED', [0])), '@neo4j/graphql/FORBIDDEN', [0]) DETACH DELETE this
----

'''

== Update Node

.GraphQL-Query
[source,graphql]
----
mutation {
  updatePosts(where: {id: "1"}, update: {id: "id-1"}) {
    posts {
      id
    }
  }
}
----

.Query Context
[source,json,query-config=true]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [
      "admin"
    ]
  },
  "contextParams": {
    "jwt": {
      "roles": [
        "admin"
      ],
      "sub": "super_admin"
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "auth" : {
    "isAuthenticated" : true,
    "roles" : [ "admin" ],
    "jwt" : {
      "roles" : [ "admin" ],
      "sub" : "super_admin"
    }
  },
  "param0" : "1",
  "this_update_id" : "id-1"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Post)
WHERE this.id = $param0
WITH this CALL apoc.util.validate(NOT (apoc.util.validatePredicate(NOT ($auth.isAuthenticated = true), '@neo4j/graphql/UNAUTHENTICATED', [0])), '@neo4j/graphql/FORBIDDEN', [0])
SET this.id = $this_update_id
RETURN collect(DISTINCT this {
	.id
}) AS data
----

'''

