:toc:

= Require fields on nested types

== Source schema

[source,graphql,schema=true]
----
type City {
  name: String!
  population: Int
}

type Address {
  street: String!
  city: City! @relationship(type: "IN_CITY", direction: OUT)
}

type User {
  id: ID!
  firstName: String!
  lastName: String!
  address: Address @relationship(type: "LIVES_AT", direction: OUT)
  fullName: String @customResolver(requires: "firstName lastName address { city { name population } }")
}
----

== should not fetch required fields if @customResolver field is not selected

.GraphQL-Query
[source,graphql]
----
{
  users {
    firstName
  }
}
----

.Expected Cypher params
[source,json]
----
{ }
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:User)
RETURN this {
	.firstName
} AS this
----

'''

== should not over fetch when all required fields are manually selected

.GraphQL-Query
[source,graphql]
----
{
  users {
    firstName
    lastName
    fullName
    address {
      city {
        name
        population
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{ }
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:User)
CALL {
	WITH this
	MATCH (this)-[this0:LIVES_AT]->(this1:Address)
	CALL {
		WITH this1
		MATCH (this1)-[this2:IN_CITY]->(this3:City)
		WITH this3 {
			.name,
			.population
		} AS this3
		RETURN head(collect(this3)) AS var4
	}
	WITH this1 {
		city: var4
	} AS this1
	RETURN head(collect(this1)) AS var5
}
RETURN this {
	.firstName,
	.lastName,
	.fullName,
	address: var5
} AS this
----

'''

== should not over fetch when no required fields are manually selected

.GraphQL-Query
[source,graphql]
----
{
  users {
    fullName
  }
}
----

.Expected Cypher params
[source,json]
----
{ }
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:User)
CALL {
	WITH this
	MATCH (this)-[this0:LIVES_AT]->(this1:Address)
	CALL {
		WITH this1
		MATCH (this1)-[this2:IN_CITY]->(this3:City)
		WITH this3 {
			.name,
			.population
		} AS this3
		RETURN head(collect(this3)) AS var4
	}
	WITH this1 {
		city: var4
	} AS this1
	RETURN head(collect(this1)) AS var5
}
RETURN this {
	.fullName,
	.firstName,
	.lastName,
	address: var5
} AS this
----

'''

== should not over fetch when some required fields are manually selected

.GraphQL-Query
[source,graphql]
----
{
  users {
    lastName
    fullName
    address {
      city {
        population
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{ }
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:User)
CALL {
	WITH this
	MATCH (this)-[this0:LIVES_AT]->(this1:Address)
	CALL {
		WITH this1
		MATCH (this1)-[this2:IN_CITY]->(this3:City)
		WITH this3 {
			.population,
			.name
		} AS this3
		RETURN head(collect(this3)) AS var4
	}
	WITH this1 {
		city: var4
	} AS this1
	RETURN head(collect(this1)) AS var5
}
RETURN this {
	.lastName,
	.fullName,
	.firstName,
	address: var5
} AS this
----

'''

