:toc:

= Require fields on nested types

== Source schema

[source,graphql,schema=true]
----
type City {
  name: String!
  population: Int
}

type Address {
  street: String!
  city: City! @relationship(type: "IN_CITY", direction: OUT)
}

type User {
  id: ID!
  firstName: String!
  lastName: String!
  address: Address @relationship(type: "LIVES_AT", direction: OUT)
  fullName: String @customResolver(requires: "firstName lastName address { city { name population } }")
}
----

== should not fetch required fields if @customResolver field is not selected

.GraphQL-Query
[source,graphql]
----
{
  users {
    firstName
  }
}
----

.Expected Cypher params
[source,json]
----
{ }
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:User)
RETURN this {
	.firstName
} AS this
----

'''

== should not over fetch when all required fields are manually selected

.GraphQL-Query
[source,graphql]
----
{
  users {
    firstName
    lastName
    fullName
    address {
      city {
        name
        population
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{ }
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:User)
CALL {
	WITH this
	MATCH (this)-[livesAt0:LIVES_AT]->(address0:Address)
	CALL {
		WITH address0
		MATCH (address0)-[inCity0:IN_CITY]->(city0:City)
		WITH city0 {
			.name,
			.population
		} AS city
		RETURN head(collect(city)) AS city
	}
	WITH address0 {
		city: city
	} AS address
	RETURN head(collect(address)) AS address
}
RETURN this {
	.firstName,
	.lastName,
	address: address
} AS this
----

'''

== should not over fetch when no required fields are manually selected

.GraphQL-Query
[source,graphql]
----
{
  users {
    fullName
  }
}
----

.Expected Cypher params
[source,json]
----
{ }
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:User)
CALL {
	WITH this
	MATCH (this)-[livesAt0:LIVES_AT]->(address0:Address)
	CALL {
		WITH address0
		MATCH (address0)-[inCity0:IN_CITY]->(city0:City)
		WITH city0 {
			.name,
			.population
		} AS city
		RETURN head(collect(city)) AS city
	}
	WITH address0 {
		city: city
	} AS address
	RETURN head(collect(address)) AS address
}
RETURN this {
	.firstName,
	.lastName,
	address: address
} AS this
----

'''

== should not over fetch when some required fields are manually selected

.GraphQL-Query
[source,graphql]
----
{
  users {
    lastName
    fullName
    address {
      city {
        population
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{ }
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:User)
CALL {
	WITH this
	MATCH (this)-[livesAt0:LIVES_AT]->(address0:Address)
	CALL {
		WITH address0
		MATCH (address0)-[inCity0:IN_CITY]->(city0:City)
		WITH city0 {
			.population,
			.name
		} AS city
		RETURN head(collect(city)) AS city
	}
	WITH address0 {
		city: city
	} AS address
	RETURN head(collect(address)) AS address
}
RETURN this {
	.lastName,
	address: address,
	.firstName
} AS this
----

'''

