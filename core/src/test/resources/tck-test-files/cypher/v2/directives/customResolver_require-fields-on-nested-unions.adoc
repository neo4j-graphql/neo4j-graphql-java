:toc:

= Require fields on nested unions

== Source schema

[source,graphql,schema=true]
----
union Publication = Book | Journal

type Author {
  name: String!
  publications: [Publication!]! @relationship(type: "WROTE", direction: OUT)
  publicationsWithAuthor: [String!]! @customResolver(requires: "name publications { ...on Book { title } ... on Journal { subject } }")
}

type Book {
  title: String!
  author: Author! @relationship(type: "WROTE", direction: IN)
}

type Journal {
  subject: String!
  author: Author! @relationship(type: "WROTE", direction: IN)
}
----
== should not fetch required fields if @customResolver field is not selected

.GraphQL-Query
[source,graphql]
----
{
  authors {
    name
  }
}
----

.Expected Cypher params
[source,json]
----
{}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Author)
RETURN this { .name } AS this
----

'''

== should not over fetch when all required fields are manually selected

.GraphQL-Query
[source,graphql]
----
{
  authors {
    name
    publicationsWithAuthor
    publications {
      ... on Book {
        title
      }
      ... on Journal {
        subject
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Author)
CALL {
    WITH this
    CALL {
        WITH *
        MATCH (this)-[this0:WROTE]->(this1:Book)
        WITH this1 { .title, __resolveType: "Book", __id: id(this1) } AS this1
        RETURN this1 AS var2
        UNION
        WITH *
        MATCH (this)-[this3:WROTE]->(this4:Journal)
        WITH this4 { .subject, __resolveType: "Journal", __id: id(this4) } AS this4
        RETURN this4 AS var2
    }
    WITH var2
    RETURN collect(var2) AS var2
}
RETURN this { .name, .publicationsWithAuthor, publications: var2 } AS this
----

'''

== should not over fetch when no required fields are manually selected

.GraphQL-Query
[source,graphql]
----
{
  authors {
    publicationsWithAuthor
  }
}
----

.Expected Cypher params
[source,json]
----
{}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Author)
CALL {
    WITH this
    CALL {
        WITH *
        MATCH (this)-[this0:WROTE]->(this1:Book)
        WITH this1 { .title, __resolveType: "Book", __id: id(this1) } AS this1
        RETURN this1 AS var2
        UNION
        WITH *
        MATCH (this)-[this3:WROTE]->(this4:Journal)
        WITH this4 { .subject, __resolveType: "Journal", __id: id(this4) } AS this4
        RETURN this4 AS var2
    }
    WITH var2
    RETURN collect(var2) AS var2
}
RETURN this { .publicationsWithAuthor, .name, publications: var2 } AS this
----

'''

== should not over fetch when some required fields are manually selected

.GraphQL-Query
[source,graphql]
----
{
  authors {
    publicationsWithAuthor
    publications {
      ... on Book {
        title
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Author)
CALL {
    WITH this
    CALL {
        WITH *
        MATCH (this)-[this0:WROTE]->(this1:Book)
        WITH this1 { .title, __resolveType: "Book", __id: id(this1) } AS this1
        RETURN this1 AS var2
        UNION
        WITH *
        MATCH (this)-[this3:WROTE]->(this4:Journal)
        WITH this4 { .subject, __resolveType: "Journal", __id: id(this4) } AS this4
        RETURN this4 AS var2
    }
    WITH var2
    RETURN collect(var2) AS var2
}
RETURN this { .publicationsWithAuthor, .name, publications: var2 } AS this
----

'''

