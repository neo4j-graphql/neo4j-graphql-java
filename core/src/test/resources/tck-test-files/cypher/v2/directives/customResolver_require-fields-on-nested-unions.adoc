:toc:

= Require fields on nested unions

== Source schema

[source,graphql,schema=true]
----
union Publication = Book | Journal

type Author {
  name: String!
  publications: [Publication!]! @relationship(type: "WROTE", direction: OUT)
  publicationsWithAuthor: [String!]! @customResolver(requires: "name publications { ...on Book { title } ... on Journal { subject } }")
}

type Book {
  title: String!
  author: Author! @relationship(type: "WROTE", direction: IN)
}

type Journal {
  subject: String!
  author: Author! @relationship(type: "WROTE", direction: IN)
}
----

== should not fetch required fields if @customResolver field is not selected

.GraphQL-Query
[source,graphql]
----
{
  authors {
    name
  }
}
----

.Expected Cypher params
[source,json]
----
{ }
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Author)
RETURN this {
	.name
} AS this
----

'''

== should not over fetch when all required fields are manually selected

.GraphQL-Query
[source,graphql]
----
{
  authors {
    name
    publicationsWithAuthor
    publications {
      ... on Book {
        title
      }
      ... on Journal {
        subject
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{ }
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Author)
CALL {
	WITH this
	CALL {
		WITH *
		MATCH (this)-[wrote0:WROTE]->(book0:Book)
		WITH book0 {
			__typename: 'Book',
			__id: elementId(book0),
			.title
		} AS book0
		RETURN book0 AS publications0 UNION
		WITH *
		MATCH (this)-[wrote1:WROTE]->(journal0:Journal)
		WITH journal0 {
			__typename: 'Journal',
			__id: elementId(journal0),
			.subject
		} AS journal0
		RETURN journal0 AS publications0
	}
	WITH publications0
	RETURN collect(publications0) AS publications0
}
RETURN this {
	.name,
	publications: publications0
} AS this
----

'''

== should not over fetch when no required fields are manually selected

.GraphQL-Query
[source,graphql]
----
{
  authors {
    publicationsWithAuthor
  }
}
----

.Expected Cypher params
[source,json]
----
{ }
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Author)
CALL {
	WITH this
	CALL {
		WITH *
		MATCH (this)-[wrote0:WROTE]->(book0:Book)
		WITH book0 {
			__typename: 'Book',
			__id: elementId(book0),
			.title
		} AS book0
		RETURN book0 AS publications0 UNION
		WITH *
		MATCH (this)-[wrote1:WROTE]->(journal0:Journal)
		WITH journal0 {
			__typename: 'Journal',
			__id: elementId(journal0),
			.subject
		} AS journal0
		RETURN journal0 AS publications0
	}
	WITH publications0
	RETURN collect(publications0) AS publications0
}
RETURN this {
	.name,
	publications: publications0
} AS this
----

'''

== should not over fetch when some required fields are manually selected

.GraphQL-Query
[source,graphql]
----
{
  authors {
    publicationsWithAuthor
    publications {
      ... on Book {
        title
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{ }
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Author)
CALL {
	WITH this
	CALL {
		WITH *
		MATCH (this)-[wrote0:WROTE]->(book0:Book)
		WITH book0 {
			__typename: 'Book',
			__id: elementId(book0),
			.title
		} AS book0
		RETURN book0 AS publications0 UNION
		WITH *
		MATCH (this)-[wrote1:WROTE]->(journal0:Journal)
		WITH journal0 {
			__typename: 'Journal',
			__id: elementId(journal0),
			.subject
		} AS journal0
		RETURN journal0 AS publications0
	}
	WITH publications0
	RETURN collect(publications0) AS publications0
}
RETURN this {
	publications: publications0,
	.name
} AS this
----

'''

