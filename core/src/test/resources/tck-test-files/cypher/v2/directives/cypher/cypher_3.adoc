:toc:

= Cypher directive

== Source schema

[source,graphql,schema=true]
----
type Actor {
  name: String
  year: Int
  movies(title: String): [Movie] @cypher(statement: """
  MATCH (m:Movie {title: $title})
  RETURN m
  """, columnName: "m")
  tvShows(title: String): [Movie] @cypher(statement: """
  MATCH (t:TVShow {title: $title})
  RETURN t
  """, columnName: "t")
  randomNumber: Int @cypher(statement: """RETURN rand() as res""", columnName: "res")
}

type TVShow {
  id: ID
  title: String
  numSeasons: Int
  actors: [Actor] @cypher(statement: """
  MATCH (a:Actor)
  RETURN a
  """, columnName: "a")
  topActor: Actor @cypher(statement: """
  MATCH (a:Actor)
  RETURN a
  """, columnName: "a")
}

type Movie {
  id: ID
  title: String
  actors: [Actor] @cypher(statement: """
  MATCH (a:Actor)
  RETURN a
  """, columnName: "a")
  topActor: Actor @cypher(statement: """
  MATCH (a:Actor)
  RETURN a
  """, columnName: "a")
}
----
== LIMIT happens after custom Cypher if sorting on the custom Cypher field

.GraphQL-Query
[source,graphql]
----
{
  actors(options: {limit: 10, sort: [{randomNumber: ASC}]}) {
    randomNumber
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": 10
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
CALL {
    WITH this
    CALL {
        WITH this
        WITH this AS this
        RETURN rand() as res
    }
    WITH res AS this0
    RETURN this0 AS var1
}
WITH *
ORDER BY var1 ASC
LIMIT $param0
RETURN this { randomNumber: var1 } AS this
----

'''

== LIMIT happens before custom Cypher if not sorting on the custom Cypher field

.GraphQL-Query
[source,graphql]
----
{
  actors(options: {limit: 10}) {
    randomNumber
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": 10
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WITH *

LIMIT $param0
CALL {
    WITH this
    CALL {
        WITH this
        WITH this AS this
        RETURN rand() as res
    }
    WITH res AS this0
    RETURN this0 AS var1
}
RETURN this { randomNumber: var1 } AS this
----

'''

== Nested directive

.GraphQL-Query
[source,graphql]
----
{
  movies {
    title
    topActor {
      name
      movies(title: "some title") {
        title
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": "some title"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL {
    WITH this
    CALL {
        WITH this
        WITH this AS this
        MATCH (a:Actor)
        RETURN a
    }
    WITH a AS this0
    CALL {
        WITH this0
        CALL {
            WITH this0
            WITH this0 AS this
            MATCH (m:Movie {title: $param0})
            RETURN m
        }
        WITH m AS this1
        WITH this1 { .title } AS this1
        RETURN collect(this1) AS var2
    }
    WITH this0 { .name, movies: var2 } AS this0
    RETURN head(collect(this0)) AS var3
}
RETURN this { .title, topActor: var3 } AS this
----

'''

== Nested directive with params

.GraphQL-Query
[source,graphql]
----
{
  movies {
    title
    topActor {
      name
      movies(title: "some title") {
        title
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": "some title"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL {
    WITH this
    CALL {
        WITH this
        WITH this AS this
        MATCH (a:Actor)
        RETURN a
    }
    WITH a AS this0
    CALL {
        WITH this0
        CALL {
            WITH this0
            WITH this0 AS this
            MATCH (m:Movie {title: $param0})
            RETURN m
        }
        WITH m AS this1
        WITH this1 { .title } AS this1
        RETURN collect(this1) AS var2
    }
    WITH this0 { .name, movies: var2 } AS this0
    RETURN head(collect(this0)) AS var3
}
RETURN this { .title, topActor: var3 } AS this
----

'''

== Simple directive

.GraphQL-Query
[source,graphql]
----
{
  movies {
    title
    topActor {
      name
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL {
    WITH this
    CALL {
        WITH this
        WITH this AS this
        MATCH (a:Actor)
        RETURN a
    }
    WITH a AS this0
    WITH this0 { .name } AS this0
    RETURN head(collect(this0)) AS var1
}
RETURN this { .title, topActor: var1 } AS this
----

'''

== Simple directive (primitive)

.GraphQL-Query
[source,graphql]
----
{
  actors {
    randomNumber
  }
}
----

.Expected Cypher params
[source,json]
----
{}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
CALL {
    WITH this
    CALL {
        WITH this
        WITH this AS this
        RETURN rand() as res
    }
    WITH res AS this0
    RETURN this0 AS var1
}
RETURN this { randomNumber: var1 } AS this
----

'''

== Super Nested directive

.GraphQL-Query
[source,graphql]
----
{
  movies {
    title
    topActor {
      name
      movies(title: "some title") {
        title
        topActor {
          name
          movies(title: "another title") {
            title
          }
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": "some title",
  "param1": "another title"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL {
    WITH this
    CALL {
        WITH this
        WITH this AS this
        MATCH (a:Actor)
        RETURN a
    }
    WITH a AS this0
    CALL {
        WITH this0
        CALL {
            WITH this0
            WITH this0 AS this
            MATCH (m:Movie {title: $param0})
            RETURN m
        }
        WITH m AS this1
        CALL {
            WITH this1
            CALL {
                WITH this1
                WITH this1 AS this
                MATCH (a:Actor)
                RETURN a
            }
            WITH a AS this2
            CALL {
                WITH this2
                CALL {
                    WITH this2
                    WITH this2 AS this
                    MATCH (m:Movie {title: $param1})
                    RETURN m
                }
                WITH m AS this3
                WITH this3 { .title } AS this3
                RETURN collect(this3) AS var4
            }
            WITH this2 { .name, movies: var4 } AS this2
            RETURN head(collect(this2)) AS var5
        }
        WITH this1 { .title, topActor: var5 } AS this1
        RETURN collect(this1) AS var6
    }
    WITH this0 { .name, movies: var6 } AS this0
    RETURN head(collect(this0)) AS var7
}
RETURN this { .title, topActor: var7 } AS this
----

'''

