:toc:

= Cypher directive

== Source schema

[source,graphql,schema=true]
----
type Actor {
  name: String
  year: Int
  movies(title: String): [Movie] @cypher(statement: """
  MATCH (m:Movie {title: $title})
  RETURN m
  """, columnName: "m")
  tvShows(title: String): [Movie] @cypher(statement: """
  MATCH (t:TVShow {title: $title})
  RETURN t
  """, columnName: "t")
  movieOrTVShow(title: String): [MovieOrTVShow] @cypher(statement: """
  MATCH (n)
  WHERE (n:TVShow OR n:Movie) AND ($title IS NULL OR n.title = $title)
  RETURN n
  """, columnName: "n")
  randomNumber: Int @cypher(statement: """RETURN rand() as res""", columnName: "res")
}

union MovieOrTVShow = Movie | TVShow

type TVShow {
  id: ID
  title: String
  numSeasons: Int
  actors: [Actor] @cypher(statement: """
  MATCH (a:Actor)
  RETURN a
  """, columnName: "a")
  topActor: Actor @cypher(statement: """
  MATCH (a:Actor)
  RETURN a
  """, columnName: "a")
}

type Movie {
  id: ID
  title: String
  actors: [Actor] @cypher(statement: """
  MATCH (a:Actor)
  RETURN a
  """, columnName: "a")
  topActor: Actor @cypher(statement: """
  MATCH (a:Actor)
  RETURN a
  """, columnName: "a")
}
----
== LIMIT happens after custom Cypher if sorting on the custom Cypher field

.GraphQL-Query
[source,graphql]
----
{
  actors(options: {limit: 10, sort: [{randomNumber: ASC}]}) {
    randomNumber
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": 10
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
CALL {
    WITH this
    CALL {
        WITH this
        WITH this AS this
        RETURN rand() as res
    }
    UNWIND res AS this0
    RETURN head(collect(this0)) AS this0
}
WITH *
ORDER BY this0 ASC
LIMIT $param0
RETURN this { randomNumber: this0 } AS this
----

'''

== LIMIT happens before custom Cypher if not sorting on the custom Cypher field

.GraphQL-Query
[source,graphql]
----
{
  actors(options: {limit: 10}) {
    randomNumber
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": 10
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WITH *

LIMIT $param0
CALL {
    WITH this
    CALL {
        WITH this
        WITH this AS this
        RETURN rand() as res
    }
    UNWIND res AS this0
    RETURN head(collect(this0)) AS this0
}
RETURN this { randomNumber: this0 } AS this
----

'''

== Nested directive

.GraphQL-Query
[source,graphql]
----
{
  movies {
    title
    topActor {
      name
      movies(title: "some title") {
        title
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": "some title"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL {
    WITH this
    CALL {
        WITH this
        WITH this AS this
        MATCH (a:Actor)
        RETURN a
    }
    WITH a AS this0
    CALL {
        WITH this0
        CALL {
            WITH this0
            WITH this0 AS this
            MATCH (m:Movie {title: $param0})
            RETURN m
        }
        WITH m AS this1
        RETURN collect(this1 { .title }) AS this1
    }
    RETURN head(collect(this0 { .name, movies: this1 })) AS this0
}
RETURN this { .title, topActor: this0 } AS this
----

'''

== Nested directive with params

.GraphQL-Query
[source,graphql]
----
{
  movies {
    title
    topActor {
      name
      movies(title: "some title") {
        title
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": "some title"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL {
    WITH this
    CALL {
        WITH this
        WITH this AS this
        MATCH (a:Actor)
        RETURN a
    }
    WITH a AS this0
    CALL {
        WITH this0
        CALL {
            WITH this0
            WITH this0 AS this
            MATCH (m:Movie {title: $param0})
            RETURN m
        }
        WITH m AS this1
        RETURN collect(this1 { .title }) AS this1
    }
    RETURN head(collect(this0 { .name, movies: this1 })) AS this0
}
RETURN this { .title, topActor: this0 } AS this
----

'''

== Simple directive

.GraphQL-Query
[source,graphql]
----
{
  movies {
    title
    topActor {
      name
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL {
    WITH this
    CALL {
        WITH this
        WITH this AS this
        MATCH (a:Actor)
        RETURN a
    }
    WITH a AS this0
    RETURN head(collect(this0 { .name })) AS this0
}
RETURN this { .title, topActor: this0 } AS this
----

'''

== Simple directive (primitive)

.GraphQL-Query
[source,graphql]
----
{
  actors {
    randomNumber
  }
}
----

.Expected Cypher params
[source,json]
----
{}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
CALL {
    WITH this
    CALL {
        WITH this
        WITH this AS this
        RETURN rand() as res
    }
    UNWIND res AS this0
    RETURN head(collect(this0)) AS this0
}
RETURN this { randomNumber: this0 } AS this
----

'''

== Super Nested directive

.GraphQL-Query
[source,graphql]
----
{
  movies {
    title
    topActor {
      name
      movies(title: "some title") {
        title
        topActor {
          name
          movies(title: "another title") {
            title
          }
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": "some title",
  "param1": "another title"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL {
    WITH this
    CALL {
        WITH this
        WITH this AS this
        MATCH (a:Actor)
        RETURN a
    }
    WITH a AS this0
    CALL {
        WITH this0
        CALL {
            WITH this0
            WITH this0 AS this
            MATCH (m:Movie {title: $param0})
            RETURN m
        }
        WITH m AS this1
        CALL {
            WITH this1
            CALL {
                WITH this1
                WITH this1 AS this
                MATCH (a:Actor)
                RETURN a
            }
            WITH a AS this2
            CALL {
                WITH this2
                CALL {
                    WITH this2
                    WITH this2 AS this
                    MATCH (m:Movie {title: $param1})
                    RETURN m
                }
                WITH m AS this3
                RETURN collect(this3 { .title }) AS this3
            }
            RETURN head(collect(this2 { .name, movies: this3 })) AS this2
        }
        RETURN collect(this1 { .title, topActor: this2 }) AS this1
    }
    RETURN head(collect(this0 { .name, movies: this1 })) AS this0
}
RETURN this { .title, topActor: this0 } AS this
----

'''

== Union directive

.GraphQL-Query
[source,graphql]
----
{
  actors {
    movieOrTVShow(title: "some title") {
      ... on Movie {
        id
        title
        topActor {
          name
          year
        }
        actors {
          name
        }
      }
      ... on TVShow {
        id
        title
        topActor {
          name
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": "some title"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
CALL {
    WITH this
    CALL {
        WITH this
        WITH this AS this
        MATCH (n)
        WHERE (n:TVShow OR n:Movie) AND ($param0 IS NULL OR n.title = $param0)
        RETURN n
    }
    WITH n AS this0
    WITH *
    WHERE (this0:Movie OR this0:TVShow)
    WITH *, this0 AS this1
    CALL {
        WITH this1
        CALL {
            WITH this1
            WITH this1 AS this
            MATCH (a:Actor)
            RETURN a
        }
        WITH a AS this2
        RETURN head(collect(this2 { .name, .year })) AS this2
    }
    CALL {
        WITH this1
        CALL {
            WITH this1
            WITH this1 AS this
            MATCH (a:Actor)
            RETURN a
        }
        WITH a AS this3
        RETURN collect(this3 { .name }) AS this3
    }
    WITH *, this0 AS this4
    CALL {
        WITH this4
        CALL {
            WITH this4
            WITH this4 AS this
            MATCH (a:Actor)
            RETURN a
        }
        WITH a AS this5
        RETURN head(collect(this5 { .name })) AS this5
    }
    RETURN collect(CASE
        WHEN this0:Movie THEN this0 { .id, .title, topActor: this2, actors: this3, __resolveType: "Movie" }
        WHEN this0:TVShow THEN this0 { .id, .title, topActor: this5, __resolveType: "TVShow" }
    END) AS this0
}
RETURN this { movieOrTVShow: this0 } AS this
----

'''

== Union directive - querying only __typename

.GraphQL-Query
[source,graphql]
----
{
  actors {
    movieOrTVShow(title: "some title") {
      __typename
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": "some title"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
CALL {
    WITH this
    CALL {
        WITH this
        WITH this AS this
        MATCH (n)
        WHERE (n:TVShow OR n:Movie) AND ($param0 IS NULL OR n.title = $param0)
        RETURN n
    }
    WITH n AS this0
    WITH *
    WHERE (this0:Movie OR this0:TVShow)
    RETURN collect(CASE
        WHEN this0:Movie THEN this0 { __resolveType: "Movie" }
        WHEN this0:TVShow THEN this0 { __resolveType: "TVShow" }
    END) AS this0
}
RETURN this { movieOrTVShow: this0 } AS this
----

'''

