:toc:

= Interface Relationships - Update connect

== Source schema

[source,graphql,schema=true]
----
interface Production {
  title: String!
  actors: [Actor!]! @relationship(type: "ACTED_IN", direction: IN, properties: "ActedIn")
}

type Movie implements Production {
  title: String!
  runtime: Int!
  actors: [Actor!]!
}

type Series implements Production {
  title: String!
  episodes: Int!
  actors: [Actor!]!
}

interface ActedIn @relationshipProperties {
  screenTime: Int!
}

type Actor {
  name: String!
  actedIn: [Production!]! @relationship(type: "ACTED_IN", direction: OUT, properties: "ActedIn")
}
----
== Update connect to an interface relationship

.GraphQL-Query
[source,graphql]
----
mutation {
  updateActors(
    connect: {actedIn: {edge: {screenTime: 90}, where: {node: {title_STARTS_WITH: "The "}}}}
  ) {
    actors {
      name
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_connect_actedIn0_node_param0": "The ",
  "this_connect_actedIn0_relationship_screenTime": 90,
  "this_connect_actedIn1_node_param0": "The ",
  "this_connect_actedIn1_relationship_screenTime": 90
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WITH *
CALL {
	WITH this
	OPTIONAL MATCH (this_connect_actedIn0_node:Movie)
	WHERE this_connect_actedIn0_node.title STARTS WITH $this_connect_actedIn0_node_param0
	CALL {
		WITH *
		WITH collect(this_connect_actedIn0_node) as connectedNodes, collect(this) as parentNodes
		CALL {
			WITH connectedNodes, parentNodes
			UNWIND parentNodes as this
			UNWIND connectedNodes as this_connect_actedIn0_node
			MERGE (this)-[this_connect_actedIn0_relationship:ACTED_IN]->(this_connect_actedIn0_node)
			SET this_connect_actedIn0_relationship.screenTime = $this_connect_actedIn0_relationship_screenTime
		}
	}
WITH this, this_connect_actedIn0_node
	RETURN count(*) AS connect_this_connect_actedIn_Movie0
}
CALL {
		WITH this
	OPTIONAL MATCH (this_connect_actedIn1_node:Series)
	WHERE this_connect_actedIn1_node.title STARTS WITH $this_connect_actedIn1_node_param0
	CALL {
		WITH *
		WITH collect(this_connect_actedIn1_node) as connectedNodes, collect(this) as parentNodes
		CALL {
			WITH connectedNodes, parentNodes
			UNWIND parentNodes as this
			UNWIND connectedNodes as this_connect_actedIn1_node
			MERGE (this)-[this_connect_actedIn1_relationship:ACTED_IN]->(this_connect_actedIn1_node)
			SET this_connect_actedIn1_relationship.screenTime = $this_connect_actedIn1_relationship_screenTime
		}
	}
WITH this, this_connect_actedIn1_node
	RETURN count(*) AS connect_this_connect_actedIn_Series1
}
WITH *
RETURN collect(DISTINCT this { .name }) AS data
----

'''

== Update connect to an interface relationship and nested connect

.GraphQL-Query
[source,graphql]
----
mutation {
  updateActors(
    connect: {actedIn: {edge: {screenTime: 90}, where: {node: {title_STARTS_WITH: "The "}}, connect: {actors: {edge: {screenTime: 90}, where: {node: {name: "Actor"}}}}}}
  ) {
    actors {
      name
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_connect_actedIn0_node_param0": "The ",
  "this_connect_actedIn0_relationship_screenTime": 90,
  "this_connect_actedIn0_node_actors0_node_param0": "Actor",
  "this_connect_actedIn0_node_actors0_relationship_screenTime": 90,
  "this_connect_actedIn1_node_param0": "The ",
  "this_connect_actedIn1_relationship_screenTime": 90,
  "this_connect_actedIn1_node_actors0_node_param0": "Actor",
  "this_connect_actedIn1_node_actors0_relationship_screenTime": 90
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WITH *
CALL {
	WITH this
	OPTIONAL MATCH (this_connect_actedIn0_node:Movie)
	WHERE this_connect_actedIn0_node.title STARTS WITH $this_connect_actedIn0_node_param0
	CALL {
		WITH *
		WITH collect(this_connect_actedIn0_node) as connectedNodes, collect(this) as parentNodes
		CALL {
			WITH connectedNodes, parentNodes
			UNWIND parentNodes as this
			UNWIND connectedNodes as this_connect_actedIn0_node
			MERGE (this)-[this_connect_actedIn0_relationship:ACTED_IN]->(this_connect_actedIn0_node)
			SET this_connect_actedIn0_relationship.screenTime = $this_connect_actedIn0_relationship_screenTime
		}
	}
WITH this, this_connect_actedIn0_node
CALL {
	WITH this, this_connect_actedIn0_node
	OPTIONAL MATCH (this_connect_actedIn0_node_actors0_node:Actor)
	WHERE this_connect_actedIn0_node_actors0_node.name = $this_connect_actedIn0_node_actors0_node_param0
	CALL {
		WITH *
		WITH this, collect(this_connect_actedIn0_node_actors0_node) as connectedNodes, collect(this_connect_actedIn0_node) as parentNodes
		CALL {
			WITH connectedNodes, parentNodes
			UNWIND parentNodes as this_connect_actedIn0_node
			UNWIND connectedNodes as this_connect_actedIn0_node_actors0_node
			MERGE (this_connect_actedIn0_node)<-[this_connect_actedIn0_node_actors0_relationship:ACTED_IN]-(this_connect_actedIn0_node_actors0_node)
			SET this_connect_actedIn0_node_actors0_relationship.screenTime = $this_connect_actedIn0_node_actors0_relationship_screenTime
		}
	}
WITH this, this_connect_actedIn0_node, this_connect_actedIn0_node_actors0_node
	RETURN count(*) AS connect_this_connect_actedIn0_node_actors_Actor0
}
	RETURN count(*) AS connect_this_connect_actedIn_Movie0
}
CALL {
		WITH this
	OPTIONAL MATCH (this_connect_actedIn1_node:Series)
	WHERE this_connect_actedIn1_node.title STARTS WITH $this_connect_actedIn1_node_param0
	CALL {
		WITH *
		WITH collect(this_connect_actedIn1_node) as connectedNodes, collect(this) as parentNodes
		CALL {
			WITH connectedNodes, parentNodes
			UNWIND parentNodes as this
			UNWIND connectedNodes as this_connect_actedIn1_node
			MERGE (this)-[this_connect_actedIn1_relationship:ACTED_IN]->(this_connect_actedIn1_node)
			SET this_connect_actedIn1_relationship.screenTime = $this_connect_actedIn1_relationship_screenTime
		}
	}
WITH this, this_connect_actedIn1_node
CALL {
	WITH this, this_connect_actedIn1_node
	OPTIONAL MATCH (this_connect_actedIn1_node_actors0_node:Actor)
	WHERE this_connect_actedIn1_node_actors0_node.name = $this_connect_actedIn1_node_actors0_node_param0
	CALL {
		WITH *
		WITH this, collect(this_connect_actedIn1_node_actors0_node) as connectedNodes, collect(this_connect_actedIn1_node) as parentNodes
		CALL {
			WITH connectedNodes, parentNodes
			UNWIND parentNodes as this_connect_actedIn1_node
			UNWIND connectedNodes as this_connect_actedIn1_node_actors0_node
			MERGE (this_connect_actedIn1_node)<-[this_connect_actedIn1_node_actors0_relationship:ACTED_IN]-(this_connect_actedIn1_node_actors0_node)
			SET this_connect_actedIn1_node_actors0_relationship.screenTime = $this_connect_actedIn1_node_actors0_relationship_screenTime
		}
	}
WITH this, this_connect_actedIn1_node, this_connect_actedIn1_node_actors0_node
	RETURN count(*) AS connect_this_connect_actedIn1_node_actors_Actor0
}
	RETURN count(*) AS connect_this_connect_actedIn_Series1
}
WITH *
RETURN collect(DISTINCT this { .name }) AS data
----

'''

== Update connect to an interface relationship and nested connect using _on to connect only one implementation

.GraphQL-Query
[source,graphql]
----
mutation {
  updateActors(
    connect: {actedIn: {edge: {screenTime: 90}, where: {node: {title_STARTS_WITH: "The "}}, connect: {_on: {Movie: {actors: {edge: {screenTime: 90}, where: {node: {name: "Actor"}}}}}}}}
  ) {
    actors {
      name
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_connect_actedIn0_node_param0": "The ",
  "this_connect_actedIn0_relationship_screenTime": 90,
  "this_connect_actedIn0_node_on_Movie0_actors0_node_param0": "Actor",
  "this_connect_actedIn0_node_on_Movie0_actors0_relationship_screenTime": 90,
  "this_connect_actedIn1_node_param0": "The ",
  "this_connect_actedIn1_relationship_screenTime": 90
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WITH *
CALL {
	WITH this
	OPTIONAL MATCH (this_connect_actedIn0_node:Movie)
	WHERE this_connect_actedIn0_node.title STARTS WITH $this_connect_actedIn0_node_param0
	CALL {
		WITH *
		WITH collect(this_connect_actedIn0_node) as connectedNodes, collect(this) as parentNodes
		CALL {
			WITH connectedNodes, parentNodes
			UNWIND parentNodes as this
			UNWIND connectedNodes as this_connect_actedIn0_node
			MERGE (this)-[this_connect_actedIn0_relationship:ACTED_IN]->(this_connect_actedIn0_node)
			SET this_connect_actedIn0_relationship.screenTime = $this_connect_actedIn0_relationship_screenTime
		}
	}
WITH this, this_connect_actedIn0_node

CALL {
	WITH this, this_connect_actedIn0_node
	OPTIONAL MATCH (this_connect_actedIn0_node_on_Movie0_actors0_node:Actor)
	WHERE this_connect_actedIn0_node_on_Movie0_actors0_node.name = $this_connect_actedIn0_node_on_Movie0_actors0_node_param0
	CALL {
		WITH *
		WITH this, collect(this_connect_actedIn0_node_on_Movie0_actors0_node) as connectedNodes, collect(this_connect_actedIn0_node) as parentNodes
		CALL {
			WITH connectedNodes, parentNodes
			UNWIND parentNodes as this_connect_actedIn0_node
			UNWIND connectedNodes as this_connect_actedIn0_node_on_Movie0_actors0_node
			MERGE (this_connect_actedIn0_node)<-[this_connect_actedIn0_node_on_Movie0_actors0_relationship:ACTED_IN]-(this_connect_actedIn0_node_on_Movie0_actors0_node)
			SET this_connect_actedIn0_node_on_Movie0_actors0_relationship.screenTime = $this_connect_actedIn0_node_on_Movie0_actors0_relationship_screenTime
		}
	}
WITH this, this_connect_actedIn0_node, this_connect_actedIn0_node_on_Movie0_actors0_node
	RETURN count(*) AS connect_this_connect_actedIn0_node_on_Movie0_actors_Actor0
}
	RETURN count(*) AS connect_this_connect_actedIn_Movie0
}
CALL {
		WITH this
	OPTIONAL MATCH (this_connect_actedIn1_node:Series)
	WHERE this_connect_actedIn1_node.title STARTS WITH $this_connect_actedIn1_node_param0
	CALL {
		WITH *
		WITH collect(this_connect_actedIn1_node) as connectedNodes, collect(this) as parentNodes
		CALL {
			WITH connectedNodes, parentNodes
			UNWIND parentNodes as this
			UNWIND connectedNodes as this_connect_actedIn1_node
			MERGE (this)-[this_connect_actedIn1_relationship:ACTED_IN]->(this_connect_actedIn1_node)
			SET this_connect_actedIn1_relationship.screenTime = $this_connect_actedIn1_relationship_screenTime
		}
	}
WITH this, this_connect_actedIn1_node

	RETURN count(*) AS connect_this_connect_actedIn_Series1
}
WITH *
RETURN collect(DISTINCT this { .name }) AS data
----

'''

== Update connect to an interface relationship and nested connect using _on to override connection

.GraphQL-Query
[source,graphql]
----
mutation {
  updateActors(
    connect: {actedIn: {edge: {screenTime: 90}, where: {node: {title_STARTS_WITH: "The "}}, connect: {actors: {edge: {screenTime: 90}, where: {node: {name: "Actor"}}}, _on: {Movie: {actors: {edge: {screenTime: 90}, where: {node: {name: "Different Actor"}}}}}}}}
  ) {
    actors {
      name
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_connect_actedIn0_node_param0": "The ",
  "this_connect_actedIn0_relationship_screenTime": 90,
  "this_connect_actedIn0_node_on_Movie0_actors0_node_param0": "Different Actor",
  "this_connect_actedIn0_node_on_Movie0_actors0_relationship_screenTime": 90,
  "this_connect_actedIn1_node_param0": "The ",
  "this_connect_actedIn1_relationship_screenTime": 90,
  "this_connect_actedIn1_node_actors0_node_param0": "Actor",
  "this_connect_actedIn1_node_actors0_relationship_screenTime": 90
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WITH *
CALL {
	WITH this
	OPTIONAL MATCH (this_connect_actedIn0_node:Movie)
	WHERE this_connect_actedIn0_node.title STARTS WITH $this_connect_actedIn0_node_param0
	CALL {
		WITH *
		WITH collect(this_connect_actedIn0_node) as connectedNodes, collect(this) as parentNodes
		CALL {
			WITH connectedNodes, parentNodes
			UNWIND parentNodes as this
			UNWIND connectedNodes as this_connect_actedIn0_node
			MERGE (this)-[this_connect_actedIn0_relationship:ACTED_IN]->(this_connect_actedIn0_node)
			SET this_connect_actedIn0_relationship.screenTime = $this_connect_actedIn0_relationship_screenTime
		}
	}
WITH this, this_connect_actedIn0_node

CALL {
	WITH this, this_connect_actedIn0_node
	OPTIONAL MATCH (this_connect_actedIn0_node_on_Movie0_actors0_node:Actor)
	WHERE this_connect_actedIn0_node_on_Movie0_actors0_node.name = $this_connect_actedIn0_node_on_Movie0_actors0_node_param0
	CALL {
		WITH *
		WITH this, collect(this_connect_actedIn0_node_on_Movie0_actors0_node) as connectedNodes, collect(this_connect_actedIn0_node) as parentNodes
		CALL {
			WITH connectedNodes, parentNodes
			UNWIND parentNodes as this_connect_actedIn0_node
			UNWIND connectedNodes as this_connect_actedIn0_node_on_Movie0_actors0_node
			MERGE (this_connect_actedIn0_node)<-[this_connect_actedIn0_node_on_Movie0_actors0_relationship:ACTED_IN]-(this_connect_actedIn0_node_on_Movie0_actors0_node)
			SET this_connect_actedIn0_node_on_Movie0_actors0_relationship.screenTime = $this_connect_actedIn0_node_on_Movie0_actors0_relationship_screenTime
		}
	}
WITH this, this_connect_actedIn0_node, this_connect_actedIn0_node_on_Movie0_actors0_node
	RETURN count(*) AS connect_this_connect_actedIn0_node_on_Movie0_actors_Actor0
}
	RETURN count(*) AS connect_this_connect_actedIn_Movie0
}
CALL {
		WITH this
	OPTIONAL MATCH (this_connect_actedIn1_node:Series)
	WHERE this_connect_actedIn1_node.title STARTS WITH $this_connect_actedIn1_node_param0
	CALL {
		WITH *
		WITH collect(this_connect_actedIn1_node) as connectedNodes, collect(this) as parentNodes
		CALL {
			WITH connectedNodes, parentNodes
			UNWIND parentNodes as this
			UNWIND connectedNodes as this_connect_actedIn1_node
			MERGE (this)-[this_connect_actedIn1_relationship:ACTED_IN]->(this_connect_actedIn1_node)
			SET this_connect_actedIn1_relationship.screenTime = $this_connect_actedIn1_relationship_screenTime
		}
	}
WITH this, this_connect_actedIn1_node
CALL {
	WITH this, this_connect_actedIn1_node
	OPTIONAL MATCH (this_connect_actedIn1_node_actors0_node:Actor)
	WHERE this_connect_actedIn1_node_actors0_node.name = $this_connect_actedIn1_node_actors0_node_param0
	CALL {
		WITH *
		WITH this, collect(this_connect_actedIn1_node_actors0_node) as connectedNodes, collect(this_connect_actedIn1_node) as parentNodes
		CALL {
			WITH connectedNodes, parentNodes
			UNWIND parentNodes as this_connect_actedIn1_node
			UNWIND connectedNodes as this_connect_actedIn1_node_actors0_node
			MERGE (this_connect_actedIn1_node)<-[this_connect_actedIn1_node_actors0_relationship:ACTED_IN]-(this_connect_actedIn1_node_actors0_node)
			SET this_connect_actedIn1_node_actors0_relationship.screenTime = $this_connect_actedIn1_node_actors0_relationship_screenTime
		}
	}
WITH this, this_connect_actedIn1_node, this_connect_actedIn1_node_actors0_node
	RETURN count(*) AS connect_this_connect_actedIn1_node_actors_Actor0
}
	RETURN count(*) AS connect_this_connect_actedIn_Series1
}
WITH *
RETURN collect(DISTINCT this { .name }) AS data
----

'''

