:toc:

= Interface Relationships - Update delete

== Source schema

[source,graphql,schema=true]
----
interface Production {
  title: String!
  actors: [Actor!]! @relationship(type: "ACTED_IN", direction: IN, properties: "ActedIn")
}

type Movie implements Production {
  title: String!
  runtime: Int!
  actors: [Actor!]!
}

type Series implements Production {
  title: String!
  episodes: Int!
  actors: [Actor!]!
}

interface ActedIn @relationshipProperties {
  screenTime: Int!
}

type Actor {
  name: String!
  actedIn: [Production!]! @relationship(type: "ACTED_IN", direction: OUT, properties: "ActedIn")
}
----
== Update delete an interface relationship

.GraphQL-Query
[source,graphql]
----
mutation {
  updateActors(delete: {actedIn: {where: {node: {title_STARTS_WITH: "The "}}}}) {
    actors {
      name
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "updateActors" : {
    "args" : {
      "delete" : {
        "actedIn" : [ {
          "where" : {
            "node" : {
              "title_STARTS_WITH" : "The "
            }
          }
        } ]
      }
    }
  },
  "updateActors_args_delete_actedIn0_where_this_delete_actedIn_Movie0param0" : "The ",
  "updateActors_args_delete_actedIn0_where_this_delete_actedIn_Series0param0" : "The "
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WITH *
CALL {
	WITH *
	OPTIONAL MATCH (this)-[this_delete_actedIn_Movie0_relationship:ACTED_IN]->(this_delete_actedIn_Movie0:Movie)
	WHERE this_delete_actedIn_Movie0.title STARTS WITH $updateActors_args_delete_actedIn0_where_this_delete_actedIn_Movie0param0
	WITH this_delete_actedIn_Movie0_relationship, collect(DISTINCT this_delete_actedIn_Movie0) AS this_delete_actedIn_Movie0_to_delete
	CALL {
		WITH this_delete_actedIn_Movie0_to_delete
		UNWIND this_delete_actedIn_Movie0_to_delete AS x DETACH DELETE x
	}
}
WITH *
CALL {
	WITH *
	OPTIONAL MATCH (this)-[this_delete_actedIn_Series0_relationship:ACTED_IN]->(this_delete_actedIn_Series0:Series)
	WHERE this_delete_actedIn_Series0.title STARTS WITH $updateActors_args_delete_actedIn0_where_this_delete_actedIn_Series0param0
	WITH this_delete_actedIn_Series0_relationship, collect(DISTINCT this_delete_actedIn_Series0) AS this_delete_actedIn_Series0_to_delete
	CALL {
		WITH this_delete_actedIn_Series0_to_delete
		UNWIND this_delete_actedIn_Series0_to_delete AS x DETACH DELETE x
	}
}
WITH *
RETURN collect(DISTINCT this {
	.name
}) AS data
----

'''

== Update delete an interface relationship with nested delete

.GraphQL-Query
[source,graphql]
----
mutation {
  updateActors(
    delete: {actedIn: {where: {node: {title_STARTS_WITH: "The "}}, delete: {actors: {where: {node: {name: "Actor"}}}}}}
  ) {
    actors {
      name
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "updateActors" : {
    "args" : {
      "delete" : {
        "actedIn" : [ {
          "where" : {
            "node" : {
              "title_STARTS_WITH" : "The "
            }
          },
          "delete" : {
            "actors" : [ {
              "where" : {
                "node" : {
                  "name" : "Actor"
                }
              }
            } ]
          }
        } ]
      }
    }
  },
  "updateActors_args_delete_actedIn0_delete_actors0_where_this_delete_actedIn_Movie0_actors0param0" : "Actor",
  "updateActors_args_delete_actedIn0_delete_actors0_where_this_delete_actedIn_Series0_actors0param0" : "Actor",
  "updateActors_args_delete_actedIn0_where_this_delete_actedIn_Movie0param0" : "The ",
  "updateActors_args_delete_actedIn0_where_this_delete_actedIn_Series0param0" : "The "
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WITH *
CALL {
	WITH *
	OPTIONAL MATCH (this)-[this_delete_actedIn_Movie0_relationship:ACTED_IN]->(this_delete_actedIn_Movie0:Movie)
	WHERE this_delete_actedIn_Movie0.title STARTS WITH $updateActors_args_delete_actedIn0_where_this_delete_actedIn_Movie0param0
	WITH *
	CALL {
		WITH *
		OPTIONAL MATCH (this_delete_actedIn_Movie0)<-[this_delete_actedIn_Movie0_actors0_relationship:ACTED_IN]-(this_delete_actedIn_Movie0_actors0:Actor)
		WHERE this_delete_actedIn_Movie0_actors0.name = $updateActors_args_delete_actedIn0_delete_actors0_where_this_delete_actedIn_Movie0_actors0param0
		WITH this_delete_actedIn_Movie0_actors0_relationship, collect(DISTINCT this_delete_actedIn_Movie0_actors0) AS this_delete_actedIn_Movie0_actors0_to_delete
		CALL {
			WITH this_delete_actedIn_Movie0_actors0_to_delete
			UNWIND this_delete_actedIn_Movie0_actors0_to_delete AS x DETACH DELETE x
		}
	}
	WITH this_delete_actedIn_Movie0_relationship, collect(DISTINCT this_delete_actedIn_Movie0) AS this_delete_actedIn_Movie0_to_delete
	CALL {
		WITH this_delete_actedIn_Movie0_to_delete
		UNWIND this_delete_actedIn_Movie0_to_delete AS x DETACH DELETE x
	}
}
WITH *
CALL {
	WITH *
	OPTIONAL MATCH (this)-[this_delete_actedIn_Series0_relationship:ACTED_IN]->(this_delete_actedIn_Series0:Series)
	WHERE this_delete_actedIn_Series0.title STARTS WITH $updateActors_args_delete_actedIn0_where_this_delete_actedIn_Series0param0
	WITH *
	CALL {
		WITH *
		OPTIONAL MATCH (this_delete_actedIn_Series0)<-[this_delete_actedIn_Series0_actors0_relationship:ACTED_IN]-(this_delete_actedIn_Series0_actors0:Actor)
		WHERE this_delete_actedIn_Series0_actors0.name = $updateActors_args_delete_actedIn0_delete_actors0_where_this_delete_actedIn_Series0_actors0param0
		WITH this_delete_actedIn_Series0_actors0_relationship, collect(DISTINCT this_delete_actedIn_Series0_actors0) AS this_delete_actedIn_Series0_actors0_to_delete
		CALL {
			WITH this_delete_actedIn_Series0_actors0_to_delete
			UNWIND this_delete_actedIn_Series0_actors0_to_delete AS x DETACH DELETE x
		}
	}
	WITH this_delete_actedIn_Series0_relationship, collect(DISTINCT this_delete_actedIn_Series0) AS this_delete_actedIn_Series0_to_delete
	CALL {
		WITH this_delete_actedIn_Series0_to_delete
		UNWIND this_delete_actedIn_Series0_to_delete AS x DETACH DELETE x
	}
}
WITH *
RETURN collect(DISTINCT this {
	.name
}) AS data
----

'''

== Update delete an interface relationship with nested delete using _on to delete from only one implementation

.GraphQL-Query
[source,graphql]
----
mutation {
  updateActors(
    delete: {actedIn: {where: {node: {title_STARTS_WITH: "The "}}, delete: {_on: {Movie: {actors: {where: {node: {name: "Actor"}}}}}}}}
  ) {
    actors {
      name
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "updateActors" : {
    "args" : {
      "delete" : {
        "actedIn" : [ {
          "where" : {
            "node" : {
              "title_STARTS_WITH" : "The "
            }
          },
          "delete" : {
            "_on" : {
              "Movie" : [ {
                "actors" : [ {
                  "where" : {
                    "node" : {
                      "name" : "Actor"
                    }
                  }
                } ]
              } ]
            }
          }
        } ]
      }
    }
  },
  "updateActors_args_delete_actedIn0_delete__on_Movie0_actors0_where_this_delete_actedIn_Movie0_actors0param0" : "Actor",
  "updateActors_args_delete_actedIn0_where_this_delete_actedIn_Movie0param0" : "The ",
  "updateActors_args_delete_actedIn0_where_this_delete_actedIn_Series0param0" : "The "
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WITH *
CALL {
	WITH *
	OPTIONAL MATCH (this)-[this_delete_actedIn_Movie0_relationship:ACTED_IN]->(this_delete_actedIn_Movie0:Movie)
	WHERE this_delete_actedIn_Movie0.title STARTS WITH $updateActors_args_delete_actedIn0_where_this_delete_actedIn_Movie0param0
	WITH *
	CALL {
		WITH *
		OPTIONAL MATCH (this_delete_actedIn_Movie0)<-[this_delete_actedIn_Movie0_actors0_relationship:ACTED_IN]-(this_delete_actedIn_Movie0_actors0:Actor)
		WHERE this_delete_actedIn_Movie0_actors0.name = $updateActors_args_delete_actedIn0_delete__on_Movie0_actors0_where_this_delete_actedIn_Movie0_actors0param0
		WITH this_delete_actedIn_Movie0_actors0_relationship, collect(DISTINCT this_delete_actedIn_Movie0_actors0) AS this_delete_actedIn_Movie0_actors0_to_delete
		CALL {
			WITH this_delete_actedIn_Movie0_actors0_to_delete
			UNWIND this_delete_actedIn_Movie0_actors0_to_delete AS x DETACH DELETE x
		}
	}
	WITH this_delete_actedIn_Movie0_relationship, collect(DISTINCT this_delete_actedIn_Movie0) AS this_delete_actedIn_Movie0_to_delete
	CALL {
		WITH this_delete_actedIn_Movie0_to_delete
		UNWIND this_delete_actedIn_Movie0_to_delete AS x DETACH DELETE x
	}
}
WITH *
CALL {
	WITH *
	OPTIONAL MATCH (this)-[this_delete_actedIn_Series0_relationship:ACTED_IN]->(this_delete_actedIn_Series0:Series)
	WHERE this_delete_actedIn_Series0.title STARTS WITH $updateActors_args_delete_actedIn0_where_this_delete_actedIn_Series0param0
	WITH this_delete_actedIn_Series0_relationship, collect(DISTINCT this_delete_actedIn_Series0) AS this_delete_actedIn_Series0_to_delete
	CALL {
		WITH this_delete_actedIn_Series0_to_delete
		UNWIND this_delete_actedIn_Series0_to_delete AS x DETACH DELETE x
	}
}
WITH *
RETURN collect(DISTINCT this {
	.name
}) AS data
----

'''

== Update delete an interface relationship with nested delete using _on to override deletion

.GraphQL-Query
[source,graphql]
----
mutation {
  updateActors(
    delete: {actedIn: {where: {node: {title_STARTS_WITH: "The "}}, delete: {actors: {where: {node: {name: "Actor"}}}, _on: {Movie: {actors: {where: {node: {name: "Different Actor"}}}}}}}}
  ) {
    actors {
      name
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "updateActors" : {
    "args" : {
      "delete" : {
        "actedIn" : [ {
          "where" : {
            "node" : {
              "title_STARTS_WITH" : "The "
            }
          },
          "delete" : {
            "_on" : {
              "Movie" : [ {
                "actors" : [ {
                  "where" : {
                    "node" : {
                      "name" : "Different Actor"
                    }
                  }
                } ]
              } ]
            },
            "actors" : [ {
              "where" : {
                "node" : {
                  "name" : "Actor"
                }
              }
            } ]
          }
        } ]
      }
    }
  },
  "updateActors_args_delete_actedIn0_delete__on_Movie0_actors0_where_this_delete_actedIn_Movie0_actors0param0" : "Different Actor",
  "updateActors_args_delete_actedIn0_delete_actors0_where_this_delete_actedIn_Series0_actors0param0" : "Actor",
  "updateActors_args_delete_actedIn0_where_this_delete_actedIn_Movie0param0" : "The ",
  "updateActors_args_delete_actedIn0_where_this_delete_actedIn_Series0param0" : "The "
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WITH *
CALL {
	WITH *
	OPTIONAL MATCH (this)-[this_delete_actedIn_Movie0_relationship:ACTED_IN]->(this_delete_actedIn_Movie0:Movie)
	WHERE this_delete_actedIn_Movie0.title STARTS WITH $updateActors_args_delete_actedIn0_where_this_delete_actedIn_Movie0param0
	WITH *
	CALL {
		WITH *
		OPTIONAL MATCH (this_delete_actedIn_Movie0)<-[this_delete_actedIn_Movie0_actors0_relationship:ACTED_IN]-(this_delete_actedIn_Movie0_actors0:Actor)
		WHERE this_delete_actedIn_Movie0_actors0.name = $updateActors_args_delete_actedIn0_delete__on_Movie0_actors0_where_this_delete_actedIn_Movie0_actors0param0
		WITH this_delete_actedIn_Movie0_actors0_relationship, collect(DISTINCT this_delete_actedIn_Movie0_actors0) AS this_delete_actedIn_Movie0_actors0_to_delete
		CALL {
			WITH this_delete_actedIn_Movie0_actors0_to_delete
			UNWIND this_delete_actedIn_Movie0_actors0_to_delete AS x DETACH DELETE x
		}
	}
	WITH this_delete_actedIn_Movie0_relationship, collect(DISTINCT this_delete_actedIn_Movie0) AS this_delete_actedIn_Movie0_to_delete
	CALL {
		WITH this_delete_actedIn_Movie0_to_delete
		UNWIND this_delete_actedIn_Movie0_to_delete AS x DETACH DELETE x
	}
}
WITH *
CALL {
	WITH *
	OPTIONAL MATCH (this)-[this_delete_actedIn_Series0_relationship:ACTED_IN]->(this_delete_actedIn_Series0:Series)
	WHERE this_delete_actedIn_Series0.title STARTS WITH $updateActors_args_delete_actedIn0_where_this_delete_actedIn_Series0param0
	WITH *
	CALL {
		WITH *
		OPTIONAL MATCH (this_delete_actedIn_Series0)<-[this_delete_actedIn_Series0_actors0_relationship:ACTED_IN]-(this_delete_actedIn_Series0_actors0:Actor)
		WHERE this_delete_actedIn_Series0_actors0.name = $updateActors_args_delete_actedIn0_delete_actors0_where_this_delete_actedIn_Series0_actors0param0
		WITH this_delete_actedIn_Series0_actors0_relationship, collect(DISTINCT this_delete_actedIn_Series0_actors0) AS this_delete_actedIn_Series0_actors0_to_delete
		CALL {
			WITH this_delete_actedIn_Series0_actors0_to_delete
			UNWIND this_delete_actedIn_Series0_actors0_to_delete AS x DETACH DELETE x
		}
	}
	WITH this_delete_actedIn_Series0_relationship, collect(DISTINCT this_delete_actedIn_Series0) AS this_delete_actedIn_Series0_to_delete
	CALL {
		WITH this_delete_actedIn_Series0_to_delete
		UNWIND this_delete_actedIn_Series0_to_delete AS x DETACH DELETE x
	}
}
WITH *
RETURN collect(DISTINCT this {
	.name
}) AS data
----

'''

