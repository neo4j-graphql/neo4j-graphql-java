:toc:

= Interface Relationships - Update delete

== Source schema

[source,graphql,schema=true]
----
interface Production {
  title: String!
  actors: [Actor!]! @relationship(type: "ACTED_IN", direction: IN, properties: "ActedIn")
}

type Movie implements Production {
  title: String!
  runtime: Int!
  actors: [Actor!]!
}

type Series implements Production {
  title: String!
  episodes: Int!
  actors: [Actor!]!
}

interface ActedIn @relationshipProperties {
  screenTime: Int!
}

type Actor {
  name: String!
  actedIn: [Production!]! @relationship(type: "ACTED_IN", direction: OUT, properties: "ActedIn")
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{
  "enableRegex": true
}
----
== Update delete an interface relationship

.GraphQL-Query
[source,graphql]
----
mutation {
  updateActors(delete: {actedIn: {where: {node: {title_STARTS_WITH: "The "}}}}) {
    actors {
      name
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "updateActors_args_delete_actedIn0_where_Movieparam0": "The ",
  "updateActors_args_delete_actedIn0_where_Seriesparam0": "The ",
  "updateActors": {
    "args": {
      "delete": {
        "actedIn": [
          {
            "where": {
              "node": {
                "title_STARTS_WITH": "The "
              }
            }
          }
        ]
      }
    }
  },
  "resolvedCallbacks": {}
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WITH this
OPTIONAL MATCH (this)-[this_delete_actedIn_Movie0_relationship:ACTED_IN]->(this_delete_actedIn_Movie0:Movie)
WHERE this_delete_actedIn_Movie0.title STARTS WITH $updateActors_args_delete_actedIn0_where_Movieparam0
WITH this, collect(DISTINCT this_delete_actedIn_Movie0) AS this_delete_actedIn_Movie0_to_delete
CALL {
	WITH this_delete_actedIn_Movie0_to_delete
	UNWIND this_delete_actedIn_Movie0_to_delete AS x
	DETACH DELETE x
	RETURN count(*) AS _
}
WITH this
OPTIONAL MATCH (this)-[this_delete_actedIn_Series0_relationship:ACTED_IN]->(this_delete_actedIn_Series0:Series)
WHERE this_delete_actedIn_Series0.title STARTS WITH $updateActors_args_delete_actedIn0_where_Seriesparam0
WITH this, collect(DISTINCT this_delete_actedIn_Series0) AS this_delete_actedIn_Series0_to_delete
CALL {
	WITH this_delete_actedIn_Series0_to_delete
	UNWIND this_delete_actedIn_Series0_to_delete AS x
	DETACH DELETE x
	RETURN count(*) AS _
}
WITH *
RETURN collect(DISTINCT this {
	.name
}) AS data
----

'''

== Update delete an interface relationship with nested delete

.GraphQL-Query
[source,graphql]
----
mutation {
  updateActors(
    delete: {actedIn: {where: {node: {title_STARTS_WITH: "The "}}, delete: {actors: {where: {node: {name: "Actor"}}}}}}
  ) {
    actors {
      name
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "updateActors_args_delete_actedIn0_where_Movieparam0": "The ",
  "updateActors_args_delete_actedIn0_delete_actors0_where_Actorparam0": "Actor",
  "updateActors_args_delete_actedIn0_where_Seriesparam0": "The ",
  "updateActors": {
    "args": {
      "delete": {
        "actedIn": [
          {
            "delete": {
              "actors": [
                {
                  "where": {
                    "node": {
                      "name": "Actor"
                    }
                  }
                }
              ]
            },
            "where": {
              "node": {
                "title_STARTS_WITH": "The "
              }
            }
          }
        ]
      }
    }
  },
  "resolvedCallbacks": {}
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WITH this
OPTIONAL MATCH (this)-[this_delete_actedIn_Movie0_relationship:ACTED_IN]->(this_delete_actedIn_Movie0:Movie)
WHERE this_delete_actedIn_Movie0.title STARTS WITH $updateActors_args_delete_actedIn0_where_Movieparam0
WITH this, this_delete_actedIn_Movie0
OPTIONAL MATCH (this_delete_actedIn_Movie0)<-[this_delete_actedIn_Movie0_actors0_relationship:ACTED_IN]-(this_delete_actedIn_Movie0_actors0:Actor)
WHERE this_delete_actedIn_Movie0_actors0.name = $updateActors_args_delete_actedIn0_delete_actors0_where_Actorparam0
WITH this, this_delete_actedIn_Movie0, collect(DISTINCT this_delete_actedIn_Movie0_actors0) AS this_delete_actedIn_Movie0_actors0_to_delete
CALL {
	WITH this_delete_actedIn_Movie0_actors0_to_delete
	UNWIND this_delete_actedIn_Movie0_actors0_to_delete AS x
	DETACH DELETE x
	RETURN count(*) AS _
}
WITH this, collect(DISTINCT this_delete_actedIn_Movie0) AS this_delete_actedIn_Movie0_to_delete
CALL {
	WITH this_delete_actedIn_Movie0_to_delete
	UNWIND this_delete_actedIn_Movie0_to_delete AS x
	DETACH DELETE x
	RETURN count(*) AS _
}
WITH this
OPTIONAL MATCH (this)-[this_delete_actedIn_Series0_relationship:ACTED_IN]->(this_delete_actedIn_Series0:Series)
WHERE this_delete_actedIn_Series0.title STARTS WITH $updateActors_args_delete_actedIn0_where_Seriesparam0
WITH this, this_delete_actedIn_Series0
OPTIONAL MATCH (this_delete_actedIn_Series0)<-[this_delete_actedIn_Series0_actors0_relationship:ACTED_IN]-(this_delete_actedIn_Series0_actors0:Actor)
WHERE this_delete_actedIn_Series0_actors0.name = $updateActors_args_delete_actedIn0_delete_actors0_where_Actorparam0
WITH this, this_delete_actedIn_Series0, collect(DISTINCT this_delete_actedIn_Series0_actors0) AS this_delete_actedIn_Series0_actors0_to_delete
CALL {
	WITH this_delete_actedIn_Series0_actors0_to_delete
	UNWIND this_delete_actedIn_Series0_actors0_to_delete AS x
	DETACH DELETE x
	RETURN count(*) AS _
}
WITH this, collect(DISTINCT this_delete_actedIn_Series0) AS this_delete_actedIn_Series0_to_delete
CALL {
	WITH this_delete_actedIn_Series0_to_delete
	UNWIND this_delete_actedIn_Series0_to_delete AS x
	DETACH DELETE x
	RETURN count(*) AS _
}
WITH *
RETURN collect(DISTINCT this {
	.name
}) AS data
----

'''

== Update delete an interface relationship with nested delete using _on to delete from only one implementation

.GraphQL-Query
[source,graphql]
----
mutation {
  updateActors(
    delete: {actedIn: {where: {node: {title_STARTS_WITH: "The "}}, delete: {_on: {Movie: {actors: {where: {node: {name: "Actor"}}}}}}}}
  ) {
    actors {
      name
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "updateActors_args_delete_actedIn0_where_Movieparam0": "The ",
  "updateActors_args_delete_actedIn0_delete__on_Movie0_actors0_where_Actorparam0": "Actor",
  "updateActors_args_delete_actedIn0_where_Seriesparam0": "The ",
  "updateActors": {
    "args": {
      "delete": {
        "actedIn": [
          {
            "delete": {
              "_on": {
                "Movie": [
                  {
                    "actors": [
                      {
                        "where": {
                          "node": {
                            "name": "Actor"
                          }
                        }
                      }
                    ]
                  }
                ]
              }
            },
            "where": {
              "node": {
                "title_STARTS_WITH": "The "
              }
            }
          }
        ]
      }
    }
  },
  "resolvedCallbacks": {}
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WITH this
OPTIONAL MATCH (this)-[this_delete_actedIn_Movie0_relationship:ACTED_IN]->(this_delete_actedIn_Movie0:Movie)
WHERE this_delete_actedIn_Movie0.title STARTS WITH $updateActors_args_delete_actedIn0_where_Movieparam0
WITH this, this_delete_actedIn_Movie0
OPTIONAL MATCH (this_delete_actedIn_Movie0)<-[this_delete_actedIn_Movie0_actors0_relationship:ACTED_IN]-(this_delete_actedIn_Movie0_actors0:Actor)
WHERE this_delete_actedIn_Movie0_actors0.name = $updateActors_args_delete_actedIn0_delete__on_Movie0_actors0_where_Actorparam0
WITH this, this_delete_actedIn_Movie0, collect(DISTINCT this_delete_actedIn_Movie0_actors0) AS this_delete_actedIn_Movie0_actors0_to_delete
CALL {
	WITH this_delete_actedIn_Movie0_actors0_to_delete
	UNWIND this_delete_actedIn_Movie0_actors0_to_delete AS x
	DETACH DELETE x
	RETURN count(*) AS _
}
WITH this, collect(DISTINCT this_delete_actedIn_Movie0) AS this_delete_actedIn_Movie0_to_delete
CALL {
	WITH this_delete_actedIn_Movie0_to_delete
	UNWIND this_delete_actedIn_Movie0_to_delete AS x
	DETACH DELETE x
	RETURN count(*) AS _
}
WITH this
OPTIONAL MATCH (this)-[this_delete_actedIn_Series0_relationship:ACTED_IN]->(this_delete_actedIn_Series0:Series)
WHERE this_delete_actedIn_Series0.title STARTS WITH $updateActors_args_delete_actedIn0_where_Seriesparam0
WITH this, collect(DISTINCT this_delete_actedIn_Series0) AS this_delete_actedIn_Series0_to_delete
CALL {
	WITH this_delete_actedIn_Series0_to_delete
	UNWIND this_delete_actedIn_Series0_to_delete AS x
	DETACH DELETE x
	RETURN count(*) AS _
}
WITH *
RETURN collect(DISTINCT this {
	.name
}) AS data
----

'''

== Update delete an interface relationship with nested delete using _on to override deletion

.GraphQL-Query
[source,graphql]
----
mutation {
  updateActors(
    delete: {actedIn: {where: {node: {title_STARTS_WITH: "The "}}, delete: {actors: {where: {node: {name: "Actor"}}}, _on: {Movie: {actors: {where: {node: {name: "Different Actor"}}}}}}}}
  ) {
    actors {
      name
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "updateActors_args_delete_actedIn0_where_Movieparam0": "The ",
  "updateActors_args_delete_actedIn0_delete__on_Movie0_actors0_where_Actorparam0": "Different Actor",
  "updateActors_args_delete_actedIn0_where_Seriesparam0": "The ",
  "updateActors_args_delete_actedIn0_delete_actors0_where_Actorparam0": "Actor",
  "updateActors": {
    "args": {
      "delete": {
        "actedIn": [
          {
            "delete": {
              "actors": [
                {
                  "where": {
                    "node": {
                      "name": "Actor"
                    }
                  }
                }
              ],
              "_on": {
                "Movie": [
                  {
                    "actors": [
                      {
                        "where": {
                          "node": {
                            "name": "Different Actor"
                          }
                        }
                      }
                    ]
                  }
                ]
              }
            },
            "where": {
              "node": {
                "title_STARTS_WITH": "The "
              }
            }
          }
        ]
      }
    }
  },
  "resolvedCallbacks": {}
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WITH this
OPTIONAL MATCH (this)-[this_delete_actedIn_Movie0_relationship:ACTED_IN]->(this_delete_actedIn_Movie0:Movie)
WHERE this_delete_actedIn_Movie0.title STARTS WITH $updateActors_args_delete_actedIn0_where_Movieparam0
WITH this, this_delete_actedIn_Movie0
OPTIONAL MATCH (this_delete_actedIn_Movie0)<-[this_delete_actedIn_Movie0_actors0_relationship:ACTED_IN]-(this_delete_actedIn_Movie0_actors0:Actor)
WHERE this_delete_actedIn_Movie0_actors0.name = $updateActors_args_delete_actedIn0_delete__on_Movie0_actors0_where_Actorparam0
WITH this, this_delete_actedIn_Movie0, collect(DISTINCT this_delete_actedIn_Movie0_actors0) AS this_delete_actedIn_Movie0_actors0_to_delete
CALL {
	WITH this_delete_actedIn_Movie0_actors0_to_delete
	UNWIND this_delete_actedIn_Movie0_actors0_to_delete AS x
	DETACH DELETE x
	RETURN count(*) AS _
}
WITH this, collect(DISTINCT this_delete_actedIn_Movie0) AS this_delete_actedIn_Movie0_to_delete
CALL {
	WITH this_delete_actedIn_Movie0_to_delete
	UNWIND this_delete_actedIn_Movie0_to_delete AS x
	DETACH DELETE x
	RETURN count(*) AS _
}
WITH this
OPTIONAL MATCH (this)-[this_delete_actedIn_Series0_relationship:ACTED_IN]->(this_delete_actedIn_Series0:Series)
WHERE this_delete_actedIn_Series0.title STARTS WITH $updateActors_args_delete_actedIn0_where_Seriesparam0
WITH this, this_delete_actedIn_Series0
OPTIONAL MATCH (this_delete_actedIn_Series0)<-[this_delete_actedIn_Series0_actors0_relationship:ACTED_IN]-(this_delete_actedIn_Series0_actors0:Actor)
WHERE this_delete_actedIn_Series0_actors0.name = $updateActors_args_delete_actedIn0_delete_actors0_where_Actorparam0
WITH this, this_delete_actedIn_Series0, collect(DISTINCT this_delete_actedIn_Series0_actors0) AS this_delete_actedIn_Series0_actors0_to_delete
CALL {
	WITH this_delete_actedIn_Series0_actors0_to_delete
	UNWIND this_delete_actedIn_Series0_actors0_to_delete AS x
	DETACH DELETE x
	RETURN count(*) AS _
}
WITH this, collect(DISTINCT this_delete_actedIn_Series0) AS this_delete_actedIn_Series0_to_delete
CALL {
	WITH this_delete_actedIn_Series0_to_delete
	UNWIND this_delete_actedIn_Series0_to_delete AS x
	DETACH DELETE x
	RETURN count(*) AS _
}
WITH *
RETURN collect(DISTINCT this {
	.name
}) AS data
----

'''

