:toc:

= Interface Relationships - Update disconnect

== Source schema

[source,graphql,schema=true]
----
interface Production {
  title: String!
  actors: [Actor!]! @declareRelationship
}

type Movie implements Production {
  title: String!
  runtime: Int!
  actors: [Actor!]! @relationship(type: "ACTED_IN", direction: IN, properties: "ActedIn")
}

type Series implements Production {
  title: String!
  episodes: Int!
  actors: [Actor!]! @relationship(type: "ACTED_IN", direction: IN, properties: "ActedIn")
}

type ActedIn @relationshipProperties {
  screenTime: Int!
}

type Actor {
  name: String!
  actedIn: [Production!]! @relationship(type: "ACTED_IN", direction: OUT, properties: "ActedIn")
}
----
== Update disconnect from an interface relationship

.GraphQL-Query
[source,graphql]
----
mutation {
  updateActors(
    disconnect: {actedIn: {where: {node: {title_STARTS_WITH: "The "}}}}
  ) {
    actors {
      name
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "updateActors_args_disconnect_actedIn0_where_Movie_this_disconnect_actedIn0param0": "The ",
  "updateActors_args_disconnect_actedIn0_where_Series_this_disconnect_actedIn0param0": "The ",
  "updateActors": {
    "args": {
      "disconnect": {
        "actedIn": [
          {
            "where": {
              "node": {
                "title_STARTS_WITH": "The "
              }
            }
          }
        ]
      }
    }
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WITH this
CALL {
WITH this
OPTIONAL MATCH (this)-[this_disconnect_actedIn0_rel:ACTED_IN]->(this_disconnect_actedIn0:Movie)
WHERE this_disconnect_actedIn0.title STARTS WITH $updateActors_args_disconnect_actedIn0_where_Movie_this_disconnect_actedIn0param0
CALL {
	WITH this_disconnect_actedIn0, this_disconnect_actedIn0_rel, this
	WITH collect(this_disconnect_actedIn0) as this_disconnect_actedIn0, this_disconnect_actedIn0_rel, this
	UNWIND this_disconnect_actedIn0 as x
	DELETE this_disconnect_actedIn0_rel
}
RETURN count(*) AS disconnect_this_disconnect_actedIn_Movie
}
CALL {
	WITH this
OPTIONAL MATCH (this)-[this_disconnect_actedIn0_rel:ACTED_IN]->(this_disconnect_actedIn0:Series)
WHERE this_disconnect_actedIn0.title STARTS WITH $updateActors_args_disconnect_actedIn0_where_Series_this_disconnect_actedIn0param0
CALL {
	WITH this_disconnect_actedIn0, this_disconnect_actedIn0_rel, this
	WITH collect(this_disconnect_actedIn0) as this_disconnect_actedIn0, this_disconnect_actedIn0_rel, this
	UNWIND this_disconnect_actedIn0 as x
	DELETE this_disconnect_actedIn0_rel
}
RETURN count(*) AS disconnect_this_disconnect_actedIn_Series
}
WITH *
RETURN collect(DISTINCT this { .name }) AS data
----

'''

== Update disconnect from an interface relationship with nested disconnect

.GraphQL-Query
[source,graphql]
----
mutation {
  updateActors(
    disconnect: {actedIn: {where: {node: {title_STARTS_WITH: "The "}}, disconnect: {actors: {where: {node: {name: "Actor"}}}}}}
  ) {
    actors {
      name
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "updateActors_args_disconnect_actedIn0_where_Movie_this_disconnect_actedIn0param0": "The ",
  "updateActors_args_disconnect_actedIn0_disconnect_actors0_where_Actor_this_disconnect_actedIn0_actors0param0": "Actor",
  "updateActors_args_disconnect_actedIn0_where_Series_this_disconnect_actedIn0param0": "The ",
  "updateActors": {
    "args": {
      "disconnect": {
        "actedIn": [
          {
            "where": {
              "node": {
                "title_STARTS_WITH": "The "
              }
            },
            "disconnect": {
              "actors": [
                {
                  "where": {
                    "node": {
                      "name": "Actor"
                    }
                  }
                }
              ]
            }
          }
        ]
      }
    }
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WITH this
CALL {
WITH this
OPTIONAL MATCH (this)-[this_disconnect_actedIn0_rel:ACTED_IN]->(this_disconnect_actedIn0:Movie)
WHERE this_disconnect_actedIn0.title STARTS WITH $updateActors_args_disconnect_actedIn0_where_Movie_this_disconnect_actedIn0param0
CALL {
	WITH this_disconnect_actedIn0, this_disconnect_actedIn0_rel, this
	WITH collect(this_disconnect_actedIn0) as this_disconnect_actedIn0, this_disconnect_actedIn0_rel, this
	UNWIND this_disconnect_actedIn0 as x
	DELETE this_disconnect_actedIn0_rel
}
CALL {
WITH this, this_disconnect_actedIn0
OPTIONAL MATCH (this_disconnect_actedIn0)<-[this_disconnect_actedIn0_actors0_rel:ACTED_IN]-(this_disconnect_actedIn0_actors0:Actor)
WHERE this_disconnect_actedIn0_actors0.name = $updateActors_args_disconnect_actedIn0_disconnect_actors0_where_Actor_this_disconnect_actedIn0_actors0param0
CALL {
	WITH this_disconnect_actedIn0_actors0, this_disconnect_actedIn0_actors0_rel, this_disconnect_actedIn0
	WITH collect(this_disconnect_actedIn0_actors0) as this_disconnect_actedIn0_actors0, this_disconnect_actedIn0_actors0_rel, this_disconnect_actedIn0
	UNWIND this_disconnect_actedIn0_actors0 as x
	DELETE this_disconnect_actedIn0_actors0_rel
}
RETURN count(*) AS disconnect_this_disconnect_actedIn0_actors_Actor
}
RETURN count(*) AS disconnect_this_disconnect_actedIn_Movie
}
CALL {
	WITH this
OPTIONAL MATCH (this)-[this_disconnect_actedIn0_rel:ACTED_IN]->(this_disconnect_actedIn0:Series)
WHERE this_disconnect_actedIn0.title STARTS WITH $updateActors_args_disconnect_actedIn0_where_Series_this_disconnect_actedIn0param0
CALL {
	WITH this_disconnect_actedIn0, this_disconnect_actedIn0_rel, this
	WITH collect(this_disconnect_actedIn0) as this_disconnect_actedIn0, this_disconnect_actedIn0_rel, this
	UNWIND this_disconnect_actedIn0 as x
	DELETE this_disconnect_actedIn0_rel
}
CALL {
WITH this, this_disconnect_actedIn0
OPTIONAL MATCH (this_disconnect_actedIn0)<-[this_disconnect_actedIn0_actors0_rel:ACTED_IN]-(this_disconnect_actedIn0_actors0:Actor)
WHERE this_disconnect_actedIn0_actors0.name = $updateActors_args_disconnect_actedIn0_disconnect_actors0_where_Actor_this_disconnect_actedIn0_actors0param0
CALL {
	WITH this_disconnect_actedIn0_actors0, this_disconnect_actedIn0_actors0_rel, this_disconnect_actedIn0
	WITH collect(this_disconnect_actedIn0_actors0) as this_disconnect_actedIn0_actors0, this_disconnect_actedIn0_actors0_rel, this_disconnect_actedIn0
	UNWIND this_disconnect_actedIn0_actors0 as x
	DELETE this_disconnect_actedIn0_actors0_rel
}
RETURN count(*) AS disconnect_this_disconnect_actedIn0_actors_Actor
}
RETURN count(*) AS disconnect_this_disconnect_actedIn_Series
}
WITH *
RETURN collect(DISTINCT this { .name }) AS data
----

'''

