:toc:

= Label in Node directive

== Source schema

[source,graphql,schema=true]
----
type Actor @node(label: "Person") {
  name: String
  movies: [Movie!]! @relationship(type: "ACTED_IN", direction: OUT)
}

type Movie @node(label: "Film") {
  id: ID
  title: String
  actors: [Actor!]! @relationship(type: "ACTED_IN", direction: IN)
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{
  "enableRegex": true
}
----
== Admin Deletes Post

.GraphQL-Query
[source,graphql]
----
mutation {
  deleteMovies(where: {actors: {name: "tom"}}) {
    nodesDeleted
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "tom"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Film)
WHERE EXISTS {
	MATCH (this0:Person)-[:ACTED_IN]->(this)
	WHERE this0.name = $param0
} DETACH DELETE this
----

'''

== Create Movie and relation with custom labels

.GraphQL-Query
[source,graphql]
----
mutation {
  createMovies(
    input: [{id: 1, actors: {create: [{node: {name: "actor 1"}}]}}, {id: 2, actors: {create: [{node: {name: "actor 2"}}]}}]
  ) {
    movies {
      id
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "create_param0" : [ {
    "id" : "1",
    "actors" : {
      "create" : [ {
        "node" : {
          "name" : "actor 1"
        }
      } ]
    }
  }, {
    "id" : "2",
    "actors" : {
      "create" : [ {
        "node" : {
          "name" : "actor 2"
        }
      } ]
    }
  } ]
}
----

.Expected Cypher output
[source,cypher]
----
UNWIND $create_param0 AS create_var1
CALL {
	WITH create_var1
	CREATE (create_this0:Film)
	SET create_this0.id = create_var1.id
	WITH create_this0, create_var1
	CALL {
		WITH create_this0, create_var1
		UNWIND create_var1.actors.create AS create_var2
		WITH create_var2.node AS create_var3, create_var2.edge AS create_var4, create_this0
		CREATE (create_this5:Person)
		SET create_this5.name = create_var3.name
		MERGE (create_this5)-[create_this6:ACTED_IN]->(create_this0)
		RETURN collect(NULL) AS create_var7
	}
	RETURN create_this0
}
RETURN collect(create_this0 {
	.id
}) AS data
----

'''

== Create Movie with label Film

.GraphQL-Query
[source,graphql]
----
mutation {
  createMovies(input: [{id: "1"}]) {
    movies {
      id
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "create_param0" : [ {
    "id" : "1"
  } ]
}
----

.Expected Cypher output
[source,cypher]
----
UNWIND $create_param0 AS create_var1
CALL {
	WITH create_var1
	CREATE (create_this0:Film)
	SET create_this0.id = create_var1.id
	RETURN create_this0
}
RETURN collect(create_this0 {
	.id
}) AS data
----

'''

== Delete Movie with custom label

.GraphQL-Query
[source,graphql]
----
mutation {
  deleteMovies(where: {id: "123"}) {
    nodesDeleted
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "123"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Film)
WHERE this.id = $param0 DETACH DELETE this
----

'''

== Delete Movies and actors with custom labels

.GraphQL-Query
[source,graphql]
----
mutation {
  deleteMovies(
    where: {id: 123}
    delete: {actors: {where: {node: {name: "Actor to delete"}}}}
  ) {
    nodesDeleted
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "123",
  "this_deleteMovies" : {
    "args" : {
      "delete" : {
        "actors" : [ {
          "where" : {
            "node" : {
              "name" : "Actor to delete"
            }
          }
        } ]
      }
    }
  },
  "this_deleteMovies_args_delete_actors0_where_Actorparam0" : "Actor to delete"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Film)
WHERE this.id = $param0
WITH this
OPTIONAL MATCH (this)<-[this_actors0_relationship:ACTED_IN]-(this_actors0:Person)
WHERE this_actors0.name = $this_deleteMovies_args_delete_actors0_where_Actorparam0
WITH this, collect(DISTINCT this_actors0) AS this_actors0_to_delete
CALL {
	WITH this_actors0_to_delete
	UNWIND this_actors0_to_delete AS x DETACH DELETE x
	RETURN count(*) AS _
} DETACH DELETE this
----

'''

== Select movie and actor with custom labels

.GraphQL-Query
[source,graphql]
----
{
  movies {
    title
    actors {
      name
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{ }
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Film)
CALL {
	WITH this
	MATCH (this_actors:Person)-[this0:ACTED_IN]->(this)
	WITH this_actors {
		.name
	} AS this_actors
	RETURN collect(this_actors) AS this_actors
}
RETURN this {
	.title,
	actors: this_actors
} AS this
----

'''

== Select movie and actor with custom labels using Relay connection

.GraphQL-Query
[source,graphql]
----
{
  movies {
    title
    actorsConnection {
      edges {
        node {
          name
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{ }
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Film)
CALL {
	WITH this
	MATCH (this)<-[this_connection_actorsConnectionthis0:ACTED_IN]-(this_Actor:Person)
	WITH {
		node: {
			name: this_Actor.name
		}
	} AS edge
	WITH collect(edge) AS edges
	WITH edges, size(edges) AS totalCount
	RETURN {
		edges: edges,
		totalCount: totalCount
	} AS this_actorsConnection
}
RETURN this {
	.title,
	actorsConnection: this_actorsConnection
} AS this
----

'''

== Select Movie with label Film

.GraphQL-Query
[source,graphql]
----
{
  movies {
    title
  }
}
----

.Expected Cypher params
[source,json]
----
{ }
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Film)
RETURN this {
	.title
} AS this
----

'''

== Update connection in Movie with label film

.GraphQL-Query
[source,graphql]
----
mutation {
  updateMovies(
    where: {id: "1"}
    connect: {actors: [{where: {node: {name: "Daniel"}}}]}
  ) {
    movies {
      id
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "1",
  "this_connect_actors0_node_param0" : "Daniel"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Film)
WHERE this.id = $param0
WITH this
CALL {
	WITH this
	OPTIONAL MATCH (this_connect_actors0_node:Person)
	WHERE this_connect_actors0_node.name = $this_connect_actors0_node_param0
	CALL {
		WITH *
		WITH collect(this_connect_actors0_node) AS connectedNodes, collect(this) AS parentNodes
		CALL {
			WITH connectedNodes, parentNodes
			UNWIND parentNodes AS this
			UNWIND connectedNodes AS this_connect_actors0_node
			MERGE (this)<-[:ACTED_IN]-(this_connect_actors0_node)
			RETURN count(*) AS _
		}
		RETURN count(*) AS _
	}
	WITH this, this_connect_actors0_node
	RETURN count(*) AS connect_this_connect_actors_Actor
}
WITH *
RETURN collect(DISTINCT this {
	.id
}) AS data
----

'''

== Update disconnect in Movie with label film

.GraphQL-Query
[source,graphql]
----
mutation {
  updateMovies(
    where: {id: "1"}
    disconnect: {actors: [{where: {node: {name: "Daniel"}}}]}
  ) {
    movies {
      id
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "1",
  "updateMovies" : {
    "args" : {
      "disconnect" : {
        "actors" : [ {
          "where" : {
            "node" : {
              "name" : "Daniel"
            }
          }
        } ]
      }
    }
  },
  "updateMovies_args_disconnect_actors0_where_Actorparam0" : "Daniel"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Film)
WHERE this.id = $param0
WITH this
CALL {
	WITH this
	OPTIONAL MATCH (this)<-[this_disconnect_actors0_rel:ACTED_IN]-(this_disconnect_actors0:Person)
	WHERE this_disconnect_actors0.name = $updateMovies_args_disconnect_actors0_where_Actorparam0
	CALL {
		WITH this_disconnect_actors0, this_disconnect_actors0_rel, this
		WITH collect(this_disconnect_actors0) AS this_disconnect_actors0, this_disconnect_actors0_rel, this
		UNWIND this_disconnect_actors0 AS x DELETE this_disconnect_actors0_rel
		RETURN count(*) AS _
	}
	RETURN count(*) AS disconnect_this_disconnect_actors_Actor
}
WITH *
RETURN collect(DISTINCT this {
	.id
}) AS data
----

'''

== Update Movie with label film

.GraphQL-Query
[source,graphql]
----
mutation {
  updateMovies(where: {id: "1"}, update: {id: "2"}) {
    movies {
      id
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "1",
  "this_update_id" : "2"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Film)
WHERE this.id = $param0
SET this.id = $this_update_id
RETURN collect(DISTINCT this {
	.id
}) AS data
----

'''

== Update nested actors with custom label

.GraphQL-Query
[source,graphql]
----
mutation {
  updateMovies(
    where: {id: "1"}
    update: {actors: [{where: {node: {name: "old name"}}, update: {node: {name: "new name"}}}]}
  ) {
    movies {
      id
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "1",
  "this_update_actors0_name" : "new name",
  "updateMovies" : {
    "args" : {
      "update" : {
        "actors" : [ {
          "where" : {
            "node" : {
              "name" : "old name"
            }
          },
          "update" : {
            "node" : {
              "name" : "new name"
            }
          }
        } ]
      }
    }
  },
  "updateMovies_args_update_actors0_where_Actorparam0" : "old name"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Film)
WHERE this.id = $param0
WITH this
CALL {
	WITH this
	MATCH (this)<-[this_acted_in0_relationship:ACTED_IN]-(this_actors0:Person)
	WHERE this_actors0.name = $updateMovies_args_update_actors0_where_Actorparam0
	SET this_actors0.name = $this_update_actors0_name
	RETURN count(*) AS update_this_actors0
}
RETURN collect(DISTINCT this {
	.id
}) AS data
----

'''

