:toc:

= Node Directive

== Source schema

[source,graphql,schema=true]
----
type JWT @jwt {
  roles: [String!]!
}

type Post @node(labels: ["Comment"]) {
  id: ID
  content: String
  creator: User! @relationship(type: "HAS_POST", direction: IN)
}

extend type Post @authorization(validate: [{operations: [DELETE], where: {jwt: {roles_INCLUDES: "admin"}}}])

type User @node(labels: ["Person"]) {
  id: ID
  name: String
  posts: [Post!]! @relationship(type: "HAS_POST", direction: OUT)
}

extend type User @authorization(validate: [{operations: [READ, UPDATE, DELETE, DELETE_RELATIONSHIP, CREATE_RELATIONSHIP], when: [BEFORE], where: {node: {id: "$jwt.sub"}}}])
----
== Admin Deletes Post

.GraphQL-Query
[source,graphql]
----
mutation {
  deletePosts(where: {creator: {id: "123"}}) {
    nodesDeleted
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "isAuthenticated" : true,
  "jwt" : {
    "roles" : [ "admin" ],
    "sub" : "id-01"
  },
  "param0" : "123",
  "param3" : "admin"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Comment)
OPTIONAL MATCH (this)<-[:HAS_POST]-(this0:Person)
WITH *, count(this0) AS creatorCount
WITH *
WHERE (creatorCount <> 0
	AND this0.id = $param0
	AND apoc.util.validatePredicate(NOT (($isAuthenticated = true
		AND $jwt.roles IS NOT NULL
		AND $param3 IN $jwt.roles)), '@neo4j/graphql/FORBIDDEN', [0])) DETACH DELETE this
----

'''

== Read User

.GraphQL-Query
[source,graphql]
----
{
  users {
    id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "isAuthenticated" : true,
  "jwt" : {
    "roles" : [ "admin" ],
    "sub" : "id-01"
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Person)
WITH *
WHERE apoc.util.validatePredicate(NOT (($isAuthenticated = true
	AND $jwt.sub IS NOT NULL
	AND this.id = $jwt.sub)), '@neo4j/graphql/FORBIDDEN', [0])
RETURN this {
	.id
} AS this
----

'''

