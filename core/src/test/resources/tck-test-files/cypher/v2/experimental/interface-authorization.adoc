:toc:

= Interface top level operations with authorization

== Source schema

[source,graphql,schema=true]
----
type JWT @jwt {
  roles: [String]
  groups: [String]
}

type SomeNodeType implements MyOtherInterface & MyInterface @authorization(validate: [{when: [BEFORE], operations: [READ], where: {node: {id: "$jwt.jwtAllowedNamesExample"}, jwt: {roles_INCLUDES: "admin"}}}]) {
  id: ID! @id @unique
  something: String
  somethingElse: String
  other: OtherNodeType! @relationship(type: "HAS_OTHER_NODES", direction: OUT)
}

type OtherNodeType {
  id: ID! @id @unique
  interfaceField: MyInterface! @relationship(type: "HAS_INTERFACE_NODES", direction: OUT)
}

interface MyInterface {
  id: ID!
}

interface MyOtherInterface implements MyInterface {
  id: ID!
  something: String
}

type MyImplementationType implements MyInterface @authorization(validate: [{operations: [READ], where: {jwt: {groups_INCLUDES: "a"}}}]) {
  id: ID! @id @unique
}

type MyOtherImplementationType implements MyInterface {
  id: ID! @id @unique
  someField: String
}
----
== Read interface

.GraphQL-Query
[source,graphql]
----
{
  myOtherInterfaces {
    id
    ... on SomeNodeType {
      id
      other {
        id
      }
    }
  }
}
----

.Query Context
[source,json,query-config=true]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [],
    "jwt": {
      "roles": [],
      "jwtAllowedNamesExample": "Horror"
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "isAuthenticated": true,
  "jwt": {
    "roles": [],
    "jwtAllowedNamesExample": "Horror"
  },
  "param2": "admin"
}
----

.Expected Cypher output
[source,cypher]
----
CALL {
    MATCH (this0:SomeNodeType)
    WHERE apoc.util.validatePredicate(NOT ($isAuthenticated = true AND ($jwt.jwtAllowedNamesExample IS NOT NULL AND this0.id = $jwt.jwtAllowedNamesExample) AND ($jwt.roles IS NOT NULL AND $param2 IN $jwt.roles)), "@neo4j/graphql/FORBIDDEN", [0])
    CALL {
        WITH this0
        MATCH (this0)-[this1:HAS_OTHER_NODES]->(this2:OtherNodeType)
        WITH this2 { .id } AS this2
        RETURN head(collect(this2)) AS var3
    }
    WITH this0 { .id, other: var3, __resolveType: "SomeNodeType", __id: id(this0) } AS this0
    RETURN this0 AS this
}
WITH this
RETURN this AS this
----

'''

== Read interface (interface target of a relationship)

.GraphQL-Query
[source,graphql]
----
{
  myInterfaces {
    id
  }
}
----

.Query Context
[source,json,query-config=true]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [],
    "jwt": {
      "roles": [],
      "jwtAllowedNamesExample": "Horror"
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "isAuthenticated": true,
  "jwt": {
    "roles": [],
    "jwtAllowedNamesExample": "Horror"
  },
  "param2": "a",
  "param3": "admin"
}
----

.Expected Cypher output
[source,cypher]
----
CALL {
    MATCH (this0:MyImplementationType)
    WHERE apoc.util.validatePredicate(NOT ($isAuthenticated = true AND ($jwt.groups IS NOT NULL AND $param2 IN $jwt.groups)), "@neo4j/graphql/FORBIDDEN", [0])
    WITH this0 { .id, __resolveType: "MyImplementationType", __id: id(this0) } AS this0
    RETURN this0 AS this
    UNION
    MATCH (this1:MyOtherImplementationType)
    WITH this1 { .id, __resolveType: "MyOtherImplementationType", __id: id(this1) } AS this1
    RETURN this1 AS this
    UNION
    MATCH (this2:SomeNodeType)
    WHERE apoc.util.validatePredicate(NOT ($isAuthenticated = true AND ($jwt.jwtAllowedNamesExample IS NOT NULL AND this2.id = $jwt.jwtAllowedNamesExample) AND ($jwt.roles IS NOT NULL AND $param3 IN $jwt.roles)), "@neo4j/graphql/FORBIDDEN", [0])
    WITH this2 { .id, __resolveType: "SomeNodeType", __id: id(this2) } AS this2
    RETURN this2 AS this
}
WITH this
RETURN this AS this
----

'''

== Read interface (interface target of a relationship) with implementation projection

.GraphQL-Query
[source,graphql]
----
{
  myInterfaces {
    id
    ... on MyOtherImplementationType {
      someField
    }
  }
}
----

.Query Context
[source,json,query-config=true]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [],
    "jwt": {
      "roles": [],
      "jwtAllowedNamesExample": "Horror"
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "isAuthenticated": true,
  "jwt": {
    "roles": [],
    "jwtAllowedNamesExample": "Horror"
  },
  "param2": "a",
  "param3": "admin"
}
----

.Expected Cypher output
[source,cypher]
----
CALL {
    MATCH (this0:MyImplementationType)
    WHERE apoc.util.validatePredicate(NOT ($isAuthenticated = true AND ($jwt.groups IS NOT NULL AND $param2 IN $jwt.groups)), "@neo4j/graphql/FORBIDDEN", [0])
    WITH this0 { .id, __resolveType: "MyImplementationType", __id: id(this0) } AS this0
    RETURN this0 AS this
    UNION
    MATCH (this1:MyOtherImplementationType)
    WITH this1 { .id, .someField, __resolveType: "MyOtherImplementationType", __id: id(this1) } AS this1
    RETURN this1 AS this
    UNION
    MATCH (this2:SomeNodeType)
    WHERE apoc.util.validatePredicate(NOT ($isAuthenticated = true AND ($jwt.jwtAllowedNamesExample IS NOT NULL AND this2.id = $jwt.jwtAllowedNamesExample) AND ($jwt.roles IS NOT NULL AND $param3 IN $jwt.roles)), "@neo4j/graphql/FORBIDDEN", [0])
    WITH this2 { .id, __resolveType: "SomeNodeType", __id: id(this2) } AS this2
    RETURN this2 AS this
}
WITH this
RETURN this AS this
----

'''

== Read interface (interface target of a relationship) with interface implementation and implementation of it projection

.GraphQL-Query
[source,graphql]
----
{
  myInterfaces {
    id
    ... on MyOtherImplementationType {
      someField
    }
    ... on MyOtherInterface {
      something
      ... on SomeNodeType {
        somethingElse
      }
    }
  }
}
----

.Query Context
[source,json,query-config=true]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [],
    "jwt": {
      "roles": [],
      "jwtAllowedNamesExample": "Horror"
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "isAuthenticated": true,
  "jwt": {
    "roles": [],
    "jwtAllowedNamesExample": "Horror"
  },
  "param2": "a",
  "param3": "admin"
}
----

.Expected Cypher output
[source,cypher]
----
CALL {
    MATCH (this0:MyImplementationType)
    WHERE apoc.util.validatePredicate(NOT ($isAuthenticated = true AND ($jwt.groups IS NOT NULL AND $param2 IN $jwt.groups)), "@neo4j/graphql/FORBIDDEN", [0])
    WITH this0 { .id, __resolveType: "MyImplementationType", __id: id(this0) } AS this0
    RETURN this0 AS this
    UNION
    MATCH (this1:MyOtherImplementationType)
    WITH this1 { .id, .someField, __resolveType: "MyOtherImplementationType", __id: id(this1) } AS this1
    RETURN this1 AS this
    UNION
    MATCH (this2:SomeNodeType)
    WHERE apoc.util.validatePredicate(NOT ($isAuthenticated = true AND ($jwt.jwtAllowedNamesExample IS NOT NULL AND this2.id = $jwt.jwtAllowedNamesExample) AND ($jwt.roles IS NOT NULL AND $param3 IN $jwt.roles)), "@neo4j/graphql/FORBIDDEN", [0])
    WITH this2 { .id, .something, .somethingElse, __resolveType: "SomeNodeType", __id: id(this2) } AS this2
    RETURN this2 AS this
}
WITH this
RETURN this AS this
----

'''

== Read interface (interface target of a relationship) with interface implementation projection

.GraphQL-Query
[source,graphql]
----
{
  myInterfaces {
    id
    ... on MyOtherImplementationType {
      someField
    }
    ... on MyOtherInterface {
      something
    }
  }
}
----

.Query Context
[source,json,query-config=true]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [],
    "jwt": {
      "roles": [],
      "jwtAllowedNamesExample": "Horror"
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "isAuthenticated": true,
  "jwt": {
    "roles": [],
    "jwtAllowedNamesExample": "Horror"
  },
  "param2": "a",
  "param3": "admin"
}
----

.Expected Cypher output
[source,cypher]
----
CALL {
    MATCH (this0:MyImplementationType)
    WHERE apoc.util.validatePredicate(NOT ($isAuthenticated = true AND ($jwt.groups IS NOT NULL AND $param2 IN $jwt.groups)), "@neo4j/graphql/FORBIDDEN", [0])
    WITH this0 { .id, __resolveType: "MyImplementationType", __id: id(this0) } AS this0
    RETURN this0 AS this
    UNION
    MATCH (this1:MyOtherImplementationType)
    WITH this1 { .id, .someField, __resolveType: "MyOtherImplementationType", __id: id(this1) } AS this1
    RETURN this1 AS this
    UNION
    MATCH (this2:SomeNodeType)
    WHERE apoc.util.validatePredicate(NOT ($isAuthenticated = true AND ($jwt.jwtAllowedNamesExample IS NOT NULL AND this2.id = $jwt.jwtAllowedNamesExample) AND ($jwt.roles IS NOT NULL AND $param3 IN $jwt.roles)), "@neo4j/graphql/FORBIDDEN", [0])
    WITH this2 { .id, .something, __resolveType: "SomeNodeType", __id: id(this2) } AS this2
    RETURN this2 AS this
}
WITH this
RETURN this AS this
----

'''

== Read interface with shared filters

.GraphQL-Query
[source,graphql]
----
{
  myOtherInterfaces(where: {id_STARTS_WITH: "1"}) {
    id
  }
}
----

.Query Context
[source,json,query-config=true]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [],
    "jwt": {
      "roles": [],
      "jwtAllowedNamesExample": "Horror"
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": "1",
  "isAuthenticated": true,
  "jwt": {
    "roles": [],
    "jwtAllowedNamesExample": "Horror"
  },
  "param3": "admin"
}
----

.Expected Cypher output
[source,cypher]
----
CALL {
    MATCH (this0:SomeNodeType)
    WHERE (this0.id STARTS WITH $param0 AND apoc.util.validatePredicate(NOT ($isAuthenticated = true AND ($jwt.jwtAllowedNamesExample IS NOT NULL AND this0.id = $jwt.jwtAllowedNamesExample) AND ($jwt.roles IS NOT NULL AND $param3 IN $jwt.roles)), "@neo4j/graphql/FORBIDDEN", [0]))
    WITH this0 { .id, __resolveType: "SomeNodeType", __id: id(this0) } AS this0
    RETURN this0 AS this
}
WITH this
RETURN this AS this
----

'''

== Read interface with shared filters and concrete projection

.GraphQL-Query
[source,graphql]
----
{
  myOtherInterfaces(where: {id_STARTS_WITH: "4"}) {
    id
    ... on SomeNodeType {
      id
    }
  }
}
----

.Query Context
[source,json,query-config=true]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [],
    "jwt": {
      "roles": [],
      "jwtAllowedNamesExample": "Horror"
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": "4",
  "isAuthenticated": true,
  "jwt": {
    "roles": [],
    "jwtAllowedNamesExample": "Horror"
  },
  "param3": "admin"
}
----

.Expected Cypher output
[source,cypher]
----
CALL {
    MATCH (this0:SomeNodeType)
    WHERE (this0.id STARTS WITH $param0 AND apoc.util.validatePredicate(NOT ($isAuthenticated = true AND ($jwt.jwtAllowedNamesExample IS NOT NULL AND this0.id = $jwt.jwtAllowedNamesExample) AND ($jwt.roles IS NOT NULL AND $param3 IN $jwt.roles)), "@neo4j/graphql/FORBIDDEN", [0]))
    WITH this0 { .id, __resolveType: "SomeNodeType", __id: id(this0) } AS this0
    RETURN this0 AS this
}
WITH this
RETURN this AS this
----

'''

