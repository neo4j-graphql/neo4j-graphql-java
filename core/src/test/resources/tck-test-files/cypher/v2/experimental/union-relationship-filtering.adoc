:toc:

= Union relationship filtering operations

== Source schema

[source,graphql,schema=true]
----
union Production = Movie | Series

type Movie {
  title: String!
  cost: Float
  runtime: Int
  actors: [Actor!]! @relationship(type: "ACTED_IN", direction: IN, properties: "ActedIn")
}

type Series {
  title: String!
  episodes: Int
  actors: [Actor!]! @relationship(type: "ACTED_IN", direction: IN, properties: "ActedIn")
}

type Actor {
  name: String!
  actedIn: [Production!]! @relationship(type: "ACTED_IN", direction: OUT, properties: "ActedIn")
}

type ActedIn @relationshipProperties {
  screenTime: Int
}
----

== Filtering on nested-level relationship unions

.GraphQL-Query
[source,graphql]
----
query actedInWhere {
  actors(
    where: {actedIn_SOME: {Movie: {title_CONTAINS: "The Office"}, Series: {title_ENDS_WITH: "Office"}}}
  ) {
    name
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "The Office",
  "param1" : "Office"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WHERE (EXISTS {
		MATCH (this)-[:ACTED_IN]->(this0:Movie)
		WHERE this0.title CONTAINS $param0
	}
	AND EXISTS {
		MATCH (this)-[:ACTED_IN]->(this1:Series)
		WHERE this1.title ENDS WITH $param1
	})
RETURN this {
	.name
} AS this
----

'''

== Union filter (top level)

.GraphQL-Query
[source,graphql]
----
query actedInWhere {
  productions(
    where: {Movie: {title: "The Office"}, Series: {title: "The Office 2"}}
  ) {
    ... on Movie {
      title
    }
    ... on Series {
      title
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "The Office",
  "param1" : "The Office 2"
}
----

.Expected Cypher output
[source,cypher]
----
CALL {
	MATCH (movie0:Movie)
	WHERE movie0.title = $param0
	WITH movie0 {
		__resolveType: 'Movie',
		__id: elementId(movie0),
		.title
	} AS movie0
	RETURN movie0 AS this UNION
	MATCH (series0:Series)
	WHERE series0.title = $param1
	WITH series0 {
		__resolveType: 'Series',
		__id: elementId(series0),
		.title
	} AS series0
	RETURN series0 AS this
}
WITH this
RETURN this AS this
----

'''

