:toc:

= Cypher -> fulltext -> Auth

== Source schema

[source,graphql,schema=true]
----
type Movie @fulltext(indexes: [{indexName: "MovieTitle", fields: ["title"]}]) @authorization(validate: [{when: [BEFORE], where: {node: {directorConnection_ALL: {edge: {year: 2020}}}}}]) {
  title: String
  director: [Person!]! @relationship(type: "DIRECTED", direction: IN, properties: "Directed")
}

type Person {
  id: ID
}

type Directed @relationshipProperties {
  year: Int
}
----
== 4.4

=== simple match with auth allow on connection edge ALL

.GraphQL-Query
[source,graphql]
----
{
  movies(fulltext: {MovieTitle: {phrase: "something AND something"}}) {
    title
  }
}
----

.Query Context
[source,json,query-config=true]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [],
    "jwt": {
      "roles": [],
      "sub": "my-sub"
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": "something AND something",
  "param1": "Movie",
  "isAuthenticated": true,
  "param3": 2020
}
----

.Expected Cypher output
[source,cypher]
----
CALL db.index.fulltext.queryNodes("MovieTitle", $param0) YIELD node AS this0, score AS var1
WHERE $param1 IN labels(this0)
WITH *
WHERE apoc.util.validatePredicate(NOT ($isAuthenticated = true AND size([(this0)<-[this2:DIRECTED]-(this3:Person) WHERE NOT ($param3 IS NOT NULL AND this2.year = $param3) | 1]) = 0), "@neo4j/graphql/FORBIDDEN", [0])
RETURN this0 { .title } AS this
----

'''


== 5

=== simple match with auth allow on connection edge ALL

.GraphQL-Query
[source,graphql]
----
{
  movies(fulltext: {MovieTitle: {phrase: "something AND something"}}) {
    title
  }
}
----

.Query Context
[source,json,query-config=true]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [],
    "jwt": {
      "roles": [],
      "sub": "my-sub"
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": "something AND something",
  "param1": "Movie",
  "isAuthenticated": true,
  "param3": 2020
}
----

.Expected Cypher output
[source,cypher]
----
CALL db.index.fulltext.queryNodes("MovieTitle", $param0) YIELD node AS this0, score AS var1
WHERE $param1 IN labels(this0)
WITH *
WHERE apoc.util.validatePredicate(NOT ($isAuthenticated = true AND (EXISTS {
    MATCH (this0)<-[this2:DIRECTED]-(this3:Person)
    WHERE ($param3 IS NOT NULL AND this2.year = $param3)
} AND NOT (EXISTS {
    MATCH (this0)<-[this2:DIRECTED]-(this3:Person)
    WHERE NOT ($param3 IS NOT NULL AND this2.year = $param3)
}))), "@neo4j/graphql/FORBIDDEN", [0])
RETURN this0 { .title } AS this
----

'''


