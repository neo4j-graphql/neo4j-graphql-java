:toc:

= https://github.com/neo4j/graphql/issues/1115

== Source schema

[source,graphql,schema=true]
----
type JWT @jwt {
  roles: [String!]!
}

type Parent {
  children: [Child!]! @relationship(type: "HAS", direction: IN)
}

type Child {
  tcId: String @unique
}

extend type Child @authorization(validate: [{operations: [READ, CREATE, UPDATE, DELETE, CREATE_RELATIONSHIP, DELETE_RELATIONSHIP], where: {jwt: {roles_INCLUDES: "upstream"}}}, {operations: [READ], where: {jwt: {roles_INCLUDES: "downstream"}}}])
----
== multiple connectOrCreate operations with auth

.GraphQL-Query
[source,graphql]
----
mutation UpdateParents {
  updateParents(
    connectOrCreate: {children: [{where: {node: {tcId: "123"}}, onCreate: {node: {tcId: "123"}}}, {where: {node: {tcId: "456"}}, onCreate: {node: {tcId: "456"}}}]}
  ) {
    info {
      nodesCreated
    }
  }
}
----

.Query Context
[source,json,query-config=true]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [],
    "jwt": {
      "roles": []
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_connectOrCreate_children_param0": "123",
  "this_connectOrCreate_children_param1": "123",
  "isAuthenticated": true,
  "jwt": {
    "roles": []
  },
  "this_connectOrCreate_children_param4": "upstream",
  "this_connectOrCreate_children_param5": "456",
  "this_connectOrCreate_children_param6": "456",
  "this_connectOrCreate_children_param7": "upstream"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Parent)
WITH this
CALL {
    WITH this
    MERGE (this_connectOrCreate_children0:Child { tcId: $this_connectOrCreate_children_param0 })
    ON CREATE SET
        this_connectOrCreate_children0.tcId = $this_connectOrCreate_children_param1
    MERGE (this)<-[this_connectOrCreate_children_this0:HAS]-(this_connectOrCreate_children0)
    WITH *
    WHERE apoc.util.validatePredicate(NOT ($isAuthenticated = true AND ($jwt.roles IS NOT NULL AND $this_connectOrCreate_children_param4 IN $jwt.roles)), "@neo4j/graphql/FORBIDDEN", [0])
    RETURN count(*) AS _
}
WITH this
CALL {
    WITH this
    MERGE (this_connectOrCreate_children1:Child { tcId: $this_connectOrCreate_children_param5 })
    ON CREATE SET
        this_connectOrCreate_children1.tcId = $this_connectOrCreate_children_param6
    MERGE (this)<-[this_connectOrCreate_children_this1:HAS]-(this_connectOrCreate_children1)
    WITH *
    WHERE apoc.util.validatePredicate(NOT ($isAuthenticated = true AND ($jwt.roles IS NOT NULL AND $this_connectOrCreate_children_param7 IN $jwt.roles)), "@neo4j/graphql/FORBIDDEN", [0])
    RETURN count(*) AS _
}
WITH *
RETURN "Query cannot conclude with CALL"
----

'''

