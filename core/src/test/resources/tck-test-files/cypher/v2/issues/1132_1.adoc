:toc:

= https://github.com/neo4j/graphql/issues/1132

== Source schema

[source,graphql,schema=true]
----
type Source @auth(rules: [{operations: [CONNECT], allow: {id: "$jwt.sub"}}]) {
  id: ID!
  targets: [Target!]! @relationship(type: "HAS_TARGET", direction: OUT)
}

type Target {
  id: ID!
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{
  "enableRegex": true
}
----
== Auth CONNECT rules checked against correct property

.GraphQL-Query
[source,graphql]
----
mutation {
  updateSources(connect: {targets: {where: {node: {id: 1}}}}) {
    sources {
      id
    }
  }
}
----

.Query Context
[source,json,query-config=true]
----
{
  "auth": {},
  "contextParams": {
    "jwt": {
      "sub": "1"
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_connect_targets0_node_param0" : "1",
  "thisauth_param0" : "1"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Source)
WITH this
CALL {
	WITH this
	OPTIONAL MATCH (this_connect_targets0_node:Target)
	WHERE this_connect_targets0_node.id = $this_connect_targets0_node_param0
	WITH this, this_connect_targets0_node CALL apoc.util.validate(NOT ((this.id IS NOT NULL
		AND this.id = $thisauth_param0)), '@neo4j/graphql/FORBIDDEN', [0])
	CALL {
		WITH *
		WITH collect(this_connect_targets0_node) AS connectedNodes, collect(this) AS parentNodes
		CALL {
			WITH connectedNodes, parentNodes
			UNWIND parentNodes AS this
			UNWIND connectedNodes AS this_connect_targets0_node
			MERGE (this)-[:HAS_TARGET]->(this_connect_targets0_node)
			RETURN count(*) AS _
		}
		RETURN count(*) AS _
	}
	WITH this, this_connect_targets0_node
	RETURN count(*) AS connect_this_connect_targets_Target
}
WITH *
RETURN collect(DISTINCT this {
	.id
}) AS data
----

'''

