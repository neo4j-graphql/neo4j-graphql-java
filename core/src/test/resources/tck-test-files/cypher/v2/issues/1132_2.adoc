:toc:

= https://github.com/neo4j/graphql/issues/1132

== Source schema

[source,graphql,schema=true]
----
type Source @authorization(validate: [{when: [BEFORE], operations: [DELETE_RELATIONSHIP], where: {node: {id: "$jwt.sub"}}}]) {
  id: ID!
  targets: [Target!]! @relationship(type: "HAS_TARGET", direction: OUT)
}

type Target {
  id: ID!
}
----
== Auth DISCONNECT rules checked against correct property

.GraphQL-Query
[source,graphql]
----
mutation {
  updateSources(disconnect: {targets: {where: {node: {id: 1}}}}) {
    sources {
      id
    }
  }
}
----

.Query Context
[source,json,query-config=true]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [],
    "jwt": {
      "roles": [],
      "sub": "1"
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "updateSources_args_disconnect_targets0_where_Target_this_disconnect_targets0param0": "1",
  "isAuthenticated": true,
  "jwt": {
    "roles": [],
    "sub": "1"
  },
  "updateSources": {
    "args": {
      "disconnect": {
        "targets": [
          {
            "where": {
              "node": {
                "id": "1"
              }
            }
          }
        ]
      }
    }
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Source)
WITH this
CALL {
WITH this
OPTIONAL MATCH (this)-[this_disconnect_targets0_rel:HAS_TARGET]->(this_disconnect_targets0:Target)
WHERE this_disconnect_targets0.id = $updateSources_args_disconnect_targets0_where_Target_this_disconnect_targets0param0 AND apoc.util.validatePredicate(NOT ($isAuthenticated = true AND ($jwt.sub IS NOT NULL AND this.id = $jwt.sub)), "@neo4j/graphql/FORBIDDEN", [0])
CALL {
	WITH this_disconnect_targets0, this_disconnect_targets0_rel, this
	WITH collect(this_disconnect_targets0) as this_disconnect_targets0, this_disconnect_targets0_rel, this
	UNWIND this_disconnect_targets0 as x
	DELETE this_disconnect_targets0_rel
}
RETURN count(*) AS disconnect_this_disconnect_targets_Target
}
WITH *
RETURN collect(DISTINCT this { .id }) AS data
----

'''

