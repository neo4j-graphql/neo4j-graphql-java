:toc:

= https://github.com/neo4j/graphql/issues/1221

== Source schema

[source,graphql,schema=true]
----
type Series {
  id: ID! @unique
  current: Boolean!
  architecture: [MasterData!]! @relationship(type: "ARCHITECTURE", properties: "RelationProps", direction: OUT)
}

type NameDetails @mutation(operations: []) @query(read: false, aggregate: false) {
  fullName: String!
}

type RelationProps @relationshipProperties {
  current: Boolean!
}

type MasterData {
  id: ID! @unique
  current: Boolean!
  nameDetails: NameDetails @relationship(type: "HAS_NAME", properties: "RelationProps", direction: OUT)
}
----
== should apply where filter for deep relations, two relations deep

.GraphQL-Query
[source,graphql]
----
{
  series(
    where: {current: true, architectureConnection_SINGLE: {node: {nameDetailsConnection: {node: {fullName: "MHA"}}}}}
  ) {
    id
    architectureConnection(where: {edge: {current: true}}) {
      edges {
        node {
          nameDetailsConnection(where: {edge: {current: true}}) {
            edges {
              node {
                fullName
              }
            }
          }
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": true,
  "param1": "MHA",
  "param2": true,
  "param3": true
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Series)
WHERE (this.current = $param0 AND single(this1 IN [(this)-[this3:ARCHITECTURE]->(this1:MasterData) WHERE single(this0 IN [(this1)-[this2:HAS_NAME]->(this0:NameDetails) WHERE this0.fullName = $param1 | 1] WHERE true) | 1] WHERE true))
CALL {
    WITH this
    MATCH (this)-[this4:ARCHITECTURE]->(this5:MasterData)
    WHERE this4.current = $param2
    WITH collect({ node: this5, relationship: this4 }) AS edges
    WITH edges, size(edges) AS totalCount
    CALL {
        WITH edges
        UNWIND edges AS edge
        WITH edge.node AS this5, edge.relationship AS this4
        CALL {
            WITH this5
            MATCH (this5)-[this6:HAS_NAME]->(this7:NameDetails)
            WHERE this6.current = $param3
            WITH collect({ node: this7, relationship: this6 }) AS edges
            WITH edges, size(edges) AS totalCount
            CALL {
                WITH edges
                UNWIND edges AS edge
                WITH edge.node AS this7, edge.relationship AS this6
                RETURN collect({ node: { fullName: this7.fullName, __resolveType: "NameDetails" } }) AS var8
            }
            RETURN { edges: var8, totalCount: totalCount } AS var9
        }
        RETURN collect({ node: { nameDetailsConnection: var9, __resolveType: "MasterData" } }) AS var10
    }
    RETURN { edges: var10, totalCount: totalCount } AS var11
}
RETURN this { .id, architectureConnection: var11 } AS this
----

'''

