:toc:

= https://github.com/neo4j/graphql/issues/1221

== Source schema

[source,graphql,schema=true]
----
type Series {
  id: ID! @id(autogenerate: false)
  current: Boolean!
  architecture: [MasterData!]! @relationship(type: "ARCHITECTURE", properties: "RelationProps", direction: OUT)
}

type NameDetails @exclude(operations: [CREATE, UPDATE, DELETE, READ]) {
  fullName: String!
}

interface RelationProps {
  current: Boolean!
}

type MasterData {
  id: ID! @id(autogenerate: false)
  current: Boolean!
  nameDetails: NameDetails @relationship(type: "HAS_NAME", properties: "RelationProps", direction: OUT)
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{}
----
== should apply where filter for deep relations, two relations deep

.GraphQL-Query
[source,graphql]
----
{
  series(
    where: {current: true, architectureConnection_SINGLE: {node: {nameDetailsConnection: {node: {fullName: "MHA"}}}}}
  ) {
    id
    architectureConnection(where: {edge: {current: true}}) {
      edges {
        node {
          nameDetailsConnection(where: {edge: {current: true}}) {
            edges {
              node {
                fullName
              }
            }
          }
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : true,
  "param1" : "MHA",
  "this_MasterData_connection_nameDetailsConnectionparam0" : true,
  "this_connection_architectureConnectionparam0" : true
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Series)
WHERE (this.current = $param0
	AND size([(this)-[this3:ARCHITECTURE]->(this2:MasterData)
	WHERE size([(this2)-[this1:HAS_NAME]->(this0:NameDetails)
	WHERE this0.fullName = $param1 | 1]) = 1 | 1]) = 1)
CALL {
	WITH this
	MATCH (this)-[this_connection_architectureConnectionthis0:ARCHITECTURE]->(this_MasterData:MasterData)
	WHERE this_connection_architectureConnectionthis0.current = $this_connection_architectureConnectionparam0
	CALL {
		WITH this_MasterData
		MATCH (this_MasterData)-[this_MasterData_connection_nameDetailsConnectionthis0:HAS_NAME]->(this_MasterData_NameDetails:NameDetails)
		WHERE this_MasterData_connection_nameDetailsConnectionthis0.current = $this_MasterData_connection_nameDetailsConnectionparam0
		WITH {
			node: {
				fullName: this_MasterData_NameDetails.fullName
			}
		} AS edge
		WITH collect(edge) AS edges
		WITH edges, size(edges) AS totalCount
		RETURN {
			edges: edges,
			totalCount: totalCount
		} AS this_MasterData_nameDetailsConnection
	}
	WITH {
		node: {
			nameDetailsConnection: this_MasterData_nameDetailsConnection
		}
	} AS edge
	WITH collect(edge) AS edges
	WITH edges, size(edges) AS totalCount
	RETURN {
		edges: edges,
		totalCount: totalCount
	} AS this_architectureConnection
}
RETURN this {
	.id,
	architectureConnection: this_architectureConnection
} AS this
----

'''

