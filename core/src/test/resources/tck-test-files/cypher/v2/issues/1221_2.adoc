:toc:

= https://github.com/neo4j/graphql/issues/1221

== Source schema

[source,graphql,schema=true]
----
type Main {
  id: ID! @id(autogenerate: false)
  current: Boolean!
  main: [Series!]! @relationship(type: "MAIN", properties: "RelationProps", direction: OUT)
}

type Series {
  id: ID! @id(autogenerate: false)
  current: Boolean!
  architecture: [MasterData!]! @relationship(type: "ARCHITECTURE", properties: "RelationProps", direction: OUT)
}

type NameDetails @exclude(operations: [CREATE, UPDATE, DELETE, READ]) {
  fullName: String!
}

interface RelationProps {
  current: Boolean!
}

type MasterData {
  id: ID! @id(autogenerate: false)
  current: Boolean!
  nameDetails: NameDetails @relationship(type: "HAS_NAME", properties: "RelationProps", direction: OUT)
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{}
----
== should apply where filter for deep relations, three relations deep

.GraphQL-Query
[source,graphql]
----
{
  mains(
    where: {current: true, mainConnection_SINGLE: {node: {architectureConnection: {node: {nameDetailsConnection: {node: {fullName: "MHA"}}}}}}}
  ) {
    id
    mainConnection(where: {edge: {current: true}}) {
      edges {
        node {
          architectureConnection(where: {edge: {current: true}}) {
            edges {
              node {
                nameDetailsConnection(where: {edge: {current: true}}) {
                  edges {
                    node {
                      fullName
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : true,
  "param1" : "MHA",
  "this_Series_MasterData_connection_nameDetailsConnectionparam0" : true,
  "this_Series_connection_architectureConnectionparam0" : true,
  "this_connection_mainConnectionparam0" : true
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Main)
WHERE (this.current = $param0
	AND size([(this)-[this5:MAIN]->(this1:Series)
	WHERE EXISTS {
		MATCH (this1)-[this0:ARCHITECTURE]->(this2:MasterData)
		WHERE size([(this2)-[this4:HAS_NAME]->(this3:NameDetails)
		WHERE this3.fullName = $param1 | 1]) = 1
	} | 1]) = 1)
CALL {
	WITH this
	MATCH (this)-[this_connection_mainConnectionthis0:MAIN]->(this_Series:Series)
	WHERE this_connection_mainConnectionthis0.current = $this_connection_mainConnectionparam0
	CALL {
		WITH this_Series
		MATCH (this_Series)-[this_Series_connection_architectureConnectionthis0:ARCHITECTURE]->(this_Series_MasterData:MasterData)
		WHERE this_Series_connection_architectureConnectionthis0.current = $this_Series_connection_architectureConnectionparam0
		CALL {
			WITH this_Series_MasterData
			MATCH (this_Series_MasterData)-[this_Series_MasterData_connection_nameDetailsConnectionthis0:HAS_NAME]->(this_Series_MasterData_NameDetails:NameDetails)
			WHERE this_Series_MasterData_connection_nameDetailsConnectionthis0.current = $this_Series_MasterData_connection_nameDetailsConnectionparam0
			WITH {
				node: {
					fullName: this_Series_MasterData_NameDetails.fullName
				}
			} AS edge
			WITH collect(edge) AS edges
			WITH edges, size(edges) AS totalCount
			RETURN {
				edges: edges,
				totalCount: totalCount
			} AS this_Series_MasterData_nameDetailsConnection
		}
		WITH {
			node: {
				nameDetailsConnection: this_Series_MasterData_nameDetailsConnection
			}
		} AS edge
		WITH collect(edge) AS edges
		WITH edges, size(edges) AS totalCount
		RETURN {
			edges: edges,
			totalCount: totalCount
		} AS this_Series_architectureConnection
	}
	WITH {
		node: {
			architectureConnection: this_Series_architectureConnection
		}
	} AS edge
	WITH collect(edge) AS edges
	WITH edges, size(edges) AS totalCount
	RETURN {
		edges: edges,
		totalCount: totalCount
	} AS this_mainConnection
}
RETURN this {
	.id,
	mainConnection: this_mainConnection
} AS this
----

'''

