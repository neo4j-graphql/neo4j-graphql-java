:toc:

= https://github.com/neo4j/graphql/issues/1221

== Source schema

[source,graphql,schema=true]
----
type Main {
  id: ID! @unique
  current: Boolean!
  main: [Series!]! @relationship(type: "MAIN", properties: "RelationProps", direction: OUT)
}

type Series {
  id: ID! @unique
  current: Boolean!
  architecture: [MasterData!]! @relationship(type: "ARCHITECTURE", properties: "RelationProps", direction: OUT)
}

type NameDetails @mutation(operations: []) @query(read: false, aggregate: false) {
  fullName: String!
}

type RelationProps @relationshipProperties {
  current: Boolean!
}

type MasterData {
  id: ID! @unique
  current: Boolean!
  nameDetails: NameDetails @relationship(type: "HAS_NAME", properties: "RelationProps", direction: OUT)
}
----
== should apply where filter for deep relations, three relations deep

.GraphQL-Query
[source,graphql]
----
{
  mains(
    where: {current: true, mainConnection_SINGLE: {node: {architectureConnection_SOME: {node: {nameDetailsConnection: {node: {fullName: "MHA"}}}}}}}
  ) {
    id
    mainConnection(where: {edge: {current: true}}) {
      edges {
        node {
          architectureConnection(where: {edge: {current: true}}) {
            edges {
              node {
                nameDetailsConnection(where: {edge: {current: true}}) {
                  edges {
                    node {
                      fullName
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": true,
  "param1": "MHA",
  "param2": true,
  "param3": true,
  "param4": true
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Main)
WHERE (this.current = $param0 AND single(this0 IN [(this)-[this5:MAIN]->(this0:Series) WHERE EXISTS {
    MATCH (this0)-[this1:ARCHITECTURE]->(this2:MasterData)
    WHERE single(this3 IN [(this2)-[this4:HAS_NAME]->(this3:NameDetails) WHERE this3.fullName = $param1 | 1] WHERE true)
} | 1] WHERE true))
CALL {
    WITH this
    MATCH (this)-[this6:MAIN]->(this7:Series)
    WHERE this6.current = $param2
    WITH collect({ node: this7, relationship: this6 }) AS edges
    WITH edges, size(edges) AS totalCount
    CALL {
        WITH edges
        UNWIND edges AS edge
        WITH edge.node AS this7, edge.relationship AS this6
        CALL {
            WITH this7
            MATCH (this7)-[this8:ARCHITECTURE]->(this9:MasterData)
            WHERE this8.current = $param3
            WITH collect({ node: this9, relationship: this8 }) AS edges
            WITH edges, size(edges) AS totalCount
            CALL {
                WITH edges
                UNWIND edges AS edge
                WITH edge.node AS this9, edge.relationship AS this8
                CALL {
                    WITH this9
                    MATCH (this9)-[this10:HAS_NAME]->(this11:NameDetails)
                    WHERE this10.current = $param4
                    WITH collect({ node: this11, relationship: this10 }) AS edges
                    WITH edges, size(edges) AS totalCount
                    CALL {
                        WITH edges
                        UNWIND edges AS edge
                        WITH edge.node AS this11, edge.relationship AS this10
                        RETURN collect({ node: { fullName: this11.fullName, __resolveType: "NameDetails" } }) AS var12
                    }
                    RETURN { edges: var12, totalCount: totalCount } AS var13
                }
                RETURN collect({ node: { nameDetailsConnection: var13, __resolveType: "MasterData" } }) AS var14
            }
            RETURN { edges: var14, totalCount: totalCount } AS var15
        }
        RETURN collect({ node: { architectureConnection: var15, __resolveType: "Series" } }) AS var16
    }
    RETURN { edges: var16, totalCount: totalCount } AS var17
}
RETURN this { .id, mainConnection: var17 } AS this
----

'''

