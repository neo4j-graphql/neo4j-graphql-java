:toc:

= https://github.com/neo4j/graphql/issues/1249

== Source schema

[source,graphql,schema=true]
----
type Bulk @mutation(operations: []) @node(labels: ["Bulk", "$tenant"]) {
  id: ID!
  supplierMaterialNumber: String!
  material: Material! @relationship(type: "MATERIAL_BULK", direction: OUT)
}

type Material @mutation(operations: []) {
  id: ID!
  itemNumber: String!
  suppliers: [Supplier!]! @relationship(type: "MATERIAL_SUPPLIER", properties: "RelationMaterialSupplier", direction: OUT)
}

type Supplier @mutation(operations: []) {
  id: ID!
  name: String
  supplierId: String!
}

interface RelationMaterialSupplier @relationshipProperties {
  supplierMaterialNumber: String!
}
----
== should contain the cypherParams that are passed via the context

.GraphQL-Query
[source,graphql]
----
{
  bulks {
    supplierMaterialNumber
    material {
      id
      suppliersConnection {
        edges {
          supplierMaterialNumber
          node {
            supplierId
          }
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "tenant" : "BULK"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Bulk:BULK)
CALL {
	WITH this
	MATCH (this)-[this0:MATERIAL_BULK]->(this1:Material)
	CALL {
		WITH this1
		MATCH (this1)-[this2:MATERIAL_SUPPLIER]->(this3:Supplier)
		WITH collect( {
			node: this3,
			relationship: this2
		}) AS edges
		WITH edges, size(edges) AS totalCount
		CALL {
			WITH edges
			UNWIND edges AS edge
			WITH edge.node AS this3, edge.relationship AS this2
			RETURN collect( {
				supplierMaterialNumber: this2.supplierMaterialNumber,
				node: {
					supplierId: this3.supplierId
				}
			}) AS var4
		}
		RETURN {
			edges: var4,
			totalCount: totalCount
		} AS var5
	}
	WITH this1 {
		.id,
		suppliersConnection: var5
	} AS this1
	RETURN head(collect(this1)) AS var6
}
RETURN this {
	.supplierMaterialNumber,
	material: var6
} AS this
----

'''

