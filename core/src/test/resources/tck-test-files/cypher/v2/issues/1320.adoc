:toc:

= https://github.com/neo4j/graphql/issues/1320

== Source schema

[source,graphql,schema=true]
----
type Risk {
  code: String!
  ownedBy: Team @relationship(type: "OWNS_RISK", direction: IN)
  mitigationState: [MitigationState]
}

type Team {
  code: String!
  ownsRisks: [Risk!]! @relationship(type: "OWNS_RISK", direction: OUT)
}

enum MitigationState {
  Deferred
  Identified
  Accepted
  Complete
}
----
== multiple aggregations in the same query should return the same results as if were written separately

.GraphQL-Query
[source,graphql]
----
query getAggreationOnTeams {
  stats: teams {
    accepted: ownsRisksAggregate(where: {mitigationState_INCLUDES: Accepted}) {
      count
    }
    identified: ownsRisksAggregate(where: {mitigationState_INCLUDES: Identified}) {
      count
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "Accepted",
  "param1" : "Identified"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Team)
CALL {
	WITH this
	MATCH (this)-[this0:OWNS_RISK]->(this1:Risk)
	WHERE $param0 IN this1.mitigationState
	RETURN count(this1) AS var2
}
CALL {
	WITH this
	MATCH (this)-[this3:OWNS_RISK]->(this4:Risk)
	WHERE $param1 IN this4.mitigationState
	RETURN count(this4) AS var5
}
RETURN this {
	accepted: {
		count: var2
	},
	identified: {
		count: var5
	}
} AS this
----

'''

