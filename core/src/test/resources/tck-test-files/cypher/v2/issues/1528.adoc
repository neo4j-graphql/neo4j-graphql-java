:toc:

= https://github.com/neo4j/graphql/issues/1528

== Source schema

[source,graphql,schema=true]
----
type Movie {
  title: String!
  actors: [Person!]! @relationship(type: "ACTED_IN", direction: IN)
  actorsCount: Int! @cypher(statement: """
  MATCH (this)<-[:ACTED_IN]-(ac:Person)
  RETURN count(ac) as res
  """, columnName: "res")
}

type Person {
  name: String!
  movies: [Movie!]! @relationship(type: "ACTED_IN", direction: OUT)
}

type Genre {
  name: String!
  movies: [Movie!]! @relationship(type: "IS_GENRE", direction: IN)
}
----
== order in connections with custom cypher

.GraphQL-Query
[source,graphql]
----
{
  genres {
    moviesConnection(sort: [{node: {actorsCount: DESC}}]) {
      edges {
        node {
          title
          actorsCount
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Genre)
CALL {
    WITH this
    MATCH (this)<-[this0:IS_GENRE]-(this1:Movie)
    WITH collect({ node: this1, relationship: this0 }) AS edges
    WITH edges, size(edges) AS totalCount
    CALL {
        WITH edges
        UNWIND edges AS edge
        WITH edge.node AS this1, edge.relationship AS this0
        CALL {
            WITH this1
            CALL {
                WITH this1
                WITH this1 AS this
                MATCH (this)<-[:ACTED_IN]-(ac:Person)
                RETURN count(ac) as res
            }
            WITH res AS this2
            RETURN this2 AS var3
        }
        WITH *
        ORDER BY var3 DESC
        RETURN collect({ node: { title: this1.title, actorsCount: var3, __resolveType: "Movie" } }) AS var4
    }
    RETURN { edges: var4, totalCount: totalCount } AS var5
}
RETURN this { moviesConnection: var5 } AS this
----

'''

