:toc:

= https://github.com/neo4j/graphql/issues/1566

== Source schema

[source,graphql,schema=true]
----
type Content {
  id: Int!
  name: String!
}

type Project {
  id: Int!
  name: String!
}

union FeedItem = Content | Project

type Community {
  id: Int!
  name: String!
  hasFeedItems(limit: Int = 10, page: Int = 0): [FeedItem!]! @cypher(statement: """
  Match(this)-[:COMMUNITY_CONTENTPIECE_HASCONTENTPIECES|:COMMUNITY_PROJECT_HASASSOCIATEDPROJECTS]-(pag)
     return pag SKIP ($limit * $pageIndex) LIMIT $limit
  """, columnName: "pag")
}
----
== collect unions returned by cypher directive

.GraphQL-Query
[source,graphql]
----
{
  communities(where: {id: 4656564}) {
    id
    hasFeedItems {
      __typename
      ... on Content {
        name
      }
      ... on Project {
        name
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": 4656564,
  "param1": 10
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Community)
WHERE this.id = $param0
CALL {
    WITH this
    CALL {
        WITH this
        WITH this AS this
        Match(this)-[:COMMUNITY_CONTENTPIECE_HASCONTENTPIECES|:COMMUNITY_PROJECT_HASASSOCIATEDPROJECTS]-(pag)
           return pag SKIP ($param1 * $pageIndex) LIMIT $param1
    }
    WITH pag AS this0
    CALL {
        WITH this0
        CALL {
            WITH *
            MATCH (this0)
            WHERE this0:Content
            WITH this0 { .name, __resolveType: "Content", __id: id(this0) } AS this0
            RETURN this0 AS var1
            UNION
            WITH *
            MATCH (this0)
            WHERE this0:Project
            WITH this0 { .name, __resolveType: "Project", __id: id(this0) } AS this0
            RETURN this0 AS var1
        }
        RETURN var1
    }
    RETURN collect(var1) AS this0
}
RETURN this { .id, hasFeedItems: this0 } AS this
----

'''

