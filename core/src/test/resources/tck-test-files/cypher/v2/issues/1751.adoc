:toc:

= https://github.com/neo4j/graphql/issues/1751

== Source schema

[source,graphql,schema=true]
----
type Organization {
  organizationId: ID! @id @unique
  title: String
  createdAt: DateTime!
  admins: [Admin!]! @relationship(type: "HAS_ADMINISTRATOR", direction: OUT)
}

type Admin {
  adminId: ID! @id @unique
  createdAt: DateTime!
  isSuperAdmin: Boolean
  organizations: [Organization!]! @relationship(type: "HAS_ADMINISTRATOR", direction: IN)
}
----
== should correctly count aggregate connections in a where inside a delete

.GraphQL-Query
[source,graphql]
----
mutation DeleteOrganizations($where: OrganizationWhere, $delete: OrganizationDeleteInput) {
  deleteOrganizations(where: $where, delete: $delete) {
    nodesDeleted
    relationshipsDeleted
  }
}
----

.GraphQL params input
[source,json,request=true]
----
{
  "where": {
    "title": "Google"
  },
  "delete": {
    "admins": [
      {
        "where": {
          "node": {
            "organizationsAggregate": {
              "count": 1
            }
          }
        }
      }
    ]
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": "Google",
  "this_deleteOrganizations": {
    "args": {
      "delete": {
        "admins": [
          {
            "where": {
              "node": {
                "organizationsAggregate": {
                  "count": 1
                }
              }
            }
          }
        ]
      }
    }
  },
  "this_deleteOrganizations_args_delete_admins0_where_this_admins0param0": 1
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Organization)
WHERE this.title = $param0
WITH *
CALL {
WITH *
OPTIONAL MATCH (this)-[this_admins0_relationship:HAS_ADMINISTRATOR]->(this_admins0:Admin)
CALL {
    WITH this_admins0
    MATCH (this_admins0)<-[this_deleteOrganizations_args_delete_admins0_where_this_admins0this1:HAS_ADMINISTRATOR]-(this_deleteOrganizations_args_delete_admins0_where_this_admins0this2:Organization)
    RETURN count(this_deleteOrganizations_args_delete_admins0_where_this_admins0this2) = $this_deleteOrganizations_args_delete_admins0_where_this_admins0param0 AS this_deleteOrganizations_args_delete_admins0_where_this_admins0var0
}
WITH *, CASE this_deleteOrganizations_args_delete_admins0_where_this_admins0var0 = true
    WHEN true THEN [this_admins0_relationship, this_admins0]
    ELSE [NULL, NULL]
END AS aggregateWhereFiltervar0
WITH *, aggregateWhereFiltervar0[0] AS this_admins0_relationship, aggregateWhereFiltervar0[1] AS this_admins0
WITH this_admins0_relationship, collect(DISTINCT this_admins0) AS this_admins0_to_delete
CALL {
	WITH this_admins0_to_delete
	UNWIND this_admins0_to_delete AS x
	DETACH DELETE x
}
}
DETACH DELETE this
----

'''

