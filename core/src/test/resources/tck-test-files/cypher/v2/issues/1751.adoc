:toc:

= https://github.com/neo4j/graphql/issues/1751

== Source schema

[source,graphql,schema=true]
----
type Organization {
  organizationId: ID! @id @unique
  title: String
  createdAt: DateTime!
  admins: [Admin!]! @relationship(type: "HAS_ADMINISTRATOR", direction: OUT)
}

type Admin {
  adminId: ID! @id @unique
  createdAt: DateTime!
  isSuperAdmin: Boolean
  organizations: [Organization!]! @relationship(type: "HAS_ADMINISTRATOR", direction: IN)
}
----
== should correctly count aggregate connections in a where inside a delete

.GraphQL-Query
[source,graphql]
----
mutation DeleteOrganizations($where: OrganizationWhere, $delete: OrganizationDeleteInput) {
  deleteOrganizations(where: $where, delete: $delete) {
    nodesDeleted
    relationshipsDeleted
  }
}
----

.GraphQL params input
[source,json,request=true]
----
{
  "where": {
    "title": "Google"
  },
  "delete": {
    "admins": [
      {
        "where": {
          "node": {
            "organizationsAggregate": {
              "count": 1
            }
          }
        }
      }
    ]
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": "Google",
  "param1": 1
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Organization)
WHERE this.title = $param0
WITH *
CALL {
    WITH *
    OPTIONAL MATCH (this)-[this0:HAS_ADMINISTRATOR]->(this1:Admin)
    CALL {
        WITH this1
        MATCH (this1)<-[this2:HAS_ADMINISTRATOR]-(this3:Organization)
        RETURN count(this3) = $param1 AS var4
    }
    WITH *
    WHERE var4 = true
    WITH this0, collect(DISTINCT this1) AS var5
    CALL {
        WITH var5
        UNWIND var5 AS var6
        DETACH DELETE var6
    }
}
WITH *
DETACH DELETE this
----

'''

