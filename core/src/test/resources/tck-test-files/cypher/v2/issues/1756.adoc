:toc:

= https://github.com/neo4j/graphql/issues/1756

== Source schema

[source,graphql,schema=true]
----
interface INode {
  id: ID
}

type Product implements INode {
  id: ID @populatedBy(operations: [CREATE], callback: "nanoid")
  name: String!
  genre: [Genre!]! @relationship(type: "HAS_GENRE", direction: OUT)
}

type Genre implements INode {
  id: ID @populatedBy(operations: [CREATE], callback: "nanoid")
  value: String! @unique
}
----
== should define the ID using the callback function

.GraphQL-Query
[source,graphql]
----
mutation {
  createProducts(
    input: {name: "TestProduct", genre: {connectOrCreate: [{where: {node: {value: "Action"}}, onCreate: {node: {value: "Action"}}}]}}
  ) {
    products {
      id
      name
      genre {
        id
        value
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this0_name": "TestProduct",
  "this0_genre_connectOrCreate_param0": "Action",
  "this0_genre_connectOrCreate_param1": "Action",
  "resolvedCallbacks": {
    "this0_id_nanoid": "callback_value",
    "this0_genre_connectOrCreate0_id_nanoid": "callback_value"
  }
}
----

.Expected Cypher output
[source,cypher]
----
CALL {
CREATE (this0:Product)
SET this0.id = $resolvedCallbacks.this0_id_nanoid
SET this0.name = $this0_name
WITH this0
CALL {
    WITH this0
    MERGE (this0_genre_connectOrCreate0:Genre { value: $this0_genre_connectOrCreate_param0 })
    ON CREATE SET
        this0_genre_connectOrCreate0.value = $this0_genre_connectOrCreate_param1,
        this0_genre_connectOrCreate0.id = $resolvedCallbacks.this0_genre_connectOrCreate0_id_nanoid
    MERGE (this0)-[this0_genre_connectOrCreate_this0:HAS_GENRE]->(this0_genre_connectOrCreate0)
    RETURN count(*) AS _
}
RETURN this0
}
CALL {
    WITH this0
    CALL {
        WITH this0
        MATCH (this0)-[create_this0:HAS_GENRE]->(create_this1:Genre)
        WITH create_this1 { .id, .value } AS create_this1
        RETURN collect(create_this1) AS create_var2
    }
    RETURN this0 { .id, .name, genre: create_var2 } AS create_var3
}
RETURN [create_var3] AS data
----

'''

