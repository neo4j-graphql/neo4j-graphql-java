:toc:

= https://github.com/neo4j/graphql/issues/1783

== Source schema

[source,graphql,schema=true]
----
type Series {
  id: ID! @unique
  current: Boolean!
  architecture: [MasterData!]! @relationship(type: "ARCHITECTURE", properties: "RelationProps", direction: OUT)
  nameDetails: NameDetails @relationship(type: "HAS_NAME", properties: "RelationProps", direction: OUT)
}

type NameDetails @mutation(operations: []) @query(read: false, aggregate: false) {
  fullName: String!
}

interface RelationProps @relationshipProperties {
  current: Boolean!
}

type MasterData {
  id: ID! @unique
  current: Boolean!
  nameDetails: NameDetails @relationship(type: "HAS_NAME", properties: "RelationProps", direction: OUT)
}
----
== should add parameters with implicit and

.GraphQL-Query
[source,graphql]
----
query ($where: SeriesWhere, $connectionWhere: RelationPropsWhere) {
  series(where: $where) {
    id
    nameDetailsConnection(where: {edge: $connectionWhere}) {
      edges {
        node {
          fullName
        }
      }
    }
    architectureConnection(where: {edge: $connectionWhere}) {
      edges {
        node {
          nameDetailsConnection(where: {edge: $connectionWhere}) {
            edges {
              node {
                fullName
              }
            }
          }
        }
      }
    }
  }
}
----

.GraphQL params input
[source,json,request=true]
----
{
  "where": {
    "current": true,
    "nameDetailsConnection": {
      "edge": {
        "current": true
      },
      "node": {
        "fullName_CONTAINS": "1"
      }
    },
    "architectureConnection_SINGLE": {
      "edge": {
        "current": true
      },
      "node": {
        "nameDetailsConnection": {
          "edge": {
            "current": true
          },
          "node": {
            "fullName": "MHA"
          }
        }
      }
    }
  },
  "connectionWhere": {
    "current": true
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": true,
  "param1": "MHA",
  "param2": true,
  "param3": true,
  "param4": "1",
  "param5": true,
  "param6": true,
  "param7": true,
  "param8": true
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Series)
WHERE (this.current = $param0 AND single(this2 IN [(this)-[this3:ARCHITECTURE]->(this2:MasterData) WHERE (single(this0 IN [(this2)-[this1:HAS_NAME]->(this0:NameDetails) WHERE (this0.fullName = $param1 AND this1.current = $param2) | 1] WHERE true) AND this3.current = $param3) | 1] WHERE true) AND single(this4 IN [(this)-[this5:HAS_NAME]->(this4:NameDetails) WHERE (this4.fullName CONTAINS $param4 AND this5.current = $param5) | 1] WHERE true))
CALL {
    WITH this
    MATCH (this)-[this6:HAS_NAME]->(this7:NameDetails)
    WHERE this6.current = $param6
    WITH collect({ node: this7, relationship: this6 }) AS edges
    WITH edges, size(edges) AS totalCount
    CALL {
        WITH edges
        UNWIND edges AS edge
        WITH edge.node AS this7, edge.relationship AS this6
        RETURN collect({ node: { fullName: this7.fullName } }) AS var8
    }
    RETURN { edges: var8, totalCount: totalCount } AS var9
}
CALL {
    WITH this
    MATCH (this)-[this10:ARCHITECTURE]->(this11:MasterData)
    WHERE this10.current = $param7
    WITH collect({ node: this11, relationship: this10 }) AS edges
    WITH edges, size(edges) AS totalCount
    CALL {
        WITH edges
        UNWIND edges AS edge
        WITH edge.node AS this11, edge.relationship AS this10
        CALL {
            WITH this11
            MATCH (this11)-[this12:HAS_NAME]->(this13:NameDetails)
            WHERE this12.current = $param8
            WITH collect({ node: this13, relationship: this12 }) AS edges
            WITH edges, size(edges) AS totalCount
            CALL {
                WITH edges
                UNWIND edges AS edge
                WITH edge.node AS this13, edge.relationship AS this12
                RETURN collect({ node: { fullName: this13.fullName } }) AS var14
            }
            RETURN { edges: var14, totalCount: totalCount } AS var15
        }
        RETURN collect({ node: { nameDetailsConnection: var15 } }) AS var16
    }
    RETURN { edges: var16, totalCount: totalCount } AS var17
}
RETURN this { .id, nameDetailsConnection: var9, architectureConnection: var17 } AS this
----

'''

