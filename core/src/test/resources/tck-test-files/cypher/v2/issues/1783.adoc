:toc:

= https://github.com/neo4j/graphql/issues/1783

== Source schema

[source,graphql,schema=true]
----
type Series {
  id: ID! @id(autogenerate: false)
  current: Boolean!
  architecture: [MasterData!]! @relationship(type: "ARCHITECTURE", properties: "RelationProps", direction: OUT)
  nameDetails: NameDetails @relationship(type: "HAS_NAME", properties: "RelationProps", direction: OUT)
}

type NameDetails @exclude(operations: [CREATE, UPDATE, DELETE, READ]) {
  fullName: String!
}

interface RelationProps {
  current: Boolean!
}

type MasterData {
  id: ID! @id(autogenerate: false)
  current: Boolean!
  nameDetails: NameDetails @relationship(type: "HAS_NAME", properties: "RelationProps", direction: OUT)
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{}
----
== should add parameters with implicit and

.GraphQL-Query
[source,graphql]
----
query ($where: SeriesWhere, $connectionWhere: RelationPropsWhere) {
  series(where: $where) {
    id
    nameDetailsConnection(where: {edge: $connectionWhere}) {
      edges {
        node {
          fullName
        }
      }
    }
    architectureConnection(where: {edge: $connectionWhere}) {
      edges {
        node {
          nameDetailsConnection(where: {edge: $connectionWhere}) {
            edges {
              node {
                fullName
              }
            }
          }
        }
      }
    }
  }
}
----

.GraphQL params input
[source,json,request=true]
----
{
  "where": {
    "current": true,
    "nameDetailsConnection": {
      "edge": {
        "current": true
      },
      "node": {
        "fullName_CONTAINS": "1"
      }
    },
    "architectureConnection_SINGLE": {
      "edge": {
        "current": true
      },
      "node": {
        "nameDetailsConnection": {
          "edge": {
            "current": true
          },
          "node": {
            "fullName": "MHA"
          }
        }
      }
    }
  },
  "connectionWhere": {
    "current": true
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : true,
  "param1" : true,
  "param2" : true,
  "param3" : "MHA",
  "param4" : true,
  "param5" : "1",
  "this_MasterData_connection_nameDetailsConnectionparam0" : true,
  "this_connection_architectureConnectionparam0" : true,
  "this_connection_nameDetailsConnectionparam0" : true
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Series)
WHERE (this.current = $param0
	AND size([(this)-[this0:ARCHITECTURE]->(this3:MasterData)
	WHERE (this0.current = $param1
		AND size([(this3)-[this1:HAS_NAME]->(this2:NameDetails)
		WHERE (this1.current = $param2
			AND this2.fullName = $param3) | 1]) = 1) | 1]) = 1
	AND size([(this)-[this4:HAS_NAME]->(this5:NameDetails)
	WHERE (this4.current = $param4
		AND this5.fullName CONTAINS $param5) | 1]) = 1)
CALL {
	WITH this
	MATCH (this)-[this_connection_nameDetailsConnectionthis0:HAS_NAME]->(this_NameDetails:NameDetails)
	WHERE this_connection_nameDetailsConnectionthis0.current = $this_connection_nameDetailsConnectionparam0
	WITH {
		node: {
			fullName: this_NameDetails.fullName
		}
	} AS edge
	WITH collect(edge) AS edges
	WITH edges, size(edges) AS totalCount
	RETURN {
		edges: edges,
		totalCount: totalCount
	} AS this_nameDetailsConnection
}
CALL {
	WITH this
	MATCH (this)-[this_connection_architectureConnectionthis0:ARCHITECTURE]->(this_MasterData:MasterData)
	WHERE this_connection_architectureConnectionthis0.current = $this_connection_architectureConnectionparam0
	CALL {
		WITH this_MasterData
		MATCH (this_MasterData)-[this_MasterData_connection_nameDetailsConnectionthis0:HAS_NAME]->(this_MasterData_NameDetails:NameDetails)
		WHERE this_MasterData_connection_nameDetailsConnectionthis0.current = $this_MasterData_connection_nameDetailsConnectionparam0
		WITH {
			node: {
				fullName: this_MasterData_NameDetails.fullName
			}
		} AS edge
		WITH collect(edge) AS edges
		WITH edges, size(edges) AS totalCount
		RETURN {
			edges: edges,
			totalCount: totalCount
		} AS this_MasterData_nameDetailsConnection
	}
	WITH {
		node: {
			nameDetailsConnection: this_MasterData_nameDetailsConnection
		}
	} AS edge
	WITH collect(edge) AS edges
	WITH edges, size(edges) AS totalCount
	RETURN {
		edges: edges,
		totalCount: totalCount
	} AS this_architectureConnection
}
RETURN this {
	.id,
	nameDetailsConnection: this_nameDetailsConnection,
	architectureConnection: this_architectureConnection
} AS this
----

'''

