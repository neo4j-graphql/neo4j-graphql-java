:toc:

= https://github.com/neo4j/graphql/issues/1848

== Source schema

[source,graphql,schema=true]
----
type ContentPiece @node(labels: ["ContentPiece", "UNIVERSAL"]) {
  uid: String! @unique
  id: Int
}

type Project @node(labels: ["Project", "UNIVERSAL"]) {
  uid: String! @unique
  id: Int
}

type Community @node(labels: ["Community", "UNIVERSAL"]) {
  uid: String! @unique
  id: Int
  hasContentPieces: [ContentPiece!]! @relationship(type: "COMMUNITY_CONTENTPIECE_HASCONTENTPIECES", direction: OUT)
  hasAssociatedProjects: [Project!]! @relationship(type: "COMMUNITY_PROJECT_HASASSOCIATEDPROJECTS", direction: OUT)
}

extend type Community {
  """Used on Community Landing Page"""
  hasFeedItems(limit: Int = 10, pageIndex: Int = 0): [FeedItem!]! @cypher(statement: """
  Match(this)-[:COMMUNITY_CONTENTPIECE_HASCONTENTPIECES|:COMMUNITY_PROJECT_HASASSOCIATEDPROJECTS]-(pag) return pag SKIP ($limit * $pageIndex) LIMIT $limit
  """, columnName: "pag")
}

union FeedItem = ContentPiece | Project
----
== should not concatenate AND and variable name

.GraphQL-Query
[source,graphql]
----
{
  communities {
    id
    hasFeedItems {
      ... on ContentPiece {
        id
      }
      ... on Project {
        id
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": 10,
  "param1": 0
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Community:UNIVERSAL)
CALL {
    WITH this
    CALL {
        WITH this
        WITH this AS this
        Match(this)-[:COMMUNITY_CONTENTPIECE_HASCONTENTPIECES|:COMMUNITY_PROJECT_HASASSOCIATEDPROJECTS]-(pag) return pag SKIP ($param0 * $param1) LIMIT $param0
    }
    WITH pag AS this0
    CALL {
        WITH this0
        CALL {
            WITH *
            MATCH (this0)
            WHERE this0:ContentPiece
            WITH this0 { .id, __resolveType: "ContentPiece", __id: id(this0) } AS this0
            RETURN this0 AS var1
            UNION
            WITH *
            MATCH (this0)
            WHERE this0:Project
            WITH this0 { .id, __resolveType: "Project", __id: id(this0) } AS this0
            RETURN this0 AS var1
        }
        RETURN var1
    }
    RETURN collect(var1) AS this0
}
RETURN this { .id, hasFeedItems: this0 } AS this
----

'''

