:toc:

= https://github.com/neo4j/graphql/issues/2022

== Source schema

[source,graphql,schema=true]
----
type ArtPiece {
  dbId: ID! @id @unique @relayId @alias(property: "id")
  title: String!
  auction: AuctionItem! @relationship(type: "SOLD_AT_AUCTION_AS", direction: OUT)
  owner: Organization! @relationship(type: "OWNED_BY", direction: OUT)
}

type AuctionItem {
  dbId: ID! @id @unique @relayId @alias(property: "id")
  auctionName: String!
  lotNumber: Int!
  item: ArtPiece! @relationship(type: "SOLD_AT_AUCTION_AS", direction: IN)
  buyer: Organization! @relationship(type: "BOUGHT_ITEM_AT_AUCTION", direction: IN)
  seller: Organization! @relationship(type: "SOLD_ITEM_AT_AUCTION", direction: IN)
}

type Organization {
  dbId: ID! @id @unique @relayId @alias(property: "id")
  name: String!
  artCollection: [ArtPiece!]! @relationship(type: "OWNED_BY", direction: IN)
  itemsSoldAtAuction: [AuctionItem!]! @relationship(type: "SOLD_ITEM_AT_AUCTION", direction: OUT)
  itemsBoughtAtAuction: [AuctionItem!]! @relationship(type: "BOUGHT_ITEM_AT_AUCTION", direction: OUT)
}
----
== query nested relations under a root connection field

.GraphQL-Query
[source,graphql]
----
{
  artPiecesConnection {
    totalCount
    edges {
      node {
        id
        title
        auction {
          id
          auctionName
          lotNumber
          buyer {
            id
            name
          }
        }
        owner {
          id
          name
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this0:ArtPiece)
WITH collect({ node: this0 }) AS edges
WITH edges, size(edges) AS totalCount
CALL {
    WITH edges
    UNWIND edges AS edge
    WITH edge.node AS this0
    CALL {
        WITH this0
        MATCH (this0)-[this1:SOLD_AT_AUCTION_AS]->(this2:AuctionItem)
        CALL {
            WITH this2
            MATCH (this2)<-[this3:BOUGHT_ITEM_AT_AUCTION]-(this4:Organization)
            WITH this4 { .name, dbId: this4.id } AS this4
            RETURN head(collect(this4)) AS var5
        }
        WITH this2 { .auctionName, .lotNumber, dbId: this2.id, buyer: var5 } AS this2
        RETURN head(collect(this2)) AS var6
    }
    CALL {
        WITH this0
        MATCH (this0)-[this7:OWNED_BY]->(this8:Organization)
        WITH this8 { .name, dbId: this8.id } AS this8
        RETURN head(collect(this8)) AS var9
    }
    RETURN collect({ node: { dbId: this0.id, title: this0.title, auction: var6, owner: var9 } }) AS var10
}
RETURN { edges: var10, totalCount: totalCount } AS this
----

'''

