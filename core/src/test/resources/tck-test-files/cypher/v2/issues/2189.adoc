:toc:

= https://github.com/neo4j/graphql/issues/2189

== Source schema

[source,graphql,schema=true]
----
type Test_Item {
  uuid: ID! @id @unique
  int: Int
  str: String
  bool: Boolean
  feedback: Test_Feedback @relationship(type: "TEST_RELATIONSHIP", direction: IN)
  feedbackCypher: Test_Feedback @cypher(statement: """
  OPTIONAL MATCH (this)<-[:TEST_RELATIONSHIP]-(t:Test_Feedback)
  RETURN t
  LIMIT 1
  """, columnName: "t")
}

type Test_Feedback {
  uuid: ID! @id @unique
  int: Int
  str: String
  bool: Boolean
  item: Test_Item @relationship(type: "TEST_RELATIONSHIP", direction: OUT)
}
----
== Mutation followed by query with Cypher field should return 2 nodes

.GraphQL-Query
[source,graphql]
----
mutation {
  createTestItems(
    input: [{feedback: {create: {node: {str: "hi there"}}}, int: 1, str: "one", bool: false}, {int: 2, str: "two", bool: true}]
  ) {
    info {
      relationshipsCreated
      nodesCreated
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "create_param0": [
    {
      "int": 1,
      "str": "one",
      "bool": false,
      "feedback": {
        "create": {
          "node": {
            "str": "hi there"
          }
        }
      }
    },
    {
      "int": 2,
      "str": "two",
      "bool": true
    }
  ]
}
----

.Expected Cypher output
[source,cypher]
----
UNWIND $create_param0 AS create_var0
CALL {
    WITH create_var0
    CREATE (create_this1:Test_Item)
    SET
        create_this1.int = create_var0.int,
        create_this1.str = create_var0.str,
        create_this1.bool = create_var0.bool,
        create_this1.uuid = randomUUID()
    WITH create_this1, create_var0
    CALL {
        WITH create_this1, create_var0
        UNWIND create_var0.feedback.create AS create_var2
        WITH create_var2.node AS create_var3, create_var2.edge AS create_var4, create_this1
        CREATE (create_this5:Test_Feedback)
        SET
            create_this5.str = create_var3.str,
            create_this5.uuid = randomUUID()
        MERGE (create_this1)<-[create_this6:TEST_RELATIONSHIP]-(create_this5)
        WITH create_this5
        CALL {
        	WITH create_this5
        	MATCH (create_this5)-[create_this5_item_Test_Item_unique:TEST_RELATIONSHIP]->(:Test_Item)
        	WITH count(create_this5_item_Test_Item_unique) as c
        	WHERE apoc.util.validatePredicate(NOT (c <= 1), '@neo4j/graphql/RELATIONSHIP-REQUIREDTest_Feedback.item must be less than or equal to one', [0])
        	RETURN c AS create_this5_item_Test_Item_unique_ignored
        }
        RETURN collect(NULL) AS create_var7
    }
    WITH create_this1
    CALL {
    	WITH create_this1
    	MATCH (create_this1)<-[create_this1_feedback_Test_Feedback_unique:TEST_RELATIONSHIP]-(:Test_Feedback)
    	WITH count(create_this1_feedback_Test_Feedback_unique) as c
    	WHERE apoc.util.validatePredicate(NOT (c <= 1), '@neo4j/graphql/RELATIONSHIP-REQUIREDTest_Item.feedback must be less than or equal to one', [0])
    	RETURN c AS create_this1_feedback_Test_Feedback_unique_ignored
    }
    RETURN create_this1
}
RETURN "Query cannot conclude with CALL"
----

'''

== Mutation followed by query without Cypher field should return 2 nodes

.GraphQL-Query
[source,graphql]
----
mutation {
  createTestItems(
    input: [{feedback: {create: {node: {str: "hi there"}}}, int: 1, str: "one", bool: false}, {int: 2, str: "two", bool: true}]
  ) {
    info {
      relationshipsCreated
      nodesCreated
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "create_param0": [
    {
      "int": 1,
      "str": "one",
      "bool": false,
      "feedback": {
        "create": {
          "node": {
            "str": "hi there"
          }
        }
      }
    },
    {
      "int": 2,
      "str": "two",
      "bool": true
    }
  ]
}
----

.Expected Cypher output
[source,cypher]
----
UNWIND $create_param0 AS create_var0
CALL {
    WITH create_var0
    CREATE (create_this1:Test_Item)
    SET
        create_this1.int = create_var0.int,
        create_this1.str = create_var0.str,
        create_this1.bool = create_var0.bool,
        create_this1.uuid = randomUUID()
    WITH create_this1, create_var0
    CALL {
        WITH create_this1, create_var0
        UNWIND create_var0.feedback.create AS create_var2
        WITH create_var2.node AS create_var3, create_var2.edge AS create_var4, create_this1
        CREATE (create_this5:Test_Feedback)
        SET
            create_this5.str = create_var3.str,
            create_this5.uuid = randomUUID()
        MERGE (create_this1)<-[create_this6:TEST_RELATIONSHIP]-(create_this5)
        WITH create_this5
        CALL {
        	WITH create_this5
        	MATCH (create_this5)-[create_this5_item_Test_Item_unique:TEST_RELATIONSHIP]->(:Test_Item)
        	WITH count(create_this5_item_Test_Item_unique) as c
        	WHERE apoc.util.validatePredicate(NOT (c <= 1), '@neo4j/graphql/RELATIONSHIP-REQUIREDTest_Feedback.item must be less than or equal to one', [0])
        	RETURN c AS create_this5_item_Test_Item_unique_ignored
        }
        RETURN collect(NULL) AS create_var7
    }
    WITH create_this1
    CALL {
    	WITH create_this1
    	MATCH (create_this1)<-[create_this1_feedback_Test_Feedback_unique:TEST_RELATIONSHIP]-(:Test_Feedback)
    	WITH count(create_this1_feedback_Test_Feedback_unique) as c
    	WHERE apoc.util.validatePredicate(NOT (c <= 1), '@neo4j/graphql/RELATIONSHIP-REQUIREDTest_Item.feedback must be less than or equal to one', [0])
    	RETURN c AS create_this1_feedback_Test_Feedback_unique_ignored
    }
    RETURN create_this1
}
RETURN "Query cannot conclude with CALL"
----

'''

== Mutation with Cypher relationship in projection should return 2 nodes

.GraphQL-Query
[source,graphql]
----
mutation {
  createTestItems(
    input: [{feedback: {create: {node: {str: "hi there"}}}, int: 1, str: "one", bool: false}, {int: 2, str: "two", bool: true}]
  ) {
    info {
      relationshipsCreated
      nodesCreated
    }
    testItems {
      bool
      int
      str
      uuid
      feedbackCypher {
        bool
        str
        int
        uuid
      }
      feedback {
        uuid
        int
        str
        bool
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "create_param0": [
    {
      "int": 1,
      "str": "one",
      "bool": false,
      "feedback": {
        "create": {
          "node": {
            "str": "hi there"
          }
        }
      }
    },
    {
      "int": 2,
      "str": "two",
      "bool": true
    }
  ]
}
----

.Expected Cypher output
[source,cypher]
----
UNWIND $create_param0 AS create_var0
CALL {
    WITH create_var0
    CREATE (create_this1:Test_Item)
    SET
        create_this1.int = create_var0.int,
        create_this1.str = create_var0.str,
        create_this1.bool = create_var0.bool,
        create_this1.uuid = randomUUID()
    WITH create_this1, create_var0
    CALL {
        WITH create_this1, create_var0
        UNWIND create_var0.feedback.create AS create_var2
        WITH create_var2.node AS create_var3, create_var2.edge AS create_var4, create_this1
        CREATE (create_this5:Test_Feedback)
        SET
            create_this5.str = create_var3.str,
            create_this5.uuid = randomUUID()
        MERGE (create_this1)<-[create_this6:TEST_RELATIONSHIP]-(create_this5)
        WITH create_this5
        CALL {
        	WITH create_this5
        	MATCH (create_this5)-[create_this5_item_Test_Item_unique:TEST_RELATIONSHIP]->(:Test_Item)
        	WITH count(create_this5_item_Test_Item_unique) as c
        	WHERE apoc.util.validatePredicate(NOT (c <= 1), '@neo4j/graphql/RELATIONSHIP-REQUIREDTest_Feedback.item must be less than or equal to one', [0])
        	RETURN c AS create_this5_item_Test_Item_unique_ignored
        }
        RETURN collect(NULL) AS create_var7
    }
    WITH create_this1
    CALL {
    	WITH create_this1
    	MATCH (create_this1)<-[create_this1_feedback_Test_Feedback_unique:TEST_RELATIONSHIP]-(:Test_Feedback)
    	WITH count(create_this1_feedback_Test_Feedback_unique) as c
    	WHERE apoc.util.validatePredicate(NOT (c <= 1), '@neo4j/graphql/RELATIONSHIP-REQUIREDTest_Item.feedback must be less than or equal to one', [0])
    	RETURN c AS create_this1_feedback_Test_Feedback_unique_ignored
    }
    RETURN create_this1
}
CALL {
    WITH create_this1
    CALL {
        WITH create_this1
        WITH create_this1 AS this
        OPTIONAL MATCH (this)<-[:TEST_RELATIONSHIP]-(t:Test_Feedback)
        RETURN t
        LIMIT 1
    }
    WITH t AS create_this8
    RETURN head(collect(create_this8 { .bool, .str, .int, .uuid })) AS create_this8
}
CALL {
    WITH create_this1
    MATCH (create_this1)<-[create_this9:TEST_RELATIONSHIP]-(create_this10:Test_Feedback)
    WITH create_this10 { .uuid, .int, .str, .bool } AS create_this10
    RETURN head(collect(create_this10)) AS create_var11
}
RETURN collect(create_this1 { .bool, .int, .str, .uuid, feedbackCypher: create_this8, feedback: create_var11 }) AS data
----

'''

== Mutation without Cypher relationship in projection should return 2 nodes

.GraphQL-Query
[source,graphql]
----
mutation {
  createTestItems(
    input: [{feedback: {create: {node: {str: "hi there"}}}, int: 1, str: "one", bool: false}, {int: 2, str: "two", bool: true}]
  ) {
    info {
      relationshipsCreated
      nodesCreated
    }
    testItems {
      bool
      int
      str
      uuid
      feedback {
        uuid
        int
        str
        bool
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "create_param0": [
    {
      "int": 1,
      "str": "one",
      "bool": false,
      "feedback": {
        "create": {
          "node": {
            "str": "hi there"
          }
        }
      }
    },
    {
      "int": 2,
      "str": "two",
      "bool": true
    }
  ]
}
----

.Expected Cypher output
[source,cypher]
----
UNWIND $create_param0 AS create_var0
CALL {
    WITH create_var0
    CREATE (create_this1:Test_Item)
    SET
        create_this1.int = create_var0.int,
        create_this1.str = create_var0.str,
        create_this1.bool = create_var0.bool,
        create_this1.uuid = randomUUID()
    WITH create_this1, create_var0
    CALL {
        WITH create_this1, create_var0
        UNWIND create_var0.feedback.create AS create_var2
        WITH create_var2.node AS create_var3, create_var2.edge AS create_var4, create_this1
        CREATE (create_this5:Test_Feedback)
        SET
            create_this5.str = create_var3.str,
            create_this5.uuid = randomUUID()
        MERGE (create_this1)<-[create_this6:TEST_RELATIONSHIP]-(create_this5)
        WITH create_this5
        CALL {
        	WITH create_this5
        	MATCH (create_this5)-[create_this5_item_Test_Item_unique:TEST_RELATIONSHIP]->(:Test_Item)
        	WITH count(create_this5_item_Test_Item_unique) as c
        	WHERE apoc.util.validatePredicate(NOT (c <= 1), '@neo4j/graphql/RELATIONSHIP-REQUIREDTest_Feedback.item must be less than or equal to one', [0])
        	RETURN c AS create_this5_item_Test_Item_unique_ignored
        }
        RETURN collect(NULL) AS create_var7
    }
    WITH create_this1
    CALL {
    	WITH create_this1
    	MATCH (create_this1)<-[create_this1_feedback_Test_Feedback_unique:TEST_RELATIONSHIP]-(:Test_Feedback)
    	WITH count(create_this1_feedback_Test_Feedback_unique) as c
    	WHERE apoc.util.validatePredicate(NOT (c <= 1), '@neo4j/graphql/RELATIONSHIP-REQUIREDTest_Item.feedback must be less than or equal to one', [0])
    	RETURN c AS create_this1_feedback_Test_Feedback_unique_ignored
    }
    RETURN create_this1
}
CALL {
    WITH create_this1
    MATCH (create_this1)<-[create_this8:TEST_RELATIONSHIP]-(create_this9:Test_Feedback)
    WITH create_this9 { .uuid, .int, .str, .bool } AS create_this9
    RETURN head(collect(create_this9)) AS create_var10
}
RETURN collect(create_this1 { .bool, .int, .str, .uuid, feedback: create_var10 }) AS data
----

'''

