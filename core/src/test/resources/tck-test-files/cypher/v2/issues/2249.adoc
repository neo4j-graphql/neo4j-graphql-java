:toc:

= https://github.com/neo4j/graphql/issues/2249

== Source schema

[source,graphql,schema=true]
----
type Movie {
  title: String!
  reviewers: [Reviewer!]! @relationship(type: "REVIEWED", properties: "Review", direction: IN)
}

interface Review @relationshipProperties {
  score: Int!
}

type Person implements Reviewer {
  name: String!
  reputation: Int!
  id: Int @unique
  reviewerId: Int @unique
}

type Influencer implements Reviewer {
  reputation: Int!
  url: String!
  reviewerId: Int
}

interface Reviewer {
  reputation: Int!
  reviewerId: Int
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{}
----
== nested update with create should generate a single relationship with the nested value

.GraphQL-Query
[source,graphql]
----
mutation UpdateMovies {
  updateMovies(
    where: {title: "John Wick"}
    update: {reviewers: [{create: [{edge: {score: 10}, node: {Person: {reputation: 100, name: "Ana"}}}]}]}
  ) {
    movies {
      title
      reviewers {
        ... on Person {
          name
          reputation
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "John Wick",
  "this_reviewers0_create0_node_name" : "Ana",
  "this_reviewers0_create0_node_reputation" : 100,
  "updateMovies" : {
    "args" : {
      "update" : {
        "reviewers" : [ {
          "create" : [ {
            "node" : {
              "Person" : {
                "name" : "Ana",
                "reputation" : 100
              }
            },
            "edge" : {
              "score" : 10
            }
          } ]
        } ]
      }
    }
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.title = $param0
WITH this
CALL {
	WITH this
	WITH this
	CREATE (this_reviewers0_create0_node:Person)
	SET this_reviewers0_create0_node.name = $this_reviewers0_create0_node_name
	SET this_reviewers0_create0_node.reputation = $this_reviewers0_create0_node_reputation
	MERGE (this)<-[this_reviewers0_create0_relationship:REVIEWED]-(this_reviewers0_create0_node)
	SET this_reviewers0_create0_relationship.score = $updateMovies.args.update.reviewers[0].create[0].edge.score
	RETURN count(*) AS update_this_Person
}
CALL {
	WITH this
	WITH this
	RETURN count(*) AS update_this_Influencer
}
WITH *
WITH *
CALL {
	WITH *
	CALL {
		WITH this
		MATCH (this)<-[update_this0:REVIEWED]-(this_Person:Person)
		RETURN {
			__resolveType: 'Person',
			name: this_Person.name,
			reputation: this_Person.reputation
		} AS this_reviewers UNION
		WITH this
		MATCH (this)<-[update_this1:REVIEWED]-(this_Influencer:Influencer)
		RETURN {
			__resolveType: 'Influencer'
		} AS this_reviewers
	}
	RETURN collect(this_reviewers) AS this_reviewers
}
RETURN collect(DISTINCT this {
	.title,
	reviewers: this_reviewers
}) AS data
----

'''

