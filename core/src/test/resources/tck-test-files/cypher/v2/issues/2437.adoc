:toc:

= https://github.com/neo4j/graphql/issues/2437

== Source schema

[source,graphql,schema=true]
----
type JWT @jwt {
  roles: [String!]!
}

type Agent @mutation(operations: [CREATE, UPDATE]) {
  uuid: ID! @id @unique
  archivedAt: DateTime
  valuations: [Valuation!]! @relationship(type: "IS_VALUATION_AGENT", direction: OUT)
}

extend type Agent @authorization(validate: [{operations: [CREATE], where: {jwt: {roles_INCLUDES: "Admin"}}}], filter: [{where: {node: {archivedAt: null}}}])

type Valuation @mutation(operations: [CREATE, UPDATE]) {
  uuid: ID! @id @unique
  archivedAt: DateTime
  agent: Agent! @relationship(type: "IS_VALUATION_AGENT", direction: IN)
}

extend type Valuation @authorization(filter: [{where: {node: {archivedAt: null}}}])
----
== query and limits nested connections

.GraphQL-Query
[source,graphql]
----
query Agents {
  agents(where: {uuid: "a1"}) {
    uuid
    valuationsConnection(first: 10) {
      edges {
        node {
          uuid
        }
      }
      pageInfo {
        hasNextPage
      }
    }
  }
}
----

.Query Context
[source,json,query-config=true]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [],
    "jwt": {
      "roles": []
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": "a1",
  "isAuthenticated": true,
  "param2": 10
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Agent)
WITH *
WHERE (this.uuid = $param0 AND ($isAuthenticated = true AND this.archivedAt IS NULL))
CALL {
    WITH this
    MATCH (this)-[this0:IS_VALUATION_AGENT]->(this1:Valuation)
    WHERE ($isAuthenticated = true AND this1.archivedAt IS NULL)
    WITH collect({ node: this1, relationship: this0 }) AS edges
    WITH edges, size(edges) AS totalCount
    CALL {
        WITH edges
        UNWIND edges AS edge
        WITH edge.node AS this1, edge.relationship AS this0
        WITH *
        
        LIMIT $param2
        RETURN collect({ node: { uuid: this1.uuid } }) AS var2
    }
    RETURN { edges: var2, totalCount: totalCount } AS var3
}
RETURN this { .uuid, valuationsConnection: var3 } AS this
----

'''

