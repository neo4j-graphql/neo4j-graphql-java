:toc:

= https://github.com/neo4j/graphql/issues/2581

== Source schema

[source,graphql,schema=true]
----
type Author {
  name: String
  mostRecentBook: Book @cypher(statement: "MATCH (this)-[:AUTHORED_BOOK]->(b:Book) RETURN b AS result ORDER BY b.year DESC LIMIT 1", columnName: "result")
  mostRecentBooks: [Book!] @cypher(statement: "MATCH (this)-[:AUTHORED_BOOK]->(b:Book) RETURN b AS result ORDER BY b.year DESC LIMIT 5", columnName: "result")
  lastPublishedYear: Int @cypher(statement: "MATCH (this)-[:AUTHORED_BOOK]->(b:Book) RETURN b.year AS result ORDER BY b.year DESC LIMIT 1", columnName: "result")
  books: [Book!]! @relationship(type: "AUTHORED_BOOK", direction: OUT)
}

type Book {
  name: String!
  year: Int
  refID: ID @id @unique
  soldCopies: Int @cypher(statement: "OPTIONAL MATCH(sales:Sales) WHERE this.refID = sales.refID WITH count(sales) as result RETURN result as result", columnName: "result")
  soldCopiesWithoutColumnName: Int @cypher(statement: "OPTIONAL MATCH(sales:Sales) WHERE this.refID = sales.refID WITH count(sales) as result RETURN result as result", columnName: "result")
  authors: [Author!]! @relationship(type: "AUTHORED_BOOK", direction: IN)
}

type Sales {
  price: Int
  refID: ID
}
----
== query nested custom cypher with columnName

.GraphQL-Query
[source,graphql]
----
{
  authors {
    name
    mostRecentBook {
      name
      year
      soldCopies
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{ }
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Author)
CALL {
	WITH this
	CALL {
		WITH this
		WITH this AS this
		MATCH (this)-[:AUTHORED_BOOK]->(b:Book)
		RETURN b AS result ORDER BY b.year DESC LIMIT 1
	}
	WITH result AS this0
	CALL {
		WITH this0
		CALL {
			WITH this0
			WITH this0 AS this
			OPTIONAL MATCH (sales:Sales)
			WHERE this.refID = sales.refID
			WITH count(sales) AS result
			RETURN result AS result
		}
		UNWIND result AS this1
		RETURN head(collect(this1)) AS this1
	}
	RETURN head(collect(this0 {
		.name,
		.year,
		soldCopies: this1
	})) AS this0
}
RETURN this {
	.name,
	mostRecentBook: this0
} AS this
----

'''

== query nested custom cypher without columnName

.GraphQL-Query
[source,graphql]
----
{
  authors {
    name
    mostRecentBook {
      name
      year
      soldCopiesWithoutColumnName
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{ }
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Author)
CALL {
	WITH this
	CALL {
		WITH this
		WITH this AS this
		MATCH (this)-[:AUTHORED_BOOK]->(b:Book)
		RETURN b AS result ORDER BY b.year DESC LIMIT 1
	}
	WITH result AS this0
	CALL {
		WITH this0
		CALL {
			WITH this0
			WITH this0 AS this
			OPTIONAL MATCH (sales:Sales)
			WHERE this.refID = sales.refID
			WITH count(sales) AS result
			RETURN result AS result
		}
		UNWIND result AS this1
		RETURN head(collect(this1)) AS this1
	}
	RETURN head(collect(this0 {
		.name,
		.year,
		soldCopiesWithoutColumnName: this1
	})) AS this0
}
RETURN this {
	.name,
	mostRecentBook: this0
} AS this
----

'''

