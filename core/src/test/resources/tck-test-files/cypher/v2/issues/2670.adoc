:toc:

= https://github.com/neo4j/graphql/issues/2670

== Source schema

[source,graphql,schema=true]
----
type Movie {
  title: String
  genres: [Genre!]! @relationship(type: "IN_GENRE", direction: OUT, properties: "InGenre")
}

type Genre {
  name: String
  movies: [Movie!]! @relationship(type: "IN_GENRE", direction: IN, properties: "InGenre")
  series: [Series!]! @relationship(type: "IN_GENRE", direction: IN, properties: "InGenre")
}

type Series {
  name: String!
  genres: [Genre!]! @relationship(type: "IN_GENRE", direction: OUT, properties: "InGenre")
}

type InGenre @relationshipProperties {
  intValue: Int!
}
----
== should find genresConnection with aggregation at the same level

.GraphQL-Query
[source,graphql]
----
{
  movies(
    where: {genresConnection_SOME: {node: {moviesAggregate: {count: 3}}}, genresAggregate: {count: 1}}
  ) {
    title
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": 3,
  "param1": 1
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL {
    WITH this
    MATCH (this)-[this0:IN_GENRE]->(this1:Genre)
    CALL {
        WITH this1
        MATCH (this1)<-[this2:IN_GENRE]-(this3:Movie)
        RETURN count(this3) = $param0 AS var4
    }
    WITH *
    WHERE var4 = true
    RETURN count(this1) > 0 AS var5
}
CALL {
    WITH this
    MATCH (this)-[this6:IN_GENRE]->(this7:Genre)
    RETURN count(this7) = $param1 AS var8
}
WITH *
WHERE (var5 = true AND var8 = true)
RETURN this { .title } AS this
----

'''

== should find genresConnection with multiple AND aggregates

.GraphQL-Query
[source,graphql]
----
{
  movies(
    where: {genresConnection_SOME: {AND: [{node: {moviesAggregate: {count: 2}}}, {node: {seriesAggregate: {node: {name_SHORTEST_LENGTH_EQUAL: 1}}}}]}}
  ) {
    title
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": 2,
  "param1": 1
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL {
    WITH this
    MATCH (this)-[this0:IN_GENRE]->(this1:Genre)
    CALL {
        WITH this1
        MATCH (this1)<-[this2:IN_GENRE]-(this3:Movie)
        RETURN count(this3) = $param0 AS var4
    }
    CALL {
        WITH this1
        MATCH (this1)<-[this5:IN_GENRE]-(this6:Series)
        RETURN min(size(this6.name)) = $param1 AS var7
    }
    WITH *
    WHERE (var4 = true AND var7 = true)
    RETURN count(this1) > 0 AS var8
}
WITH *
WHERE var8 = true
RETURN this { .title } AS this
----

'''

== should find genresConnection with multiple implicit AND aggregates

.GraphQL-Query
[source,graphql]
----
{
  movies(
    where: {genresConnection_SOME: {node: {moviesAggregate: {count: 2}, seriesAggregate: {node: {name_SHORTEST_LENGTH_EQUAL: 983}}}}}
  ) {
    title
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": 2,
  "param1": 983
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL {
    WITH this
    MATCH (this)-[this0:IN_GENRE]->(this1:Genre)
    CALL {
        WITH this1
        MATCH (this1)<-[this2:IN_GENRE]-(this3:Movie)
        RETURN count(this3) = $param0 AS var4
    }
    CALL {
        WITH this1
        MATCH (this1)<-[this5:IN_GENRE]-(this6:Series)
        RETURN min(size(this6.name)) = $param1 AS var7
    }
    WITH *
    WHERE (var4 = true AND var7 = true)
    RETURN count(this1) > 0 AS var8
}
WITH *
WHERE var8 = true
RETURN this { .title } AS this
----

'''

== should find genresConnection with multiple OR aggregates

.GraphQL-Query
[source,graphql]
----
{
  movies(
    where: {genresConnection_SOME: {OR: [{node: {moviesAggregate: {count: 3}}}, {node: {seriesAggregate: {node: {name_SHORTEST_LENGTH_EQUAL: 983}}}}]}}
  ) {
    title
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": 3,
  "param1": 983
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL {
    WITH this
    MATCH (this)-[this0:IN_GENRE]->(this1:Genre)
    CALL {
        WITH this1
        MATCH (this1)<-[this2:IN_GENRE]-(this3:Movie)
        RETURN count(this3) = $param0 AS var4
    }
    CALL {
        WITH this1
        MATCH (this1)<-[this5:IN_GENRE]-(this6:Series)
        RETURN min(size(this6.name)) = $param1 AS var7
    }
    WITH *
    WHERE (var4 = true OR var7 = true)
    RETURN count(this1) > 0 AS var8
}
WITH *
WHERE var8 = true
RETURN this { .title } AS this
----

'''

== should find where genresConnection_ALL

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {genresConnection_ALL: {node: {moviesAggregate: {count: 2}}}}) {
    title
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": 2,
  "param1": 2
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL {
    WITH this
    MATCH (this)-[this0:IN_GENRE]->(this1:Genre)
    CALL {
        WITH this1
        MATCH (this1)<-[this2:IN_GENRE]-(this3:Movie)
        RETURN count(this3) = $param0 AS var4
    }
    WITH *
    WHERE var4 = true
    RETURN count(this1) > 0 AS var5
}
CALL {
    WITH this
    MATCH (this)-[this0:IN_GENRE]->(this1:Genre)
    CALL {
        WITH this1
        MATCH (this1)<-[this6:IN_GENRE]-(this7:Movie)
        RETURN count(this7) = $param1 AS var8
    }
    WITH *
    WHERE NOT (var8 = true)
    RETURN count(this1) > 0 AS var9
}
WITH *
WHERE (var9 = false AND var5 = true)
RETURN this { .title } AS this
----

'''

== should find where genresConnection_NONE

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {genresConnection_NONE: {node: {moviesAggregate: {count: 2}}}}) {
    title
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": 2
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL {
    WITH this
    MATCH (this)-[this0:IN_GENRE]->(this1:Genre)
    CALL {
        WITH this1
        MATCH (this1)<-[this2:IN_GENRE]-(this3:Movie)
        RETURN count(this3) = $param0 AS var4
    }
    WITH *
    WHERE var4 = true
    RETURN count(this1) > 0 AS var5
}
WITH *
WHERE var5 = false
RETURN this { .title } AS this
----

'''

== should find where genresConnection_NOT

.GraphQL-Query
[source,graphql]
----
{
  movies(
    where: {NOT: {genresConnection_SOME: {node: {moviesAggregate: {count: 2}}}}}
  ) {
    title
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": 2
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL {
    WITH this
    MATCH (this)-[this0:IN_GENRE]->(this1:Genre)
    CALL {
        WITH this1
        MATCH (this1)<-[this2:IN_GENRE]-(this3:Movie)
        RETURN count(this3) = $param0 AS var4
    }
    WITH *
    WHERE var4 = true
    RETURN count(this1) > 0 AS var5
}
WITH *
WHERE NOT (var5 = true)
RETURN this { .title } AS this
----

'''

== should find where genresConnection_SINGLE

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {genresConnection_SINGLE: {node: {moviesAggregate: {count: 2}}}}) {
    title
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": 2
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL {
    WITH this
    MATCH (this)-[this0:IN_GENRE]->(this1:Genre)
    CALL {
        WITH this1
        MATCH (this1)<-[this2:IN_GENRE]-(this3:Movie)
        RETURN count(this3) = $param0 AS var4
    }
    WITH *
    WHERE var4 = true
    RETURN count(this1) = 1 AS var5
}
WITH *
WHERE var5 = true
RETURN this { .title } AS this
----

'''

== should find where genresConnection_SOME

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {genresConnection_SOME: {node: {moviesAggregate: {count: 2}}}}) {
    title
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": 2
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL {
    WITH this
    MATCH (this)-[this0:IN_GENRE]->(this1:Genre)
    CALL {
        WITH this1
        MATCH (this1)<-[this2:IN_GENRE]-(this3:Movie)
        RETURN count(this3) = $param0 AS var4
    }
    WITH *
    WHERE var4 = true
    RETURN count(this1) > 0 AS var5
}
WITH *
WHERE var5 = true
RETURN this { .title } AS this
----

'''

== should find where moviesAggregate count equal

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {genresConnection_SOME: {node: {moviesAggregate: {count: 2}}}}) {
    title
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": 2
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL {
    WITH this
    MATCH (this)-[this0:IN_GENRE]->(this1:Genre)
    CALL {
        WITH this1
        MATCH (this1)<-[this2:IN_GENRE]-(this3:Movie)
        RETURN count(this3) = $param0 AS var4
    }
    WITH *
    WHERE var4 = true
    RETURN count(this1) > 0 AS var5
}
WITH *
WHERE var5 = true
RETURN this { .title } AS this
----

'''

== should find where moviesAggregate count_GT

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {genresConnection_SOME: {node: {moviesAggregate: {count_GT: 2}}}}) {
    title
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": 2
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL {
    WITH this
    MATCH (this)-[this0:IN_GENRE]->(this1:Genre)
    CALL {
        WITH this1
        MATCH (this1)<-[this2:IN_GENRE]-(this3:Movie)
        RETURN count(this3) > $param0 AS var4
    }
    WITH *
    WHERE var4 = true
    RETURN count(this1) > 0 AS var5
}
WITH *
WHERE var5 = true
RETURN this { .title } AS this
----

'''

== should find where moviesAggregate count_LT

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {genresConnection_SOME: {node: {moviesAggregate: {count_LT: 3}}}}) {
    title
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": 3
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL {
    WITH this
    MATCH (this)-[this0:IN_GENRE]->(this1:Genre)
    CALL {
        WITH this1
        MATCH (this1)<-[this2:IN_GENRE]-(this3:Movie)
        RETURN count(this3) < $param0 AS var4
    }
    WITH *
    WHERE var4 = true
    RETURN count(this1) > 0 AS var5
}
WITH *
WHERE var5 = true
RETURN this { .title } AS this
----

'''

== should find where moviesAggregate edge property MAX_LT

.GraphQL-Query
[source,graphql]
----
{
  movies(
    where: {genresConnection_SOME: {node: {moviesAggregate: {edge: {intValue_MAX_LT: 983}}}}}
  ) {
    title
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": 983
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL {
    WITH this
    MATCH (this)-[this0:IN_GENRE]->(this1:Genre)
    CALL {
        WITH this1
        MATCH (this1)<-[this2:IN_GENRE]-(this3:Movie)
        RETURN max(this2.intValue) < $param0 AS var4
    }
    WITH *
    WHERE var4 = true
    RETURN count(this1) > 0 AS var5
}
WITH *
WHERE var5 = true
RETURN this { .title } AS this
----

'''

== should find where moviesAggregate edge property MIN_EQUAL

.GraphQL-Query
[source,graphql]
----
{
  movies(
    where: {genresConnection_SOME: {node: {moviesAggregate: {edge: {intValue_MIN_EQUAL: 1}}}}}
  ) {
    title
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": 1
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL {
    WITH this
    MATCH (this)-[this0:IN_GENRE]->(this1:Genre)
    CALL {
        WITH this1
        MATCH (this1)<-[this2:IN_GENRE]-(this3:Movie)
        RETURN min(this2.intValue) = $param0 AS var4
    }
    WITH *
    WHERE var4 = true
    RETURN count(this1) > 0 AS var5
}
WITH *
WHERE var5 = true
RETURN this { .title } AS this
----

'''

== should find where moviesAggregate node property AVERAGE

.GraphQL-Query
[source,graphql]
----
{
  movies(
    where: {genresConnection_SOME: {node: {moviesAggregate: {node: {title_AVERAGE_LENGTH_EQUAL: 1}}}}}
  ) {
    title
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": 1
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL {
    WITH this
    MATCH (this)-[this0:IN_GENRE]->(this1:Genre)
    CALL {
        WITH this1
        MATCH (this1)<-[this2:IN_GENRE]-(this3:Movie)
        RETURN avg(size(this3.title)) = $param0 AS var4
    }
    WITH *
    WHERE var4 = true
    RETURN count(this1) > 0 AS var5
}
WITH *
WHERE var5 = true
RETURN this { .title } AS this
----

'''

== should find where moviesAggregate node property SHORTEST

.GraphQL-Query
[source,graphql]
----
{
  movies(
    where: {genresConnection_SOME: {node: {moviesAggregate: {node: {title_SHORTEST_LENGTH_EQUAL: 5}}}}}
  ) {
    title
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": 5
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL {
    WITH this
    MATCH (this)-[this0:IN_GENRE]->(this1:Genre)
    CALL {
        WITH this1
        MATCH (this1)<-[this2:IN_GENRE]-(this3:Movie)
        RETURN min(size(this3.title)) = $param0 AS var4
    }
    WITH *
    WHERE var4 = true
    RETURN count(this1) > 0 AS var5
}
WITH *
WHERE var5 = true
RETURN this { .title } AS this
----

'''

