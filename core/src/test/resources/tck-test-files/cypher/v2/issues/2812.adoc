:toc:

= https://github.com/neo4j/graphql/issues/2812

== Source schema

[source,graphql,schema=true]
----
type JWT @jwt {
  roles: [String!]!
}

type Actor @authorization(validate: [{when: [BEFORE], where: {node: {nodeCreatedBy: "$jwt.sub"}}}]) {
  id: ID! @id @unique
  name: String
  nodeCreatedBy: String
  fieldA: String @authorization(validate: [{operations: [CREATE, UPDATE], where: {jwt: {roles_INCLUDES: "role-A"}}}])
  fieldB: String @authorization(validate: [{operations: [CREATE, UPDATE], where: {jwt: {roles_INCLUDES: "role-B"}}}])
  movies: [Movie!]! @relationship(type: "ACTED_IN", direction: OUT)
}

type Movie @authorization(validate: [{operations: [CREATE, UPDATE], where: {jwt: {roles_INCLUDES: "admin"}}}]) {
  id: ID
  actors: [Actor!]! @relationship(type: "ACTED_IN", direction: IN)
}
----

== auth fields always included in the input

.GraphQL-Query
[source,graphql]
----
mutation {
  createMovies(
    input: [{id: "1", actors: {create: [{node: {nodeCreatedBy: "User", name: "actor 1", fieldA: "b", fieldB: "a"}}]}}, {id: "2", actors: {create: [{node: {nodeCreatedBy: "User", fieldA: "b", fieldB: "a"}}]}}]
  ) {
    movies {
      id
      actors {
        name
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "create_param0" : [ {
    "id" : "1",
    "actors" : {
      "create" : [ {
        "node" : {
          "name" : "actor 1",
          "nodeCreatedBy" : "User",
          "fieldA" : "b",
          "fieldB" : "a"
        }
      } ]
    }
  }, {
    "id" : "2",
    "actors" : {
      "create" : [ {
        "node" : {
          "nodeCreatedBy" : "User",
          "fieldA" : "b",
          "fieldB" : "a"
        }
      } ]
    }
  } ],
  "create_param3" : "role-A",
  "create_param4" : "role-B",
  "create_param5" : "admin",
  "isAuthenticated" : true,
  "jwt" : {
    "roles" : [ "role-A", "role-B", "admin" ],
    "sub" : "User"
  }
}
----

.Expected Cypher output
[source,cypher]
----
UNWIND $create_param0 AS create_var0
CALL {
	WITH create_var0
	CREATE (create_this1:Movie)
	SET create_this1.id = create_var0.id
	WITH create_this1, create_var0
	CALL {
		WITH create_this1, create_var0
		UNWIND create_var0.actors.create AS create_var2
		WITH create_var2.node AS create_var3, create_var2.edge AS create_var4, create_this1
		CREATE (create_this5:Actor)
		SET create_this5.name = create_var3.name, create_this5.nodeCreatedBy = create_var3.nodeCreatedBy, create_this5.fieldA = create_var3.fieldA, create_this5.fieldB = create_var3.fieldB, create_this5.id = randomUUID()
		MERGE (create_this1)<-[create_this6:ACTED_IN]-(create_this5)
		WITH *
		WHERE (apoc.util.validatePredicate((create_var3.fieldA IS NOT NULL
				AND NOT (($isAuthenticated = true
					AND $jwt.roles IS NOT NULL
					AND $create_param3 IN $jwt.roles))), '@neo4j/graphql/FORBIDDEN', [0])
			AND apoc.util.validatePredicate((create_var3.fieldB IS NOT NULL
				AND NOT (($isAuthenticated = true
					AND $jwt.roles IS NOT NULL
					AND $create_param4 IN $jwt.roles))), '@neo4j/graphql/FORBIDDEN', [0]))
		RETURN collect(NULL) AS create_var7
	}
	WITH *
	WHERE apoc.util.validatePredicate(NOT (($isAuthenticated = true
		AND $jwt.roles IS NOT NULL
		AND $create_param5 IN $jwt.roles)), '@neo4j/graphql/FORBIDDEN', [0])
	RETURN create_this1
}
CALL {
	WITH create_this1
	MATCH (create_this1)<-[create_this8:ACTED_IN]-(create_this9:Actor)
	WHERE apoc.util.validatePredicate(NOT (($isAuthenticated = true
		AND $jwt.sub IS NOT NULL
		AND create_this9.nodeCreatedBy = $jwt.sub)), '@neo4j/graphql/FORBIDDEN', [0])
	WITH create_this9 {
		.name
	} AS create_this9
	RETURN collect(create_this9) AS create_var10
}
RETURN collect(create_this1 {
	.id,
	actors: create_var10
}) AS data
----

'''

== auth fields not included in the input

.GraphQL-Query
[source,graphql]
----
mutation {
  createMovies(
    input: [{id: "1", actors: {create: [{node: {nodeCreatedBy: "User", name: "actor 1"}}]}}, {id: "2", actors: {create: [{node: {nodeCreatedBy: "User"}}]}}]
  ) {
    movies {
      id
      actors {
        name
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "create_param0" : [ {
    "id" : "1",
    "actors" : {
      "create" : [ {
        "node" : {
          "name" : "actor 1",
          "nodeCreatedBy" : "User"
        }
      } ]
    }
  }, {
    "id" : "2",
    "actors" : {
      "create" : [ {
        "node" : {
          "nodeCreatedBy" : "User"
        }
      } ]
    }
  } ],
  "create_param3" : "admin",
  "isAuthenticated" : true,
  "jwt" : {
    "roles" : [ "role-A", "role-B", "admin" ],
    "sub" : "User"
  }
}
----

.Expected Cypher output
[source,cypher]
----
UNWIND $create_param0 AS create_var0
CALL {
	WITH create_var0
	CREATE (create_this1:Movie)
	SET create_this1.id = create_var0.id
	WITH create_this1, create_var0
	CALL {
		WITH create_this1, create_var0
		UNWIND create_var0.actors.create AS create_var2
		WITH create_var2.node AS create_var3, create_var2.edge AS create_var4, create_this1
		CREATE (create_this5:Actor)
		SET create_this5.name = create_var3.name, create_this5.nodeCreatedBy = create_var3.nodeCreatedBy, create_this5.id = randomUUID()
		MERGE (create_this1)<-[create_this6:ACTED_IN]-(create_this5)
		RETURN collect(NULL) AS create_var7
	}
	WITH *
	WHERE apoc.util.validatePredicate(NOT (($isAuthenticated = true
		AND $jwt.roles IS NOT NULL
		AND $create_param3 IN $jwt.roles)), '@neo4j/graphql/FORBIDDEN', [0])
	RETURN create_this1
}
CALL {
	WITH create_this1
	MATCH (create_this1)<-[create_this8:ACTED_IN]-(create_this9:Actor)
	WHERE apoc.util.validatePredicate(NOT (($isAuthenticated = true
		AND $jwt.sub IS NOT NULL
		AND create_this9.nodeCreatedBy = $jwt.sub)), '@neo4j/graphql/FORBIDDEN', [0])
	WITH create_this9 {
		.name
	} AS create_this9
	RETURN collect(create_this9) AS create_var10
}
RETURN collect(create_this1 {
	.id,
	actors: create_var10
}) AS data
----

'''

== auth fields partially included in the input

.GraphQL-Query
[source,graphql]
----
mutation {
  createMovies(
    input: [{id: "1", actors: {create: [{node: {nodeCreatedBy: "User", name: "actor 1", fieldA: "b"}}]}}, {id: "2", actors: {create: [{node: {nodeCreatedBy: "User", fieldB: "a"}}]}}]
  ) {
    movies {
      id
      actors {
        name
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "create_param0" : [ {
    "id" : "1",
    "actors" : {
      "create" : [ {
        "node" : {
          "name" : "actor 1",
          "nodeCreatedBy" : "User",
          "fieldA" : "b"
        }
      } ]
    }
  }, {
    "id" : "2",
    "actors" : {
      "create" : [ {
        "node" : {
          "nodeCreatedBy" : "User",
          "fieldB" : "a"
        }
      } ]
    }
  } ],
  "create_param3" : "role-A",
  "create_param4" : "role-B",
  "create_param5" : "admin",
  "isAuthenticated" : true,
  "jwt" : {
    "roles" : [ "role-A", "role-B", "admin" ],
    "sub" : "User"
  }
}
----

.Expected Cypher output
[source,cypher]
----
UNWIND $create_param0 AS create_var0
CALL {
	WITH create_var0
	CREATE (create_this1:Movie)
	SET create_this1.id = create_var0.id
	WITH create_this1, create_var0
	CALL {
		WITH create_this1, create_var0
		UNWIND create_var0.actors.create AS create_var2
		WITH create_var2.node AS create_var3, create_var2.edge AS create_var4, create_this1
		CREATE (create_this5:Actor)
		SET create_this5.name = create_var3.name, create_this5.nodeCreatedBy = create_var3.nodeCreatedBy, create_this5.fieldA = create_var3.fieldA, create_this5.fieldB = create_var3.fieldB, create_this5.id = randomUUID()
		MERGE (create_this1)<-[create_this6:ACTED_IN]-(create_this5)
		WITH *
		WHERE (apoc.util.validatePredicate((create_var3.fieldA IS NOT NULL
				AND NOT (($isAuthenticated = true
					AND $jwt.roles IS NOT NULL
					AND $create_param3 IN $jwt.roles))), '@neo4j/graphql/FORBIDDEN', [0])
			AND apoc.util.validatePredicate((create_var3.fieldB IS NOT NULL
				AND NOT (($isAuthenticated = true
					AND $jwt.roles IS NOT NULL
					AND $create_param4 IN $jwt.roles))), '@neo4j/graphql/FORBIDDEN', [0]))
		RETURN collect(NULL) AS create_var7
	}
	WITH *
	WHERE apoc.util.validatePredicate(NOT (($isAuthenticated = true
		AND $jwt.roles IS NOT NULL
		AND $create_param5 IN $jwt.roles)), '@neo4j/graphql/FORBIDDEN', [0])
	RETURN create_this1
}
CALL {
	WITH create_this1
	MATCH (create_this1)<-[create_this8:ACTED_IN]-(create_this9:Actor)
	WHERE apoc.util.validatePredicate(NOT (($isAuthenticated = true
		AND $jwt.sub IS NOT NULL
		AND create_this9.nodeCreatedBy = $jwt.sub)), '@neo4j/graphql/FORBIDDEN', [0])
	WITH create_this9 {
		.name
	} AS create_this9
	RETURN collect(create_this9) AS create_var10
}
RETURN collect(create_this1 {
	.id,
	actors: create_var10
}) AS data
----

'''

