:toc:

= https://github.com/neo4j/graphql/issues/3394

== Source schema

[source,graphql,schema=true]
----
type Employee {
  products: [Product!]! @relationship(type: "CAN_ACCESS", direction: OUT)
}

type Product {
  id: String! @alias(property: "fg_item_id")
  description: String!
  partNumber: ID! @alias(property: "fg_item")
}
----
== should sort by aliased field

.GraphQL-Query
[source,graphql]
----
query listProducts {
  products(options: {sort: {partNumber: DESC}}) {
    id
    partNumber
    description
  }
}
----

.Expected Cypher params
[source,json]
----
{}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Product)
WITH *
ORDER BY this.fg_item DESC
RETURN this { .description, id: this.fg_item_id, partNumber: this.fg_item } AS this
----

'''

== should sort by aliased field in relationship

.GraphQL-Query
[source,graphql]
----
query listProducts {
  employees {
    products(options: {sort: {partNumber: DESC}}) {
      id
      partNumber
      description
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Employee)
CALL {
    WITH this
    MATCH (this)-[this0:CAN_ACCESS]->(this1:Product)
    WITH this1 { .description, id: this1.fg_item_id, partNumber: this1.fg_item } AS this1
    ORDER BY this1.partNumber DESC
    RETURN collect(this1) AS var2
}
RETURN this { products: var2 } AS this
----

'''

== Connection sort

=== should sort by aliased field in connection

.GraphQL-Query
[source,graphql]
----
query listProducts {
  productsConnection(sort: {partNumber: DESC}) {
    edges {
      node {
        id
        partNumber
        description
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this0:Product)
WITH collect({ node: this0 }) AS edges
WITH edges, size(edges) AS totalCount
CALL {
    WITH edges
    UNWIND edges AS edge
    WITH edge.node AS this0
    WITH *
    ORDER BY this0.fg_item DESC
    RETURN collect({ node: { id: this0.fg_item_id, partNumber: this0.fg_item, description: this0.description } }) AS var1
}
RETURN { edges: var1, totalCount: totalCount } AS this
----

'''

=== should sort by aliased field in nested connection

.GraphQL-Query
[source,graphql]
----
query listProducts {
  employees {
    productsConnection(sort: {node: {partNumber: DESC}}) {
      edges {
        node {
          id
          partNumber
          description
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Employee)
CALL {
    WITH this
    MATCH (this)-[this0:CAN_ACCESS]->(this1:Product)
    WITH collect({ node: this1, relationship: this0 }) AS edges
    WITH edges, size(edges) AS totalCount
    CALL {
        WITH edges
        UNWIND edges AS edge
        WITH edge.node AS this1, edge.relationship AS this0
        WITH *
        ORDER BY this1.fg_item DESC
        RETURN collect({ node: { id: this1.fg_item_id, partNumber: this1.fg_item, description: this1.description } }) AS var2
    }
    RETURN { edges: var2, totalCount: totalCount } AS var3
}
RETURN this { productsConnection: var3 } AS this
----

'''


