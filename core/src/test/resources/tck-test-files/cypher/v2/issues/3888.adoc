:toc:

= https://github.com/neo4j/graphql/issues/3888

== Source schema

[source,graphql,schema=true]
----
type User {
  id: ID!
}

type Post @authorization(filter: [{where: {node: {author: {id: "$jwt.sub"}}}}]) {
  title: String!
  content: String!
  author: User! @relationship(type: "AUTHORED", direction: IN)
}
----
== should not add an authorization check for connects coming from create

.GraphQL-Query
[source,graphql]
----
mutation {
  createPosts(
    input: [{title: "Test1", content: "Test1", author: {connect: {where: {node: {id: "michel"}}}}}]
  ) {
    posts {
      title
    }
  }
}
----

.Query Context
[source,json,query-config=true]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [],
    "jwt": {
      "roles": [],
      "sub": "michel"
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this0_title": "Test1",
  "this0_content": "Test1",
  "this0_author_connect0_node_param0": "michel"
}
----

.Expected Cypher output
[source,cypher]
----
CALL {
CREATE (this0:Post)
SET this0.title = $this0_title
SET this0.content = $this0_content
WITH *
CALL {
	WITH this0
	OPTIONAL MATCH (this0_author_connect0_node:User)
	WHERE this0_author_connect0_node.id = $this0_author_connect0_node_param0
	CALL {
		WITH *
		WITH collect(this0_author_connect0_node) as connectedNodes, collect(this0) as parentNodes
		CALL {
			WITH connectedNodes, parentNodes
			UNWIND parentNodes as this0
			UNWIND connectedNodes as this0_author_connect0_node
			MERGE (this0)<-[:AUTHORED]-(this0_author_connect0_node)
		}
	}
WITH this0, this0_author_connect0_node
	RETURN count(*) AS connect_this0_author_connect_User0
}
WITH *
CALL {
	WITH this0
	MATCH (this0)<-[this0_author_User_unique:AUTHORED]-(:User)
	WITH count(this0_author_User_unique) as c
	WHERE apoc.util.validatePredicate(NOT (c = 1), '@neo4j/graphql/RELATIONSHIP-REQUIREDPost.author required exactly once', [0])
	RETURN c AS this0_author_User_unique_ignored
}
RETURN this0
}
CALL {
    WITH this0
    RETURN this0 { .title } AS create_var0
}
RETURN [create_var0] AS data
----

'''

