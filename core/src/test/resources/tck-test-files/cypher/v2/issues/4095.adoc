:toc:

= https://github.com/neo4j/graphql/issues/4095

== Source schema

[source,graphql,schema=true]
----
type User {
  id: ID! @unique
}

type Family {
  id: ID! @id @unique
  members: [Person!]! @relationship(type: "MEMBER_OF", direction: IN)
  creator: User! @relationship(type: "CREATOR_OF", direction: IN)
}

type Person @authorization(filter: [{where: {node: {creator: {id: "$jwt.uid"}}}}]) {
  id: ID! @id @unique
  creator: User! @relationship(type: "CREATOR_OF", direction: IN, nestedOperations: [CONNECT])
  family: Family! @relationship(type: "MEMBER_OF", direction: OUT)
}

extend schema @authentication {
  query: Query
  mutation: Mutation
}
----

== query with nested aggregate count

.GraphQL-Query
[source,graphql]
----
query Family {
  families {
    id
    membersAggregate {
      count
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "isAuthenticated" : true,
  "jwt" : {
    "roles" : [ "admin" ],
    "sub" : "michel"
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Family)
CALL {
	WITH this
	MATCH (this)<-[this0:MEMBER_OF]-(this1:Person)
	OPTIONAL MATCH (this1)<-[:CREATOR_OF]-(this2:User)
	WITH *, count(this2) AS creatorCount
	WITH *
	WHERE ($isAuthenticated = true
		AND creatorCount <> 0
		AND $jwt.uid IS NOT NULL
		AND this2.id = $jwt.uid)
	RETURN count(this1) AS var3
}
RETURN this {
	.id,
	membersAggregate: {
		count: var3
	}
} AS this
----

'''

