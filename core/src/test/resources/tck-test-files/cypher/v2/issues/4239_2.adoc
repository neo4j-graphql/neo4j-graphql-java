:toc:

= https://github.com/neo4j/graphql/issues/4239

== Source schema

[source,graphql,schema=true]
----
type Movie @authorization(validate: [{when: [BEFORE], where: {node: {director_SOME: {id: "$jwt.sub"}}}}]) {
  title: String
  director: [Person!]! @relationship(type: "DIRECTED", direction: IN)
}

type Person {
  id: ID
}
----
== should produce a predicate for apoc.util.validatePredicate for version 4.4 (simple API)

.GraphQL-Query
[source,graphql]
----
{
  movies {
    title
  }
}
----

.Query Context
[source,json,query-config=true]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [],
    "jwt": {
      "roles": [],
      "sub": "my-sub"
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "isAuthenticated": true,
  "jwt": {
    "roles": [],
    "sub": "my-sub"
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WITH *
WHERE apoc.util.validatePredicate(NOT ($isAuthenticated = true AND size([(this)<-[:DIRECTED]-(this0:Person) WHERE ($jwt.sub IS NOT NULL AND this0.id = $jwt.sub) | 1]) > 0), "@neo4j/graphql/FORBIDDEN", [0])
RETURN this { .title } AS this
----

'''

