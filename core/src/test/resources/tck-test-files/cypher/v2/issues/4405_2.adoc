:toc:

= https://github.com/neo4j/graphql/issues/4405

== Source schema

[source,graphql,schema=true]
----
type Movie {
  title: String
}

type Actor @authorization(validate: [{when: [BEFORE], operations: [READ], where: {node: {actedInConnection_SOME: {node: {OR: [{title_IN: ["Matrix"]}, {title_IN: ["Forrest Gump", "Top Gun"]}]}}}}}]) {
  name: String!
  actedIn: [Movie!]! @relationship(type: "ACTED_IN", direction: OUT)
}
----
== authorization should work when the filter value is an array, inside logical

.GraphQL-Query
[source,graphql]
----
query actors {
  actors {
    name
  }
}
----

.Query Context
[source,json,query-config=true]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [
      "admin"
    ],
    "jwt": {
      "roles": [
        "admin"
      ],
      "id": "something",
      "email": "something"
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "isAuthenticated": true,
  "param1": [
    "Matrix"
  ],
  "param2": [
    "Forrest Gump",
    "Top Gun"
  ]
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WITH *
WHERE apoc.util.validatePredicate(NOT ($isAuthenticated = true AND size([(this)-[this1:ACTED_IN]->(this0:Movie) WHERE (($param1 IS NOT NULL AND this0.title IN $param1) OR ($param2 IS NOT NULL AND this0.title IN $param2)) | 1]) > 0), "@neo4j/graphql/FORBIDDEN", [0])
RETURN this { .name } AS this
----

'''

