:toc:

= https://github.com/neo4j/graphql/issues/4477

== Source schema

[source,graphql,schema=true]
----
type Brand {
  services: [Service!]! @relationship(type: "HAS_SERVICE", direction: OUT)
  name: String!
}

type Collection {
  services: [Service!]! @relationship(type: "HAS_SERVICE", direction: OUT)
}

type Service {
  collection: Collection @relationship(type: "HAS_SERVICE", direction: IN)
}
----

== filtering by count on an aggregate should work

.GraphQL-Query
[source,graphql]
----
{
  brands {
    name
    services(where: {collectionAggregate: {count: 0}}) {
      collectionAggregate {
        count
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : 0
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Brand)
CALL {
	WITH this
	MATCH (this)-[this0:HAS_SERVICE]->(this1:Service)
	CALL {
		WITH this1
		MATCH (this1)<-[this2:HAS_SERVICE]-(this3:Collection)
		RETURN count(this3) = $param0 AS var4
	}
	WITH *
	WHERE var4 = true
	CALL {
		WITH this1
		MATCH (this1)<-[this5:HAS_SERVICE]-(this6:Collection)
		RETURN count(this6) AS var7
	}
	WITH this1 {
		collectionAggregate: {
			count: var7
		}
	} AS this1
	RETURN collect(this1) AS var8
}
RETURN this {
	.name,
	services: var8
} AS this
----

'''

