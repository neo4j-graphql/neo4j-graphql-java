:toc:

= #488

== Source schema

[source,graphql,schema=true]
----
type Journalist {
  name: String!
  keywords: [Keyword!]! @relationship(type: "HAS_KEYWORD", direction: OUT)
}

union Keyword = Emoji | Hashtag | Text

type Emoji {
  id: ID! @id
  type: String!
}

type Hashtag {
  id: ID! @id
  type: String!
}

type Text {
  id: ID! @id
  type: String!
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{
  "enableRegex": true
}
----
== Should replicate issue and return correct cypher

.GraphQL-Query
[source,graphql]
----
{
  journalists(where: {keywordsConnection: {Emoji: {node: {type: "Smile"}}}}) {
    name
    keywords {
      ... on Emoji {
        id
        type
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "Smile"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Journalist)
WHERE EXISTS {
	MATCH (this)-[this0:HAS_KEYWORD]->(this1:Emoji)
	WHERE this1.type = $param0
}
CALL {
	WITH this
	CALL {
		WITH *
		MATCH (this)-[this2:HAS_KEYWORD]->(this_keywords:Emoji)
		WITH this_keywords {
			__resolveType: 'Emoji',
			.id,
			.type
		} AS this_keywords
		RETURN this_keywords AS this_keywords UNION
		WITH *
		MATCH (this)-[this3:HAS_KEYWORD]->(this_keywords:Hashtag)
		WITH this_keywords {
			__resolveType: 'Hashtag'
		} AS this_keywords
		RETURN this_keywords AS this_keywords UNION
		WITH *
		MATCH (this)-[this4:HAS_KEYWORD]->(this_keywords:Text)
		WITH this_keywords {
			__resolveType: 'Text'
		} AS this_keywords
		RETURN this_keywords AS this_keywords
	}
	WITH this_keywords
	RETURN collect(this_keywords) AS this_keywords
}
RETURN this {
	.name,
	keywords: this_keywords
} AS this
----

'''

== Should replicate issue and return correct cypher (using not)

.GraphQL-Query
[source,graphql]
----
{
  journalists(where: {keywordsConnection_NOT: {Emoji: {node: {type: "Smile"}}}}) {
    name
    keywords {
      ... on Emoji {
        id
        type
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "Smile"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Journalist)
WHERE NOT (EXISTS {
	MATCH (this)-[this0:HAS_KEYWORD]->(this1:Emoji)
	WHERE this1.type = $param0
})
CALL {
	WITH this
	CALL {
		WITH *
		MATCH (this)-[this2:HAS_KEYWORD]->(this_keywords:Emoji)
		WITH this_keywords {
			__resolveType: 'Emoji',
			.id,
			.type
		} AS this_keywords
		RETURN this_keywords AS this_keywords UNION
		WITH *
		MATCH (this)-[this3:HAS_KEYWORD]->(this_keywords:Hashtag)
		WITH this_keywords {
			__resolveType: 'Hashtag'
		} AS this_keywords
		RETURN this_keywords AS this_keywords UNION
		WITH *
		MATCH (this)-[this4:HAS_KEYWORD]->(this_keywords:Text)
		WITH this_keywords {
			__resolveType: 'Text'
		} AS this_keywords
		RETURN this_keywords AS this_keywords
	}
	WITH this_keywords
	RETURN collect(this_keywords) AS this_keywords
}
RETURN this {
	.name,
	keywords: this_keywords
} AS this
----

'''

