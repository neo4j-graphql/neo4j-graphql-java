:toc:

= https://github.com/neo4j/graphql/issues/488

== Source schema

[source,graphql,schema=true]
----
type Journalist {
  name: String!
  keywords: [Keyword!]! @relationship(type: "HAS_KEYWORD", direction: OUT)
}

union Keyword = Emoji | Hashtag | Text

type Emoji {
  id: ID! @id @unique
  type: String!
}

type Hashtag {
  id: ID! @id @unique
  type: String!
}

type Text {
  id: ID! @id @unique
  type: String!
}
----
== Should replicate issue and return correct cypher

.GraphQL-Query
[source,graphql]
----
{
  journalists(where: {keywordsConnection: {Emoji: {node: {type: "Smile"}}}}) {
    name
    keywords {
      ... on Emoji {
        id
        type
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": "Smile"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Journalist)
WHERE EXISTS {
    MATCH (this)-[this0:HAS_KEYWORD]->(this1:Emoji)
    WHERE this1.type = $param0
}
CALL {
    WITH this
    CALL {
        WITH *
        MATCH (this)-[this2:HAS_KEYWORD]->(this3:Emoji)
        WITH this3 { .id, .type, __resolveType: "Emoji", __id: id(this3) } AS this3
        RETURN this3 AS var4
        UNION
        WITH *
        MATCH (this)-[this5:HAS_KEYWORD]->(this6:Hashtag)
        WITH this6 { __resolveType: "Hashtag", __id: id(this6) } AS this6
        RETURN this6 AS var4
        UNION
        WITH *
        MATCH (this)-[this7:HAS_KEYWORD]->(this8:Text)
        WITH this8 { __resolveType: "Text", __id: id(this8) } AS this8
        RETURN this8 AS var4
    }
    WITH var4
    RETURN collect(var4) AS var4
}
RETURN this { .name, keywords: var4 } AS this
----

'''

== Should replicate issue and return correct cypher (using not)

.GraphQL-Query
[source,graphql]
----
{
  journalists(where: {keywordsConnection_NOT: {Emoji: {node: {type: "Smile"}}}}) {
    name
    keywords {
      ... on Emoji {
        id
        type
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": "Smile"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Journalist)
WHERE NOT (EXISTS {
    MATCH (this)-[this0:HAS_KEYWORD]->(this1:Emoji)
    WHERE this1.type = $param0
})
CALL {
    WITH this
    CALL {
        WITH *
        MATCH (this)-[this2:HAS_KEYWORD]->(this3:Emoji)
        WITH this3 { .id, .type, __resolveType: "Emoji", __id: id(this3) } AS this3
        RETURN this3 AS var4
        UNION
        WITH *
        MATCH (this)-[this5:HAS_KEYWORD]->(this6:Hashtag)
        WITH this6 { __resolveType: "Hashtag", __id: id(this6) } AS this6
        RETURN this6 AS var4
        UNION
        WITH *
        MATCH (this)-[this7:HAS_KEYWORD]->(this8:Text)
        WITH this8 { __resolveType: "Text", __id: id(this8) } AS this8
        RETURN this8 AS var4
    }
    WITH var4
    RETURN collect(var4) AS var4
}
RETURN this { .name, keywords: var4 } AS this
----

'''

