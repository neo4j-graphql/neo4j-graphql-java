:toc:

= #601

== Source schema

[source,graphql,schema=true]
----
interface UploadedDocument @relationshipProperties {
  fileId: ID!
  uploadedAt: DateTime!
}

type Document @exclude(operations: [CREATE, UPDATE, DELETE]) {
  id: ID! @id
  stakeholder: Stakeholder! @relationship(type: "REQUIRES", direction: OUT)
  customerContact: CustomerContact! @relationship(type: "UPLOADED", properties: "UploadedDocument", direction: IN)
}

extend type Document @auth(rules: [{roles: ["view"]}])

type CustomerContact @exclude(operations: [CREATE, UPDATE, DELETE]) {
  email: String!
  firstname: String!
  lastname: String!
  documents: [Document!]! @relationship(type: "UPLOADED", properties: "UploadedDocument", direction: OUT)
}

extend type CustomerContact @auth(rules: [{roles: ["view"]}])

type Stakeholder @exclude(operations: [CREATE, UPDATE, DELETE]) {
  id: ID!
  fields: String!
  documents: [Document!]! @relationship(type: "REQUIRES", direction: OUT)
}

extend type Stakeholder @auth(rules: [{roles: ["view"]}])
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{
  "enableRegex": true
}
----
== Example 1

.GraphQL-Query
[source,graphql]
----
query Document {
  stakeholders {
    documents {
      customerContactConnection {
        edges {
          fileId
          uploadedAt
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "auth" : {
    "isAuthenticated" : false,
    "roles" : [ ]
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Stakeholder)
WHERE apoc.util.validatePredicate(NOT (any(r IN ['view']
WHERE any(rr IN $auth.roles
WHERE rr = r))), '@neo4j/graphql/FORBIDDEN', [0])
CALL {
	WITH this
	MATCH (this)-[this0:REQUIRES]->(this_documents:Document)
	WHERE apoc.util.validatePredicate(NOT (any(r IN ['view']
	WHERE any(rr IN $auth.roles
	WHERE rr = r))), '@neo4j/graphql/FORBIDDEN', [0])
	CALL {
		WITH this_documents
		MATCH (this_documents)<-[this_documents_connection_customerContactConnectionthis0:UPLOADED]-(this_documents_CustomerContact:CustomerContact)
		WHERE apoc.util.validatePredicate(NOT (any(r IN ['view']
		WHERE any(rr IN $auth.roles
		WHERE rr = r))), '@neo4j/graphql/FORBIDDEN', [0])
		WITH {
			fileId: this_documents_connection_customerContactConnectionthis0.fileId,
			uploadedAt: apoc.date.convertFormat(toString(this_documents_connection_customerContactConnectionthis0.uploadedAt), 'iso_zoned_date_time', 'iso_offset_date_time')
		} AS edge
		WITH collect(edge) AS edges
		WITH edges, size(edges) AS totalCount
		RETURN {
			edges: edges,
			totalCount: totalCount
		} AS this_documents_customerContactConnection
	}
	WITH this_documents {
		customerContactConnection: this_documents_customerContactConnection
	} AS this_documents
	RETURN collect(this_documents) AS this_documents
}
RETURN this {
	documents: this_documents
} AS this
----

'''

