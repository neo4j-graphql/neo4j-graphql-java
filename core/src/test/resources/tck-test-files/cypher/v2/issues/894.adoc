:toc:

= https://github.com/neo4j/graphql/issues/894

== Source schema

[source,graphql,schema=true]
----
type User {
  id: ID! @id @unique @alias(property: "_id")
  name: String!
  activeOrganization: Organization @relationship(type: "ACTIVELY_MANAGING", direction: OUT)
}

type Organization {
  id: ID! @id @unique @alias(property: "_id")
  name: String!
}
----
== Disconnect and connect

.GraphQL-Query
[source,graphql]
----
mutation SwapSides {
  updateUsers(
    where: {name: "Luke Skywalker"}
    connect: {activeOrganization: {where: {node: {id: "test-id"}}}}
    disconnect: {activeOrganization: {where: {node: {NOT: {id: "test-id"}}}}}
  ) {
    users {
      id
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": "Luke Skywalker",
  "updateUsers_args_disconnect_activeOrganization_where_Organization_this_disconnect_activeOrganization0param0": "test-id",
  "this_connect_activeOrganization0_node_param0": "test-id",
  "updateUsers": {
    "args": {
      "disconnect": {
        "activeOrganization": {
          "where": {
            "node": {
              "NOT": {
                "id": "test-id"
              }
            }
          }
        }
      }
    }
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:User)
WHERE this.name = $param0
WITH this
CALL {
WITH this
OPTIONAL MATCH (this)-[this_disconnect_activeOrganization0_rel:ACTIVELY_MANAGING]->(this_disconnect_activeOrganization0:Organization)
WHERE NOT (this_disconnect_activeOrganization0._id = $updateUsers_args_disconnect_activeOrganization_where_Organization_this_disconnect_activeOrganization0param0)
CALL {
	WITH this_disconnect_activeOrganization0, this_disconnect_activeOrganization0_rel, this
	WITH collect(this_disconnect_activeOrganization0) as this_disconnect_activeOrganization0, this_disconnect_activeOrganization0_rel, this
	UNWIND this_disconnect_activeOrganization0 as x
	DELETE this_disconnect_activeOrganization0_rel
}
RETURN count(*) AS disconnect_this_disconnect_activeOrganization_Organization
}
WITH *
CALL {
	WITH this
	OPTIONAL MATCH (this_connect_activeOrganization0_node:Organization)
	WHERE this_connect_activeOrganization0_node._id = $this_connect_activeOrganization0_node_param0
	CALL {
		WITH *
		WITH collect(this_connect_activeOrganization0_node) as connectedNodes, collect(this) as parentNodes
		CALL {
			WITH connectedNodes, parentNodes
			UNWIND parentNodes as this
			UNWIND connectedNodes as this_connect_activeOrganization0_node
			MERGE (this)-[:ACTIVELY_MANAGING]->(this_connect_activeOrganization0_node)
		}
	}
WITH this, this_connect_activeOrganization0_node
	RETURN count(*) AS connect_this_connect_activeOrganization_Organization0
}
WITH *
WITH *
CALL {
	WITH this
	MATCH (this)-[this_activeOrganization_Organization_unique:ACTIVELY_MANAGING]->(:Organization)
	WITH count(this_activeOrganization_Organization_unique) as c
	WHERE apoc.util.validatePredicate(NOT (c <= 1), '@neo4j/graphql/RELATIONSHIP-REQUIREDUser.activeOrganization must be less than or equal to one', [0])
	RETURN c AS this_activeOrganization_Organization_unique_ignored
}
RETURN collect(DISTINCT this { id: this._id }) AS data
----

'''

