:toc:

= https://github.com/neo4j/graphql/issues/988

== Source schema

[source,graphql,schema=true]
----
type Series {
  name: String
  current: Boolean!
  manufacturer: [Manufacturer!]! @relationship(type: "MANUFACTURER", properties: "RelationProps", direction: OUT)
  brand: [Brand!]! @relationship(type: "BRAND", properties: "RelationProps", direction: OUT)
}

type Brand {
  name: String
  current: Boolean!
}

type Manufacturer {
  name: String
  current: Boolean!
}

interface RelationProps {
  current: Boolean!
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{
  "enableRegex": true
}
----
== where with multiple filters and params

.GraphQL-Query
[source,graphql]
----
query getSeriesWithRelationFilters($where: SeriesWhere = {current: true}) {
  series(where: $where) {
    name
    current
    manufacturerConnection {
      edges {
        current
        node {
          name
        }
      }
    }
    brandConnection {
      edges {
        current
        node {
          name
        }
      }
    }
  }
}
----

.GraphQL params input
[source,json,request=true]
----
{
  "where": {
    "current": true,
    "AND": [
      {
        "OR": [
          {
            "manufacturerConnection": {
              "edge": {
                "current": true
              },
              "node": {
                "name": "C"
              }
            }
          },
          {
            "manufacturerConnection": {
              "edge": {
                "current": false
              },
              "node": {
                "name": "AM"
              }
            }
          }
        ]
      },
      {
        "OR": [
          {
            "brandConnection": {
              "edge": {
                "current": true
              },
              "node": {
                "name": "smart"
              }
            }
          }
        ]
      }
    ]
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : true,
  "param1" : "C",
  "param2" : false,
  "param3" : "AM",
  "param4" : true,
  "param5" : "smart",
  "param6" : true
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Series)
WHERE ((EXISTS {
			MATCH (this)-[this0:MANUFACTURER]->(this1:Manufacturer)
			WHERE (this0.current = $param0
				AND this1.name = $param1)
		}
		OR EXISTS {
			MATCH (this)-[this2:MANUFACTURER]->(this3:Manufacturer)
			WHERE (this2.current = $param2
				AND this3.name = $param3)
		})
	AND EXISTS {
		MATCH (this)-[this4:BRAND]->(this5:Brand)
		WHERE (this4.current = $param4
			AND this5.name = $param5)
	}
	AND this.current = $param6)
CALL {
	WITH this
	MATCH (this)-[this_connection_manufacturerConnectionthis0:MANUFACTURER]->(this_Manufacturer:Manufacturer)
	WITH {
		current: this_connection_manufacturerConnectionthis0.current,
		node: {
			name: this_Manufacturer.name
		}
	} AS edge
	WITH collect(edge) AS edges
	WITH edges, size(edges) AS totalCount
	RETURN {
		edges: edges,
		totalCount: totalCount
	} AS this_manufacturerConnection
}
CALL {
	WITH this
	MATCH (this)-[this_connection_brandConnectionthis0:BRAND]->(this_Brand:Brand)
	WITH {
		current: this_connection_brandConnectionthis0.current,
		node: {
			name: this_Brand.name
		}
	} AS edge
	WITH collect(edge) AS edges
	WITH edges, size(edges) AS totalCount
	RETURN {
		edges: edges,
		totalCount: totalCount
	} AS this_brandConnection
}
RETURN this {
	.name,
	.current,
	manufacturerConnection: this_manufacturerConnection,
	brandConnection: this_brandConnection
} AS this
----

'''

