:toc:

= Math operators

== Source schema

[source,graphql,schema=true]
----
interface Wife {
  marriageLength: Int
}

type Star implements Wife {
  marriageLength: Int
  marriedWith: Actor @relationship(type: "MARRIED_WITH", direction: IN)
}

type Movie {
  id: ID! @id @unique
  title: String!
  viewers: Int
  revenue: Float
  actors: [Actor!]! @relationship(type: "ACTED_IN", properties: "ActedIn", direction: IN)
}

type Actor {
  id: ID!
  name: String!
  actedIn: [Movie!]! @relationship(type: "ACTED_IN", properties: "ActedIn", direction: OUT)
  marriedWith: Wife @relationship(type: "MARRIED_WITH", direction: OUT)
}

interface ActedIn @relationshipProperties {
  pay: Float
}
----
== Increment on interface implementation property

.GraphQL-Query
[source,graphql]
----
mutation {
  updateActors(
    update: {marriedWith: {update: {node: {_on: {Star: {marriageLength_INCREMENT: 1}}}}}}
  ) {
    actors {
      name
      marriedWith {
        marriageLength
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_update_marriedWith0_on_Star_marriageLength_INCREMENT": 1
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)


WITH this
CALL {
	 WITH this
	
WITH this
CALL {
	WITH this
	MATCH (this)-[this_married_with0_relationship:MARRIED_WITH]->(this_marriedWith0:Star)
	
	
	
	WITH this, this_marriedWith0
	CALL {
		WITH this_marriedWith0
		MATCH (this_marriedWith0)<-[this_marriedWith0_marriedWith_Actor_unique:MARRIED_WITH]-(:Actor)
		WITH count(this_marriedWith0_marriedWith_Actor_unique) as c
		WHERE apoc.util.validatePredicate(NOT (c <= 1), '@neo4j/graphql/RELATIONSHIP-REQUIREDStar.marriedWith must be less than or equal to one', [0])
		RETURN c AS this_marriedWith0_marriedWith_Actor_unique_ignored
	}
	
	
	WITH this_marriedWith0, this
	CALL {
	WITH this_marriedWith0
	WITH this_marriedWith0
	WHERE apoc.util.validatePredicate(this_marriedWith0.marriageLength IS NULL, 'Cannot %s %s to Nan', ["_INCREMENT", $this_update_marriedWith0_on_Star_marriageLength_INCREMENT]) AND apoc.util.validatePredicate(this_marriedWith0.marriageLength IS NOT NULL AND this_marriedWith0.marriageLength + $this_update_marriedWith0_on_Star_marriageLength_INCREMENT > 2^31-1, 'Overflow: Value returned from operator %s is larger than %s bit', ["_INCREMENT", "32"])
	SET this_marriedWith0.marriageLength = this_marriedWith0.marriageLength + $this_update_marriedWith0_on_Star_marriageLength_INCREMENT
	RETURN this_marriedWith0 as this_marriedWith0_marriageLength__INCREMENT
	}
	
	RETURN count(*) AS update_this_marriedWith0
}
RETURN count(*) AS update_this_Star
}


WITH *
CALL {
    WITH this
    CALL {
        WITH *
        MATCH (this)-[update_this0:MARRIED_WITH]->(update_this1:Star)
        WITH update_this1 { .marriageLength, __resolveType: "Star", __id: id(update_this1) } AS update_this1
        RETURN update_this1 AS update_var2
    }
    WITH update_var2
    RETURN head(collect(update_var2)) AS update_var2
}
RETURN collect(DISTINCT this { .name, marriedWith: update_var2 }) AS data
----

'''

== Increment on interface property

.GraphQL-Query
[source,graphql]
----
mutation {
  updateActors(
    update: {marriedWith: {update: {node: {marriageLength_INCREMENT: 1}}}}
  ) {
    actors {
      name
      marriedWith {
        marriageLength
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_update_marriedWith0_marriageLength_INCREMENT": 1
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)


WITH this
CALL {
	 WITH this
	
WITH this
CALL {
	WITH this
	MATCH (this)-[this_married_with0_relationship:MARRIED_WITH]->(this_marriedWith0:Star)
	
	
	WITH this_marriedWith0, this
	CALL {
	WITH this_marriedWith0
	WITH this_marriedWith0
	WHERE apoc.util.validatePredicate(this_marriedWith0.marriageLength IS NULL, 'Cannot %s %s to Nan', ["_INCREMENT", $this_update_marriedWith0_marriageLength_INCREMENT]) AND apoc.util.validatePredicate(this_marriedWith0.marriageLength IS NOT NULL AND this_marriedWith0.marriageLength + $this_update_marriedWith0_marriageLength_INCREMENT > 2^31-1, 'Overflow: Value returned from operator %s is larger than %s bit', ["_INCREMENT", "32"])
	SET this_marriedWith0.marriageLength = this_marriedWith0.marriageLength + $this_update_marriedWith0_marriageLength_INCREMENT
	RETURN this_marriedWith0 as this_marriedWith0_marriageLength__INCREMENT
	}
	
	WITH this, this_marriedWith0
	CALL {
		WITH this_marriedWith0
		MATCH (this_marriedWith0)<-[this_marriedWith0_marriedWith_Actor_unique:MARRIED_WITH]-(:Actor)
		WITH count(this_marriedWith0_marriedWith_Actor_unique) as c
		WHERE apoc.util.validatePredicate(NOT (c <= 1), '@neo4j/graphql/RELATIONSHIP-REQUIREDStar.marriedWith must be less than or equal to one', [0])
		RETURN c AS this_marriedWith0_marriedWith_Actor_unique_ignored
	}
	RETURN count(*) AS update_this_marriedWith0
}
RETURN count(*) AS update_this_Star
}


WITH *
CALL {
    WITH this
    CALL {
        WITH *
        MATCH (this)-[update_this0:MARRIED_WITH]->(update_this1:Star)
        WITH update_this1 { .marriageLength, __resolveType: "Star", __id: id(update_this1) } AS update_this1
        RETURN update_this1 AS update_var2
    }
    WITH update_var2
    RETURN head(collect(update_var2)) AS update_var2
}
RETURN collect(DISTINCT this { .name, marriedWith: update_var2 }) AS data
----

'''

== Increment on relationship property

.GraphQL-Query
[source,graphql]
----
mutation Mutation {
  updateActors(update: {actedIn: [{update: {edge: {pay_ADD: 100}}}]}) {
    actors {
      name
      actedIn {
        title
      }
      actedInConnection {
        edges {
          pay
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "updateActors": {
    "args": {
      "update": {
        "actedIn": [
          {
            "update": {
              "edge": {
                "pay_ADD": 100
              }
            }
          }
        ]
      }
    }
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)


WITH this
CALL {
	WITH this
	MATCH (this)-[this_acted_in0_relationship:ACTED_IN]->(this_actedIn0:Movie)
	WITH this_acted_in0_relationship, this
	CALL {
	WITH this_acted_in0_relationship
	WITH this_acted_in0_relationship
	WHERE apoc.util.validatePredicate(this_acted_in0_relationship.pay IS NULL, 'Cannot %s %s to Nan', ["_ADD", $updateActors.args.update.actedIn[0].update.edge.pay_ADD]) AND apoc.util.validatePredicate(this_acted_in0_relationship.pay IS NOT NULL AND this_acted_in0_relationship.pay + $updateActors.args.update.actedIn[0].update.edge.pay_ADD > 2^63-1, 'Overflow: Value returned from operator %s is larger than %s bit', ["_ADD", "64"])
	SET this_acted_in0_relationship.pay = this_acted_in0_relationship.pay + $updateActors.args.update.actedIn[0].update.edge.pay_ADD
	RETURN this_acted_in0_relationship as this_acted_in0_relationship_pay__ADD
	}
	RETURN count(*) AS update_this_actedIn0
}

WITH *
CALL {
    WITH this
    MATCH (this)-[update_this0:ACTED_IN]->(update_this1:Movie)
    WITH update_this1 { .title } AS update_this1
    RETURN collect(update_this1) AS update_var2
}
CALL {
    WITH this
    MATCH (this)-[update_this3:ACTED_IN]->(update_this4:Movie)
    WITH collect({ node: update_this4, relationship: update_this3 }) AS edges
    WITH edges, size(edges) AS totalCount
    CALL {
        WITH edges
        UNWIND edges AS edge
        WITH edge.node AS update_this4, edge.relationship AS update_this3
        RETURN collect({ pay: update_this3.pay, node: { __resolveType: "Movie", __id: id(update_this4) } }) AS update_var5
    }
    RETURN { edges: update_var5, totalCount: totalCount } AS update_var6
}
RETURN collect(DISTINCT this { .name, actedIn: update_var2, actedInConnection: update_var6 }) AS data
----

'''

== Nested Int increment

.GraphQL-Query
[source,graphql]
----
mutation {
  updateActors(update: {actedIn: [{update: {node: {viewers_INCREMENT: 10}}}]}) {
    actors {
      name
      actedIn {
        viewers
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_update_actedIn0_viewers_INCREMENT": 10
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)


WITH this
CALL {
	WITH this
	MATCH (this)-[this_acted_in0_relationship:ACTED_IN]->(this_actedIn0:Movie)
	
	
	WITH this_actedIn0, this
	CALL {
	WITH this_actedIn0
	WITH this_actedIn0
	WHERE apoc.util.validatePredicate(this_actedIn0.viewers IS NULL, 'Cannot %s %s to Nan', ["_INCREMENT", $this_update_actedIn0_viewers_INCREMENT]) AND apoc.util.validatePredicate(this_actedIn0.viewers IS NOT NULL AND this_actedIn0.viewers + $this_update_actedIn0_viewers_INCREMENT > 2^31-1, 'Overflow: Value returned from operator %s is larger than %s bit', ["_INCREMENT", "32"])
	SET this_actedIn0.viewers = this_actedIn0.viewers + $this_update_actedIn0_viewers_INCREMENT
	RETURN this_actedIn0 as this_actedIn0_viewers__INCREMENT
	}
	
	RETURN count(*) AS update_this_actedIn0
}

WITH *
CALL {
    WITH this
    MATCH (this)-[update_this0:ACTED_IN]->(update_this1:Movie)
    WITH update_this1 { .viewers } AS update_this1
    RETURN collect(update_this1) AS update_var2
}
RETURN collect(DISTINCT this { .name, actedIn: update_var2 }) AS data
----

'''

== Simple Float multiply

.GraphQL-Query
[source,graphql]
----
mutation {
  updateMovies(update: {revenue_MULTIPLY: 3}) {
    movies {
      id
      revenue
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_update_revenue_MULTIPLY": 3
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)


WITH this
CALL {
WITH this
WITH this
WHERE apoc.util.validatePredicate(this.revenue IS NULL, 'Cannot %s %s to Nan', ["_MULTIPLY", $this_update_revenue_MULTIPLY]) AND apoc.util.validatePredicate(this.revenue IS NOT NULL AND this.revenue * $this_update_revenue_MULTIPLY > 2^63-1, 'Overflow: Value returned from operator %s is larger than %s bit', ["_MULTIPLY", "64"])
SET this.revenue = this.revenue * $this_update_revenue_MULTIPLY
RETURN this as this_revenue__MULTIPLY
}

RETURN collect(DISTINCT this { .id, .revenue }) AS data
----

'''

== Simple Int increment

.GraphQL-Query
[source,graphql]
----
mutation {
  updateMovies(update: {viewers_INCREMENT: 3}) {
    movies {
      id
      viewers
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_update_viewers_INCREMENT": 3
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)


WITH this
CALL {
WITH this
WITH this
WHERE apoc.util.validatePredicate(this.viewers IS NULL, 'Cannot %s %s to Nan', ["_INCREMENT", $this_update_viewers_INCREMENT]) AND apoc.util.validatePredicate(this.viewers IS NOT NULL AND this.viewers + $this_update_viewers_INCREMENT > 2^31-1, 'Overflow: Value returned from operator %s is larger than %s bit', ["_INCREMENT", "32"])
SET this.viewers = this.viewers + $this_update_viewers_INCREMENT
RETURN this as this_viewers__INCREMENT
}

RETURN collect(DISTINCT this { .id, .viewers }) AS data
----

'''

