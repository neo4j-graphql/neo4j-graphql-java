:toc:

= Cypher Create

== Source schema

[source,graphql,schema=true]
----
type Actor {
  name: String
  movies: [Movie!]! @relationship(type: "ACTED_IN", direction: OUT)
}

type Movie {
  id: ID
  actors: [Actor!]! @relationship(type: "ACTED_IN", direction: IN)
}
----
== Simple Create

.GraphQL-Query
[source,graphql]
----
mutation {
  createMovies(input: [{id: "1"}]) {
    movies {
      id
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "create_param0" : [ {
    "id" : "1"
  } ]
}
----

.Expected Cypher output
[source,cypher]
----
UNWIND $create_param0 AS create_var0
CALL {
	WITH create_var0
	CREATE (create_this1:Movie)
	SET create_this1.id = create_var0.id
	RETURN create_this1
}
RETURN collect(create_this1 {
	.id
}) AS data
----

'''

== Simple create -> relationship field -> connection(where)

.GraphQL-Query
[source,graphql]
----
mutation {
  createActors(input: {name: "Dan", movies: {connect: {where: {node: {id: 1}}}}}) {
    actors {
      name
      movies {
        actorsConnection(where: {node: {name: "Dan"}}) {
          totalCount
          edges {
            node {
              name
            }
          }
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "create_param0" : "Dan",
  "this0_movies_connect0_node_param0" : "1",
  "this0_name" : "Dan"
}
----

.Expected Cypher output
[source,cypher]
----
CALL {
	CREATE (this0:Actor)
	SET this0.name = $this0_name
	WITH *
	CALL {
		WITH this0
		OPTIONAL MATCH (this0_movies_connect0_node:Movie)
		WHERE this0_movies_connect0_node.id = $this0_movies_connect0_node_param0
		CALL {
			WITH *
			WITH collect(this0_movies_connect0_node) AS connectedNodes, collect(this0) AS parentNodes
			CALL {
				WITH connectedNodes, parentNodes
				UNWIND parentNodes AS this0
				UNWIND connectedNodes AS this0_movies_connect0_node
				MERGE (this0)-[:ACTED_IN]->(this0_movies_connect0_node)
			}
		}
		WITH this0, this0_movies_connect0_node
		RETURN count(*) AS connect_this0_movies_connect_Movie0
	}
	RETURN this0
}
CALL {
	WITH this0
	CALL {
		WITH this0
		MATCH (this0)-[create_this0:ACTED_IN]->(create_this1:Movie)
		CALL {
			WITH create_this1
			MATCH (create_this1)<-[create_this2:ACTED_IN]-(create_this3:Actor)
			WHERE create_this3.name = $create_param0
			WITH collect( {
				node: create_this3,
				relationship: create_this2
			}) AS edges
			WITH edges, size(edges) AS totalCount
			CALL {
				WITH edges
				UNWIND edges AS edge
				WITH edge.node AS create_this3, edge.relationship AS create_this2
				RETURN collect( {
					node: {
						name: create_this3.name
					}
				}) AS create_var4
			}
			RETURN {
				edges: create_var4,
				totalCount: totalCount
			} AS create_var5
		}
		WITH create_this1 {
			actorsConnection: create_var5
		} AS create_this1
		RETURN collect(create_this1) AS create_var6
	}
	RETURN this0 {
		.name,
		movies: create_var6
	} AS create_var7
}
RETURN [create_var7] AS data
----

'''

== Simple create and connect

.GraphQL-Query
[source,graphql]
----
mutation {
  createMovies(
    input: [{id: 1, actors: {connect: [{where: {node: {name: "Dan"}}}]}}]
  ) {
    movies {
      id
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this0_actors_connect0_node_param0" : "Dan",
  "this0_id" : "1"
}
----

.Expected Cypher output
[source,cypher]
----
CALL {
	CREATE (this0:Movie)
	SET this0.id = $this0_id
	WITH *
	CALL {
		WITH this0
		OPTIONAL MATCH (this0_actors_connect0_node:Actor)
		WHERE this0_actors_connect0_node.name = $this0_actors_connect0_node_param0
		CALL {
			WITH *
			WITH collect(this0_actors_connect0_node) AS connectedNodes, collect(this0) AS parentNodes
			CALL {
				WITH connectedNodes, parentNodes
				UNWIND parentNodes AS this0
				UNWIND connectedNodes AS this0_actors_connect0_node
				MERGE (this0)<-[:ACTED_IN]-(this0_actors_connect0_node)
			}
		}
		WITH this0, this0_actors_connect0_node
		RETURN count(*) AS connect_this0_actors_connect_Actor0
	}
	RETURN this0
}
CALL {
	WITH this0
	RETURN this0 {
		.id
	} AS create_var0
}
RETURN [create_var0] AS data
----

'''

== Simple Multi Create

.GraphQL-Query
[source,graphql]
----
mutation {
  createMovies(input: [{id: "1"}, {id: "2"}]) {
    movies {
      id
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "create_param0" : [ {
    "id" : "1"
  }, {
    "id" : "2"
  } ]
}
----

.Expected Cypher output
[source,cypher]
----
UNWIND $create_param0 AS create_var0
CALL {
	WITH create_var0
	CREATE (create_this1:Movie)
	SET create_this1.id = create_var0.id
	RETURN create_this1
}
RETURN collect(create_this1 {
	.id
}) AS data
----

'''

== Three Level Nested create

.GraphQL-Query
[source,graphql]
----
mutation {
  createMovies(
    input: [{id: "1", actors: {create: [{node: {name: "actor 1", movies: {create: [{node: {id: "10"}}]}}}]}}, {id: "2", actors: {create: [{node: {name: "actor 2", movies: {create: [{node: {id: "20"}}]}}}]}}]
  ) {
    movies {
      id
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "create_param0" : [ {
    "id" : "1",
    "actors" : {
      "create" : [ {
        "node" : {
          "name" : "actor 1",
          "movies" : {
            "create" : [ {
              "node" : {
                "id" : "10"
              }
            } ]
          }
        }
      } ]
    }
  }, {
    "id" : "2",
    "actors" : {
      "create" : [ {
        "node" : {
          "name" : "actor 2",
          "movies" : {
            "create" : [ {
              "node" : {
                "id" : "20"
              }
            } ]
          }
        }
      } ]
    }
  } ]
}
----

.Expected Cypher output
[source,cypher]
----
UNWIND $create_param0 AS create_var0
CALL {
	WITH create_var0
	CREATE (create_this1:Movie)
	SET create_this1.id = create_var0.id
	WITH create_this1, create_var0
	CALL {
		WITH create_this1, create_var0
		UNWIND create_var0.actors.create AS create_var2
		WITH create_var2.node AS create_var3, create_var2.edge AS create_var4, create_this1
		CREATE (create_this5:Actor)
		SET create_this5.name = create_var3.name
		MERGE (create_this1)<-[create_this6:ACTED_IN]-(create_this5)
		WITH create_this5, create_var3
		CALL {
			WITH create_this5, create_var3
			UNWIND create_var3.movies.create AS create_var7
			WITH create_var7.node AS create_var8, create_var7.edge AS create_var9, create_this5
			CREATE (create_this10:Movie)
			SET create_this10.id = create_var8.id
			MERGE (create_this5)-[create_this11:ACTED_IN]->(create_this10)
			RETURN collect(NULL) AS create_var12
		}
		RETURN collect(NULL) AS create_var13
	}
	RETURN create_this1
}
RETURN collect(create_this1 {
	.id
}) AS data
----

'''

== Two Level Nested create

.GraphQL-Query
[source,graphql]
----
mutation {
  createMovies(
    input: [{id: 1, actors: {create: [{node: {name: "actor 1"}}]}}, {id: 2, actors: {create: [{node: {name: "actor 2"}}]}}]
  ) {
    movies {
      id
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "create_param0" : [ {
    "id" : "1",
    "actors" : {
      "create" : [ {
        "node" : {
          "name" : "actor 1"
        }
      } ]
    }
  }, {
    "id" : "2",
    "actors" : {
      "create" : [ {
        "node" : {
          "name" : "actor 2"
        }
      } ]
    }
  } ]
}
----

.Expected Cypher output
[source,cypher]
----
UNWIND $create_param0 AS create_var0
CALL {
	WITH create_var0
	CREATE (create_this1:Movie)
	SET create_this1.id = create_var0.id
	WITH create_this1, create_var0
	CALL {
		WITH create_this1, create_var0
		UNWIND create_var0.actors.create AS create_var2
		WITH create_var2.node AS create_var3, create_var2.edge AS create_var4, create_this1
		CREATE (create_this5:Actor)
		SET create_this5.name = create_var3.name
		MERGE (create_this1)<-[create_this6:ACTED_IN]-(create_this5)
		RETURN collect(NULL) AS create_var7
	}
	RETURN create_this1
}
RETURN collect(create_this1 {
	.id
}) AS data
----

'''

