:toc:

= Cypher Delete - union

== Source schema

[source,graphql,schema=true]
----
type Episode {
  runtime: Int!
  series: Series! @relationship(type: "HAS_EPISODE", direction: IN)
}

union Production = Movie | Series

union Worker = ScreenWriter | StuntPerformer

type ScreenWriter {
  name: String
}

type StuntPerformer {
  name: String!
  workedOn: [Production!]! @relationship(type: "WORKED_ON", direction: OUT)
}

type Movie {
  title: String!
  runtime: Int!
  actors: [Actor!]! @relationship(type: "ACTED_IN", direction: IN, properties: "ActedIn")
  workers: [Worker!]! @relationship(type: "WORKED_ON", direction: IN)
}

type Series {
  title: String!
  episodes: [Episode!]! @relationship(type: "HAS_EPISODE", direction: OUT)
  actors: [Actor!]! @relationship(type: "ACTED_IN", direction: IN, properties: "ActedIn")
}

type Actor {
  name: String!
  actedIn: [Production!]! @relationship(type: "ACTED_IN", direction: OUT, properties: "ActedIn")
}

type ActedIn @relationshipProperties {
  screenTime: Int!
}
----
== Double Nested Delete

.GraphQL-Query
[source,graphql]
----
mutation {
  deleteActors(
    where: {name: "Keanu"}
    delete: {actedIn: {Movie: {where: {node: {title: "Matrix"}}, delete: {actors: {where: {node: {name: "Gloria Foster"}}}}}}}
  ) {
    nodesDeleted
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": "Keanu",
  "param1": "Matrix",
  "param2": "Gloria Foster"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WHERE this.name = $param0
WITH *
CALL {
    WITH *
    OPTIONAL MATCH (this)-[this0:ACTED_IN]->(this1:Movie)
    WHERE this1.title = $param1
    WITH *
    CALL {
        WITH *
        OPTIONAL MATCH (this1)<-[this2:ACTED_IN]-(this3:Actor)
        WHERE this3.name = $param2
        WITH this2, collect(DISTINCT this3) AS var4
        CALL {
            WITH var4
            UNWIND var4 AS var5
            DETACH DELETE var5
        }
    }
    WITH this0, collect(DISTINCT this1) AS var6
    CALL {
        WITH var6
        UNWIND var6 AS var7
        DETACH DELETE var7
    }
}
WITH *
DETACH DELETE this
----

'''

== Double Nested, with union target

.GraphQL-Query
[source,graphql]
----
mutation {
  deleteActors(
    where: {name: "Keanu"}
    delete: {actedIn: {Movie: {where: {node: {title: "Matrix"}}, delete: {workers: {ScreenWriter: {where: {node: {name: "Wachowski"}}}}}}}}
  ) {
    nodesDeleted
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": "Keanu",
  "param1": "Matrix",
  "param2": "Wachowski"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WHERE this.name = $param0
WITH *
CALL {
    WITH *
    OPTIONAL MATCH (this)-[this0:ACTED_IN]->(this1:Movie)
    WHERE this1.title = $param1
    WITH *
    CALL {
        WITH *
        OPTIONAL MATCH (this1)<-[this2:WORKED_ON]-(this3:ScreenWriter)
        WHERE this3.name = $param2
        WITH this2, collect(DISTINCT this3) AS var4
        CALL {
            WITH var4
            UNWIND var4 AS var5
            DETACH DELETE var5
        }
    }
    WITH this0, collect(DISTINCT this1) AS var6
    CALL {
        WITH var6
        UNWIND var6 AS var7
        DETACH DELETE var7
    }
}
WITH *
DETACH DELETE this
----

'''

== Simple Delete

.GraphQL-Query
[source,graphql]
----
mutation {
  deleteActors(where: {name: "Keanu"}) {
    nodesDeleted
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": "Keanu"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WHERE this.name = $param0
DETACH DELETE this
----

'''

== Single Nested Delete

.GraphQL-Query
[source,graphql]
----
mutation {
  deleteActors(
    where: {name: "Keanu"}
    delete: {actedIn: {Movie: {where: {node: {title: "Matrix"}}}}}
  ) {
    nodesDeleted
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": "Keanu",
  "param1": "Matrix"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WHERE this.name = $param0
WITH *
CALL {
    WITH *
    OPTIONAL MATCH (this)-[this0:ACTED_IN]->(this1:Movie)
    WHERE this1.title = $param1
    WITH this0, collect(DISTINCT this1) AS var2
    CALL {
        WITH var2
        UNWIND var2 AS var3
        DETACH DELETE var3
    }
}
WITH *
DETACH DELETE this
----

'''

== Single Nested Delete, deleting multiple

.GraphQL-Query
[source,graphql]
----
mutation {
  deleteActors(
    where: {name: "Keanu"}
    delete: {actedIn: {Movie: [{where: {node: {title: "Matrix"}}}, {where: {node: {title: "Matrix Reloaded"}}}]}}
  ) {
    nodesDeleted
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": "Keanu",
  "param1": "Matrix",
  "param2": "Matrix Reloaded"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WHERE this.name = $param0
WITH *
CALL {
    WITH *
    OPTIONAL MATCH (this)-[this0:ACTED_IN]->(this1:Movie)
    WHERE this1.title = $param1
    WITH this0, collect(DISTINCT this1) AS var2
    CALL {
        WITH var2
        UNWIND var2 AS var3
        DETACH DELETE var3
    }
}
CALL {
    WITH *
    OPTIONAL MATCH (this)-[this4:ACTED_IN]->(this5:Movie)
    WHERE this5.title = $param2
    WITH this4, collect(DISTINCT this5) AS var6
    CALL {
        WITH var6
        UNWIND var6 AS var7
        DETACH DELETE var7
    }
}
WITH *
DETACH DELETE this
----

'''

