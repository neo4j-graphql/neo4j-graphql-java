:toc:

= Cypher Delete

== Source schema

[source,graphql,schema=true]
----
type Actor {
  name: String
  movies: [Movie!]! @relationship(type: "ACTED_IN", direction: OUT)
}

type Movie {
  id: ID
  title: String
  actors: [Actor!]! @relationship(type: "ACTED_IN", direction: IN)
}
----
== Double Nested Delete

.GraphQL-Query
[source,graphql]
----
mutation {
  deleteMovies(
    where: {id: 123}
    delete: {actors: {where: {node: {name: "Actor to delete"}}, delete: {movies: {where: {node: {id: 321}}}}}}
  ) {
    nodesDeleted
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": "123",
  "param1": "Actor to delete",
  "param2": "321"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.id = $param0
WITH *
CALL {
    WITH *
    OPTIONAL MATCH (this)<-[this0:ACTED_IN]-(this1:Actor)
    WHERE this1.name = $param1
    WITH *
    CALL {
        WITH *
        OPTIONAL MATCH (this1)-[this2:ACTED_IN]->(this3:Movie)
        WHERE this3.id = $param2
        WITH this2, collect(DISTINCT this3) AS var4
        CALL {
            WITH var4
            UNWIND var4 AS var5
            DETACH DELETE var5
        }
    }
    WITH this0, collect(DISTINCT this1) AS var6
    CALL {
        WITH var6
        UNWIND var6 AS var7
        DETACH DELETE var7
    }
}
WITH *
DETACH DELETE this
----

'''

== Simple Delete

.GraphQL-Query
[source,graphql]
----
mutation {
  deleteMovies(where: {id: "123"}) {
    nodesDeleted
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": "123"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.id = $param0
DETACH DELETE this
----

'''

== Single Nested Delete

.GraphQL-Query
[source,graphql]
----
mutation {
  deleteMovies(
    where: {id: 123}
    delete: {actors: {where: {node: {name: "Actor to delete"}}}}
  ) {
    nodesDeleted
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": "123",
  "param1": "Actor to delete"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.id = $param0
WITH *
CALL {
    WITH *
    OPTIONAL MATCH (this)<-[this0:ACTED_IN]-(this1:Actor)
    WHERE this1.name = $param1
    WITH this0, collect(DISTINCT this1) AS var2
    CALL {
        WITH var2
        UNWIND var2 AS var3
        DETACH DELETE var3
    }
}
WITH *
DETACH DELETE this
----

'''

== Single Nested Delete deleting multiple

.GraphQL-Query
[source,graphql]
----
mutation {
  deleteMovies(
    where: {id: 123}
    delete: {actors: [{where: {node: {name: "Actor to delete"}}}, {where: {node: {name: "Another actor to delete"}}}]}
  ) {
    nodesDeleted
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": "123",
  "param1": "Actor to delete",
  "param2": "Another actor to delete"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.id = $param0
WITH *
CALL {
    WITH *
    OPTIONAL MATCH (this)<-[this0:ACTED_IN]-(this1:Actor)
    WHERE this1.name = $param1
    WITH this0, collect(DISTINCT this1) AS var2
    CALL {
        WITH var2
        UNWIND var2 AS var3
        DETACH DELETE var3
    }
}
CALL {
    WITH *
    OPTIONAL MATCH (this)<-[this4:ACTED_IN]-(this5:Actor)
    WHERE this5.name = $param2
    WITH this4, collect(DISTINCT this5) AS var6
    CALL {
        WITH var6
        UNWIND var6 AS var7
        DETACH DELETE var7
    }
}
WITH *
DETACH DELETE this
----

'''

== Triple Nested Delete

.GraphQL-Query
[source,graphql]
----
mutation {
  deleteMovies(
    where: {id: 123}
    delete: {actors: {where: {node: {name: "Actor to delete"}}, delete: {movies: {where: {node: {id: 321}}, delete: {actors: {where: {node: {name: "Another actor to delete"}}}}}}}}
  ) {
    nodesDeleted
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": "123",
  "param1": "Actor to delete",
  "param2": "321",
  "param3": "Another actor to delete"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.id = $param0
WITH *
CALL {
    WITH *
    OPTIONAL MATCH (this)<-[this0:ACTED_IN]-(this1:Actor)
    WHERE this1.name = $param1
    WITH *
    CALL {
        WITH *
        OPTIONAL MATCH (this1)-[this2:ACTED_IN]->(this3:Movie)
        WHERE this3.id = $param2
        WITH *
        CALL {
            WITH *
            OPTIONAL MATCH (this3)<-[this4:ACTED_IN]-(this5:Actor)
            WHERE this5.name = $param3
            WITH this4, collect(DISTINCT this5) AS var6
            CALL {
                WITH var6
                UNWIND var6 AS var7
                DETACH DELETE var7
            }
        }
        WITH this2, collect(DISTINCT this3) AS var8
        CALL {
            WITH var8
            UNWIND var8 AS var9
            DETACH DELETE var9
        }
    }
    WITH this0, collect(DISTINCT this1) AS var10
    CALL {
        WITH var10
        UNWIND var10 AS var11
        DETACH DELETE var11
    }
}
WITH *
DETACH DELETE this
----

'''

