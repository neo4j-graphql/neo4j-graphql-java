:toc:

= Cypher Disconnect

== Source schema

[source,graphql,schema=true]
----
type Product {
  id: ID!
  name: String
  sizes: [Size!]! @relationship(type: "HAS_SIZE", direction: OUT)
  colors: [Color!]! @relationship(type: "HAS_COLOR", direction: OUT)
  photos: [Photo!]! @relationship(type: "HAS_PHOTO", direction: OUT)
}

type Size {
  id: ID!
  name: String!
}

type Color {
  id: ID!
  name: String!
  photos: [Photo!]! @relationship(type: "OF_COLOR", direction: IN)
}

type Photo {
  id: ID!
  description: String!
  url: String!
  color: Color! @relationship(type: "OF_COLOR", direction: OUT)
}
----
== Recursive Disconnect

.GraphQL-Query
[source,graphql]
----
mutation {
  updateProducts(
    update: {id: "123", name: "Nested Connect", colors: {disconnect: [{where: {node: {name: "Red"}}, disconnect: {photos: [{where: {node: {id: "123"}}, disconnect: {color: {where: {node: {id: "134"}}}}}]}}]}, photos: {disconnect: [{where: {node: {id: "321"}}, disconnect: {color: {where: {node: {name: "Green"}}}}}, {where: {node: {id: "33211"}}, disconnect: {color: {where: {node: {name: "Red"}}}}}]}}
  ) {
    products {
      id
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_update_id": "123",
  "this_update_name": "Nested Connect",
  "updateProducts_args_update_colors0_disconnect0_where_Color_this_colors0_disconnect0param0": "Red",
  "updateProducts_args_update_colors0_disconnect0_disconnect_photos0_where_Photo_this_colors0_disconnect0_photos0param0": "123",
  "updateProducts_args_update_colors0_disconnect0_disconnect_photos_disconnect_color_where_Color_this_colors0_disconnect0_photos0_color0param0": "134",
  "updateProducts_args_update_photos0_disconnect0_where_Photo_this_photos0_disconnect0param0": "321",
  "updateProducts_args_update_photos0_disconnect_disconnect_color_where_Color_this_photos0_disconnect0_color0param0": "Green",
  "updateProducts_args_update_photos0_disconnect1_where_Photo_this_photos0_disconnect1param0": "33211",
  "updateProducts_args_update_photos0_disconnect_disconnect_color_where_Color_this_photos0_disconnect1_color0param0": "Red",
  "updateProducts": {
    "args": {
      "update": {
        "id": "123",
        "name": "Nested Connect",
        "colors": [
          {
            "disconnect": [
              {
                "where": {
                  "node": {
                    "name": "Red"
                  }
                },
                "disconnect": {
                  "photos": [
                    {
                      "where": {
                        "node": {
                          "id": "123"
                        }
                      },
                      "disconnect": {
                        "color": {
                          "where": {
                            "node": {
                              "id": "134"
                            }
                          }
                        }
                      }
                    }
                  ]
                }
              }
            ]
          }
        ],
        "photos": [
          {
            "disconnect": [
              {
                "where": {
                  "node": {
                    "id": "321"
                  }
                },
                "disconnect": {
                  "color": {
                    "where": {
                      "node": {
                        "name": "Green"
                      }
                    }
                  }
                }
              },
              {
                "where": {
                  "node": {
                    "id": "33211"
                  }
                },
                "disconnect": {
                  "color": {
                    "where": {
                      "node": {
                        "name": "Red"
                      }
                    }
                  }
                }
              }
            ]
          }
        ]
      }
    }
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Product)


SET this.id = $this_update_id
SET this.name = $this_update_name
WITH this
CALL {
WITH this
OPTIONAL MATCH (this)-[this_colors0_disconnect0_rel:HAS_COLOR]->(this_colors0_disconnect0:Color)
WHERE this_colors0_disconnect0.name = $updateProducts_args_update_colors0_disconnect0_where_Color_this_colors0_disconnect0param0
CALL {
	WITH this_colors0_disconnect0, this_colors0_disconnect0_rel, this
	WITH collect(this_colors0_disconnect0) as this_colors0_disconnect0, this_colors0_disconnect0_rel, this
	UNWIND this_colors0_disconnect0 as x
	DELETE this_colors0_disconnect0_rel
}
CALL {
WITH this, this_colors0_disconnect0
OPTIONAL MATCH (this_colors0_disconnect0)<-[this_colors0_disconnect0_photos0_rel:OF_COLOR]-(this_colors0_disconnect0_photos0:Photo)
WHERE this_colors0_disconnect0_photos0.id = $updateProducts_args_update_colors0_disconnect0_disconnect_photos0_where_Photo_this_colors0_disconnect0_photos0param0
CALL {
	WITH this_colors0_disconnect0_photos0, this_colors0_disconnect0_photos0_rel, this_colors0_disconnect0
	WITH collect(this_colors0_disconnect0_photos0) as this_colors0_disconnect0_photos0, this_colors0_disconnect0_photos0_rel, this_colors0_disconnect0
	UNWIND this_colors0_disconnect0_photos0 as x
	DELETE this_colors0_disconnect0_photos0_rel
}
CALL {
WITH this, this_colors0_disconnect0, this_colors0_disconnect0_photos0
OPTIONAL MATCH (this_colors0_disconnect0_photos0)-[this_colors0_disconnect0_photos0_color0_rel:OF_COLOR]->(this_colors0_disconnect0_photos0_color0:Color)
WHERE this_colors0_disconnect0_photos0_color0.id = $updateProducts_args_update_colors0_disconnect0_disconnect_photos_disconnect_color_where_Color_this_colors0_disconnect0_photos0_color0param0
CALL {
	WITH this_colors0_disconnect0_photos0_color0, this_colors0_disconnect0_photos0_color0_rel, this_colors0_disconnect0_photos0
	WITH collect(this_colors0_disconnect0_photos0_color0) as this_colors0_disconnect0_photos0_color0, this_colors0_disconnect0_photos0_color0_rel, this_colors0_disconnect0_photos0
	UNWIND this_colors0_disconnect0_photos0_color0 as x
	DELETE this_colors0_disconnect0_photos0_color0_rel
}
RETURN count(*) AS disconnect_this_colors0_disconnect0_photos0_color_Color
}
RETURN count(*) AS disconnect_this_colors0_disconnect0_photos_Photo
}
RETURN count(*) AS disconnect_this_colors0_disconnect_Color
}
WITH this
CALL {
WITH this
OPTIONAL MATCH (this)-[this_photos0_disconnect0_rel:HAS_PHOTO]->(this_photos0_disconnect0:Photo)
WHERE this_photos0_disconnect0.id = $updateProducts_args_update_photos0_disconnect0_where_Photo_this_photos0_disconnect0param0
CALL {
	WITH this_photos0_disconnect0, this_photos0_disconnect0_rel, this
	WITH collect(this_photos0_disconnect0) as this_photos0_disconnect0, this_photos0_disconnect0_rel, this
	UNWIND this_photos0_disconnect0 as x
	DELETE this_photos0_disconnect0_rel
}
CALL {
WITH this, this_photos0_disconnect0
OPTIONAL MATCH (this_photos0_disconnect0)-[this_photos0_disconnect0_color0_rel:OF_COLOR]->(this_photos0_disconnect0_color0:Color)
WHERE this_photos0_disconnect0_color0.name = $updateProducts_args_update_photos0_disconnect_disconnect_color_where_Color_this_photos0_disconnect0_color0param0
CALL {
	WITH this_photos0_disconnect0_color0, this_photos0_disconnect0_color0_rel, this_photos0_disconnect0
	WITH collect(this_photos0_disconnect0_color0) as this_photos0_disconnect0_color0, this_photos0_disconnect0_color0_rel, this_photos0_disconnect0
	UNWIND this_photos0_disconnect0_color0 as x
	DELETE this_photos0_disconnect0_color0_rel
}
RETURN count(*) AS disconnect_this_photos0_disconnect0_color_Color
}
RETURN count(*) AS disconnect_this_photos0_disconnect_Photo
}
WITH this
CALL {
WITH this
OPTIONAL MATCH (this)-[this_photos0_disconnect1_rel:HAS_PHOTO]->(this_photos0_disconnect1:Photo)
WHERE this_photos0_disconnect1.id = $updateProducts_args_update_photos0_disconnect1_where_Photo_this_photos0_disconnect1param0
CALL {
	WITH this_photos0_disconnect1, this_photos0_disconnect1_rel, this
	WITH collect(this_photos0_disconnect1) as this_photos0_disconnect1, this_photos0_disconnect1_rel, this
	UNWIND this_photos0_disconnect1 as x
	DELETE this_photos0_disconnect1_rel
}
CALL {
WITH this, this_photos0_disconnect1
OPTIONAL MATCH (this_photos0_disconnect1)-[this_photos0_disconnect1_color0_rel:OF_COLOR]->(this_photos0_disconnect1_color0:Color)
WHERE this_photos0_disconnect1_color0.name = $updateProducts_args_update_photos0_disconnect_disconnect_color_where_Color_this_photos0_disconnect1_color0param0
CALL {
	WITH this_photos0_disconnect1_color0, this_photos0_disconnect1_color0_rel, this_photos0_disconnect1
	WITH collect(this_photos0_disconnect1_color0) as this_photos0_disconnect1_color0, this_photos0_disconnect1_color0_rel, this_photos0_disconnect1
	UNWIND this_photos0_disconnect1_color0 as x
	DELETE this_photos0_disconnect1_color0_rel
}
RETURN count(*) AS disconnect_this_photos0_disconnect1_color_Color
}
RETURN count(*) AS disconnect_this_photos0_disconnect_Photo
}

RETURN collect(DISTINCT this { .id }) AS data
----

'''

