:toc:

= Cypher Update

== Source schema

[source,graphql,schema=true]
----
type Actor {
  name: String
  movies: [Movie!]! @relationship(type: "ACTED_IN", properties: "ActedIn", direction: OUT)
}

type Movie {
  id: ID
  title: String
  actors: [Actor!]! @relationship(type: "ACTED_IN", properties: "ActedIn", direction: IN)
}

interface ActedIn {
  screenTime: Int
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{
  "enableRegex": true
}
----
== Delete and update nested operations under same mutation

.GraphQL-Query
[source,graphql]
----
mutation {
  updateMovies(
    where: {id: "1"}
    update: {actors: {where: {node: {name: "Actor to update"}}, update: {node: {name: "Updated name"}}}}
    delete: {actors: {where: {node: {name: "Actor to delete"}}}}
  ) {
    movies {
      id
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "1",
  "this_update_actors0_name" : "Updated name",
  "updateMovies" : {
    "args" : {
      "update" : {
        "actors" : [ {
          "where" : {
            "node" : {
              "name" : "Actor to update"
            }
          },
          "update" : {
            "node" : {
              "name" : "Updated name"
            }
          }
        } ]
      },
      "delete" : {
        "actors" : [ {
          "where" : {
            "node" : {
              "name" : "Actor to delete"
            }
          }
        } ]
      }
    }
  },
  "updateMovies_args_delete_actors0_where_Actorparam0" : "Actor to delete",
  "updateMovies_args_update_actors0_where_Actorparam0" : "Actor to update"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.id = $param0
WITH this
CALL {
	WITH this
	MATCH (this)<-[this_acted_in0_relationship:ACTED_IN]-(this_actors0:Actor)
	WHERE this_actors0.name = $updateMovies_args_update_actors0_where_Actorparam0
	SET this_actors0.name = $this_update_actors0_name
	RETURN count(*) AS update_this_actors0
}
WITH this
OPTIONAL MATCH (this)<-[this_delete_actors0_relationship:ACTED_IN]-(this_delete_actors0:Actor)
WHERE this_delete_actors0.name = $updateMovies_args_delete_actors0_where_Actorparam0
WITH this, collect(DISTINCT this_delete_actors0) AS this_delete_actors0_to_delete
CALL {
	WITH this_delete_actors0_to_delete
	UNWIND this_delete_actors0_to_delete AS x DETACH DELETE x
	RETURN count(*) AS _
}
WITH *
RETURN collect(DISTINCT this {
	.id
}) AS data
----

'''

== Delete related node as update

.GraphQL-Query
[source,graphql]
----
mutation {
  updateMovies(
    where: {id: "1"}
    delete: {actors: {where: {node: {name: "Actor to delete"}, edge: {screenTime: 60}}}}
  ) {
    movies {
      id
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "1",
  "updateMovies" : {
    "args" : {
      "delete" : {
        "actors" : [ {
          "where" : {
            "edge" : {
              "screenTime" : 60
            },
            "node" : {
              "name" : "Actor to delete"
            }
          }
        } ]
      }
    }
  },
  "updateMovies_args_delete_actors0_where_Actorparam0" : 60,
  "updateMovies_args_delete_actors0_where_Actorparam1" : "Actor to delete"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.id = $param0
WITH this
OPTIONAL MATCH (this)<-[this_delete_actors0_relationship:ACTED_IN]-(this_delete_actors0:Actor)
WHERE (this_delete_actors0_relationship.screenTime = $updateMovies_args_delete_actors0_where_Actorparam0
	AND this_delete_actors0.name = $updateMovies_args_delete_actors0_where_Actorparam1)
WITH this, collect(DISTINCT this_delete_actors0) AS this_delete_actors0_to_delete
CALL {
	WITH this_delete_actors0_to_delete
	UNWIND this_delete_actors0_to_delete AS x DETACH DELETE x
	RETURN count(*) AS _
}
WITH *
RETURN collect(DISTINCT this {
	.id
}) AS data
----

'''

== Double nested delete under a nested update

.GraphQL-Query
[source,graphql]
----
mutation {
  updateMovies(
    where: {id: "1"}
    update: {actors: {delete: {where: {node: {name: "Actor to delete"}}, delete: {movies: {where: {node: {id: "2"}}}}}}}
  ) {
    movies {
      id
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "1",
  "updateMovies" : {
    "args" : {
      "update" : {
        "actors" : [ {
          "delete" : [ {
            "where" : {
              "node" : {
                "name" : "Actor to delete"
              }
            },
            "delete" : {
              "movies" : [ {
                "where" : {
                  "node" : {
                    "id" : "2"
                  }
                }
              } ]
            }
          } ]
        } ]
      }
    }
  },
  "updateMovies_args_update_actors0_delete0_delete_movies0_where_Movieparam0" : "2",
  "updateMovies_args_update_actors0_delete0_where_Actorparam0" : "Actor to delete"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.id = $param0
WITH this
OPTIONAL MATCH (this)<-[this_actors0_delete0_relationship:ACTED_IN]-(this_actors0_delete0:Actor)
WHERE this_actors0_delete0.name = $updateMovies_args_update_actors0_delete0_where_Actorparam0
WITH this, this_actors0_delete0
OPTIONAL MATCH (this_actors0_delete0)-[this_actors0_delete0_movies0_relationship:ACTED_IN]->(this_actors0_delete0_movies0:Movie)
WHERE this_actors0_delete0_movies0.id = $updateMovies_args_update_actors0_delete0_delete_movies0_where_Movieparam0
WITH this, this_actors0_delete0, collect(DISTINCT this_actors0_delete0_movies0) AS this_actors0_delete0_movies0_to_delete
CALL {
	WITH this_actors0_delete0_movies0_to_delete
	UNWIND this_actors0_delete0_movies0_to_delete AS x DETACH DELETE x
	RETURN count(*) AS _
}
WITH this, collect(DISTINCT this_actors0_delete0) AS this_actors0_delete0_to_delete
CALL {
	WITH this_actors0_delete0_to_delete
	UNWIND this_actors0_delete0_to_delete AS x DETACH DELETE x
	RETURN count(*) AS _
}
RETURN collect(DISTINCT this {
	.id
}) AS data
----

'''

== Double Nested Update

.GraphQL-Query
[source,graphql]
----
mutation {
  updateMovies(
    where: {id: "1"}
    update: {actors: [{where: {node: {name: "old actor name"}}, update: {node: {name: "new actor name", movies: [{where: {node: {id: "old movie title"}}, update: {node: {title: "new movie title"}}}]}}}]}
  ) {
    movies {
      id
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "1",
  "this_update_actors0_movies0_title" : "new movie title",
  "this_update_actors0_name" : "new actor name",
  "updateMovies" : {
    "args" : {
      "update" : {
        "actors" : [ {
          "where" : {
            "node" : {
              "name" : "old actor name"
            }
          },
          "update" : {
            "node" : {
              "name" : "new actor name",
              "movies" : [ {
                "where" : {
                  "node" : {
                    "id" : "old movie title"
                  }
                },
                "update" : {
                  "node" : {
                    "title" : "new movie title"
                  }
                }
              } ]
            }
          }
        } ]
      }
    }
  },
  "updateMovies_args_update_actors0_update_node_movies0_where_Movieparam0" : "old movie title",
  "updateMovies_args_update_actors0_where_Actorparam0" : "old actor name"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.id = $param0
WITH this
CALL {
	WITH this
	MATCH (this)<-[this_acted_in0_relationship:ACTED_IN]-(this_actors0:Actor)
	WHERE this_actors0.name = $updateMovies_args_update_actors0_where_Actorparam0
	SET this_actors0.name = $this_update_actors0_name
	WITH this, this_actors0
	CALL {
		WITH this, this_actors0
		MATCH (this_actors0)-[this_actors0_acted_in0_relationship:ACTED_IN]->(this_actors0_movies0:Movie)
		WHERE this_actors0_movies0.id = $updateMovies_args_update_actors0_update_node_movies0_where_Movieparam0
		SET this_actors0_movies0.title = $this_update_actors0_movies0_title
		RETURN count(*) AS update_this_actors0_movies0
	}
	RETURN count(*) AS update_this_actors0
}
RETURN collect(DISTINCT this {
	.id
}) AS data
----

'''

== Nested delete under a nested update

.GraphQL-Query
[source,graphql]
----
mutation {
  updateMovies(
    where: {id: "1"}
    update: {actors: {delete: {where: {node: {name: "Actor to delete"}}}}}
  ) {
    movies {
      id
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "1",
  "updateMovies" : {
    "args" : {
      "update" : {
        "actors" : [ {
          "delete" : [ {
            "where" : {
              "node" : {
                "name" : "Actor to delete"
              }
            }
          } ]
        } ]
      }
    }
  },
  "updateMovies_args_update_actors0_delete0_where_Actorparam0" : "Actor to delete"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.id = $param0
WITH this
OPTIONAL MATCH (this)<-[this_actors0_delete0_relationship:ACTED_IN]-(this_actors0_delete0:Actor)
WHERE this_actors0_delete0.name = $updateMovies_args_update_actors0_delete0_where_Actorparam0
WITH this, collect(DISTINCT this_actors0_delete0) AS this_actors0_delete0_to_delete
CALL {
	WITH this_actors0_delete0_to_delete
	UNWIND this_actors0_delete0_to_delete AS x DETACH DELETE x
	RETURN count(*) AS _
}
RETURN collect(DISTINCT this {
	.id
}) AS data
----

'''

== Simple Update

.GraphQL-Query
[source,graphql]
----
mutation {
  updateMovies(where: {id: "1"}, update: {id: "2"}) {
    movies {
      id
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "1",
  "this_update_id" : "2"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.id = $param0
SET this.id = $this_update_id
RETURN collect(DISTINCT this {
	.id
}) AS data
----

'''

== Simple Update as Connect

.GraphQL-Query
[source,graphql]
----
mutation {
  updateMovies(
    where: {id: "1"}
    connect: {actors: [{where: {node: {name: "Daniel"}}}]}
  ) {
    movies {
      id
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "1",
  "this_connect_actors0_node_param0" : "Daniel"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.id = $param0
WITH this
CALL {
	WITH this
	OPTIONAL MATCH (this_connect_actors0_node:Actor)
	WHERE this_connect_actors0_node.name = $this_connect_actors0_node_param0
	CALL {
		WITH *
		WITH collect(this_connect_actors0_node) AS connectedNodes, collect(this) AS parentNodes
		CALL {
			WITH connectedNodes, parentNodes
			UNWIND parentNodes AS this
			UNWIND connectedNodes AS this_connect_actors0_node
			MERGE (this)<-[this_connect_actors0_relationship:ACTED_IN]-(this_connect_actors0_node)
			RETURN count(*) AS _
		}
		RETURN count(*) AS _
	}
	WITH this, this_connect_actors0_node
	RETURN count(*) AS connect_this_connect_actors_Actor
}
WITH *
RETURN collect(DISTINCT this {
	.id
}) AS data
----

'''

== Simple Update as Disconnect

.GraphQL-Query
[source,graphql]
----
mutation {
  updateMovies(
    where: {id: "1"}
    disconnect: {actors: [{where: {node: {name: "Daniel"}}}]}
  ) {
    movies {
      id
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "1",
  "updateMovies" : {
    "args" : {
      "disconnect" : {
        "actors" : [ {
          "where" : {
            "node" : {
              "name" : "Daniel"
            }
          }
        } ]
      }
    }
  },
  "updateMovies_args_disconnect_actors0_where_Actorparam0" : "Daniel"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.id = $param0
WITH this
CALL {
	WITH this
	OPTIONAL MATCH (this)<-[this_disconnect_actors0_rel:ACTED_IN]-(this_disconnect_actors0:Actor)
	WHERE this_disconnect_actors0.name = $updateMovies_args_disconnect_actors0_where_Actorparam0
	CALL {
		WITH this_disconnect_actors0, this_disconnect_actors0_rel, this
		WITH collect(this_disconnect_actors0) AS this_disconnect_actors0, this_disconnect_actors0_rel, this
		UNWIND this_disconnect_actors0 AS x DELETE this_disconnect_actors0_rel
		RETURN count(*) AS _
	}
	RETURN count(*) AS disconnect_this_disconnect_actors_Actor
}
WITH *
RETURN collect(DISTINCT this {
	.id
}) AS data
----

'''

== Single Nested Update

.GraphQL-Query
[source,graphql]
----
mutation {
  updateMovies(
    where: {id: "1"}
    update: {actors: [{where: {node: {name: "old name"}}, update: {node: {name: "new name"}}}]}
  ) {
    movies {
      id
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "1",
  "this_update_actors0_name" : "new name",
  "updateMovies" : {
    "args" : {
      "update" : {
        "actors" : [ {
          "where" : {
            "node" : {
              "name" : "old name"
            }
          },
          "update" : {
            "node" : {
              "name" : "new name"
            }
          }
        } ]
      }
    }
  },
  "updateMovies_args_update_actors0_where_Actorparam0" : "old name"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.id = $param0
WITH this
CALL {
	WITH this
	MATCH (this)<-[this_acted_in0_relationship:ACTED_IN]-(this_actors0:Actor)
	WHERE this_actors0.name = $updateMovies_args_update_actors0_where_Actorparam0
	SET this_actors0.name = $this_update_actors0_name
	RETURN count(*) AS update_this_actors0
}
RETURN collect(DISTINCT this {
	.id
}) AS data
----

'''

== Update an Actor while creating and connecting to a new Movie (via field level)

.GraphQL-Query
[source,graphql]
----
mutation {
  updateActors(
    where: {name: "Dan"}
    update: {movies: {create: [{node: {id: "dan_movie_id", title: "The Story of Beer"}}]}}
  ) {
    actors {
      name
      movies {
        id
        title
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "Dan",
  "this_movies0_create0_node_id" : "dan_movie_id",
  "this_movies0_create0_node_title" : "The Story of Beer"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WHERE this.name = $param0
WITH this
CREATE (this_movies0_create0_node:Movie)
SET this_movies0_create0_node.id = $this_movies0_create0_node_id
SET this_movies0_create0_node.title = $this_movies0_create0_node_title
MERGE (this)-[:ACTED_IN]->(this_movies0_create0_node)
WITH *
CALL {
	WITH this
	MATCH (this)-[update_this0:ACTED_IN]->(this_movies:Movie)
	WITH this_movies {
		.id,
		.title
	} AS this_movies
	RETURN collect(this_movies) AS this_movies
}
RETURN collect(DISTINCT this {
	.name,
	movies: this_movies
}) AS data
----

'''

== Update an Actor while creating and connecting to a new Movie (via top level)

.GraphQL-Query
[source,graphql]
----
mutation {
  updateActors(
    where: {name: "Dan"}
    create: {movies: [{node: {id: "dan_movie_id", title: "The Story of Beer"}}]}
  ) {
    actors {
      name
      movies {
        id
        title
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "Dan",
  "this_create_movies0_node_id" : "dan_movie_id",
  "this_create_movies0_node_title" : "The Story of Beer"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WHERE this.name = $param0
CREATE (this_create_movies0_node:Movie)
SET this_create_movies0_node.id = $this_create_movies0_node_id
SET this_create_movies0_node.title = $this_create_movies0_node_title
MERGE (this)-[this_create_movies0_relationship:ACTED_IN]->(this_create_movies0_node)
WITH *
CALL {
	WITH this
	MATCH (this)-[update_this0:ACTED_IN]->(this_movies:Movie)
	WITH this_movies {
		.id,
		.title
	} AS this_movies
	RETURN collect(this_movies) AS this_movies
}
RETURN collect(DISTINCT this {
	.name,
	movies: this_movies
}) AS data
----

'''

== Update an Actor while creating and connecting to multiple new Movies (via top level)

.GraphQL-Query
[source,graphql]
----
mutation {
  updateActors(
    where: {name: "Dan"}
    create: {movies: [{node: {id: "dan_movie_id", title: "The Story of Beer"}}, {node: {id: "dan_movie2_id", title: "Forrest Gump"}}]}
  ) {
    actors {
      name
      movies {
        id
        title
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "Dan",
  "this_create_movies0_node_id" : "dan_movie_id",
  "this_create_movies0_node_title" : "The Story of Beer",
  "this_create_movies1_node_id" : "dan_movie2_id",
  "this_create_movies1_node_title" : "Forrest Gump"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WHERE this.name = $param0
CREATE (this_create_movies0_node:Movie)
SET this_create_movies0_node.id = $this_create_movies0_node_id
SET this_create_movies0_node.title = $this_create_movies0_node_title
MERGE (this)-[this_create_movies0_relationship:ACTED_IN]->(this_create_movies0_node)
CREATE (this_create_movies1_node:Movie)
SET this_create_movies1_node.id = $this_create_movies1_node_id
SET this_create_movies1_node.title = $this_create_movies1_node_title
MERGE (this)-[this_create_movies1_relationship:ACTED_IN]->(this_create_movies1_node)
WITH *
CALL {
	WITH this
	MATCH (this)-[update_this0:ACTED_IN]->(this_movies:Movie)
	WITH this_movies {
		.id,
		.title
	} AS this_movies
	RETURN collect(this_movies) AS this_movies
}
RETURN collect(DISTINCT this {
	.name,
	movies: this_movies
}) AS data
----

'''

== Update as multiple Connect

.GraphQL-Query
[source,graphql]
----
mutation {
  updateMovies(
    where: {id: "1"}
    connect: {actors: [{where: {node: {name: "Daniel"}}}, {where: {node: {name: "Darrell"}}}]}
  ) {
    movies {
      id
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "1",
  "this_connect_actors0_node_param0" : "Daniel",
  "this_connect_actors1_node_param0" : "Darrell"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.id = $param0
WITH this
CALL {
	WITH this
	OPTIONAL MATCH (this_connect_actors0_node:Actor)
	WHERE this_connect_actors0_node.name = $this_connect_actors0_node_param0
	CALL {
		WITH *
		WITH collect(this_connect_actors0_node) AS connectedNodes, collect(this) AS parentNodes
		CALL {
			WITH connectedNodes, parentNodes
			UNWIND parentNodes AS this
			UNWIND connectedNodes AS this_connect_actors0_node
			MERGE (this)<-[this_connect_actors0_relationship:ACTED_IN]-(this_connect_actors0_node)
			RETURN count(*) AS _
		}
		RETURN count(*) AS _
	}
	WITH this, this_connect_actors0_node
	RETURN count(*) AS connect_this_connect_actors_Actor
}
WITH this
CALL {
	WITH this
	OPTIONAL MATCH (this_connect_actors1_node:Actor)
	WHERE this_connect_actors1_node.name = $this_connect_actors1_node_param0
	CALL {
		WITH *
		WITH collect(this_connect_actors1_node) AS connectedNodes, collect(this) AS parentNodes
		CALL {
			WITH connectedNodes, parentNodes
			UNWIND parentNodes AS this
			UNWIND connectedNodes AS this_connect_actors1_node
			MERGE (this)<-[this_connect_actors1_relationship:ACTED_IN]-(this_connect_actors1_node)
			RETURN count(*) AS _
		}
		RETURN count(*) AS _
	}
	WITH this, this_connect_actors1_node
	RETURN count(*) AS connect_this_connect_actors_Actor
}
WITH *
RETURN collect(DISTINCT this {
	.id
}) AS data
----

'''

== Update as multiple Disconnect

.GraphQL-Query
[source,graphql]
----
mutation {
  updateMovies(
    where: {id: "1"}
    disconnect: {actors: [{where: {node: {name: "Daniel"}}}, {where: {node: {name: "Darrell"}}}]}
  ) {
    movies {
      id
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "1",
  "updateMovies" : {
    "args" : {
      "disconnect" : {
        "actors" : [ {
          "where" : {
            "node" : {
              "name" : "Daniel"
            }
          }
        }, {
          "where" : {
            "node" : {
              "name" : "Darrell"
            }
          }
        } ]
      }
    }
  },
  "updateMovies_args_disconnect_actors0_where_Actorparam0" : "Daniel",
  "updateMovies_args_disconnect_actors1_where_Actorparam0" : "Darrell"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.id = $param0
WITH this
CALL {
	WITH this
	OPTIONAL MATCH (this)<-[this_disconnect_actors0_rel:ACTED_IN]-(this_disconnect_actors0:Actor)
	WHERE this_disconnect_actors0.name = $updateMovies_args_disconnect_actors0_where_Actorparam0
	CALL {
		WITH this_disconnect_actors0, this_disconnect_actors0_rel, this
		WITH collect(this_disconnect_actors0) AS this_disconnect_actors0, this_disconnect_actors0_rel, this
		UNWIND this_disconnect_actors0 AS x DELETE this_disconnect_actors0_rel
		RETURN count(*) AS _
	}
	RETURN count(*) AS disconnect_this_disconnect_actors_Actor
}
WITH this
CALL {
	WITH this
	OPTIONAL MATCH (this)<-[this_disconnect_actors1_rel:ACTED_IN]-(this_disconnect_actors1:Actor)
	WHERE this_disconnect_actors1.name = $updateMovies_args_disconnect_actors1_where_Actorparam0
	CALL {
		WITH this_disconnect_actors1, this_disconnect_actors1_rel, this
		WITH collect(this_disconnect_actors1) AS this_disconnect_actors1, this_disconnect_actors1_rel, this
		UNWIND this_disconnect_actors1 AS x DELETE this_disconnect_actors1_rel
		RETURN count(*) AS _
	}
	RETURN count(*) AS disconnect_this_disconnect_actors_Actor
}
WITH *
RETURN collect(DISTINCT this {
	.id
}) AS data
----

'''

