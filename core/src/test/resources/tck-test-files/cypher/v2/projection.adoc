:toc:

= Cypher Projection

== Source schema

[source,graphql,schema=true]
----
type Product {
  id: ID!
  name: String
  sizes: [Size!]! @relationship(type: "HAS_SIZE", direction: OUT)
  colors: [Color!]! @relationship(type: "HAS_COLOR", direction: OUT)
  photos: [Photo!]! @relationship(type: "HAS_PHOTO", direction: OUT)
}

type Size {
  id: ID!
  name: String!
}

type Color {
  id: ID!
  name: String!
  photos: [Photo!]! @relationship(type: "OF_COLOR", direction: IN)
}

type Photo {
  id: ID!
  description: String!
  url: String!
  color: Color! @relationship(type: "OF_COLOR", direction: OUT)
  location: Point
}
----
== Multi Create With Projection

.GraphQL-Query
[source,graphql]
----
mutation {
  createProducts(input: [{id: "1"}, {id: "2"}]) {
    products {
      id
      photos(where: {url: "url.com"}) {
        url
        location {
          latitude
          longitude
          height
        }
      }
      colors(where: {id: 123}) {
        id
      }
      sizes(where: {name: "small"}) {
        name
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "create_param0" : [ {
    "id" : "1"
  }, {
    "id" : "2"
  } ],
  "create_param1" : "url.com",
  "create_param2" : "123",
  "create_param3" : "small"
}
----

.Expected Cypher output
[source,cypher]
----
UNWIND $create_param0 AS create_var0
CALL {
	WITH create_var0
	CREATE (create_this1:Product)
	SET create_this1.id = create_var0.id
	RETURN create_this1
}
CALL {
	WITH create_this1
	MATCH (create_this1)-[create_this2:HAS_PHOTO]->(create_this3:Photo)
	WHERE create_this3.url = $create_param1
	WITH create_this3 {
		.url,
		location: CASE WHEN create_this3.location IS NOT NULL THEN {
			point: create_this3.location
		} ELSE NULL END
	} AS create_this3
	RETURN collect(create_this3) AS create_var4
}
CALL {
	WITH create_this1
	MATCH (create_this1)-[create_this5:HAS_COLOR]->(create_this6:Color)
	WHERE create_this6.id = $create_param2
	WITH create_this6 {
		.id
	} AS create_this6
	RETURN collect(create_this6) AS create_var7
}
CALL {
	WITH create_this1
	MATCH (create_this1)-[create_this8:HAS_SIZE]->(create_this9:Size)
	WHERE create_this9.name = $create_param3
	WITH create_this9 {
		.name
	} AS create_this9
	RETURN collect(create_this9) AS create_var10
}
RETURN collect(create_this1 {
	.id,
	photos: create_var4,
	colors: create_var7,
	sizes: create_var10
}) AS data
----

'''

