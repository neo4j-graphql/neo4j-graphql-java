// This file was generated by the Test-Case extractor of neo4j-graphql
:toc:
:toclevels: 42

= tck/rfcs/query-limits

== Setup

.Schema
[source,graphql,schema=true]
----
type Movie @limit(default: 3, max: 5) {
  id: ID!
  actors: [Person!]! @relationship(type: "ACTED_IN", direction: IN)
}

type Person @limit(default: 2) {
  id: ID!
}

type Show @limit(max: 2) {
  id: ID!
}

type Festival {
  name: String!
  shows: [Show!]! @relationship(type: "PART_OF", direction: IN)
}
----

== Top Level Query Limits

=== should limit the top level query with default value

.GraphQL-Query
[source,graphql,request=true]
----
{
  movies {
    id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": 3
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WITH *

LIMIT $param0
RETURN this { .id } AS this
----

=== should limit the top level query with max value if not default is available

.GraphQL-Query
[source,graphql,request=true]
----
{
  shows {
    id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": 2
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Show)
WITH *

LIMIT $param0
RETURN this { .id } AS this
----

=== should limit the top level query with max value the option given is higher

.GraphQL-Query
[source,graphql,request=true]
----
{
  shows(options: {limit: 5}) {
    id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": 2
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Show)
WITH *

LIMIT $param0
RETURN this { .id } AS this
----

== Field Level Query Limits

=== should limit the normal field level query

.GraphQL-Query
[source,graphql,request=true]
----
{
  movies {
    id
    actors {
      id
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": 3,
  "param1": 2
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WITH *

LIMIT $param0
CALL {
    WITH this
    MATCH (this)<-[this0:ACTED_IN]-(this1:Person)
    WITH this1 { .id } AS this1
    
    LIMIT $param1
    RETURN collect(this1) AS var2
}
RETURN this { .id, actors: var2 } AS this
----

=== should limit the connection field level query

.GraphQL-Query
[source,graphql,request=true]
----
{
  movies {
    id
    actorsConnection {
      edges {
        node {
          id
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": 3,
  "param1": 2
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WITH *

LIMIT $param0
CALL {
    WITH this
    MATCH (this)<-[this0:ACTED_IN]-(this1:Person)
    WITH collect({ node: this1, relationship: this0 }) AS edges
    WITH edges, size(edges) AS totalCount
    CALL {
        WITH edges
        UNWIND edges AS edge
        WITH edge.node AS this1, edge.relationship AS this0
        WITH *
        
        LIMIT $param1
        RETURN collect({ node: { id: this1.id, __typename: "Person" } }) AS var2
    }
    RETURN { edges: var2, totalCount: totalCount } AS var3
}
RETURN this { .id, actorsConnection: var3 } AS this
----

=== should extend the limit to the connection field if `first` provided

.GraphQL-Query
[source,graphql,request=true]
----
{
  movies {
    id
    actorsConnection(first: 4) {
      edges {
        node {
          id
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": 3,
  "param1": 4
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WITH *

LIMIT $param0
CALL {
    WITH this
    MATCH (this)<-[this0:ACTED_IN]-(this1:Person)
    WITH collect({ node: this1, relationship: this0 }) AS edges
    WITH edges, size(edges) AS totalCount
    CALL {
        WITH edges
        UNWIND edges AS edge
        WITH edge.node AS this1, edge.relationship AS this0
        WITH *
        
        LIMIT $param1
        RETURN collect({ node: { id: this1.id, __typename: "Person" } }) AS var2
    }
    RETURN { edges: var2, totalCount: totalCount } AS var3
}
RETURN this { .id, actorsConnection: var3 } AS this
----

=== should extend the limit to the connection field if `first` provided, honouring the `max` argument

.GraphQL-Query
[source,graphql,request=true]
----
{
  festivals {
    name
    showsConnection(first: 3) {
      edges {
        node {
          id
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": 2
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Festival)
CALL {
    WITH this
    MATCH (this)<-[this0:PART_OF]-(this1:Show)
    WITH collect({ node: this1, relationship: this0 }) AS edges
    WITH edges, size(edges) AS totalCount
    CALL {
        WITH edges
        UNWIND edges AS edge
        WITH edge.node AS this1, edge.relationship AS this0
        WITH *
        
        LIMIT $param0
        RETURN collect({ node: { id: this1.id, __typename: "Show" } }) AS var2
    }
    RETURN { edges: var2, totalCount: totalCount } AS var3
}
RETURN this { .name, showsConnection: var3 } AS this
----

=== should limit the relationship field level query

.GraphQL-Query
[source,graphql,request=true]
----
{
  movies {
    id
    actors {
      id
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": 3,
  "param1": 2
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WITH *

LIMIT $param0
CALL {
    WITH this
    MATCH (this)<-[this0:ACTED_IN]-(this1:Person)
    WITH this1 { .id } AS this1
    
    LIMIT $param1
    RETURN collect(this1) AS var2
}
RETURN this { .id, actors: var2 } AS this
----
