// This file was generated by the Test-Case extractor of neo4j-graphql
:toc:
:toclevels: 42

= tck/rfs/022 subquery projection

== no auth

=== Setup

.Schema
[source,graphql,schema=true]
----
type Movie {
  title: String!
  released: Int
  actors: [Person!]! @relationship(type: "ACTED_IN", direction: IN, properties: "ActedIn")
  directors: [Person!]! @relationship(type: "DIRECTED", direction: IN)
}

type Person {
  name: String!
  movies: [Movie!]! @relationship(type: "ACTED_IN", direction: OUT, properties: "ActedIn")
  directed: [Movie!]! @relationship(type: "DIRECTED", direction: OUT)
}

type ActedIn @relationshipProperties {
  year: Int
}
----

=== Nested query

.GraphQL-Query
[source,graphql,request=true]
----
query Query {
  movies(where: {released: 1999}) {
    title
    actors(where: {name: "Keanu Reeves"}) {
      name
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": 1999,
  "param1": "Keanu Reeves"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.released = $param0
CALL {
    WITH this
    MATCH (this)<-[this0:ACTED_IN]-(this1:Person)
    WHERE this1.name = $param1
    WITH this1 { .name } AS this1
    RETURN collect(this1) AS var2
}
RETURN this { .title, actors: var2 } AS this
----

=== Double nested query

.GraphQL-Query
[source,graphql,request=true]
----
query Query {
  movies(where: {released: 1999}) {
    title
    actors(where: {name: "Keanu Reeves"}) {
      name
      directed {
        title
        released
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": 1999,
  "param1": "Keanu Reeves"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.released = $param0
CALL {
    WITH this
    MATCH (this)<-[this0:ACTED_IN]-(this1:Person)
    WHERE this1.name = $param1
    CALL {
        WITH this1
        MATCH (this1)-[this2:DIRECTED]->(this3:Movie)
        WITH this3 { .title, .released } AS this3
        RETURN collect(this3) AS var4
    }
    WITH this1 { .name, directed: var4 } AS this1
    RETURN collect(this1) AS var5
}
RETURN this { .title, actors: var5 } AS this
----
