:toc:

= With auth

== Source schema

[source,graphql,schema=true]
----
type Movie {
  title: String!
  released: Int
  actors: [Person!]! @relationship(type: "ACTED_IN", direction: IN, properties: "ActedIn")
}

type Person @auth(rules: [{isAuthenticated: true, where: {name: "The Matrix"}, allow: {name: "$jwt.test"}, roles: ["admin"]}]) {
  name: String!
  movies: [Movie!]! @relationship(type: "ACTED_IN", direction: OUT, properties: "ActedIn")
}

interface ActedIn @relationshipProperties {
  year: Int
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{
  "enableRegex": true
}
----
== Nested query

.GraphQL-Query
[source,graphql]
----
query Query {
  movies(where: {released: 1999}) {
    title
    actors(where: {name: "Keanu Reeves"}) {
      name
    }
  }
}
----

.Query Context
[source,json,query-config=true]
----
{
  "auth": {},
  "contextParams": {
    "jwt": {
      "test": "my-test"
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "auth" : {
    "isAuthenticated" : true,
    "roles" : [ ],
    "jwt" : {
      "roles" : [ ],
      "test" : "my-test"
    }
  },
  "param0" : 1999,
  "param1" : "Keanu Reeves",
  "param3" : "The Matrix",
  "param5" : "my-test"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.released = $param0
CALL {
	WITH this
	MATCH (this_actors:Person)-[this0:ACTED_IN]->(this)
	WHERE (this_actors.name = $param1
		AND any(r IN ['admin']
		WHERE any(rr IN $auth.roles
		WHERE rr = r))
		AND apoc.util.validatePredicate(NOT ($auth.isAuthenticated = true), '@neo4j/graphql/UNAUTHENTICATED', [0])
		AND this_actors.name IS NOT NULL
		AND this_actors.name = $param3
		AND apoc.util.validatePredicate(NOT ((any(r IN ['admin']
			WHERE any(rr IN $auth.roles
			WHERE rr = r))
			AND apoc.util.validatePredicate(NOT ($auth.isAuthenticated = true), '@neo4j/graphql/UNAUTHENTICATED', [0])
			AND this_actors.name IS NOT NULL
			AND this_actors.name = $param5)), '@neo4j/graphql/FORBIDDEN', [0]))
	WITH this_actors {
		.name
	} AS this_actors
	RETURN collect(this_actors) AS this_actors
}
RETURN this {
	.title,
	actors: this_actors
} AS this
----

'''

