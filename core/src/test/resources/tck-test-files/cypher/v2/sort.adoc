:toc:

= Cypher sort tests

== Source schema

[source,graphql,schema=true]
----
type Movie {
  id: ID
  title: String
  genres: [Genre!]! @relationship(type: "HAS_GENRE", direction: OUT)
  totalGenres: Int! @cypher(statement: """
  MATCH (this)-[:HAS_GENRE]->(genre:Genre)
  RETURN count(DISTINCT genre)
  """)
}

type Genre {
  id: ID
  name: String
  totalMovies: Int! @cypher(statement: """
  MATCH (this)<-[:HAS_GENRE]-(movie:Movie)
  RETURN count(DISTINCT movie)
  """)
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{
  "enableRegex": true
}
----
== Multi Sort

.GraphQL-Query
[source,graphql]
----
{
  movies(options: {sort: [{id: DESC}, {title: ASC}]}) {
    id
    title
  }
}
----

.Expected Cypher params
[source,json]
----
{ }
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WITH * ORDER BY this.id DESC, this.title ASC
RETURN this {
	.id,
	.title
} AS this
----

'''

== Nested Sort ASC

.GraphQL-Query
[source,graphql]
----
{
  movies {
    genres(options: {sort: [{name: ASC}]}) {
      name
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{ }
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL {
	WITH this
	MATCH (this)-[this0:HAS_GENRE]->(this_genres:Genre)
	WITH this_genres {
		.name
	} AS this_genres ORDER BY this_genres.name ASC
	RETURN collect(this_genres) AS this_genres
}
RETURN this {
	genres: this_genres
} AS this
----

'''

== Nested Sort DESC

.GraphQL-Query
[source,graphql]
----
{
  movies {
    genres(options: {sort: [{name: DESC}]}) {
      name
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{ }
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL {
	WITH this
	MATCH (this)-[this0:HAS_GENRE]->(this_genres:Genre)
	WITH this_genres {
		.name
	} AS this_genres ORDER BY this_genres.name DESC
	RETURN collect(this_genres) AS this_genres
}
RETURN this {
	genres: this_genres
} AS this
----

'''

== Nested Sort On Cypher Field ASC

.GraphQL-Query
[source,graphql]
----
{
  movies {
    genres(options: {sort: [{totalMovies: ASC}]}) {
      name
      totalMovies
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "auth" : {
    "isAuthenticated" : true,
    "roles" : [ ],
    "jwt" : {
      "roles" : [ ]
    }
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL {
	WITH this
	MATCH (this)-[this0:HAS_GENRE]->(this_genres:Genre)
	CALL {
		WITH this_genres
		UNWIND apoc.cypher.runFirstColumnSingle('MATCH (this)<-[:HAS_GENRE]-(movie:Movie)
        RETURN count(DISTINCT movie)', {
			this: this_genres,
			auth: $auth
		}) AS this_genres_totalMovies
		RETURN head(collect(this_genres_totalMovies)) AS this_genres_totalMovies
	}
	WITH this_genres {
		.name,
		totalMovies: this_genres_totalMovies
	} AS this_genres ORDER BY this_genres.totalMovies ASC
	RETURN collect(this_genres) AS this_genres
}
RETURN this {
	genres: this_genres
} AS this
----

'''

== Simple Sort On Cypher Field

.GraphQL-Query
[source,graphql]
----
{
  movies(options: {sort: [{totalGenres: DESC}]}) {
    totalGenres
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "auth" : {
    "isAuthenticated" : true,
    "roles" : [ ],
    "jwt" : {
      "roles" : [ ]
    }
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL {
	WITH this
	UNWIND apoc.cypher.runFirstColumnSingle('MATCH (this)-[:HAS_GENRE]->(genre:Genre)
    RETURN count(DISTINCT genre)', {
		this: this,
		auth: $auth
	}) AS this_totalGenres
	RETURN head(collect(this_totalGenres)) AS this_totalGenres
}
WITH * ORDER BY this_totalGenres DESC
RETURN this {
	totalGenres: this_totalGenres
} AS this
----

'''

== Sort with offset limit & with other variables

.GraphQL-Query
[source,graphql]
----
query ($title: String, $offset: Int, $limit: Int) {
  movies(
    options: {sort: [{id: DESC}, {title: ASC}], offset: $offset, limit: $limit}
    where: {title: $title}
  ) {
    id
    title
  }
}
----

.GraphQL params input
[source,json,request=true]
----
{
  "limit": 2,
  "offset": 1,
  "title": "some title"
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "some title",
  "param1" : 1,
  "param2" : 2
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.title = $param0
WITH * ORDER BY this.id DESC, this.title ASC SKIP $param1 LIMIT $param2
RETURN this {
	.id,
	.title
} AS this
----

'''

== Simple Sort

=== with field aliased in selection set

.GraphQL-Query
[source,graphql]
----
{
  movies(options: {sort: [{id: DESC}]}) {
    aliased: id
    title
  }
}
----

.Expected Cypher params
[source,json]
----
{ }
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WITH * ORDER BY this.id DESC
RETURN this {
	aliased: this.id,
	.title,
	.id
} AS this
----

'''

=== with field in selection set

.GraphQL-Query
[source,graphql]
----
{
  movies(options: {sort: [{id: DESC}]}) {
    id
    title
  }
}
----

.Expected Cypher params
[source,json]
----
{ }
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WITH * ORDER BY this.id DESC
RETURN this {
	.id,
	.title
} AS this
----

'''

=== with field not in selection set

.GraphQL-Query
[source,graphql]
----
{
  movies(options: {sort: [{id: DESC}]}) {
    title
  }
}
----

.Expected Cypher params
[source,json]
----
{ }
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WITH * ORDER BY this.id DESC
RETURN this {
	.title,
	.id
} AS this
----

'''


