:toc:

= Cypher Union

== Source schema

[source,graphql,schema=true]
----
union Search = Genre | Movie

type Genre @authorization(validate: [{when: [BEFORE], operations: [READ], where: {node: {name: "$jwt.jwtAllowedNamesExample"}}}]) {
  name: String
}

type Movie {
  title: String
  search: [Search!]! @relationship(type: "SEARCH", direction: OUT)
}
----
== Connect Unions (in create)

.GraphQL-Query
[source,graphql]
----
mutation {
  createMovies(
    input: [{title: "some movie", search: {Genre: {connect: [{where: {node: {name: "some genre"}}}]}}}]
  ) {
    movies {
      title
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this0_search_Genre_connect0_node_param0" : "some genre",
  "this0_title" : "some movie"
}
----

.Expected Cypher output
[source,cypher]
----
CALL {
	CREATE (this0:Movie)
	SET this0.title = $this0_title
	WITH *
	CALL {
		WITH this0
		OPTIONAL MATCH (this0_search_Genre_connect0_node:Genre)
		WHERE this0_search_Genre_connect0_node.name = $this0_search_Genre_connect0_node_param0
		CALL {
			WITH *
			WITH collect(this0_search_Genre_connect0_node) AS connectedNodes, collect(this0) AS parentNodes
			CALL {
				WITH connectedNodes, parentNodes
				UNWIND parentNodes AS this0
				UNWIND connectedNodes AS this0_search_Genre_connect0_node
				MERGE (this0)-[:SEARCH]->(this0_search_Genre_connect0_node)
			}
		}
		WITH this0, this0_search_Genre_connect0_node
		RETURN count(*) AS connect_this0_search_Genre_connect_Genre0
	}
	RETURN this0
}
CALL {
	WITH this0
	RETURN this0 {
		.title
	} AS create_var0
}
RETURN [create_var0] AS data
----

'''

== Connect Unions (in update)

.GraphQL-Query
[source,graphql]
----
mutation {
  updateMovies(
    where: {title: "some movie"}
    connect: {search: {Genre: {where: {node: {name: "some genre"}}}}}
  ) {
    movies {
      title
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "some movie",
  "this_connect_search_Genre0_node_param0" : "some genre"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.title = $param0
WITH *
CALL {
	WITH this
	OPTIONAL MATCH (this_connect_search_Genre0_node:Genre)
	WHERE this_connect_search_Genre0_node.name = $this_connect_search_Genre0_node_param0
	CALL {
		WITH *
		WITH collect(this_connect_search_Genre0_node) AS connectedNodes, collect(this) AS parentNodes
		CALL {
			WITH connectedNodes, parentNodes
			UNWIND parentNodes AS this
			UNWIND connectedNodes AS this_connect_search_Genre0_node
			MERGE (this)-[:SEARCH]->(this_connect_search_Genre0_node)
		}
	}
	WITH this, this_connect_search_Genre0_node
	RETURN count(*) AS connect_this_connect_search_Genre_Genre0
}
WITH *
RETURN collect(DISTINCT this {
	.title
}) AS data
----

'''

== Create Unions from create mutation

.GraphQL-Query
[source,graphql]
----
mutation {
  createMovies(
    input: [{title: "some movie", search: {Genre: {create: [{node: {name: "some genre"}}]}}}]
  ) {
    movies {
      title
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this0_search_Genre0_node_name" : "some genre",
  "this0_title" : "some movie"
}
----

.Expected Cypher output
[source,cypher]
----
CALL {
	CREATE (this0:Movie)
	SET this0.title = $this0_title
	WITH *
	CREATE (this0_search_Genre0_node:Genre)
	SET this0_search_Genre0_node.name = $this0_search_Genre0_node_name
	MERGE (this0)-[:SEARCH]->(this0_search_Genre0_node)
	RETURN this0
}
CALL {
	WITH this0
	RETURN this0 {
		.title
	} AS create_var0
}
RETURN [create_var0] AS data
----

'''

== Create Unions from update create(top-level)

.GraphQL-Query
[source,graphql]
----
mutation {
  updateMovies(create: {search: {Genre: [{node: {name: "some genre"}}]}}) {
    movies {
      title
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_create_search_Genre0_node_name" : "some genre"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CREATE (this_create_search_Genre0_node:Genre)
SET this_create_search_Genre0_node.name = $this_create_search_Genre0_node_name
MERGE (this)-[:SEARCH]->(this_create_search_Genre0_node)
WITH *
RETURN collect(DISTINCT this {
	.title
}) AS data
----

'''

== Delete Unions (from update)

.GraphQL-Query
[source,graphql]
----
mutation {
  updateMovies(
    where: {title: "some movie"}
    delete: {search: {Genre: {where: {node: {name: "some genre"}}}}}
  ) {
    movies {
      title
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "some movie",
  "updateMovies" : {
    "args" : {
      "delete" : {
        "search" : {
          "Genre" : [ {
            "where" : {
              "node" : {
                "name" : "some genre"
              }
            }
          } ]
        }
      }
    }
  },
  "updateMovies_args_delete_search_Genre0_where_this_delete_search_Genre0param0" : "some genre"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.title = $param0
WITH *
CALL {
	WITH *
	OPTIONAL MATCH (this)-[this_delete_search_Genre0_relationship:SEARCH]->(this_delete_search_Genre0:Genre)
	WHERE this_delete_search_Genre0.name = $updateMovies_args_delete_search_Genre0_where_this_delete_search_Genre0param0
	WITH this_delete_search_Genre0_relationship, collect(DISTINCT this_delete_search_Genre0) AS this_delete_search_Genre0_to_delete
	CALL {
		WITH this_delete_search_Genre0_to_delete
		UNWIND this_delete_search_Genre0_to_delete AS x DETACH DELETE x
	}
}
WITH *
RETURN collect(DISTINCT this {
	.title
}) AS data
----

'''

== Disconnect Unions

.GraphQL-Query
[source,graphql]
----
mutation {
  updateMovies(
    where: {title: "some movie"}
    disconnect: {search: {Genre: {where: {node: {name: "some genre"}}}}}
  ) {
    movies {
      title
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "some movie",
  "updateMovies" : {
    "args" : {
      "disconnect" : {
        "search" : {
          "Genre" : [ {
            "where" : {
              "node" : {
                "name" : "some genre"
              }
            }
          } ]
        }
      }
    }
  },
  "updateMovies_args_disconnect_search_Genre0_where_Genre_this_disconnect_search_Genre0param0" : "some genre"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.title = $param0
WITH this
CALL {
	WITH this
	OPTIONAL MATCH (this)-[this_disconnect_search_Genre0_rel:SEARCH]->(this_disconnect_search_Genre0:Genre)
	WHERE this_disconnect_search_Genre0.name = $updateMovies_args_disconnect_search_Genre0_where_Genre_this_disconnect_search_Genre0param0
	CALL {
		WITH this_disconnect_search_Genre0, this_disconnect_search_Genre0_rel, this
		WITH collect(this_disconnect_search_Genre0) AS this_disconnect_search_Genre0, this_disconnect_search_Genre0_rel, this
		UNWIND this_disconnect_search_Genre0 AS x DELETE this_disconnect_search_Genre0_rel
	}
	RETURN count(*) AS disconnect_this_disconnect_search_Genre_Genre
}
WITH *
RETURN collect(DISTINCT this {
	.title
}) AS data
----

'''

== Disconnect Unions (in update)

.GraphQL-Query
[source,graphql]
----
mutation {
  updateMovies(
    where: {title: "some movie"}
    update: {search: {Genre: {disconnect: [{where: {node: {name: "some genre"}}}]}}}
  ) {
    movies {
      title
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "some movie",
  "updateMovies" : {
    "args" : {
      "update" : {
        "search" : {
          "Genre" : [ {
            "disconnect" : [ {
              "where" : {
                "node" : {
                  "name" : "some genre"
                }
              }
            } ]
          } ]
        }
      }
    }
  },
  "updateMovies_args_update_search_Genre0_disconnect0_where_Genre_this_search_Genre0_disconnect0param0" : "some genre"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.title = $param0
WITH this
CALL {
	WITH this
	OPTIONAL MATCH (this)-[this_search_Genre0_disconnect0_rel:SEARCH]->(this_search_Genre0_disconnect0:Genre)
	WHERE this_search_Genre0_disconnect0.name = $updateMovies_args_update_search_Genre0_disconnect0_where_Genre_this_search_Genre0_disconnect0param0
	CALL {
		WITH this_search_Genre0_disconnect0, this_search_Genre0_disconnect0_rel, this
		WITH collect(this_search_Genre0_disconnect0) AS this_search_Genre0_disconnect0, this_search_Genre0_disconnect0_rel, this
		UNWIND this_search_Genre0_disconnect0 AS x DELETE this_search_Genre0_disconnect0_rel
	}
	RETURN count(*) AS disconnect_this_search_Genre0_disconnect_Genre
}
RETURN collect(DISTINCT this {
	.title
}) AS data
----

'''

== Read Unions simple

.GraphQL-Query
[source,graphql]
----
{
  movies {
    search {
      ... on Movie {
        title
      }
      ... on Genre {
        name
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "isAuthenticated" : true,
  "jwt" : {
    "roles" : [ ],
    "jwtAllowedNamesExample" : "Horror"
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL {
	WITH this
	CALL {
		WITH *
		MATCH (this)-[this0:SEARCH]->(this1:Genre)
		WHERE apoc.util.validatePredicate(NOT (($isAuthenticated = true
			AND $jwt.jwtAllowedNamesExample IS NOT NULL
			AND this1.name = $jwt.jwtAllowedNamesExample)), '@neo4j/graphql/FORBIDDEN', [0])
		WITH this1 {
			.name,
			__resolveType: 'Genre',
			__id: id(this1)
		} AS this1
		RETURN this1 AS var2 UNION
		WITH *
		MATCH (this)-[this3:SEARCH]->(this4:Movie)
		WITH this4 {
			.title,
			__resolveType: 'Movie',
			__id: id(this4)
		} AS this4
		RETURN this4 AS var2
	}
	WITH var2
	RETURN collect(var2) AS var2
}
RETURN this {
	search: var2
} AS this
----

'''

== Read Unions with filter and limit

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {title: "some title"}) {
    search(
      where: {Movie: {title: "The Matrix"}, Genre: {name: "Horror"}}
      options: {offset: 1, limit: 10}
    ) {
      ... on Movie {
        title
      }
      ... on Genre {
        name
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "isAuthenticated" : true,
  "jwt" : {
    "roles" : [ ],
    "jwtAllowedNamesExample" : "Horror"
  },
  "param0" : "some title",
  "param1" : "Horror",
  "param4" : "The Matrix",
  "param5" : 1,
  "param6" : 10
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.title = $param0
CALL {
	WITH this
	CALL {
		WITH *
		MATCH (this)-[this0:SEARCH]->(this1:Genre)
		WHERE (this1.name = $param1
			AND apoc.util.validatePredicate(NOT (($isAuthenticated = true
				AND $jwt.jwtAllowedNamesExample IS NOT NULL
				AND this1.name = $jwt.jwtAllowedNamesExample)), '@neo4j/graphql/FORBIDDEN', [0]))
		WITH this1 {
			.name,
			__resolveType: 'Genre',
			__id: id(this1)
		} AS this1
		RETURN this1 AS var2 UNION
		WITH *
		MATCH (this)-[this3:SEARCH]->(this4:Movie)
		WHERE this4.title = $param4
		WITH this4 {
			.title,
			__resolveType: 'Movie',
			__id: id(this4)
		} AS this4
		RETURN this4 AS var2
	}
	WITH var2 SKIP $param5 LIMIT $param6
	RETURN collect(var2) AS var2
}
RETURN this {
	search: var2
} AS this
----

'''

== Read Unions with missing types

.GraphQL-Query
[source,graphql]
----
{
  movies {
    search {
      ... on Genre {
        name
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "isAuthenticated" : true,
  "jwt" : {
    "roles" : [ ],
    "jwtAllowedNamesExample" : "Horror"
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL {
	WITH this
	CALL {
		WITH *
		MATCH (this)-[this0:SEARCH]->(this1:Genre)
		WHERE apoc.util.validatePredicate(NOT (($isAuthenticated = true
			AND $jwt.jwtAllowedNamesExample IS NOT NULL
			AND this1.name = $jwt.jwtAllowedNamesExample)), '@neo4j/graphql/FORBIDDEN', [0])
		WITH this1 {
			.name,
			__resolveType: 'Genre',
			__id: id(this1)
		} AS this1
		RETURN this1 AS var2 UNION
		WITH *
		MATCH (this)-[this3:SEARCH]->(this4:Movie)
		WITH this4 {
			__resolveType: 'Movie',
			__id: id(this4)
		} AS this4
		RETURN this4 AS var2
	}
	WITH var2
	RETURN collect(var2) AS var2
}
RETURN this {
	search: var2
} AS this
----

'''

== Update Unions

.GraphQL-Query
[source,graphql]
----
mutation {
  updateMovies(
    where: {title: "some movie"}
    update: {search: {Genre: {where: {node: {name: "some genre"}}, update: {node: {name: "some new genre"}}}}}
  ) {
    movies {
      title
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "some movie",
  "this_update_search_Genre0_name" : "some new genre",
  "updateMovies" : {
    "args" : {
      "update" : {
        "search" : {
          "Genre" : [ {
            "where" : {
              "node" : {
                "name" : "some genre"
              }
            },
            "update" : {
              "node" : {
                "name" : "some new genre"
              }
            }
          } ]
        }
      }
    }
  },
  "updateMovies_args_update_search_Genre0_where_this_search_Genre0param0" : "some genre"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.title = $param0
WITH this
CALL {
	WITH this
	MATCH (this)-[this_search0_relationship:SEARCH]->(this_search_Genre0:Genre)
	WHERE this_search_Genre0.name = $updateMovies_args_update_search_Genre0_where_this_search_Genre0param0
	SET this_search_Genre0.name = $this_update_search_Genre0_name
	RETURN count(*) AS update_this_search_Genre0
}
RETURN collect(DISTINCT this {
	.title
}) AS data
----

'''

