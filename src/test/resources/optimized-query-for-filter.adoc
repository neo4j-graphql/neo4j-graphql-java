:toc:
= Translator Tests

== Schema

[source,graphql,schema=true]
----
type Movie {
  title: String!
  released: Int
  tagline: String
  actor: [Person!]! @relation(name:"ACTED_IN", direction: IN)
  reviews: [Review!]!
  reviewedBy: [Person!]! @relation(name:"REVIEWED", direction: IN)
  producedBy: [Person!]! @relation(name:"PRODUCED", direction: IN)
  writtenBy: [Person!]! @relation(name:"WROTE", direction: IN)
  directedBy: [Person!]! @relation(name:"DIRECTED", direction: IN)
}
type Person {
  name: String!
  born: Int
  actedIn: [Movie!]! @relation(name: "ACTED_IN", direction:OUT)
  roles: [Role!]!
  reviewedMovies: [Movie!]! @relation(name: "REVIEWED", direction:OUT)
  reviews: [Review!]!
  producedMovies: [Movie!]! @relation(name: "PRODUCED", direction:OUT)
  writtenMovies: [Movie!]! @relation(name: "WROTE", direction:OUT)
  directedMovies: [Movie!]! @relation(name: "DIRECTED", direction:OUT)
  follows: [Person!]! @relation(name: "FOLLOWS", direction:OUT)
  followedBy: [Person!]! @relation(name: "FOLLOWS", direction:IN)
}
type Role @relation(name:"ACTED_IN", from:"actor", to:"movie") {
  actor: Person!
  movie: Movie!
  roles: String
}
type Review @relation(name:"REVIEWED", to: "movie") {
  from: Person!
  movie: Movie!
  rating: Int
  summary: String
}
----

== Tests

=== Filter at same level (some)

.Query configuration
[source,json,config=true]
----
{  "optimizedQuery": true }
----

.GraphQL-Query
[source,graphql]
----
{
  movie(filter: {
    actor_some:{
      name: "Halle Berry"
    }
    reviewedBy_some:{
      name: "Jessica Thompson"
    }
    released_gt: 1900
  }) {
    title
  }
}
----

.Cypher params
[source,json]
----
{
  "movie_actor_some_name": "Halle Berry",
  "movie_reviewedBy_some_name": "Jessica Thompson",
  "movie_released_gt": 1900
}
----

.Cypher
[source,cypher]
----
MATCH (movie:`Movie`)
WHERE movie.released > $movie_released_gt
WITH DISTINCT movie

MATCH (movie)<-[:`ACTED_IN`]-(movie_actor_some:`Person`)
WHERE movie_actor_some.name = $movie_actor_some_name
WITH DISTINCT movie

MATCH (movie)<-[:`REVIEWED`]-(movie_reviewedBy_some:`Person`)
WHERE movie_reviewedBy_some.name = $movie_reviewedBy_some_name
WITH DISTINCT movie

RETURN DISTINCT movie { .title } AS movie
----

.Movie Example result
|===
|title

|Cloud Atlas
|===

=== Filter at same level (some + every)

.Query configuration
[source,json,config=true]
----
{  "optimizedQuery": true }
----


.GraphQL-Query
[source,graphql]
----
{
  movie(filter: {
    actor_some:{
      name: "Halle Berry"
    }
    reviewedBy_every:{
      name: "Jessica Thompson"
    }
  }) {
    title
  }
}

----

.Cypher params
[source,json]
----
{
  "movie_actor_some_name": "Halle Berry",
  "movie_reviewedBy_every_name": "Jessica Thompson"
}
----

.Cypher
[source,cypher]
----
MATCH (movie:`Movie`)
WITH DISTINCT movie

MATCH (movie)<-[:`ACTED_IN`]-(movie_actor_some:`Person`)
WHERE
    movie_actor_some.name = $movie_actor_some_name
WITH DISTINCT movie

MATCH (movie)<-[:`REVIEWED`]-(movie_reviewedBy_every:`Person`)
WHERE
    movie_reviewedBy_every.name = $movie_reviewedBy_every_name
WITH movie,
    size((movie)<-[:`REVIEWED`]-(:`Person`)) AS movie_reviewedBy_every_total,
    count(DISTINCT movie_reviewedBy_every) AS movie_reviewedBy_every_count
WHERE
    movie_reviewedBy_every_total = movie_reviewedBy_every_count
WITH DISTINCT movie

RETURN DISTINCT movie { .title } AS movie
----

.Movie Example result
|===
|title

|Cloud Atlas
|===


=== Filter at same level (every)

.Query configuration
[source,json,config=true]
----
{  "optimizedQuery": true }
----

.GraphQL-Query
[source,graphql]
----
{
  movie(filter: {
    directedBy_every: {
      name: "Clint Eastwood"
    }
    reviewedBy_every:{
      name: "Jessica Thompson"
    }
  }) {
    title
  }
}
----

.Cypher params
[source,json]
----
{
  "movie_directedBy_every_name":  "Clint Eastwood",
  "movie_reviewedBy_every_name": "Jessica Thompson"
}
----

.Cypher
[source,cypher]
----
MATCH (movie:`Movie`)
WITH DISTINCT movie

MATCH (movie)<-[:`DIRECTED`]-(movie_directedBy_every:`Person`)
WHERE movie_directedBy_every.name = $movie_directedBy_every_name
WITH movie,
    size((movie)<-[:`DIRECTED`]-(:`Person`)) AS movie_directedBy_every_total,
    count(DISTINCT movie_directedBy_every) AS movie_directedBy_every_count
WHERE
    movie_directedBy_every_total = movie_directedBy_every_count
WITH DISTINCT movie

MATCH (movie)<-[:`REVIEWED`]-(movie_reviewedBy_every:`Person`)
WHERE
    movie_reviewedBy_every.name = $movie_reviewedBy_every_name
WITH movie,
    size((movie)<-[:`REVIEWED`]-(:`Person`)) AS movie_reviewedBy_every_total,
    count(DISTINCT movie_reviewedBy_every) AS movie_reviewedBy_every_count
WHERE
    movie_reviewedBy_every_total = movie_reviewedBy_every_count
WITH DISTINCT movie

RETURN DISTINCT movie { .title } AS movie
----

.Movie Example result
|===
|title

|Unforgiven
|===


=== Filter with `OR` and `AND`

CAUTION: *Not yet implemented*

.Query configuration
[source,json,config=true]
----
{  "optimizedQuery": true }
----

.GraphQL-Query
[source,graphql]
----
{
  movie(filter: {
    directedBy_every:{
      OR:[
        {
          AND:[{name: "Lilly Wachowski"},{name: "Lana Wachowski"},{name: "Tom Tykwer"}]
        },
      	{name: "Clint Eastwood"}
      ]
    }
    reviewedBy_every:{
      name: "Jessica Thompson"
    }
  }) {
    title
  }
}
----

.Cypher params
[source,json]
----
{
  "movie_directedBy_every_or1_and1_name":  "Lilly Wachowski",
  "movie_directedBy_every_or1_and2_name":  "Lana Wachowski",
  "movie_directedBy_every_or1_and3_name":  "Tom Tykwer",
  "movie_directedBy_every_or2_name":  "Clint Eastwood",
  "movie_reviewedBy_every_name": "Jessica Thompson"
}
----

.Cypher
[source,cypher]
----
MATCH (movie:`Movie`)
WITH movie

OPTIONAL MATCH
  (movie)<-[:DIRECTED]-(movie_directedBy_every_or1_and1:Person),
  (movie)<-[:DIRECTED]-(movie_directedBy_every_or1_and2:Person),
  (movie)<-[:DIRECTED]-(movie_directedBy_every_or1_and3:Person)
  WHERE
	movie_directedBy_every_or1_and1.name = $movie_directedBy_every_or1_and1_name
    AND movie_directedBy_every_or1_and2.name = $movie_directedBy_every_or1_and2_name
    AND movie_directedBy_every_or1_and3.name = $movie_directedBy_every_or1_and3_name

OPTIONAL MATCH
  (movie)<-[:DIRECTED]-(movie_directedBy_every_or2:Person)
  WHERE
	movie_directedBy_every_or2.name = $movie_directedBy_every_or2_name

WITH
	movie,

    size((movie)<-[:DIRECTED]-(:Person)) AS movie_directedBy_every_total,
	count(DISTINCT movie_directedBy_every_or1_and1) + count(DISTINCT movie_directedBy_every_or1_and2) + count(DISTINCT movie_directedBy_every_or1_and3) AS movie_directedBy_every_or1_count,
    count(movie_directedBy_every_or2) as movie_directedBy_every_or2_count
WHERE
((movie_directedBy_every_total = movie_directedBy_every_total AND movie_directedBy_every_total = 3) OR
(movie_directedBy_every_or2_count = movie_directedBy_every_total AND movie_directedBy_every_total = 1))
WITH movie

MATCH (movie)<-[:`REVIEWED`]-(movie_reviewedBy_every:`Person`)
WHERE movie_reviewedBy_every.name = $movie_reviewedBy_every_name
WITH movie,
    size((movie)<-[:`REVIEWED`]-(:`Person`)) AS movie_reviewedBy_every_total,
    count(DISTINCT movie_reviewedBy_every) AS movie_reviewedBy_every_count
WHERE
    movie_reviewedBy_every_total = movie_reviewedBy_every_count
WITH movie

RETURN DISTINCT movie { .title } AS movie
----

.Movie Example result
|===
|title

|Unforgiven

|Cloud Atlas
|===

=== Filter at different level (every)

.Query configuration
[source,json,config=true]
----
{  "optimizedQuery": true }
----

.GraphQL-Query
[source,graphql]
----
{
  movie(filter: {
    directedBy_every:{
      name: "Clint Eastwood"
    }
    reviewedBy_some:{
      name: "Jessica Thompson"
      followedBy_some:{
        reviewedMovies_some:{
          released_gte: 2000
        }
      }
    }
  }) {
    title
  }
}
----

.Cypher params
[source,json]
----
{
  "movie_directedBy_every_name":  "Clint Eastwood",
  "movie_reviewedBy_some_name": "Jessica Thompson",
  "movie_reviewedBy_some_followedBy_some_reviewedMovies_some_released_gte": 2000
}
----

.Cypher
[source,cypher]
----
MATCH (movie:`Movie`)
WITH DISTINCT movie

MATCH (movie)<-[:`DIRECTED`]-(movie_directedBy_every:`Person`)
WHERE movie_directedBy_every.name = $movie_directedBy_every_name
WITH movie,
  size((movie)<-[:`DIRECTED`]-(:`Person`)) AS movie_directedBy_every_total,
  count(DISTINCT movie_directedBy_every) AS movie_directedBy_every_count
WHERE movie_directedBy_every_total = movie_directedBy_every_count
WITH DISTINCT movie

MATCH (movie)<-[:`REVIEWED`]-(movie_reviewedBy_some:`Person`)
WHERE movie_reviewedBy_some.name = $movie_reviewedBy_some_name
WITH movie, movie_reviewedBy_some

MATCH (movie_reviewedBy_some)<-[:`FOLLOWS`]-(movie_reviewedBy_some_followedBy_some:`Person`)
WITH movie, movie_reviewedBy_some_followedBy_some

MATCH
  (movie_reviewedBy_some_followedBy_some)-[:`REVIEWED`]->(movie_reviewedBy_some_followedBy_some_reviewedMovies_some:`Movie`)
WHERE movie_reviewedBy_some_followedBy_some_reviewedMovies_some.released >= $movie_reviewedBy_some_followedBy_some_reviewedMovies_some_released_gte
WITH DISTINCT movie

RETURN DISTINCT movie { .title } AS movie
----

.Movie Example result
|===
|title

|Unforgiven

|===